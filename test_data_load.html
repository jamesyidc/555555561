<!DOCTYPE html>
<html>
<head>
    <title>æ•°æ®åŠ è½½æµ‹è¯•</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.0/echarts.min.js"></script>
</head>
<body>
    <h1>æ•°æ®åŠ è½½æµ‹è¯•é¡µé¢</h1>
    <div id="log" style="font-family: monospace; background: #f5f5f5; padding: 15px; margin: 15px; overflow: auto; max-height: 500px;"></div>
    <div id="trendChart" style="width: 800px; height: 400px; margin: 15px; border: 1px solid #ccc;"></div>
    
    <script>
        const log = (msg) => {
            console.log(msg);
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += new Date().toLocaleTimeString() + ' - ' + msg + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
        };
        
        log('ğŸš€ é¡µé¢åŠ è½½å¼€å§‹');
        
        // åˆå§‹åŒ–å›¾è¡¨
        const trendChartDom = document.getElementById('trendChart');
        let trendChart = echarts.init(trendChartDom);
        log('âœ… å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
        
        // æ¨¡æ‹Ÿæ•°æ®åŠ è½½
        async function loadData() {
            try {
                log('ğŸ“¡ å¼€å§‹è¯·æ±‚æ•°æ®...');
                const response = await fetch('/api/coin-change-tracker/history?limit=5');
                const result = await response.json();
                
                log(`âœ… APIå“åº”æˆåŠŸ: success=${result.success}, count=${result.count}, source=${result.source}`);
                
                if (result.success && result.data && result.data.length > 0) {
                    log(`ğŸ“Š æ•°æ®è®°å½•æ•°: ${result.data.length}`);
                    
                    // æå–æ—¶é—´å’Œæ¶¨è·Œå¹…
                    const times = result.data.map(d => {
                        const bt = d.beijing_time || d.time || '';
                        return bt.split(' ')[1] || bt;
                    });
                    
                    const changes = result.data.map(d => {
                        return d.total_change || d.cumulative_pct || 0;
                    });
                    
                    log(`â° æ—¶é—´æ•°ç»„: [${times.join(', ')}]`);
                    log(`ğŸ“ˆ æ¶¨è·Œå¹…æ•°ç»„: [${changes.join(', ')}]`);
                    
                    // æ›´æ–°å›¾è¡¨
                    log('ğŸ¨ å¼€å§‹æ›´æ–°å›¾è¡¨...');
                    
                    // æµ‹è¯•1: ä½¿ç”¨ notMerge=true
                    trendChart.setOption({
                        title: { text: 'æ¶¨è·Œå¹…è¶‹åŠ¿å›¾ (notMerge=trueæµ‹è¯•)' },
                        xAxis: { type: 'category', data: times },
                        yAxis: { type: 'value' },
                        series: [{
                            name: 'æ¶¨è·Œå¹…',
                            type: 'line',
                            data: changes
                        }]
                    }, true, true);
                    
                    log('âœ… å›¾è¡¨æ›´æ–°å®Œæˆ (ä½¿ç”¨ notMerge=true)');
                    
                } else {
                    log('âŒ æ²¡æœ‰æ•°æ®æˆ–æ•°æ®ä¸ºç©º');
                }
                
            } catch (error) {
                log('âŒ æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
                console.error(error);
            }
        }
        
        // é¡µé¢åŠ è½½åè‡ªåŠ¨è¯·æ±‚æ•°æ®
        window.addEventListener('load', () => {
            log('ğŸ¯ çª—å£åŠ è½½å®Œæˆï¼Œå¼€å§‹åŠ è½½æ•°æ®');
            loadData();
        });
    </script>
</body>
</html>
