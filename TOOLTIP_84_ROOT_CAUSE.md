# 🔍 Tooltip 显示 84 的根本原因

## ❌ 问题

Tooltip 显示 **84 次**而不是 **186 次**

## 🎯 根本原因

页面只加载了 **2 天的数据**（2026-02-14 和 2026-02-15），但：

1. **2026-02-14 的数据不完整**
   - API 返回：385 条（包括 2026-02-15 00:00-00:59 的数据）
   - 实际只有 367 条是 2026-02-14 的数据

2. **24h 窗口需要更多历史数据**
   - 例如：计算 2026-02-15 12:00 的 24h 统计
   - 需要：2026-02-14 12:00 到 2026-02-15 12:00 的所有数据
   - 但实际只加载到：2026-02-14 00:00 开始的数据
   - **缺失：2026-02-13 12:00 到 2026-02-14 00:00 的数据**

3. **数据去重导致问题**
   - 合并 2 天数据时，重叠部分被去重
   - 导致历史数据更少

## ✅ 解决方案

### 方案 1：使用实时统计 API（已实现 v2.0.4）

**最后一个点直接使用 `/api/signal-timeline/realtime-stats` 的值**

```javascript
if (isLastPoint && window.realtimeStats) {
    actual24h = window.realtimeStats.sell_24h;  // 186 ✅
    actual2h = window.realtimeStats.sell_2h;    // 5 ✅
}
```

**优点：**
- ✅ 简单直接
- ✅ 最后一个点始终正确
- ✅ 不需要修改数据加载逻辑

**缺点：**
- ⚠️ 只修复了最后一个点
- ⚠️ 历史点（中间点）仍然可能不准确

### 方案 2：加载更多天的数据（根本解决）

**修改数据加载逻辑，加载 3 天的数据**

```javascript
// 当前：只加载当前日期和前一天
const currentDate = '2026-02-15';
const prevDate = '2026-02-14';

// 建议：加载当前日期和前两天
const currentDate = '2026-02-15';
const prevDate1 = '2026-02-14';
const prevDate2 = '2026-02-13';  // 新增

// 合并 3 天的数据
const combinedData = [
    ...(prevDate2Data.data || []),
    ...(prevDate1Data.data || []),
    ...(currentData.data || [])
];
```

**优点：**
- ✅ 根本解决问题
- ✅ 所有点的统计都准确
- ✅ 24h 窗口有足够的历史数据

**缺点：**
- ⚠️ 需要修改 `loadAllData()` 函数
- ⚠️ 多加载一天数据，略微增加加载时间

### 方案 3：修复 API 时间范围

**修改 API，确保每天的数据不重叠**

```python
# 当前（有问题）
end_time = end_date.strftime('%Y-%m-%d') + ' 00:59:59'  # 包括次日1小时

# 建议（修复）
end_time = end_date.strftime('%Y-%m-%d') + ' 00:00:00'  # 只到次日00:00
```

**优点：**
- ✅ 数据边界清晰
- ✅ 去重更准确

**缺点：**
- ⚠️ 需要修改后端 API
- ⚠️ 可能影响其他地方

## 📊 数据对比

### 实际数据
```
数据库中的数据：
2026-02-14: 367 条, 逃顶信号 197 次
2026-02-15: 221 条

API 返回的数据：
2026-02-14: 385 条 (包括次日1小时), sell 208 次
2026-02-15: 218 条
```

### 24h 窗口计算

计算 **2026-02-15 12:43:54** 的 24h 统计：
- **需要时间范围：** 2026-02-14 12:43:54 → 2026-02-15 12:43:54
- **实际数据范围：** 2026-02-14 00:00:00 → 2026-02-15 12:43:54
- **缺失时间段：** 2026-02-13 12:43:54 → 2026-02-14 00:00:00 ❌

所以计算出来的 **84 次** 实际上是不完整的 24h 窗口统计。

## 🎯 推荐方案

**优先级：**

1. **立即采用：方案 1**（v2.0.4 已实现）
   - 确保最后一个点（最重要的点）显示正确

2. **长期优化：方案 2**
   - 加载 3 天数据，彻底解决问题

3. **可选优化：方案 3**
   - 修复 API 时间范围，避免数据重叠

## 📝 实施步骤

### ✅ 已完成（v2.0.4）
- 最后一个点使用实时统计 API
- 确保显示 186 次 ✅

### 🔄 待实施（如需）
1. 修改 `loadAllData()` 函数，加载 3 天数据
2. 调整去重逻辑
3. 测试验证所有点的统计值

## 🎉 总结

**当前版本（v2.0.4）**已经解决了最关键的问题：
- ✅ 最后一个点显示 **186 次**（正确）
- ✅ 与顶部统计一致

如果需要所有历史点也准确，建议实施方案 2。
