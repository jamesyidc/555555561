<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¹é½æ•°æ®å¯è§†åŒ– - Coin Tracker & Escape Signal</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #666;
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-card .label {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-card .value {
            color: #333;
            font-size: 28px;
            font-weight: bold;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            color: #333;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .chart-container {
            width: 100%;
            height: 500px;
        }

        .home-button {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
            margin-top: 15px;
        }

        .home-button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 8px;
            padding: 20px;
            color: #c33;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š æ•°æ®å¯¹é½å¯è§†åŒ–</h1>
            <div class="subtitle">Coin Price Tracker + Escape Signal Historyï¼ˆ30åˆ†é’Ÿå¯¹é½ï¼‰</div>
            <a href="/" class="home-button">ğŸ  è¿”å›é¦–é¡µ</a>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="label">æ€»è®°å½•æ•°</div>
                <div class="value" id="totalRecords">-</div>
            </div>
            <div class="stat-card">
                <div class="label">å¯¹é½è®°å½•æ•°</div>
                <div class="value" id="alignedRecords">-</div>
            </div>
            <div class="stat-card">
                <div class="label">å¯¹é½ç‡</div>
                <div class="value" id="alignmentRate">-</div>
            </div>
            <div class="stat-card">
                <div class="label">æ—¶é—´èŒƒå›´</div>
                <div class="value" style="font-size: 14px;" id="timeRange">-</div>
            </div>
        </div>

        <div id="errorMessage"></div>

        <!-- åŒè½´å›¾è¡¨ï¼š27å¸æ¶¨è·Œå¹… + é€ƒé¡¶ä¿¡å· -->
        <div class="chart-card">
            <div class="chart-title">ğŸ“ˆ 27å¸æ¶¨è·Œå¹…æ€»å’Œ vs 24å°æ—¶é€ƒé¡¶ä¿¡å·æ•°</div>
            <div id="mainChart" class="chart-container"></div>
        </div>

        <!-- 2å°æ—¶ä¿¡å·å›¾è¡¨ -->
        <div class="chart-card">
            <div class="chart-title">ğŸ“Š 27å¸æ¶¨è·Œå¹…æ€»å’Œ vs 2å°æ—¶é€ƒé¡¶ä¿¡å·æ•°</div>
            <div id="signal2hChart" class="chart-container"></div>
        </div>

        <!-- ç›¸å…³æ€§åˆ†æå›¾è¡¨ -->
        <div class="chart-card">
            <div class="chart-title">ğŸ”— æ•£ç‚¹å›¾ï¼šå¸ä»·æ¶¨è·Œå¹… vs é€ƒé¡¶ä¿¡å·ï¼ˆç›¸å…³æ€§åˆ†æï¼‰</div>
            <div id="correlationChart" class="chart-container"></div>
        </div>
    </div>

    <script>
        let allData = [];
        let mainChart = null;
        let signal2hChart = null;
        let correlationChart = null;

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                console.log('ğŸ“Š å¼€å§‹åŠ è½½å¯¹é½æ•°æ®...');
                
                const response = await fetch('/api/aligned-data/history');
                const result = await response.json();
                
                console.log('ğŸ“¦ APIå“åº”:', result);
                
                if (!result.success || !result.data || result.data.length === 0) {
                    showError('æ•°æ®åŠ è½½å¤±è´¥æˆ–æ— æ•°æ®');
                    return;
                }

                allData = result.data;
                console.log(`âœ… æˆåŠŸåŠ è½½ ${allData.length} æ¡è®°å½•`);
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateStats();
                
                // æ¸²æŸ“å›¾è¡¨
                renderCharts();
                
            } catch (error) {
                console.error('âŒ åŠ è½½æ•°æ®å‡ºé”™:', error);
                showError(`æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`);
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const totalRecords = allData.length;
            const alignedRecords = allData.filter(r => r.is_aligned).length;
            const alignmentRate = totalRecords > 0 ? (alignedRecords / totalRecords * 100).toFixed(1) : 0;
            
            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('alignedRecords').textContent = alignedRecords;
            document.getElementById('alignmentRate').textContent = alignmentRate + '%';
            
            if (allData.length > 0) {
                const firstTime = allData[0].time.substring(0, 10);
                const lastTime = allData[allData.length - 1].time.substring(0, 10);
                document.getElementById('timeRange').textContent = `${firstTime} ~ ${lastTime}`;
            }
        }

        // æ¸²æŸ“ä¸»å›¾è¡¨ï¼ˆ27å¸æ¶¨è·Œå¹… vs 24hä¿¡å·ï¼‰
        function renderMainChart() {
            const times = [];
            const coinChanges = [];
            const signal24h = [];
            
            allData.forEach(record => {
                const time = record.time.substring(5, 16); // MM-DD HH:MM
                times.push(time);
                
                // å¸ä»·æ¶¨è·Œå¹…
                const coinChange = record.coin_tracker ? record.coin_tracker.total_change : null;
                coinChanges.push(coinChange);
                
                // 24å°æ—¶ä¿¡å·æ•°
                const signal = record.escape_signal ? record.escape_signal.signal_24h_count_avg : null;
                signal24h.push(signal);
            });
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                legend: {
                    data: ['27å¸æ¶¨è·Œå¹…æ€»å’Œ', '24hé€ƒé¡¶ä¿¡å·æ•°'],
                    top: 10
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: times,
                    axisLabel: {
                        rotate: 45,
                        fontSize: 10
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '27å¸æ¶¨è·Œå¹…(%)',
                        position: 'left',
                        axisLabel: {
                            formatter: '{value}%'
                        }
                    },
                    {
                        type: 'value',
                        name: 'ä¿¡å·æ•°',
                        position: 'right',
                        axisLabel: {
                            formatter: '{value}'
                        }
                    }
                ],
                series: [
                    {
                        name: '27å¸æ¶¨è·Œå¹…æ€»å’Œ',
                        type: 'line',
                        yAxisIndex: 0,
                        data: coinChanges,
                        smooth: true,
                        lineStyle: {
                            width: 2,
                            color: '#667eea'
                        },
                        itemStyle: {
                            color: '#667eea'
                        }
                    },
                    {
                        name: '24hé€ƒé¡¶ä¿¡å·æ•°',
                        type: 'line',
                        yAxisIndex: 1,
                        data: signal24h,
                        smooth: true,
                        lineStyle: {
                            width: 2,
                            color: '#f56565'
                        },
                        itemStyle: {
                            color: '#f56565'
                        }
                    }
                ]
            };
            
            if (!mainChart) {
                mainChart = echarts.init(document.getElementById('mainChart'));
            }
            mainChart.setOption(option);
        }

        // æ¸²æŸ“2å°æ—¶ä¿¡å·å›¾è¡¨
        function renderSignal2hChart() {
            const times = [];
            const coinChanges = [];
            const signal2h = [];
            
            allData.forEach(record => {
                const time = record.time.substring(5, 16);
                times.push(time);
                
                const coinChange = record.coin_tracker ? record.coin_tracker.total_change : null;
                coinChanges.push(coinChange);
                
                const signal = record.escape_signal ? record.escape_signal.signal_2h_count_avg : null;
                signal2h.push(signal);
            });
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                legend: {
                    data: ['27å¸æ¶¨è·Œå¹…æ€»å’Œ', '2hé€ƒé¡¶ä¿¡å·æ•°'],
                    top: 10
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: times,
                    axisLabel: {
                        rotate: 45,
                        fontSize: 10
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '27å¸æ¶¨è·Œå¹…(%)',
                        position: 'left',
                        axisLabel: {
                            formatter: '{value}%'
                        }
                    },
                    {
                        type: 'value',
                        name: 'ä¿¡å·æ•°',
                        position: 'right',
                        axisLabel: {
                            formatter: '{value}'
                        }
                    }
                ],
                series: [
                    {
                        name: '27å¸æ¶¨è·Œå¹…æ€»å’Œ',
                        type: 'line',
                        yAxisIndex: 0,
                        data: coinChanges,
                        smooth: true,
                        lineStyle: {
                            width: 2,
                            color: '#667eea'
                        },
                        itemStyle: {
                            color: '#667eea'
                        }
                    },
                    {
                        name: '2hé€ƒé¡¶ä¿¡å·æ•°',
                        type: 'line',
                        yAxisIndex: 1,
                        data: signal2h,
                        smooth: true,
                        lineStyle: {
                            width: 2,
                            color: '#48bb78'
                        },
                        itemStyle: {
                            color: '#48bb78'
                        }
                    }
                ]
            };
            
            if (!signal2hChart) {
                signal2hChart = echarts.init(document.getElementById('signal2hChart'));
            }
            signal2hChart.setOption(option);
        }

        // æ¸²æŸ“ç›¸å…³æ€§æ•£ç‚¹å›¾
        function renderCorrelationChart() {
            const scatterData = [];
            
            allData.forEach(record => {
                if (record.is_aligned && record.coin_tracker && record.escape_signal) {
                    const coinChange = record.coin_tracker.total_change;
                    const signal24h = record.escape_signal.signal_24h_count_avg;
                    scatterData.push([coinChange, signal24h, record.time]);
                }
            });
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        return `æ—¶é—´: ${params.data[2]}<br/>
                                27å¸æ¶¨è·Œå¹…: ${params.data[0].toFixed(2)}%<br/>
                                24hä¿¡å·æ•°: ${params.data[1].toFixed(1)}`;
                    }
                },
                xAxis: {
                    name: '27å¸æ¶¨è·Œå¹…æ€»å’Œ(%)',
                    nameLocation: 'middle',
                    nameGap: 30
                },
                yAxis: {
                    name: '24hé€ƒé¡¶ä¿¡å·æ•°',
                    nameLocation: 'middle',
                    nameGap: 40
                },
                series: [{
                    type: 'scatter',
                    data: scatterData,
                    symbolSize: 8,
                    itemStyle: {
                        color: '#667eea',
                        opacity: 0.6
                    }
                }]
            };
            
            if (!correlationChart) {
                correlationChart = echarts.init(document.getElementById('correlationChart'));
            }
            correlationChart.setOption(option);
        }

        // æ¸²æŸ“æ‰€æœ‰å›¾è¡¨
        function renderCharts() {
            renderMainChart();
            renderSignal2hChart();
            renderCorrelationChart();
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `<div class="error">âŒ ${message}</div>`;
        }

        // å“åº”å¼è°ƒæ•´
        window.addEventListener('resize', () => {
            if (mainChart) mainChart.resize();
            if (signal2hChart) signal2hChart.resize();
            if (correlationChart) correlationChart.resize();
        });

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.onload = () => {
            loadData();
        };
    </script>
</body>
</html>
