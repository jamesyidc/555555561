<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›‘æ§ç³»ç»Ÿ - ä¸‰å¤§æ ¸å¿ƒå›¾è¡¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        .chart-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .page-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .nav-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-weight: 600;
        }
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .update-time {
            color: #718096;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="page-header">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-chart-line text-purple-600"></i>
                        ç›‘æ§ç³»ç»Ÿ - ä¸‰å¤§æ ¸å¿ƒå›¾è¡¨
                    </h1>
                    <p class="text-gray-600">å®æ—¶è¿½è¸ªå¸‚åœºå…³é”®æŒ‡æ ‡ï¼ŒåŠ©åŠ›äº¤æ˜“å†³ç­–</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="refreshAllCharts()" class="nav-button">
                        <i class="fas fa-sync-alt"></i>
                        åˆ·æ–°æ•°æ®
                    </button>
                    <a href="/" class="nav-button">
                        <i class="fas fa-home"></i>
                        è¿”å›é¦–é¡µ
                    </a>
                </div>
            </div>
        </div>

        <!-- å›¾è¡¨1: ææ…Œ/æ´—ç›˜æŸ±çŠ¶å›¾ (æœ¬å‘¨12å°æ—¶) -->
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-chart-bar text-red-500"></i>
                <span>ææ…Œ/æ´—ç›˜æŸ±çŠ¶å›¾ (æœ¬å‘¨12å°æ—¶)</span>
            </div>
            <div id="panicWashChart" style="width: 100%; height: 400px;"></div>
            <div class="update-time" id="panicUpdateTime">æœ€åæ›´æ–°: åŠ è½½ä¸­...</div>
        </div>

        <!-- å›¾è¡¨2: 1å°æ—¶çˆ†ä»“é‡‘é¢æ›²çº¿ -->
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-fire text-orange-500"></i>
                <span>çˆ†ä»“äººæ•°ï¼ˆä¸‡äººï¼‰/æŒä»“æ€»é‡ï¼ˆäº¿ç¾å…ƒï¼‰</span>
                <span style="font-size: 12px; color: #fbbf24; font-weight: normal;">[ææ…ŒæŒ‡æ•°]</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div class="text-sm text-gray-600">
                    <span id="liqPageInfo">åŠ è½½ä¸­...</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="loadLiquidationPreviousPage()" 
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        <i class="fas fa-chevron-left mr-1"></i> æ›´æ—©
                    </button>
                    <button onclick="loadLiquidationNextPage()" 
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        æ›´æ–° <i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
            <div id="liquidationChart" style="width: 100%; height: 400px; background: rgba(30, 27, 75, 0.95); border-radius: 15px;"></div>
            <div class="text-center text-xs text-gray-500 mt-3">
                æ•°æ®é‡‡é›†é¢‘ç‡: æ¯åˆ†é’Ÿä¸€æ¬¡ | æ•°æ®æ¥æº: OKX API | å•ä½: ä¸‡ç¾å…ƒ | æ¯é¡µæ˜¾ç¤º12å°æ—¶
            </div>
        </div>

        <!-- å›¾è¡¨3: å¤šç©ºå•ç›ˆåˆ©ç»Ÿè®¡ -->
        <div class="chart-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div class="chart-title" style="margin-bottom: 0;">
                    <i class="fas fa-balance-scale text-blue-500"></i>
                    <span>å¤šç©ºå•ç›ˆåˆ©ç»Ÿè®¡</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="changeProfitStatsPage(-1)" 
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        <i class="fas fa-chevron-left mr-1"></i> å‰ä¸€å¤©
                    </button>
                    <button onclick="changeProfitStatsPage(1)" 
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        åä¸€å¤© <i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
            <div id="profitStatsChart" style="width: 100%; height: 400px;"></div>
            <div class="update-time" id="profitUpdateTime">æœ€åæ›´æ–°: åŠ è½½ä¸­...</div>
        </div>
    </div>

    <script>
        let panicWashChart = null;
        let liquidationChart = null;
        let profitStatsChart = null;
        let liqCurrentPage = 0;
        let liqAllData = [];
        let profitCurrentPage = 0;
        let allProfitData = [];
        const LIQ_HOURS_PER_PAGE = 12;
        const LIQ_RECORDS_PER_HOUR = 60;
        const LIQ_RECORDS_PER_PAGE = LIQ_HOURS_PER_PAGE * LIQ_RECORDS_PER_HOUR;

        // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
        function initCharts() {
            console.log('ğŸ”§ å¼€å§‹åˆå§‹åŒ–å›¾è¡¨...');
            
            // åˆå§‹åŒ–ææ…Œ/æ´—ç›˜å›¾è¡¨
            const panicContainer = document.getElementById('panicWashChart');
            if (panicContainer) {
                panicWashChart = echarts.init(panicContainer);
                console.log('âœ… panicWashChartåˆå§‹åŒ–æˆåŠŸ');
            }
            
            // åˆå§‹åŒ–çˆ†ä»“å›¾è¡¨
            const liqContainer = document.getElementById('liquidationChart');
            if (liqContainer) {
                liquidationChart = echarts.init(liqContainer);
                console.log('âœ… liquidationChartåˆå§‹åŒ–æˆåŠŸ');
            }
            
            // åˆå§‹åŒ–å¤šç©ºç›ˆåˆ©å›¾è¡¨
            const profitContainer = document.getElementById('profitStatsChart');
            if (profitContainer) {
                profitStatsChart = echarts.init(profitContainer);
                console.log('âœ… profitStatsChartåˆå§‹åŒ–æˆåŠŸ');
            }
        }

        // åŠ è½½ææ…Œ/æ´—ç›˜æ•°æ®
        async function loadPanicWashData() {
            try {
                console.log('ğŸ“Š åŠ è½½ææ…Œ/æ´—ç›˜æ•°æ®...');
                const response = await fetch('/api/panic/recent?hours=12');
                const data = await response.json();
                
                if (data.success && data.data) {
                    renderPanicWashChart(data.data);
                    document.getElementById('panicUpdateTime').textContent = 
                        `æœ€åæ›´æ–°: ${new Date().toLocaleString('zh-CN')}`;
                }
            } catch (error) {
                console.error('âŒ åŠ è½½ææ…Œ/æ´—ç›˜æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“ææ…Œ/æ´—ç›˜å›¾è¡¨
        function renderPanicWashChart(data) {
            if (!panicWashChart || !data || data.length === 0) return;
            
            const times = data.map(d => {
                const dt = new Date(d.datetime);
                return `${dt.getMonth()+1}/${dt.getDate()} ${dt.getHours()}:${dt.getMinutes().toString().padStart(2,'0')}`;
            });
            
            const panicValues = data.map(d => d.panic_count || 0);
            const washValues = data.map(d => d.wash_count || 0);
            
            const option = {
                title: {
                    text: 'ææ…Œ/æ´—ç›˜ä¿¡å·ç»Ÿè®¡ (æœ¬å‘¨12å°æ—¶)',
                    left: 'center',
                    textStyle: {
                        color: '#2d3748',
                        fontSize: 16
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['ææ…Œä¿¡å·', 'æ´—ç›˜ä¿¡å·'],
                    top: 30
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLabel: {
                        rotate: 45,
                        fontSize: 10
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'ä¿¡å·æ•°é‡'
                },
                series: [
                    {
                        name: 'ææ…Œä¿¡å·',
                        type: 'bar',
                        data: panicValues,
                        itemStyle: {
                            color: '#ef4444'
                        },
                        barMaxWidth: 30
                    },
                    {
                        name: 'æ´—ç›˜ä¿¡å·',
                        type: 'bar',
                        data: washValues,
                        itemStyle: {
                            color: '#10b981'
                        },
                        barMaxWidth: 30
                    }
                ]
            };
            
            panicWashChart.setOption(option);
        }

        // åŠ è½½çˆ†ä»“æ•°æ®
        async function loadLiquidationData() {
            try {
                console.log('ğŸ“Š åŠ è½½1å°æ—¶çˆ†ä»“é‡‘é¢å…¨éƒ¨æ•°æ®...');
                const response = await fetch('/api/liquidation-1h/history?limit=10000');
                const result = await response.json();
                
                if (!result.success || !result.data || result.data.length === 0) {
                    console.warn('âš ï¸ æš‚æ— 1å°æ—¶çˆ†ä»“é‡‘é¢æ•°æ®');
                    return;
                }
                
                liqAllData = result.data;
                console.log(`âœ… åŠ è½½æˆåŠŸ: ${liqAllData.length}æ¡è®°å½•`);
                
                liqCurrentPage = 0;
                updateLiquidationChart();
                updateLiquidationPageInfo();
            } catch (error) {
                console.error('âŒ åŠ è½½çˆ†ä»“æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°çˆ†ä»“å›¾è¡¨
        function updateLiquidationChart() {
            if (!liquidationChart || !liqAllData || liqAllData.length === 0) return;
            
            const totalRecords = liqAllData.length;
            const startIndex = Math.max(0, totalRecords - (liqCurrentPage + 1) * LIQ_RECORDS_PER_PAGE);
            const endIndex = Math.max(0, totalRecords - liqCurrentPage * LIQ_RECORDS_PER_PAGE);
            
            const pageData = liqAllData.slice(startIndex, endIndex);
            
            const times = pageData.map(d => {
                const dt = new Date(d.timestamp * 1000);
                return `${dt.getMonth()+1}/${dt.getDate()} ${dt.getHours().toString().padStart(2, '0')}:${dt.getMinutes().toString().padStart(2, '0')}`;
            });
            
            const amounts = pageData.map(d => d.hour_1_amount);
            const avgAmount = (amounts.reduce((a, b) => a + b, 0) / amounts.length).toFixed(2);
            const maxAmount = Math.max(...amounts);
            const maxIndex = amounts.indexOf(maxAmount);
            
            const startTime = pageData[0].datetime.substring(5, 16);
            const endTime = pageData[pageData.length - 1].datetime.substring(5, 16);
            
            const option = {
                backgroundColor: 'rgba(30, 27, 75, 0.95)',
                title: {
                    text: `çˆ†ä»“äººæ•°ï¼ˆä¸‡äººï¼‰/æŒä»“æ€»é‡ï¼ˆäº¿ç¾å…ƒï¼‰ - ${startTime} ~ ${endTime}`,
                    left: 'center',
                    top: 10,
                    textStyle: {
                        color: 'rgba(255, 255, 255, 0.9)',
                        fontSize: 14
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    textStyle: {
                        color: '#fff'
                    },
                    formatter: function(params) {
                        const p = params[0];
                        const dataItem = pageData[p.dataIndex];
                        const amount = p.value;
                        const isMax = p.dataIndex === maxIndex;
                        
                        // è·å–ææ…ŒæŒ‡æ•°æ•°æ®
                        const people = dataItem.hour_24_people || 0;
                        const position = dataItem.total_position || 0;
                        const panicIndex = dataItem.panic_index || 0;
                        
                        return `<div style="padding: 8px;">
                            <div style="font-weight: 600; margin-bottom: 5px;">${p.name}</div>
                            <div style="color: #f59e0b; font-size: 16px; font-weight: 600;">
                                ğŸ’¥ 1Hçˆ†ä»“: ${amount} ä¸‡ç¾å…ƒ${isMax ? ' ğŸ”¥' : ''}
                            </div>
                            <div style="font-size: 12px; margin-top: 8px;">
                                <div style="color: #10b981; margin-bottom: 3px;">ğŸ‘¥ çˆ†ä»“äººæ•°: <span style="font-weight: 600;">${people}</span> ä¸‡äºº</div>
                                <div style="color: #3b82f6; margin-bottom: 3px;">ğŸ’° æŒä»“æ€»é‡: <span style="font-weight: 600;">${position}</span> äº¿ç¾å…ƒ</div>
                                <div style="color: #ef4444; font-weight: 700;">ğŸ”¥ ææ…ŒæŒ‡æ•°: <span style="font-size: 14px;">${panicIndex}</span></div>
                            </div>
                            <div style="font-size: 11px; color: #9ca3af; margin-top: 5px;">
                                å¹³å‡å€¼: ${avgAmount} ä¸‡ç¾å…ƒ
                            </div>
                            ${isMax ? '<div style="font-size: 12px; color: #ef4444; margin-top: 5px; font-weight: 700;">ğŸ”¥ åŒºé—´å†…æœ€å¤§å€¼ï¼</div>' : ''}
                        </div>`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLabel: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        fontSize: 10,
                        rotate: 45,
                        interval: Math.floor(times.length / 20)
                    },
                    axisLine: {
                        lineStyle: {
                            color: 'rgba(255, 255, 255, 0.2)'
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'ä¸‡ç¾å…ƒ',
                    nameTextStyle: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        fontSize: 11
                    },
                    axisLabel: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        fontSize: 11
                    },
                    axisLine: {
                        lineStyle: {
                            color: 'rgba(255, 255, 255, 0.2)'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: 'rgba(255, 255, 255, 0.1)',
                            type: 'dashed'
                        }
                    }
                },
                series: [
                    {
                        name: 'ææ…ŒæŒ‡æ•°',
                        type: 'line',
                        data: amounts,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 4,
                        lineStyle: {
                            color: '#f59e0b',
                            width: 2
                        },
                        itemStyle: {
                            color: '#f59e0b'
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(245, 158, 11, 0.3)' },
                                    { offset: 1, color: 'rgba(245, 158, 11, 0.05)' }
                                ]
                            }
                        },
                        markLine: {
                            silent: true,
                            symbol: 'none',
                            label: {
                                position: 'end',
                                formatter: 'å¹³å‡: {c}ä¸‡'
                            },
                            lineStyle: {
                                color: 'rgba(255, 255, 255, 0.4)',
                                type: 'dashed',
                                width: 1
                            },
                            data: [{ yAxis: avgAmount }]
                        },
                        markPoint: {
                            symbol: 'pin',
                            symbolSize: 80,
                            label: {
                                show: true,
                                formatter: function(params) {
                                    return `ğŸ”¥ ${params.value}ä¸‡\næœ€é«˜å€¼`;
                                },
                                color: '#fff',
                                fontSize: 18,
                                fontWeight: 'bold',
                                lineHeight: 22,
                                backgroundColor: 'rgba(239, 68, 68, 0.9)',
                                borderColor: '#fbbf24',
                                borderWidth: 2,
                                borderRadius: 8,
                                padding: [8, 12],
                                shadowColor: 'rgba(239, 68, 68, 0.6)',
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowOffsetY: 2
                            },
                            itemStyle: {
                                color: '#ef4444',
                                borderColor: '#fbbf24',
                                borderWidth: 3,
                                shadowColor: 'rgba(239, 68, 68, 0.8)',
                                shadowBlur: 15
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: 20,
                                    backgroundColor: 'rgba(239, 68, 68, 1.0)'
                                },
                                itemStyle: {
                                    shadowBlur: 20
                                }
                            },
                            data: [
                                {
                                    coord: [maxIndex, maxAmount],
                                    value: maxAmount.toFixed(2),
                                    name: 'åŒºé—´æœ€å¤§å€¼'
                                }
                            ]
                        }
                    }
                ]
            };
            
            liquidationChart.setOption(option);
        }

        // æ›´æ–°é¡µç ä¿¡æ¯
        function updateLiquidationPageInfo() {
            const totalPages = Math.ceil(liqAllData.length / LIQ_RECORDS_PER_PAGE);
            document.getElementById('liqPageInfo').textContent = 
                `å½“å‰é¡µ: ${liqCurrentPage + 1}/${totalPages}`;
        }

        // çˆ†ä»“å›¾è¡¨åˆ†é¡µ
        function loadLiquidationPreviousPage() {
            const totalPages = Math.ceil(liqAllData.length / LIQ_RECORDS_PER_PAGE);
            if (liqCurrentPage < totalPages - 1) {
                liqCurrentPage++;
                updateLiquidationChart();
                updateLiquidationPageInfo();
            }
        }

        function loadLiquidationNextPage() {
            if (liqCurrentPage > 0) {
                liqCurrentPage--;
                updateLiquidationChart();
                updateLiquidationPageInfo();
            }
        }

        // åŠ è½½å¤šç©ºç›ˆåˆ©æ•°æ®
        async function loadProfitStatsData() {
            try {
                console.log('ğŸ“Š åŠ è½½å¤šç©ºç›ˆåˆ©ç»Ÿè®¡æ•°æ®...');
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`/api/anchor-profit/by-date?date=${today}&type=profit_stats`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    allProfitData = data.data;
                    console.log(`âœ… åŠ è½½æˆåŠŸ: ${allProfitData.length}æ¡è®°å½•`);
                    renderProfitStatsChart(0);
                    document.getElementById('profitUpdateTime').textContent = 
                        `æœ€åæ›´æ–°: ${new Date().toLocaleString('zh-CN')}`;
                }
            } catch (error) {
                console.error('âŒ åŠ è½½å¤šç©ºç›ˆåˆ©æ•°æ®å¤±è´¥:', error);
            }
        }

        // UTCæ—¶é—´è½¬åŒ—äº¬æ—¶é—´
        function utcToBeijing(utcDatetimeStr) {
            const utcDate = new Date(utcDatetimeStr + ' UTC');
            const beijingDate = new Date(utcDate.getTime() + 8 * 60 * 60 * 1000);
            const year = beijingDate.getUTCFullYear();
            const month = String(beijingDate.getUTCMonth() + 1).padStart(2, '0');
            const day = String(beijingDate.getUTCDate()).padStart(2, '0');
            const hours = String(beijingDate.getUTCHours()).padStart(2, '0');
            const minutes = String(beijingDate.getUTCMinutes()).padStart(2, '0');
            const seconds = String(beijingDate.getUTCSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // æ¸²æŸ“å¤šç©ºç›ˆåˆ©å›¾è¡¨
        function renderProfitStatsChart(pageOffset) {
            if (!profitStatsChart || !allProfitData || allProfitData.length === 0) return;
            
            const now = new Date();
            const targetDate = new Date(now);
            targetDate.setDate(targetDate.getDate() + pageOffset);
            
            const year = targetDate.getFullYear();
            const month = String(targetDate.getMonth() + 1).padStart(2, '0');
            const day = String(targetDate.getDate()).padStart(2, '0');
            const datePrefix = `${year}-${month}-${day}`;
            
            const dataList = allProfitData.filter(d => {
                if (!d.datetime) return false;
                const beijingDatetime = utcToBeijing(d.datetime);
                return beijingDatetime.startsWith(datePrefix);
            });
            
            if (dataList.length === 0) {
                profitStatsChart.setOption({
                    title: {
                        text: `âš ï¸ ${targetDate.toLocaleDateString()} æš‚æ— æ•°æ®`,
                        left: 'center',
                        top: 'middle',
                        textStyle: {
                            color: '#999',
                            fontSize: 20
                        }
                    }
                });
                return;
            }
            
            const times = dataList.map(d => {
                const utcDate = new Date(d.datetime + ' UTC');
                const beijingDate = new Date(utcDate.getTime() + 8 * 60 * 60 * 1000);
                const hours = String(beijingDate.getUTCHours()).padStart(2, '0');
                const minutes = String(beijingDate.getUTCMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            });
            
            const short_lte40Data = dataList.map(d => d.stats?.short?.lte_40 || d.stats?.lte_40 || 0);
            const short_lossData = dataList.map(d => d.stats?.short?.loss || d.stats?.loss || 0);
            const short_gte80Data = dataList.map(d => d.stats?.short?.gte_80 || d.stats?.gte_80 || 0);
            const short_gte120Data = dataList.map(d => d.stats?.short?.gte_120 || d.stats?.gte_120 || 0);
            const escape2hData = dataList.map(d => d.escape_signal_2h || 0);
            
            const dateStr = targetDate.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            const dayLabel = pageOffset === 0 ? 'ä»Šå¤©' : 
                           pageOffset === -1 ? 'æ˜¨å¤©' : 
                           pageOffset === -2 ? 'å‰å¤©' : 
                           `${Math.abs(pageOffset)}å¤©å‰`;
            
            const option = {
                title: {
                    text: `å¤šç©ºå•ç›ˆåˆ©åˆ†å¸ƒè¶‹åŠ¿ï¼ˆ${dateStr} ${dayLabel} - åŒ—äº¬æ—¶é—´ UTC+8ï¼‰`,
                    left: 'center',
                    textStyle: {
                        color: '#2d3748',
                        fontSize: 16
                    }
                },
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: [
                        'ğŸŸ¢ ç©ºå•ç›ˆåˆ©â‰¤40%',
                        'ğŸŸ¢ ç©ºå•äºæŸ',
                        'ğŸ”´ ç©ºå•ç›ˆåˆ©â‰¥80%',
                        'ğŸ”´ ç©ºå•ç›ˆåˆ©â‰¥120%',
                        'âš¡ 2hé€ƒé¡¶ä¿¡å·'
                    ],
                    top: 35,
                    textStyle: {
                        fontSize: 11
                    }
                },
                grid: {
                    left: '5%',
                    right: '5%',
                    bottom: '3%',
                    top: 95,
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: times,
                    axisLabel: {
                        rotate: 45,
                        fontSize: 10
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '2hé€ƒé¡¶ä¿¡å·',
                        position: 'left',
                        minInterval: 1,
                        axisLabel: {
                            color: '#f97316'
                        },
                        axisLine: {
                            show: true,
                            lineStyle: {
                                color: '#f97316'
                            }
                        }
                    },
                    {
                        type: 'value',
                        name: 'ç©ºå•æ•°é‡',
                        position: 'right',
                        minInterval: 1,
                        axisLine: {
                            show: true,
                            lineStyle: {
                                color: '#4b5563'
                            }
                        }
                    }
                ],
                series: [
                    {
                        name: 'âš¡ 2hé€ƒé¡¶ä¿¡å·',
                        type: 'line',
                        yAxisIndex: 0,
                        data: escape2hData,
                        smooth: true,
                        itemStyle: { color: '#f97316' },
                        lineStyle: { width: 3, color: '#f97316' },
                        symbol: 'diamond',
                        symbolSize: 7
                    },
                    {
                        name: 'ğŸŸ¢ ç©ºå•ç›ˆåˆ©â‰¤40%',
                        type: 'line',
                        yAxisIndex: 1,
                        data: short_lte40Data,
                        smooth: true,
                        itemStyle: { color: '#10b981' },
                        lineStyle: { width: 3, color: '#10b981' },
                        symbol: 'circle',
                        symbolSize: 6
                    },
                    {
                        name: 'ğŸŸ¢ ç©ºå•äºæŸ',
                        type: 'line',
                        yAxisIndex: 1,
                        data: short_lossData,
                        smooth: true,
                        itemStyle: { color: '#059669' },
                        lineStyle: { width: 3, color: '#059669' },
                        symbol: 'circle',
                        symbolSize: 6
                    },
                    {
                        name: 'ğŸ”´ ç©ºå•ç›ˆåˆ©â‰¥80%',
                        type: 'line',
                        yAxisIndex: 1,
                        data: short_gte80Data,
                        smooth: true,
                        itemStyle: { color: '#ef4444' },
                        lineStyle: { width: 3, color: '#ef4444' },
                        symbol: 'circle',
                        symbolSize: 6
                    },
                    {
                        name: 'ğŸ”´ ç©ºå•ç›ˆåˆ©â‰¥120%',
                        type: 'line',
                        yAxisIndex: 1,
                        data: short_gte120Data,
                        smooth: true,
                        itemStyle: { color: '#991b1b' },
                        lineStyle: { width: 3, color: '#991b1b' },
                        symbol: 'circle',
                        symbolSize: 6
                    }
                ]
            };
            
            profitStatsChart.setOption(option);
        }

        // å¤šç©ºç›ˆåˆ©å›¾è¡¨åˆ†é¡µ
        function changeProfitStatsPage(offset) {
            profitCurrentPage += offset;
            renderProfitStatsChart(profitCurrentPage);
        }

        // åˆ·æ–°æ‰€æœ‰å›¾è¡¨
        async function refreshAllCharts() {
            console.log('ğŸ”„ åˆ·æ–°æ‰€æœ‰å›¾è¡¨...');
            await Promise.all([
                loadPanicWashData(),
                loadLiquidationData(),
                loadProfitStatsData()
            ]);
            console.log('âœ… æ‰€æœ‰å›¾è¡¨åˆ·æ–°å®Œæˆ');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ“± é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            initCharts();
            await refreshAllCharts();
        });

        // çª—å£å¤§å°æ”¹å˜æ—¶è°ƒæ•´å›¾è¡¨
        window.addEventListener('resize', function() {
            if (panicWashChart) panicWashChart.resize();
            if (liquidationChart) liquidationChart.resize();
            if (profitStatsChart) profitStatsChart.resize();
        });
    </script>
</body>
</html>
