<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>27å¸ç§å†å²æ•°æ® - 1æœˆ3æ—¥è‡³1æœˆ16æ—¥</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .date-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .date-selector label {
            font-weight: 600;
            color: #667eea;
        }

        .date-selector select {
            padding: 8px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .date-selector button {
            padding: 8px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .date-selector button:hover {
            opacity: 0.9;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .chart-container {
            width: 100%;
            height: 500px;
        }

        .data-table-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
        }

        .data-table th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .positive {
            color: #10b981;
            font-weight: 600;
        }

        .negative {
            color: #ef4444;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .table-wrapper {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .info-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            margin-left: 10px;
        }

        .base-price-info {
            background: rgba(102, 126, 234, 0.05);
            border-left: 4px solid #667eea;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 13px;
        }

        .coin-label {
            display: inline-block;
            padding: 2px 8px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .export-btn {
            padding: 8px 20px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 10px;
        }

        .export-btn:hover {
            background: #059669;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                ğŸ“Š 27å¸ç§å†å²æ•°æ®æŸ¥è¯¢
                <span class="info-badge">1æœˆ3æ—¥-1æœˆ16æ—¥ Â· 30åˆ†é’Ÿç²’åº¦</span>
            </h1>
            
            <div class="date-selector">
                <label>ğŸ“… é€‰æ‹©æ—¥æœŸ:</label>
                <select id="dateSelect">
                    <option value="">æ­£åœ¨åŠ è½½...</option>
                </select>
                
                <button onclick="loadDateData()">ğŸ” æŸ¥è¯¢</button>
                <button class="export-btn" onclick="exportToCSV()">ğŸ“¥ å¯¼å‡ºCSV</button>
            </div>

            <div class="base-price-info" id="basePriceInfo">
                ğŸ’¡ åŸºå‡†ä»·æ ¼ï¼šé€‰æ‹©æ—¥æœŸåæ˜¾ç¤ºå½“å¤©00:00çš„27ä¸ªå¸ç§ä»·æ ¼
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-title">
                ğŸ“ˆ å½“æ—¥æ¶¨è·Œè¶‹åŠ¿å›¾ï¼ˆ30åˆ†é’Ÿç²’åº¦ï¼Œ48ä¸ªæ•°æ®ç‚¹ï¼‰
            </div>
            <div id="trendChart" class="chart-container"></div>
        </div>

        <div class="data-table-card">
            <div class="chart-title">
                ğŸ“‹ è¯¦ç»†æ•°æ®è¡¨ï¼ˆåŸºå‡†ä»·æ ¼ã€å½“å‰ä»·æ ¼ã€æ¶¨è·Œå¹…ï¼‰
            </div>
            <div class="table-wrapper">
                <table class="data-table" id="dataTable">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>å¸ç§</th>
                            <th>åŸºå‡†ä»·æ ¼ï¼ˆ00:00ï¼‰</th>
                            <th>å½“å‰ä»·æ ¼</th>
                            <th>æ¶¨è·Œå¹…</th>
                            <th>27å¸ç›¸åŠ çš„å’Œ</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px;">
                                è¯·é€‰æ‹©æ—¥æœŸå¹¶ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let trendChart = null;
        let currentData = [];

        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const chartDom = document.getElementById('trendChart');
            trendChart = echarts.init(chartDom);
        }

        // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
        async function initDateSelector() {
            const select = document.getElementById('dateSelect');
            select.innerHTML = '';
            
            // ç”Ÿæˆ1æœˆ3æ—¥åˆ°1æœˆ16æ—¥çš„æ—¥æœŸé€‰é¡¹
            const startDate = new Date(2026, 0, 3);  // 1æœˆ3æ—¥
            const endDate = new Date(2026, 0, 16);   // 1æœˆ16æ—¥
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().substring(0, 10);
                const option = document.createElement('option');
                option.value = dateStr;
                option.textContent = `${dateStr} (${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]})`;
                select.appendChild(option);
            }
            
            // é»˜è®¤é€‰æ‹©ä»Šå¤©æˆ–æœ€åä¸€å¤©
            select.value = '2026-01-16';
        }

        // åŠ è½½æŒ‡å®šæ—¥æœŸçš„æ•°æ®
        async function loadDateData() {
            const dateSelect = document.getElementById('dateSelect');
            const selectedDate = dateSelect.value;
            
            if (!selectedDate) {
                alert('è¯·é€‰æ‹©æ—¥æœŸ');
                return;
            }

            console.log('ğŸ“… æŸ¥è¯¢æ—¥æœŸ:', selectedDate);
            
            try {
                // æŸ¥è¯¢è¿™ä¸€å¤©çš„æ•°æ®ï¼ˆä»00:00åˆ°23:30ï¼‰
                const startTime = `${selectedDate} 00:00:00`;
                const endTime = `${selectedDate} 23:30:00`;
                
                const response = await fetch(`/api/coin-price-tracker/history?start_time=${encodeURIComponent(startTime)}&end_time=${encodeURIComponent(endTime)}`);
                const result = await response.json();
                
                console.log('ğŸ“¦ APIå“åº”:', result);
                
                if (!result.success || !result.data || result.data.length === 0) {
                    alert('è¯¥æ—¥æœŸæš‚æ— æ•°æ®ï¼Œè¯·ç­‰å¾…å†å²æ•°æ®å›å¡«å®Œæˆ');
                    return;
                }

                currentData = result.data;
                
                // æ›´æ–°åŸºå‡†ä»·æ ¼ä¿¡æ¯
                updateBasePriceInfo(result.data[0]);
                
                // æ›´æ–°å›¾è¡¨
                updateTrendChart(result.data);
                
                // æ›´æ–°æ•°æ®è¡¨
                updateDataTable(result.data);
                
                console.log('âœ… æ•°æ®åŠ è½½å®Œæˆ');
            } catch (error) {
                console.error('âŒ åŠ è½½æ•°æ®å‡ºé”™:', error);
                alert('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ›´æ–°åŸºå‡†ä»·æ ¼ä¿¡æ¯
        function updateBasePriceInfo(firstRecord) {
            const info = document.getElementById('basePriceInfo');
            const coins = firstRecord.coins;
            
            let html = `ğŸ’¡ <strong>åŸºå‡†ä»·æ ¼ï¼ˆ${firstRecord.base_date} 00:00ï¼‰</strong>ï¼š<br/><div style="margin-top: 10px; line-height: 1.8;">`;
            
            const symbols = Object.keys(coins).sort();
            symbols.forEach(symbol => {
                const basePrice = coins[symbol].base_price;
                if (basePrice > 0) {
                    html += `<span class="coin-label">${symbol}</span> $${basePrice.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 8
                    })} &nbsp;&nbsp; `;
                }
            });
            
            html += '</div>';
            info.innerHTML = html;
        }

        // æ›´æ–°è¶‹åŠ¿å›¾
        function updateTrendChart(dataArray) {
            const times = [];
            const seriesData = {};
            
            // åˆå§‹åŒ–ç³»åˆ—æ•°æ®
            const symbols = Object.keys(dataArray[0].coins);
            symbols.forEach(symbol => {
                seriesData[symbol] = [];
            });
            
            // å¡«å……æ•°æ®
            dataArray.forEach(record => {
                const time = record.collect_time.substring(11, 16); // HH:MM
                times.push(time);
                
                symbols.forEach(symbol => {
                    const change = record.coins[symbol]?.change_pct || 0;
                    seriesData[symbol].push(change);
                });
            });
            
            // é€‰æ‹©å‡ ä¸ªä¸»è¦å¸ç§å±•ç¤º
            const mainCoins = ['BTC', 'ETH', 'XRP', 'BNB', 'SOL', 'DOGE'];
            const colors = ['#f59e0b', '#8b5cf6', '#3b82f6', '#f97316', '#10b981', '#ef4444'];
            
            const series = mainCoins.map((symbol, index) => ({
                name: symbol,
                type: 'line',
                smooth: true,
                data: seriesData[symbol],
                lineStyle: {
                    width: 2
                },
                itemStyle: {
                    color: colors[index]
                }
            }));
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    borderColor: '#ddd',
                    borderWidth: 1,
                    formatter: function(params) {
                        let html = `<div style="padding: 5px;"><strong>${params[0].axisValue}</strong><br/>`;
                        params.forEach(param => {
                            const value = param.value;
                            const color = value >= 0 ? '#10b981' : '#ef4444';
                            html += `<span style="color: ${param.color};">â—</span> ${param.seriesName}: <span style="color: ${color}; font-weight: 600;">${value >= 0 ? '+' : ''}${value.toFixed(2)}%</span><br/>`;
                        });
                        html += '</div>';
                        return html;
                    }
                },
                legend: {
                    data: mainCoins,
                    top: 10
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '12%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: times,
                    axisLabel: {
                        rotate: 45,
                        fontSize: 11
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'æ¶¨è·Œå¹… (%)',
                    axisLabel: {
                        formatter: '{value}%'
                    },
                    splitLine: {
                        lineStyle: {
                            type: 'dashed'
                        }
                    }
                },
                series: series
            };
            
            trendChart.setOption(option, true);
        }

        // æ›´æ–°æ•°æ®è¡¨
        function updateDataTable(dataArray) {
            const tbody = document.getElementById('tableBody');
            let html = '';
            
            dataArray.forEach(record => {
                const time = record.collect_time;
                const coins = record.coins;
                
                // è®¡ç®—27å¸ç›¸åŠ çš„å’Œ
                let totalSum = 0;
                Object.values(coins).forEach(data => {
                    totalSum += data.change_pct;
                });
                
                // æŒ‰æ¶¨è·Œå¹…æ’åº
                const sortedCoins = Object.entries(coins).sort((a, b) => b[1].change_pct - a[1].change_pct);
                
                sortedCoins.forEach(([symbol, data], index) => {
                    const changePct = data.change_pct;
                    const changeClass = changePct >= 0 ? 'positive' : 'negative';
                    const changeSymbol = changePct >= 0 ? '+' : '';
                    
                    // ç¬¬ä¸€è¡Œæ˜¾ç¤ºæ—¶é—´å’Œ27å¸ç›¸åŠ çš„å’Œï¼Œåç»­è¡Œä¸æ˜¾ç¤º
                    const timeCell = index === 0 ? `<td rowspan="${sortedCoins.length}" style="vertical-align: middle; font-weight: 600;">${time}</td>` : '';
                    const sumClass = totalSum >= 0 ? 'positive' : 'negative';
                    const sumSymbol = totalSum >= 0 ? '+' : '';
                    const sumCell = index === 0 ? `<td rowspan="${sortedCoins.length}" style="vertical-align: middle; font-weight: 600; background: ${totalSum >= 0 ? '#f0fdf4' : '#fef2f2'};" class="${sumClass}"><strong>${sumSymbol}${totalSum.toFixed(2)}%</strong></td>` : '';
                    
                    html += `
                        <tr>
                            ${timeCell}
                            <td><span class="coin-label">${symbol}</span></td>
                            <td>$${data.base_price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}</td>
                            <td>$${data.current_price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}</td>
                            <td class="${changeClass}">${changeSymbol}${changePct.toFixed(2)}%</td>
                            ${sumCell}
                        </tr>
                    `;
                });
            });
            
            tbody.innerHTML = html;
        }

        // å¯¼å‡ºCSV
        function exportToCSV() {
            if (currentData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }

            let csv = 'æ—¶é—´,å¸ç§,åŸºå‡†ä»·æ ¼,å½“å‰ä»·æ ¼,æ¶¨è·Œå¹…,27å¸ç›¸åŠ çš„å’Œ\n';
            
            currentData.forEach(record => {
                const time = record.collect_time;
                
                // è®¡ç®—27å¸ç›¸åŠ çš„å’Œ
                let totalSum = 0;
                Object.values(record.coins).forEach(data => {
                    totalSum += data.change_pct;
                });
                
                Object.entries(record.coins).forEach(([symbol, data], index) => {
                    // åªåœ¨ç¬¬ä¸€è¡Œæ˜¾ç¤ºtotalSumï¼Œå…¶ä»–è¡Œç•™ç©º
                    const sumValue = index === 0 ? totalSum.toFixed(2) : '';
                    csv += `${time},${symbol},${data.base_price},${data.current_price},${data.change_pct},${sumValue}\n`;
                });
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `coin_prices_${document.getElementById('dateSelect').value}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–...');
            initChart();
            initDateSelector();
            // è‡ªåŠ¨åŠ è½½ä»Šå¤©çš„æ•°æ®
            setTimeout(loadDateData, 500);
        };

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´å›¾è¡¨
        window.onresize = function() {
            if (trendChart) {
                trendChart.resize();
            }
        };
    </script>
</body>
</html>
