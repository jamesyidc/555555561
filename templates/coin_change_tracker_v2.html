<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>27å¸æ¶¨è·Œå¹…è¿½è¸ªç³»ç»Ÿ v3.0 - å…¨æ–°æµ‹è¯•ç‰ˆ</title>
    <!-- ç‰ˆæœ¬: 2026-02-09 - ç‹¬ç«‹æµ‹è¯•ç‰ˆæœ¬ï¼Œå®Œæ•´åŠŸèƒ½å¤åˆ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-lg mb-6">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="/" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-200 shadow-md hover:shadow-lg">
                        <i class="fas fa-home mr-2"></i>
                        è¿”å›é¦–é¡µ
                    </a>
                    <h1 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                        27å¸æ¶¨è·Œå¹…è¿½è¸ªç³»ç»Ÿ
                    </h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">
                        <i class="far fa-clock mr-1"></i>
                        1åˆ†é’Ÿå‘¨æœŸ
                    </span>
                    <span class="text-sm text-gray-600">
                        <i class="fas fa-sync-alt mr-1"></i>
                        æ¯å¤©0ç‚¹é‡ç½®
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4">
        <!-- é¢„è­¦è®¾ç½®é¢æ¿ -->
        <div class="bg-gradient-to-r from-orange-50 to-red-50 rounded-lg shadow-lg p-6 mb-6 border-2 border-orange-200">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-bell text-orange-600 mr-2"></i>
                    æ¶¨è·Œé¢„è­¦è®¾ç½®
                </h2>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-600">é¢„è­¦çŠ¶æ€:</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="alertEnabled" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-orange-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-600"></div>
                    </label>
                    <span id="alertStatus" class="text-sm font-medium text-orange-600">å·²å¼€å¯</span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- ä¸Šæ¶¨é¢„è­¦ -->
                <div class="bg-white rounded-lg p-4 border-2 border-green-200">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-green-600 flex items-center">
                            <i class="fas fa-arrow-up mr-2"></i>
                            ä¸Šæ¶¨é¢„è­¦
                        </h3>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="upAlertEnabled" class="sr-only peer" checked>
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                è§¦å‘é˜ˆå€¼ (%)
                            </label>
                            <input type="number" id="upThreshold" step="0.1" min="0" max="100"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="åŠ è½½ä¸­...">
                        </div>
                        <div class="text-xs text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>
                            å½“ä»»æ„å¸ç§æ¶¨å¹…å¤§äºæ­¤å€¼æ—¶è§¦å‘é¢„è­¦
                        </div>
                    </div>
                </div>
                
                <!-- ä¸‹è·Œé¢„è­¦ -->
                <div class="bg-white rounded-lg p-4 border-2 border-red-200">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-red-600 flex items-center">
                            <i class="fas fa-arrow-down mr-2"></i>
                            ä¸‹è·Œé¢„è­¦
                        </h3>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="downAlertEnabled" class="sr-only peer" checked>
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600"></div>
                        </label>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                è§¦å‘é˜ˆå€¼ (%)
                            </label>
                            <input type="number" id="downThreshold" step="0.1" max="0" min="-100"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="åŠ è½½ä¸­...">
                        </div>
                        <div class="text-xs text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>
                            å½“ä»»æ„å¸ç§è·Œå¹…å°äºæ­¤å€¼æ—¶è§¦å‘é¢„è­¦
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Telegramè®¾ç½® -->
            <div class="mt-4 bg-white rounded-lg p-4 border-2 border-blue-200">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-blue-600 flex items-center">
                        <i class="fab fa-telegram text-blue-500 mr-2"></i>
                        Telegramé€šçŸ¥
                    </h3>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="tgEnabled" class="sr-only peer">
                        <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                <div class="text-xs text-gray-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    å¼€å¯åå°†é€šè¿‡Telegramå‘é€é¢„è­¦é€šçŸ¥ï¼ˆéœ€è¦åç«¯é…ç½®ï¼‰
                </div>
            </div>
            
            <!-- ä¿å­˜æŒ‰é’® -->
            <div class="mt-4 flex justify-end space-x-3">
                <button id="saveAlertSettings" class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-bold rounded-lg shadow-lg hover:from-green-600 hover:to-green-700 transform hover:scale-105 transition-all duration-200 flex items-center">
                    <i class="fas fa-save mr-2"></i>
                    ä¿å­˜é¢„è­¦è®¾ç½®
                </button>
                <button id="resetAlertSettings" class="px-6 py-3 bg-gradient-to-r from-gray-400 to-gray-500 text-white font-bold rounded-lg shadow-lg hover:from-gray-500 hover:to-gray-600 transform hover:scale-105 transition-all duration-200 flex items-center">
                    <i class="fas fa-undo mr-2"></i>
                    æ¢å¤é»˜è®¤
                </button>
            </div>
            
            <!-- ä¿å­˜æˆåŠŸæç¤º -->
            <div id="saveSuccess" class="mt-4 hidden">
                <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                        <span class="font-medium text-green-800">é¢„è­¦è®¾ç½®å·²ä¿å­˜ï¼</span>
                    </div>
                </div>
            </div>
            
            <!-- é¢„è­¦æ—¥å¿— -->
            <div id="alertLog" class="mt-4 hidden">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                        <span class="font-medium text-yellow-800" id="alertMessage"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å®æ—¶æ•°æ®å¡ç‰‡ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <!-- æ€»æ¶¨è·Œå¹… -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-600 font-medium">27å¸æ¶¨è·Œå¹…ä¹‹å’Œ</span>
                    <i class="fas fa-percentage text-blue-600"></i>
                </div>
                <div id="totalChange" class="text-3xl font-bold text-gray-800">--</div>
                <div class="text-sm text-gray-500 mt-2">
                    <i class="far fa-clock mr-1"></i>
                    <span id="updateTime">--</span>
                </div>
            </div>

            <!-- æœ‰æ•ˆå¸ç§æ•° -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-600 font-medium">æœ‰æ•ˆå¸ç§æ•°</span>
                    <i class="fas fa-coins text-green-600"></i>
                </div>
                <div id="validCount" class="text-3xl font-bold text-gray-800">--</div>
                <div class="text-sm text-gray-500 mt-2">
                    å…± 27 ä¸ªå¸ç§
                </div>
            </div>

            <!-- åŸºå‡†ä»·æ—¶é—´ -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-600 font-medium">åŸºå‡†ä»·æ—¶é—´</span>
                    <i class="fas fa-calendar-alt text-purple-600"></i>
                </div>
                <div id="baselineDate" class="text-2xl font-bold text-gray-800">--</div>
                <div class="text-sm text-gray-500 mt-2">
                    æ¯å¤©0ç‚¹é‡ç½®
                </div>
            </div>
        </div>



        <!-- å›¾è¡¨åŒºåŸŸ - è¶‹åŠ¿å›¾ç‹¬å ä¸€è¡Œï¼Œæ”¾å¤§2å€ -->
        <div class="grid grid-cols-1 gap-6 mb-6">
            <!-- æ€»æ¶¨è·Œå¹…è¶‹åŠ¿å›¾ - æ”¾å¤§2å€ -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">
                        <i class="fas fa-chart-area text-blue-600 mr-2"></i>
                        æ€»æ¶¨è·Œå¹…è¶‹åŠ¿
                        <span class="text-sm font-normal text-gray-500 ml-2">
                            <i class="fas fa-arrow-up text-red-500"></i> æœ€é«˜ä»·
                            <i class="fas fa-arrow-down text-green-500 ml-3"></i> æœ€ä½ä»·
                        </span>
                    </h2>
                    <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
                    <div class="flex items-center space-x-3">
                        <button id="prevDay" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all duration-200 shadow-md hover:shadow-lg">
                            <i class="fas fa-chevron-left mr-1"></i> å‰ä¸€å¤©
                        </button>
                        <input type="date" id="dateSelector" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button id="nextDay" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all duration-200 shadow-md hover:shadow-lg">
                            åä¸€å¤© <i class="fas fa-chevron-right ml-1"></i>
                        </button>
                        <button id="todayBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all duration-200 shadow-md hover:shadow-lg">
                            <i class="fas fa-calendar-day mr-1"></i> ä»Šå¤©
                        </button>
                    </div>
                </div>
                <div class="mb-3 flex flex-wrap gap-3 text-sm">
                    <span class="inline-flex items-center">
                        <span class="inline-block w-8 h-0.5 bg-red-600 mr-1" style="border-top: 2px dashed;"></span>
                        <span class="text-red-600 font-semibold">+180%</span>
                    </span>
                    <span class="inline-flex items-center">
                        <span class="inline-block w-8 h-0.5 bg-amber-500 mr-1" style="border-top: 2px dashed;"></span>
                        <span class="text-amber-500 font-semibold">+90%</span>
                    </span>
                    <span class="inline-flex items-center">
                        <span class="inline-block w-8 h-0.5 bg-blue-500 mr-1" style="border-top: 2px dashed;"></span>
                        <span class="text-blue-500 font-semibold">-90%</span>
                    </span>
                    <span class="inline-flex items-center">
                        <span class="inline-block w-8 h-0.5 bg-purple-600 mr-1" style="border-top: 2px dashed;"></span>
                        <span class="text-purple-600 font-semibold">-180%</span>
                    </span>
                </div>
                <div id="trendChart" style="height: 800px;"></div>
            </div>
        </div>

        <!-- ç­–ç•¥ç­›é€‰å™¨ -->
        <div class="grid grid-cols-1 gap-6 mb-6">
            <!-- æµé€šç›˜6åç­–ç•¥ -->
            <div class="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-lg shadow-lg p-6 border-2 border-indigo-200">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-bolt text-yellow-500 mr-2"></i>
                    æµé€šç›˜6åç­–ç•¥
                    <span class="ml-3 text-sm font-normal text-gray-600">ç‚¹å‡»æŒ‰é’®å¿«é€Ÿç­›é€‰ç­–ç•¥</span>
                </h2>
                
                <!-- ç­–ç•¥æŒ‰é’®ç½‘æ ¼ -->
                <div class="grid grid-cols-4 gap-3 mb-4">
                    <!-- å‰8 1.5% 10å€åšç©º -->
                    <button onclick="applyStrategy('top8', 1.5, 10, 'short')" 
                            class="strategy-btn bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-base">ğŸ“‰ å‰8åšç©º</span>
                            <i class="fas fa-arrow-down text-lg"></i>
                        </div>
                        <div class="text-xs opacity-90">æ¶¨å¹…å: 1.5% â€¢ 10x</div>
                        <div class="text-xs opacity-75 mt-1">æ¶¨å¹…å‰8å å¼€ç©ºå•</div>
                    </button>

                    <!-- å‰8 1.5% 10å€åšå¤š -->
                    <button onclick="applyStrategy('top8', 1.5, 10, 'long')" 
                            class="strategy-btn bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-base">ğŸ“ˆ å‰8åšå¤š</span>
                            <i class="fas fa-arrow-up text-lg"></i>
                        </div>
                        <div class="text-xs opacity-90">æ¶¨å¹…å: 1.5% â€¢ 10x</div>
                        <div class="text-xs opacity-75 mt-1">æ¶¨å¹…å‰8å å¼€å¤šå•</div>
                    </button>

                    <!-- å8 1.5% 10å€åšå¤š -->
                    <button onclick="applyStrategy('bottom8', 1.5, 10, 'long')" 
                            class="strategy-btn bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-base">ğŸ“ˆ å8åšå¤š</span>
                            <i class="fas fa-arrow-up text-lg"></i>
                        </div>
                        <div class="text-xs opacity-90">è·Œå¹…å: 1.5% â€¢ 10x</div>
                        <div class="text-xs opacity-75 mt-1">è·Œå¹…å8å å¼€å¤šå•</div>
                    </button>

                    <!-- å8 1.5% 10å€åšç©º -->
                    <button onclick="applyStrategy('bottom8', 1.5, 10, 'short')" 
                            class="strategy-btn bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-base">ğŸ“‰ å8åšç©º</span>
                            <i class="fas fa-arrow-down text-lg"></i>
                        </div>
                        <div class="text-xs opacity-90">è·Œå¹…å: 1.5% â€¢ 10x</div>
                        <div class="text-xs opacity-75 mt-1">è·Œå¹…å8å å¼€ç©ºå•</div>
                    </button>
                </div>

                <!-- ç­–ç•¥è¯´æ˜ -->
                <div class="bg-white rounded-lg p-4 border border-indigo-200">
                    <h3 class="font-semibold text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-info-circle text-indigo-600 mr-2"></i>
                        ç­–ç•¥è¯´æ˜:
                    </h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>â€¢ <strong>å‰8</strong>: åœ¨æµé€šç›˜ä¸­é€‰æ¶¨å¹…å‰8åçš„å¸ç§</li>
                        <li>â€¢ <strong>å8</strong>: åœ¨æµé€šç›˜ä¸­é€‰è·Œå¹…å8åçš„å¸ç§ï¼ˆå³è·Œå¹…æœ€å¤§çš„8ä¸ªï¼‰</li>
                        <li>â€¢ <strong>æ¶¨å¹…å</strong>: ç­‰å¾…å¸ç§åœ¨å½“å‰ä»·æ ¼åŸºç¡€ä¸Šå†æ¶¨1.5%åå¼€ä»“</li>
                        <li>â€¢ <strong>è·Œå¹…å</strong>: ç­‰å¾…å¸ç§åœ¨å½“å‰ä»·æ ¼åŸºç¡€ä¸Šå†è·Œ1.5%åå¼€ä»“</li>
                        <li>â€¢ <strong>10x</strong>: ä½¿ç”¨10å€æ æ†è¿›è¡Œäº¤æ˜“</li>
                        <li>â€¢ <strong>åšå¤š/åšç©º</strong>: é€‰æ‹©å¼€å¤šå•æˆ–ç©ºå•çš„æ–¹å‘</li>
                    </ul>
                </div>

                <!-- å½“å‰ç­–ç•¥æ˜¾ç¤º -->
                <div id="currentStrategy" class="mt-4 hidden bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-4 border-2 border-yellow-400">
                    <div class="flex items-start">
                        <i class="fas fa-check-circle text-yellow-600 text-2xl mr-3 mt-1"></i>
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 mb-2">å½“å‰é€‰æ‹©çš„ç­–ç•¥:</h4>
                            <div id="strategyDetails" class="text-sm text-gray-700"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ’è¡Œæ¦œ -->
        <div class="grid grid-cols-1 gap-6 mb-6">
            <!-- å•å¸æ¶¨è·Œå¹…æ’è¡Œ -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">
                    <i class="fas fa-trophy text-yellow-600 mr-2"></i>
                    å•å¸æ¶¨è·Œå¹…æ’è¡Œï¼ˆå®æ—¶ï¼‰
                </h2>
                <div id="rankChart" style="height: 800px;"></div>
            </div>
        </div>

        <!-- è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">
                <i class="fas fa-table text-green-600 mr-2"></i>
                è¯¦ç»†æ•°æ®ï¼ˆ27ä¸ªå¸ç§ï¼‰
            </h2>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¸ç§</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åŸºå‡†ä»·</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å½“å‰ä»·</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ¶¨è·Œå¹…</th>
                        </tr>
                    </thead>
                    <tbody id="detailTable" class="bg-white divide-y divide-gray-200">
                        <!-- æ•°æ®å°†åœ¨è¿™é‡Œå¡«å…… -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // å›¾è¡¨å®ä¾‹
        let trendChart = null;
        let rankChart = null;
        
        // å†å²æ•°æ®ï¼ˆç”¨äºè¶‹åŠ¿å›¾ï¼‰
        let historyData = [];
        
        // å½“å‰é€‰æ‹©çš„æ—¥æœŸ
        let currentDate = new Date();
        
        // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // è§£ææ—¥æœŸå­—ç¬¦ä¸²
        function parseDate(dateStr) {
            return new Date(dateStr + 'T00:00:00');
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            trendChart = echarts.init(document.getElementById('trendChart'));
            rankChart = echarts.init(document.getElementById('rankChart'));
            
            // è¶‹åŠ¿å›¾é…ç½®
            trendChart.setOption({
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        label: {
                            backgroundColor: '#6a7985'
                        }
                    },
                    formatter: function(params) {
                        const p = params[0];
                        const time = p.axisValue;
                        const value = p.value;
                        
                        return `
                            <div style="padding: 8px; min-width: 180px;">
                                <div style="font-weight: bold; margin-bottom: 8px; font-size: 14px;">
                                    <i class="far fa-clock" style="margin-right: 4px;"></i>${time}
                                </div>
                                <div style="margin-bottom: 4px;">
                                    ${p.marker}<span style="font-weight: 600;">${p.seriesName}</span>
                                </div>
                                <div style="font-size: 16px; font-weight: bold; color: ${value > 0 ? '#10B981' : value < 0 ? '#EF4444' : '#6B7280'};">
                                    ${value > 0 ? '+' : ''}${value}%
                                </div>
                            </div>
                        `;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: []
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: '{value}%'
                    }
                },
                series: [{
                    name: '27å¸æ¶¨è·Œå¹…ä¹‹å’Œ',
                    type: 'line',
                    smooth: true,
                    data: [],
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0, y: 0, x2: 0, y2: 1,
                            colorStops: [
                                { offset: 0, color: 'rgba(59, 130, 246, 0.5)' },
                                { offset: 1, color: 'rgba(59, 130, 246, 0.1)' }
                            ]
                        }
                    },
                    lineStyle: {
                        color: '#3B82F6',
                        width: 2
                    }
                }]
            });
        }
        
        // æ›´æ–°å®æ—¶æ•°æ®
        async function updateLatestData() {
            try {
                const response = await fetch('/api/coin-change-tracker/latest');
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    
                    // ä¿å­˜å½“å‰æ•°æ®åˆ°å…¨å±€å˜é‡ï¼ˆä¾›ç­–ç•¥ä½¿ç”¨ï¼‰
                    window.currentCoinsData = data.changes;
                    
                    // æ›´æ–°å¡ç‰‡æ•°æ®
                    const totalChange = data.total_change;
                    const totalChangeEl = document.getElementById('totalChange');
                    totalChangeEl.textContent = `${totalChange > 0 ? '+' : ''}${totalChange.toFixed(2)}%`;
                    totalChangeEl.className = `text-3xl font-bold ${totalChange > 0 ? 'text-green-600' : totalChange < 0 ? 'text-red-600' : 'text-gray-800'}`;
                    
                    document.getElementById('validCount').textContent = `${data.valid_count}/27`;
                    document.getElementById('updateTime').textContent = data.time;
                    document.getElementById('baselineDate').textContent = data.baseline_date;
                    
                    // æ›´æ–°å•å¸æ’è¡Œæ¦œ
                    updateRankChart(data.changes);
                    
                    // æ›´æ–°è¯¦ç»†è¡¨æ ¼
                    updateDetailTable(data.changes);
                    
                } else {
                    console.error('è·å–æ•°æ®å¤±è´¥:', result.error);
                }
            } catch (error) {
                console.error('æ›´æ–°æ•°æ®å¼‚å¸¸:', error);
            }
        }
        
        // æ›´æ–°å†å²è¶‹åŠ¿ï¼ˆæ”¯æŒæŒ‡å®šæ—¥æœŸï¼‰
        async function updateHistoryData(date = null) {
            try {
                // å¦‚æœæŒ‡å®šäº†æ—¥æœŸï¼Œåˆ™æŸ¥è¯¢ç‰¹å®šæ—¥æœŸçš„æ•°æ®
                let url = '/api/coin-change-tracker/history?limit=1440';
                if (date) {
                    url += `&date=${formatDate(date)}`;
                }
                
                console.log('Fetching history data from:', url);
                
                const response = await fetch(url);
                const result = await response.json();
                
                console.log('History data result:', result);
                console.log('Fetched URL:', url);
                console.log('Data count:', result.data ? result.data.length : 0);
                
                if (result.success && result.data && result.data.length > 0) {
                    historyData = result.data;
                    
                    // æå–æ—¶é—´å’Œæ€»æ¶¨è·Œå¹…
                    const times = historyData.map(d => d.time);
                    const changes = historyData.map(d => d.total_change);
                    
                    console.log('Times count:', times.length, 'Changes count:', changes.length);
                    
                    // æ‰¾å‡ºæœ€é«˜ä»·å’Œæœ€ä½ä»·
                    const maxChange = Math.max(...changes);
                    const minChange = Math.min(...changes);
                    const maxIndex = changes.indexOf(maxChange);
                    const minIndex = changes.indexOf(minChange);
                    
                    // æ›´æ–°è¶‹åŠ¿å›¾ï¼Œæ·»åŠ æœ€é«˜ä»·å’Œæœ€ä½ä»·æ ‡è®°
                    // ä½¿ç”¨ notMerge: true å¼ºåˆ¶é‡æ–°æ¸²æŸ“æ•´ä¸ªå›¾è¡¨
                    trendChart.setOption({
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'cross',
                                label: {
                                    backgroundColor: '#6a7985'
                                }
                            },
                            formatter: function(params) {
                                const p = params[0];
                                const time = p.axisValue;
                                const value = p.value;
                                
                                return `
                                    <div style="padding: 8px; min-width: 180px;">
                                        <div style="font-weight: bold; margin-bottom: 8px; font-size: 14px;">
                                            <i class="far fa-clock" style="margin-right: 4px;"></i>${time}
                                        </div>
                                        <div style="margin-bottom: 4px;">
                                            ${p.marker}<span style="font-weight: 600;">${p.seriesName}</span>
                                        </div>
                                        <div style="font-size: 16px; font-weight: bold; color: ${value > 0 ? '#10B981' : value < 0 ? '#EF4444' : '#6B7280'};">
                                            ${value > 0 ? '+' : ''}${value}%
                                        </div>
                                    </div>
                                `;
                            }
                        },
                        xAxis: { 
                            type: 'category',
                            boundaryGap: false,
                            data: times 
                        },
                        yAxis: {
                            type: 'value',
                            axisLabel: {
                                formatter: '{value}%'
                            }
                        },
                        series: [{
                            name: '27å¸æ¶¨è·Œå¹…ä¹‹å’Œ',
                            type: 'line',
                            smooth: true,
                            data: changes,
                            areaStyle: {
                                color: {
                                    type: 'linear',
                                    x: 0,
                                    y: 0,
                                    x2: 0,
                                    y2: 1,
                                    colorStops: [
                                        { offset: 0, color: 'rgba(59, 130, 246, 0.3)' },
                                        { offset: 1, color: 'rgba(59, 130, 246, 0.05)' }
                                    ]
                                }
                            },
                            markPoint: {
                                data: [
                                    {
                                        name: 'æœ€é«˜ä»·',
                                        value: maxChange.toFixed(2) + '%',
                                        xAxis: maxIndex,
                                        yAxis: maxChange,
                                        itemStyle: {
                                            color: '#EF4444'
                                        },
                                        label: {
                                            formatter: '{b}\n{c}',
                                            fontSize: 14,
                                            fontWeight: 'bold'
                                        }
                                    },
                                    {
                                        name: 'æœ€ä½ä»·',
                                        value: minChange.toFixed(2) + '%',
                                        xAxis: minIndex,
                                        yAxis: minChange,
                                        itemStyle: {
                                            color: '#10B981'
                                        },
                                        label: {
                                            formatter: '{b}\n{c}',
                                            fontSize: 14,
                                            fontWeight: 'bold'
                                        }
                                    }
                                ],
                                symbol: 'pin',
                                symbolSize: 60
                            },
                            markLine: {
                                silent: false,
                                symbol: 'none',
                                data: [
                                    // å…³é”®æ”¯æ’‘çº¿ +300%
                                    {
                                        yAxis: 300,
                                        name: '+300%',
                                        label: {
                                            formatter: '{b}',
                                            position: 'end',
                                            fontSize: 12,
                                            fontWeight: 'bold',
                                            color: '#EF4444'
                                        },
                                        lineStyle: {
                                            color: '#EF4444',
                                            width: 2,
                                            type: 'dashed'
                                        }
                                    },
                                    // å…³é”®æ”¯æ’‘çº¿ +180%
                                    {
                                        yAxis: 180,
                                        name: '+180%',
                                        label: {
                                            formatter: '{b}',
                                            position: 'end',
                                            fontSize: 12,
                                            fontWeight: 'bold',
                                            color: '#DC2626'
                                        },
                                        lineStyle: {
                                            color: '#DC2626',
                                            width: 2,
                                            type: 'dashed'
                                        }
                                    },
                                    // å…³é”®æ”¯æ’‘çº¿ +90%
                                    {
                                        yAxis: 90,
                                        name: '+90%',
                                        label: {
                                            formatter: '{b}',
                                            position: 'end',
                                            fontSize: 12,
                                            fontWeight: 'bold',
                                            color: '#F59E0B'
                                        },
                                        lineStyle: {
                                            color: '#F59E0B',
                                            width: 2,
                                            type: 'dashed'
                                        }
                                    },
                                    // å…³é”®æ”¯æ’‘çº¿ -90%
                                    {
                                        yAxis: -90,
                                        name: '-90%',
                                        label: {
                                            formatter: '{b}',
                                            position: 'end',
                                            fontSize: 12,
                                            fontWeight: 'bold',
                                            color: '#3B82F6'
                                        },
                                        lineStyle: {
                                            color: '#3B82F6',
                                            width: 2,
                                            type: 'dashed'
                                        }
                                    },
                                    // å…³é”®æ”¯æ’‘çº¿ -180%
                                    {
                                        yAxis: -180,
                                        name: '-180%',
                                        label: {
                                            formatter: '{b}',
                                            position: 'end',
                                            fontSize: 12,
                                            fontWeight: 'bold',
                                            color: '#7C3AED'
                                        },
                                        lineStyle: {
                                            color: '#7C3AED',
                                            width: 2,
                                            type: 'dashed'
                                        }
                                    },
                                    // å…³é”®æ”¯æ’‘çº¿ -300%
                                    {
                                        yAxis: -300,
                                        name: '-300%',
                                        label: {
                                            formatter: '{b}',
                                            position: 'end',
                                            fontSize: 12,
                                            fontWeight: 'bold',
                                            color: '#10B981'
                                        },
                                        lineStyle: {
                                            color: '#10B981',
                                            width: 2,
                                            type: 'dashed'
                                        }
                                    }
                                ]
                            }
                        }]
                    }, true, true); // notMerge=true, lazyUpdate=true
                    
                    // å¼ºåˆ¶resizeå›¾è¡¨ç¡®ä¿æ­£ç¡®æ˜¾ç¤º
                    setTimeout(() => {
                        trendChart.resize();
                        console.log('âœ… è¶‹åŠ¿å›¾å·²æ¸²æŸ“ï¼Œæ•°æ®ç‚¹æ•°:', changes.length);
                    }, 100);
                } else {
                    console.warn('å†å²æ•°æ®ä¸ºç©ºæˆ–åŠ è½½å¤±è´¥');
                    console.warn('Result:', result);
                    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ¸…ç©ºå›¾è¡¨
                    trendChart.setOption({
                        xAxis: { data: [] },
                        series: [{ data: [] }]
                    }, true, true); // notMerge=true, lazyUpdate=true
                }
            } catch (error) {
                console.error('æ›´æ–°å†å²æ•°æ®å¼‚å¸¸:', error);
            }
        }
        
        // æ›´æ–°æ’è¡Œæ¦œå›¾è¡¨
        function updateRankChart(changes) {
            const validChanges = Object.entries(changes).filter(([_, v]) => !v.error);
            validChanges.sort((a, b) => b[1].change_pct - a[1].change_pct);
            
            const coins = validChanges.map(([k, _]) => k.replace('-USDT-SWAP', ''));
            const values = validChanges.map(([_, v]) => v.change_pct);
            
            rankChart.setOption({
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: function(params) {
                        const p = params[0];
                        const value = p.value;
                        const coin = p.axisValue;
                        
                        return `
                            <div style="padding: 8px; min-width: 150px;">
                                <div style="font-weight: bold; margin-bottom: 8px; font-size: 14px;">
                                    ${coin}
                                </div>
                                <div style="margin-bottom: 4px;">
                                    ${p.marker}<span style="font-weight: 600;">æ¶¨è·Œå¹…</span>
                                </div>
                                <div style="font-size: 16px; font-weight: bold; color: ${value > 0 ? '#10B981' : value < 0 ? '#EF4444' : '#6B7280'};">
                                    ${value > 0 ? '+' : ''}${value}%
                                </div>
                            </div>
                        `;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: '{value}%'
                    }
                },
                yAxis: {
                    type: 'category',
                    data: coins,
                    inverse: true
                },
                series: [{
                    type: 'bar',
                    data: values.map(v => ({
                        value: v,
                        itemStyle: {
                            color: v > 0 ? '#10B981' : v < 0 ? '#EF4444' : '#6B7280'
                        }
                    }))
                }]
            });
            
            // å¼ºåˆ¶resizeå›¾è¡¨ç¡®ä¿æ­£ç¡®æ˜¾ç¤º
            setTimeout(() => {
                rankChart.resize();
                console.log('âœ… æ’è¡Œæ¦œå›¾å·²æ¸²æŸ“ï¼Œå¸ç§æ•°:', coins.length);
            }, 100);
        }
        
        // æ›´æ–°è¯¦ç»†è¡¨æ ¼
        function updateDetailTable(changes) {
            const tbody = document.getElementById('detailTable');
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            const changesArray = Object.entries(changes)
                .filter(([_, v]) => !v.error)
                .sort((a, b) => b[1].change_pct - a[1].change_pct);
            
            tbody.innerHTML = changesArray.map(([symbol, data]) => {
                const coin = symbol.replace('-USDT-SWAP', '');
                const changePct = data.change_pct;
                const changeClass = changePct > 0 ? 'text-green-600' : changePct < 0 ? 'text-red-600' : 'text-gray-600';
                const changePrefix = changePct > 0 ? '+' : '';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap font-medium">${coin}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-600">$${data.baseline_price.toFixed(4)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-600">$${data.current_price.toFixed(4)}</td>
                        <td class="px-6 py-4 whitespace-nowrap ${changeClass} font-bold">${changePrefix}${changePct.toFixed(2)}%</td>
                    </tr>
                `;
            }).join('');
        }
        
        // æ›´æ–°æ—¥æœŸé€‰æ‹©å™¨å’ŒæŒ‰é’®çŠ¶æ€
        function updateDateSelector() {
            const dateInput = document.getElementById('dateSelector');
            dateInput.value = formatDate(currentDate);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©
            const isToday = formatDate(currentDate) === formatDate(new Date());
            const nextDayBtn = document.getElementById('nextDay');
            const todayBtn = document.getElementById('todayBtn');
            
            // å¦‚æœæ˜¯ä»Šå¤©ï¼Œç¦ç”¨"åä¸€å¤©"æŒ‰é’®
            if (isToday) {
                nextDayBtn.disabled = true;
                nextDayBtn.classList.add('opacity-50', 'cursor-not-allowed');
                todayBtn.disabled = true;
                todayBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                nextDayBtn.disabled = false;
                nextDayBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                todayBtn.disabled = false;
                todayBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        // åˆ‡æ¢åˆ°å‰ä¸€å¤©
        function goToPrevDay() {
            currentDate.setDate(currentDate.getDate() - 1);
            updateDateSelector();
            updateHistoryData(currentDate);
        }
        
        // åˆ‡æ¢åˆ°åä¸€å¤©
        function goToNextDay() {
            const today = new Date();
            const nextDay = new Date(currentDate);
            nextDay.setDate(nextDay.getDate() + 1);
            
            // ä¸èƒ½è¶…è¿‡ä»Šå¤©
            if (formatDate(nextDay) <= formatDate(today)) {
                currentDate = nextDay;
                updateDateSelector();
                updateHistoryData(currentDate);
            }
        }
        
        // åˆ‡æ¢åˆ°ä»Šå¤©
        function goToToday() {
            currentDate = new Date();
            updateDateSelector();
            updateLatestData();
            updateHistoryData();
        }
        
        // æ‰‹åŠ¨é€‰æ‹©æ—¥æœŸ
        function onDateChange(e) {
            const selectedDate = parseDate(e.target.value);
            const today = new Date();
            
            // ä¸èƒ½é€‰æ‹©æœªæ¥çš„æ—¥æœŸ
            if (selectedDate <= today) {
                currentDate = selectedDate;
                updateDateSelector();
                updateHistoryData(currentDate);
            } else {
                // æ¢å¤ä¸ºä»Šå¤©
                e.target.value = formatDate(currentDate);
                alert('ä¸èƒ½é€‰æ‹©æœªæ¥çš„æ—¥æœŸ');
            }
        }
        
        // åˆå§‹åŒ–
        window.onload = function() {
            initCharts();
            updateLatestData();
            updateHistoryData();
            updateDateSelector();
            
            // åŠ è½½è´¦æˆ·ä½™é¢ä¿¡æ¯ï¼ˆç”¨äºç­–ç•¥å¼€ä»“é‡‘é¢è®¡ç®—ï¼‰
            loadAccountsBalance().then(() => {
                console.log('âœ… è´¦æˆ·ä½™é¢ä¿¡æ¯å·²åŠ è½½ï¼Œå¯ä»¥ä½¿ç”¨ç­–ç•¥åŠŸèƒ½');
            }).catch(error => {
                console.error('âŒ è´¦æˆ·ä½™é¢åŠ è½½å¤±è´¥:', error);
            });
            
            // ç»‘å®šæ—¥æœŸé€‰æ‹©å™¨äº‹ä»¶
            document.getElementById('prevDay').addEventListener('click', goToPrevDay);
            document.getElementById('nextDay').addEventListener('click', goToNextDay);
            document.getElementById('todayBtn').addEventListener('click', goToToday);
            document.getElementById('dateSelector').addEventListener('change', onDateChange);
            
            // è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨çš„æœ€å¤§æ—¥æœŸä¸ºä»Šå¤©
            const today = formatDate(new Date());
            document.getElementById('dateSelector').max = today;
            
            // åªæœ‰åœ¨æŸ¥çœ‹ä»Šå¤©æ—¶æ‰è‡ªåŠ¨åˆ·æ–°
            let autoRefreshInterval = null;
            
            function startAutoRefresh() {
                // æ¯10ç§’æ›´æ–°å®æ—¶æ•°æ®
                autoRefreshInterval = setInterval(() => {
                    const isToday = formatDate(currentDate) === formatDate(new Date());
                    if (isToday) {
                        updateLatestData();
                        updateHistoryData();
                    }
                }, 10000);
            }
            
            startAutoRefresh();
            
            // æ¯å¤©0ç‚¹2åˆ†è‡ªåŠ¨åˆ·æ–°é¡µé¢ï¼ˆå¤„ç†è·¨æ—¥æœŸæ•°æ®ï¼‰
            function scheduleAutoPageRefresh() {
                // è·å–å½“å‰åŒ—äº¬æ—¶é—´
                const now = new Date();
                const beijingTime = new Date(now.toLocaleString('en-US', {timeZone: 'Asia/Shanghai'}));
                
                // è®¡ç®—ä¸‹ä¸€ä¸ª0ç‚¹2åˆ†ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
                const tomorrow = new Date(beijingTime);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 2, 0, 0); // è®¾ç½®ä¸ºæ˜å¤©0ç‚¹2åˆ†
                
                // è®¡ç®—å½“å‰æµè§ˆå™¨æœ¬åœ°æ—¶é—´åˆ°åŒ—äº¬æ—¶é—´0ç‚¹2åˆ†çš„æ—¶é—´å·®
                const timezoneOffset = now - beijingTime;
                const targetTime = new Date(tomorrow.getTime() + timezoneOffset);
                const timeUntilRefresh = targetTime - now;
                
                console.log(`ğŸ”„ é¡µé¢å°†åœ¨åŒ—äº¬æ—¶é—´ ${tomorrow.toLocaleString('zh-CN')} è‡ªåŠ¨åˆ·æ–°`);
                console.log(`â° è·ç¦»åˆ·æ–°è¿˜æœ‰ ${Math.floor(timeUntilRefresh / 1000 / 60)} åˆ†é’Ÿ (${Math.floor(timeUntilRefresh / 1000 / 60 / 60)} å°æ—¶)`);
                
                setTimeout(() => {
                    console.log('ğŸ”„ æ‰§è¡Œæ¯æ—¥0ç‚¹2åˆ†è‡ªåŠ¨åˆ·æ–°ï¼ˆå¤„ç†è·¨æ—¥æœŸæ•°æ®ï¼‰...');
                    location.reload();
                }, timeUntilRefresh);
            }
            
            // åŠ è½½æ‰€æœ‰è´¦æˆ·çš„ä½™é¢ä¿¡æ¯
            async function loadAccountsBalance() {
                try {
                    const accounts = JSON.parse(localStorage.getItem('okx_accounts') || '[]');
                    
                    if (accounts.length === 0) {
                        console.log('âš ï¸ æœªæ‰¾åˆ°è´¦æˆ·ä¿¡æ¯');
                        return [];
                    }
                    
                    console.log(`ğŸ”„ æ­£åœ¨åŠ è½½ ${accounts.length} ä¸ªè´¦æˆ·çš„ä½™é¢ä¿¡æ¯...`);
                    
                    // ä¸ºæ¯ä¸ªè´¦æˆ·è·å–ä½™é¢
                    for (let account of accounts) {
                        if (!account.apiKey || !account.apiSecret || !account.passphrase) {
                            console.log(`âš ï¸ è´¦æˆ· ${account.name} ç¼ºå°‘APIå‡­è¯ï¼Œè·³è¿‡`);
                            continue;
                        }
                        
                        try {
                            const response = await fetch('/api/okx-trading/account-balance', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    apiKey: account.apiKey,
                                    apiSecret: account.apiSecret,
                                    passphrase: account.passphrase
                                })
                            });
                            
                            const result = await response.json();
                            if (result.success) {
                                // ä½¿ç”¨ç°æœ‰APIçš„æ ¼å¼ï¼š{success, balance, currency, raw_data}
                                const availBal = result.balance || 0;
                                
                                // ä»raw_dataä¸­æå–è¯¦ç»†ä¿¡æ¯
                                let totalEq = availBal;
                                if (result.raw_data && result.raw_data.length > 0) {
                                    const details = result.raw_data[0].details || [];
                                    for (const detail of details) {
                                        if (detail.ccy === 'USDT') {
                                            totalEq = parseFloat(detail.eq || availBal);
                                            break;
                                        }
                                    }
                                }
                                
                                account.balance = {
                                    totalEquity: totalEq,
                                    availableBalance: availBal
                                };
                                console.log(`âœ… è´¦æˆ· ${account.name} ä½™é¢: ${account.balance.availableBalance} USDT`);
                            } else {
                                console.error(`âŒ è´¦æˆ· ${account.name} ä½™é¢è·å–å¤±è´¥:`, result.error);
                            }
                        } catch (error) {
                            console.error(`âŒ åŠ è½½è´¦æˆ· ${account.name} ä½™é¢å¤±è´¥:`, error);
                        }
                    }
                    
                    // ä¿å­˜æ›´æ–°åçš„è´¦æˆ·æ•°æ®åˆ°å…¨å±€å˜é‡
                    window.accountsWithBalance = accounts;
                    console.log('âœ… æ‰€æœ‰è´¦æˆ·ä½™é¢åŠ è½½å®Œæˆ');
                    return accounts;
                    
                } catch (error) {
                    console.error('âŒ åŠ è½½è´¦æˆ·ä½™é¢å¤±è´¥:', error);
                    return [];
                }
            }
            
            // ç­–ç•¥åº”ç”¨å‡½æ•°
            function applyStrategy(range, threshold, leverage, direction) {
                console.log(`ğŸ¯ åº”ç”¨ç­–ç•¥: ${range}, é˜ˆå€¼: ${threshold}%, æ æ†: ${leverage}x, æ–¹å‘: ${direction}`);
                
                // è·å–å½“å‰æ•°æ®
                if (!window.currentCoinsData || window.currentCoinsData.length === 0) {
                    alert('âŒ æš‚æ— æ•°æ®ï¼Œè¯·ç­‰å¾…æ•°æ®åŠ è½½å®Œæˆï¼');
                    return;
                }
                
                // æ’åºå¸ç§æ•°æ®ï¼ˆæŒ‰æ¶¨è·Œå¹…ï¼‰
                const sortedCoins = [...window.currentCoinsData].sort((a, b) => b.change - a.change);
                
                // é€‰æ‹©ç›®æ ‡å¸ç§
                let targetCoins = [];
                if (range === 'top8') {
                    // æ¶¨å¹…å‰8å
                    targetCoins = sortedCoins.slice(0, 8);
                } else if (range === 'bottom8') {
                    // è·Œå¹…å8åï¼ˆå³è·Œå¹…æœ€å¤§çš„8ä¸ªï¼‰
                    targetCoins = sortedCoins.slice(-8).reverse();
                }
                
                // æ˜¾ç¤ºç­–ç•¥è¯¦æƒ…
                const strategyDiv = document.getElementById('currentStrategy');
                const detailsDiv = document.getElementById('strategyDetails');
                
                const rangeText = range === 'top8' ? 'æ¶¨å¹…å‰8å' : 'è·Œå¹…å8åï¼ˆè·Œå¹…æœ€å¤§çš„8ä¸ªï¼‰';
                const directionText = direction === 'long' ? 'åšå¤šï¼ˆå¼€å¤šå•ï¼‰' : 'åšç©ºï¼ˆå¼€ç©ºå•ï¼‰';
                const thresholdText = range === 'top8' ? 'å†æ¶¨' : 'å†è·Œ';
                const directionIcon = direction === 'long' ? 'ğŸ“ˆ' : 'ğŸ“‰';
                const directionColor = direction === 'long' ? 'text-green-600' : 'text-red-600';
                
                let coinsListHTML = '<div class="mt-3 space-y-2">';
                targetCoins.forEach((coin, index) => {
                    const changeColor = coin.change >= 0 ? 'text-green-600' : 'text-red-600';
                    const changeSign = coin.change >= 0 ? '+' : '';
                    coinsListHTML += `
                        <div class="flex items-center justify-between p-2 bg-white rounded border border-gray-200">
                            <span class="font-semibold">${index + 1}. ${coin.symbol}</span>
                            <span class="${changeColor} font-bold">${changeSign}${coin.change.toFixed(2)}%</span>
                        </div>
                    `;
                });
                coinsListHTML += '</div>';
                
                // ç”Ÿæˆè´¦æˆ·å¼€ä»“å»ºè®®HTML
                let accountsHTML = '';
                const accounts = window.accountsWithBalance || [];
                
                if (accounts.length === 0 || !accounts.some(a => a.balance)) {
                    accountsHTML = `
                        <div class="mt-4 p-3 bg-yellow-100 rounded border border-yellow-300">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                <span class="text-yellow-800 font-semibold">æœªåŠ è½½è´¦æˆ·ä½™é¢ä¿¡æ¯</span>
                            </div>
                            <p class="text-sm text-yellow-700 mt-1">
                                è¯·åˆ·æ–°é¡µé¢ä»¥åŠ è½½è´¦æˆ·ä½™é¢ï¼Œæˆ–å‰å¾€ 
                                <a href="/okx-trading" class="underline font-semibold hover:text-yellow-900">OKXäº¤æ˜“é¡µé¢</a> 
                                é…ç½®è´¦æˆ·APIå‡­è¯
                            </p>
                        </div>
                    `;
                } else {
                    accountsHTML = '<div class="mt-4">';
                    accountsHTML += '<h5 class="font-bold text-gray-800 mb-2 flex items-center">';
                    accountsHTML += '<i class="fas fa-wallet text-blue-600 mr-2"></i>';
                    accountsHTML += 'å„è´¦æˆ·å»ºè®®å¼€ä»“é‡‘é¢ï¼š</h5>';
                    accountsHTML += '<div class="space-y-2">';
                    
                    let totalSuggestedPosition = 0;
                    let accountsWithBalance = 0;
                    
                    accounts.forEach(account => {
                        if (account.balance && account.balance.availableBalance > 0) {
                            accountsWithBalance++;
                            const availBal = account.balance.availableBalance;
                            const positionSize = availBal * (threshold / 100);
                            const requiredMargin = positionSize / leverage;
                            
                            totalSuggestedPosition += positionSize;
                            
                            // æ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³
                            const isSufficient = requiredMargin <= availBal;
                            const statusIcon = isSufficient ? 'âœ…' : 'âš ï¸';
                            const borderColor = isSufficient ? 'border-blue-200' : 'border-orange-300';
                            const bgColor = isSufficient ? 'bg-blue-50' : 'bg-orange-50';
                            
                            accountsHTML += `
                                <div class="p-3 ${bgColor} rounded border ${borderColor}">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-semibold text-gray-800">${statusIcon} ${account.name}</span>
                                        <span class="text-xs text-gray-500">å¯ç”¨: ${availBal.toFixed(2)} USDT</span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <div>
                                            <span class="text-gray-600">å»ºè®®å¼€ä»“:</span>
                                            <span class="font-bold text-blue-700 ml-1">${positionSize.toFixed(2)} USDT</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-600">éœ€ä¿è¯é‡‘:</span>
                                            <span class="font-bold text-purple-700 ml-1">${requiredMargin.toFixed(2)} USDT</span>
                                        </div>
                                    </div>
                                    ${!isSufficient ? '<div class="mt-1 text-xs text-orange-700">âš ï¸ ä½™é¢å¯èƒ½ä¸è¶³ï¼Œè¯·æ³¨æ„é£é™©</div>' : ''}
                                </div>
                            `;
                        }
                    });
                    
                    accountsHTML += '</div>';
                    
                    // æ·»åŠ æ€»è®¡ä¿¡æ¯
                    if (accountsWithBalance > 0) {
                        accountsHTML += `
                            <div class="mt-3 p-2 bg-gradient-to-r from-blue-100 to-purple-100 rounded border border-blue-300">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="font-semibold text-gray-800">
                                        <i class="fas fa-calculator mr-1"></i>
                                        æ€»è®¡ (${accountsWithBalance}ä¸ªè´¦æˆ·)
                                    </span>
                                    <span class="font-bold text-blue-800">
                                        ${totalSuggestedPosition.toFixed(2)} USDT
                                    </span>
                                </div>
                            </div>
                        `;
                    }
                    
                    accountsHTML += '</div>';
                }
                
                detailsDiv.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex items-center space-x-2">
                            <span class="font-bold ${directionColor}">${directionIcon} ${directionText}</span>
                            <span class="text-gray-500">|</span>
                            <span>é€‰æ‹©èŒƒå›´: <strong>${rangeText}</strong></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span>è§¦å‘æ¡ä»¶: ç­‰å¾…${thresholdText} <strong class="text-orange-600">${threshold}%</strong> åå¼€ä»“</span>
                            <span class="text-gray-500">|</span>
                            <span>æ æ†: <strong class="text-purple-600">${leverage}x</strong></span>
                        </div>
                        <div class="mt-3">
                            <strong>é€‰ä¸­çš„å¸ç§ï¼ˆ${targetCoins.length}ä¸ªï¼‰:</strong>
                            ${coinsListHTML}
                        </div>
                        ${accountsHTML}
                        <div class="mt-3 p-3 bg-yellow-100 rounded border border-yellow-300">
                            <strong class="text-yellow-800">ğŸ“Œ ä¸‹ä¸€æ­¥æ“ä½œ:</strong>
                            <p class="text-sm text-yellow-700 mt-1">
                                è¯·å‰å¾€ <a href="/okx-trading" class="underline font-semibold hover:text-yellow-900">OKXäº¤æ˜“é¡µé¢</a> 
                                æ ¹æ®å„è´¦æˆ·å»ºè®®é‡‘é¢æ‰‹åŠ¨ä¸‹å•
                            </p>
                        </div>
                    </div>
                `;
                
                strategyDiv.classList.remove('hidden');
                
                // æ»šåŠ¨åˆ°ç­–ç•¥è¯¦æƒ…
                strategyDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // ä¿å­˜å½“å‰ç­–ç•¥åˆ°localStorage
                const strategyData = {
                    range,
                    threshold,
                    leverage,
                    direction,
                    targetCoins: targetCoins.map(c => ({
                        symbol: c.symbol,
                        change: c.change,
                        currentPrice: c.current_price
                    })),
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('currentStrategy', JSON.stringify(strategyData));
                
                console.log('âœ… ç­–ç•¥å·²åº”ç”¨:', strategyData);
            }
            
            // é¡µé¢åŠ è½½æ—¶æ¢å¤ä¸Šæ¬¡çš„ç­–ç•¥
            function restoreLastStrategy() {
                const savedStrategy = localStorage.getItem('currentStrategy');
                if (savedStrategy) {
                    try {
                        const strategy = JSON.parse(savedStrategy);
                        // æ£€æŸ¥ç­–ç•¥æ˜¯å¦åœ¨24å°æ—¶å†…
                        const strategyTime = new Date(strategy.timestamp);
                        const now = new Date();
                        const hoursDiff = (now - strategyTime) / (1000 * 60 * 60);
                        
                        if (hoursDiff < 24) {
                            console.log('ğŸ”„ æ¢å¤ä¸Šæ¬¡çš„ç­–ç•¥...');
                            // è¿™é‡Œä¸è‡ªåŠ¨åº”ç”¨ï¼Œåªæ˜¯æç¤ºç”¨æˆ·
                            console.log('ä¸Šæ¬¡ç­–ç•¥:', strategy);
                        } else {
                            // è¶…è¿‡24å°æ—¶ï¼Œæ¸…é™¤æ—§ç­–ç•¥
                            localStorage.removeItem('currentStrategy');
                        }
                    } catch (e) {
                        console.error('æ¢å¤ç­–ç•¥å¤±è´¥:', e);
                    }
                }
            }
            
            // ==================== é¢„è­¦åŠŸèƒ½ ====================
            
            // é¢„è­¦çŠ¶æ€ç®¡ç†
            let alertState = {
                upperEnabled: false,
                lowerEnabled: false,
                upperThreshold: 300,
                lowerThreshold: -300,
                upperTriggered: false,
                lowerTriggered: false,
                lastCheckTime: null
            };
            
            // ä»åç«¯åŠ è½½é¢„è­¦è®¾ç½®
            async function loadAlertSettings() {
                try {
                    // å…ˆä»åç«¯åŠ è½½
                    const response = await fetch('/api/coin-tracker/alert-settings');
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.settings) {
                            const settings = result.settings;
                            
                            // æ›´æ–°alertState
                            alertState.upperThreshold = settings.upperThreshold || 5;
                            alertState.lowerThreshold = settings.lowerThreshold || -5;
                            alertState.upperEnabled = settings.upperEnabled || false;
                            alertState.lowerEnabled = settings.lowerEnabled || false;
                            alertState.tgEnabled = settings.tgEnabled || false;
                            alertState.upperTriggered = settings.upperTriggered || false;
                            alertState.lowerTriggered = settings.lowerTriggered || false;
                            
                            // å¼ºåˆ¶æ›´æ–°UIï¼ˆç¡®ä¿å€¼è¢«è®¾ç½®ï¼‰
                            const upInput = document.getElementById('upThreshold');
                            const downInput = document.getElementById('downThreshold');
                            const upSwitch = document.getElementById('upAlertEnabled');
                            const downSwitch = document.getElementById('downAlertEnabled');
                            const tgSwitch = document.getElementById('tgEnabled');
                            
                            if (upInput) upInput.value = alertState.upperThreshold;
                            if (downInput) downInput.value = alertState.lowerThreshold;
                            if (upSwitch) upSwitch.checked = alertState.upperEnabled;
                            if (downSwitch) downSwitch.checked = alertState.lowerEnabled;
                            if (tgSwitch) tgSwitch.checked = alertState.tgEnabled;
                            
                            updateSwitchStyles();
                            console.log('âœ… é¢„è­¦è®¾ç½®å·²ä»æœåŠ¡å™¨åŠ è½½:', alertState);
                            console.log('ğŸ“Š é˜ˆå€¼å·²æ›´æ–° - ä¸Šé™:', alertState.upperThreshold, 'ä¸‹é™:', alertState.lowerThreshold);
                            return;
                        }
                    }
                } catch (e) {
                    console.warn('ä»æœåŠ¡å™¨åŠ è½½é¢„è­¦è®¾ç½®å¤±è´¥ï¼Œå°è¯•ä»localStorageåŠ è½½:', e);
                }
                
                // å¦‚æœåç«¯åŠ è½½å¤±è´¥ï¼Œå°è¯•ä»localStorageåŠ è½½
                const saved = localStorage.getItem('coinAlertSettings');
                if (saved) {
                    try {
                        const settings = JSON.parse(saved);
                        
                        // æ›´æ–°alertState
                        alertState.upperThreshold = settings.upperThreshold || 5;
                        alertState.lowerThreshold = settings.lowerThreshold || -5;
                        alertState.upperEnabled = settings.upperEnabled || false;
                        alertState.lowerEnabled = settings.lowerEnabled || false;
                        alertState.tgEnabled = settings.tgEnabled || false;
                        alertState.upperTriggered = settings.upperTriggered || false;
                        alertState.lowerTriggered = settings.lowerTriggered || false;
                        
                        // å¼ºåˆ¶æ›´æ–°UI
                        const upInput = document.getElementById('upThreshold');
                        const downInput = document.getElementById('downThreshold');
                        const upSwitch = document.getElementById('upAlertEnabled');
                        const downSwitch = document.getElementById('downAlertEnabled');
                        const tgSwitch = document.getElementById('tgEnabled');
                        
                        if (upInput) upInput.value = alertState.upperThreshold;
                        if (downInput) downInput.value = alertState.lowerThreshold;
                        if (upSwitch) upSwitch.checked = alertState.upperEnabled;
                        if (downSwitch) downSwitch.checked = alertState.lowerEnabled;
                        if (tgSwitch) tgSwitch.checked = alertState.tgEnabled;
                        
                        updateSwitchStyles();
                        console.log('âœ… é¢„è­¦è®¾ç½®å·²ä»localStorageåŠ è½½:', alertState);
                        console.log('ğŸ“Š é˜ˆå€¼å·²æ›´æ–° - ä¸Šé™:', alertState.upperThreshold, 'ä¸‹é™:', alertState.lowerThreshold);
                    } catch (e) {
                        console.error('ä»localStorageåŠ è½½é¢„è­¦è®¾ç½®å¤±è´¥:', e);
                    }
                }
            }
            
            // ä¿å­˜é¢„è­¦è®¾ç½®åˆ°åç«¯å’ŒlocalStorage
            async function saveAlertSettings() {
                // ä¿å­˜åˆ°localStorageï¼ˆæœ¬åœ°å¤‡ä»½ï¼‰
                localStorage.setItem('coinAlertSettings', JSON.stringify(alertState));
                
                // ä¿å­˜åˆ°åç«¯
                try {
                    const response = await fetch('/api/coin-tracker/alert-settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(alertState)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('ğŸ’¾ é¢„è­¦è®¾ç½®å·²ä¿å­˜åˆ°æœåŠ¡å™¨:', result);
                    } else {
                        console.error('ä¿å­˜åˆ°æœåŠ¡å™¨å¤±è´¥ï¼Œä½†å·²ä¿å­˜åˆ°localStorage');
                    }
                } catch (e) {
                    console.error('ä¿å­˜åˆ°æœåŠ¡å™¨å¤±è´¥:', e, 'ä½†å·²ä¿å­˜åˆ°localStorage');
                }
            }
            
            // æ›´æ–°å¼€å…³æ ·å¼
            function updateSwitchStyles() {
                const upperSwitch = document.getElementById('upAlertEnabled');
                const lowerSwitch = document.getElementById('downAlertEnabled');
                const upperLabel = upperSwitch.parentElement;
                const lowerLabel = lowerSwitch.parentElement;
                
                if (alertState.upperEnabled) {
                    upperLabel.classList.add('bg-green-500');
                    upperLabel.classList.remove('bg-gray-300');
                } else {
                    upperLabel.classList.remove('bg-green-500');
                    upperLabel.classList.add('bg-gray-300');
                }
                
                if (alertState.lowerEnabled) {
                    lowerLabel.classList.add('bg-green-500');
                    lowerLabel.classList.remove('bg-gray-300');
                } else {
                    lowerLabel.classList.remove('bg-green-500');
                    lowerLabel.classList.add('bg-gray-300');
                }
            }
            
            // æ’­æ”¾é¢„è­¦éŸ³æ•ˆ
            function playAlertSound() {
                try {
                    // ä½¿ç”¨Web Audio APIç”Ÿæˆè­¦æŠ¥éŸ³
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800; // é¢‘ç‡ 800Hz
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                    
                    // é‡å¤3æ¬¡
                    setTimeout(() => {
                        const osc2 = audioContext.createOscillator();
                        const gain2 = audioContext.createGain();
                        osc2.connect(gain2);
                        gain2.connect(audioContext.destination);
                        osc2.frequency.value = 1000;
                        osc2.type = 'sine';
                        gain2.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        osc2.start(audioContext.currentTime);
                        osc2.stop(audioContext.currentTime + 0.5);
                    }, 600);
                    
                    setTimeout(() => {
                        const osc3 = audioContext.createOscillator();
                        const gain3 = audioContext.createGain();
                        osc3.connect(gain3);
                        gain3.connect(audioContext.destination);
                        osc3.frequency.value = 800;
                        osc3.type = 'sine';
                        gain3.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gain3.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        osc3.start(audioContext.currentTime);
                        osc3.stop(audioContext.currentTime + 0.5);
                    }, 1200);
                    
                    console.log('ğŸ”Š é¢„è­¦éŸ³æ•ˆå·²æ’­æ”¾');
                } catch (e) {
                    console.error('æ’­æ”¾éŸ³æ•ˆå¤±è´¥:', e);
                }
            }
            
            // å‘é€Telegramé€šçŸ¥
            async function sendTelegramAlert(message) {
                try {
                    const response = await fetch('/api/telegram/send-alert', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            type: 'coin_alert'
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('âœ… Telegramé€šçŸ¥å·²å‘é€:', result);
                        return true;
                    } else {
                        console.error('âŒ Telegramé€šçŸ¥å‘é€å¤±è´¥:', response.status);
                        return false;
                    }
                } catch (e) {
                    console.error('å‘é€Telegramé€šçŸ¥å¼‚å¸¸:', e);
                    return false;
                }
            }
            
            // æ˜¾ç¤ºé¢„è­¦å¼¹çª—
            function showAlertDialog(type, value, coins) {
                const title = type === 'upper' ? 'ğŸ”´ æ¶¨å¹…é¢„è­¦è§¦å‘' : 'ğŸŸ¢ è·Œå¹…é¢„è­¦è§¦å‘';
                const threshold = type === 'upper' ? alertState.upperThreshold : alertState.lowerThreshold;
                const coinsText = coins.map(c => `${c.symbol}: ${c.change > 0 ? '+' : ''}${c.change}%`).join('\n');
                
                const message = `${title}\n\nå½“å‰ç´¯è®¡æ¶¨è·Œå¹…: ${value > 0 ? '+' : ''}${value}%\né˜ˆå€¼: ${threshold > 0 ? '+' : ''}${threshold}%\n\nè§¦å‘å¸ç§:\n${coinsText}`;
                
                // åˆ›å»ºå¼¹çª—
                const dialog = document.createElement('div');
                dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                dialog.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl">
                        <h2 class="text-2xl font-bold mb-4 ${type === 'upper' ? 'text-red-600' : 'text-green-600'}">
                            ${title}
                        </h2>
                        <div class="bg-gray-100 rounded p-4 mb-4">
                            <p class="font-mono text-sm whitespace-pre-line">${message.replace(/\n/g, '<br>')}</p>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition">
                                å…³é—­
                            </button>
                            <button onclick="location.reload()" 
                                    class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                                åˆ·æ–°æ•°æ®
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(dialog);
                
                // 5ç§’åè‡ªåŠ¨å…³é—­
                setTimeout(() => {
                    if (document.body.contains(dialog)) {
                        dialog.remove();
                    }
                }, 5000);
            }
            
            // æ£€æŸ¥é¢„è­¦æ¡ä»¶
            function checkAlerts(currentData) {
                if (!currentData || !currentData.cumulative_pct) return;
                
                const currentValue = currentData.cumulative_pct;
                const now = Date.now();
                
                // é¿å…é¢‘ç¹æ£€æŸ¥ï¼ˆæœ€å°‘é—´éš”10ç§’ï¼‰
                if (alertState.lastCheckTime && (now - alertState.lastCheckTime) < 10000) {
                    return;
                }
                
                alertState.lastCheckTime = now;
                
                // è·å–è§¦å‘çš„å¸ç§
                const changes = currentData.changes || {};
                const triggerCoins = [];
                
                Object.entries(changes).forEach(([symbol, data]) => {
                    if (!data.error && Math.abs(data.change_pct) > 10) {
                        triggerCoins.push({
                            symbol: symbol.replace('-USDT-SWAP', ''),
                            change: data.change_pct.toFixed(2)
                        });
                    }
                });
                
                // æ£€æŸ¥ä¸Šé™é¢„è­¦
                if (alertState.upperEnabled && !alertState.upperTriggered && currentValue >= alertState.upperThreshold) {
                    console.log('ğŸ”´ è§¦å‘ä¸Šé™é¢„è­¦:', currentValue, '>=', alertState.upperThreshold);
                    
                    // æ’­æ”¾éŸ³æ•ˆ
                    playAlertSound();
                    
                    // æ˜¾ç¤ºå¼¹çª—
                    showAlertDialog('upper', currentValue, triggerCoins);
                    
                    // å‘é€Telegramé€šçŸ¥
                    const message = `ğŸ”´ æ¶¨å¹…é¢„è­¦è§¦å‘ï¼\n\nå½“å‰ç´¯è®¡æ¶¨è·Œå¹…: +${currentValue.toFixed(2)}%\né˜ˆå€¼: +${alertState.upperThreshold}%\n\nè§¦å‘å¸ç§:\n${triggerCoins.map(c => `${c.symbol}: ${c.change > 0 ? '+' : ''}${c.change}%`).join('\n')}`;
                    sendTelegramAlert(message);
                    
                    // å…³é—­å¼€å…³
                    alertState.upperEnabled = false;
                    alertState.upperTriggered = true;
                    document.getElementById('upAlertEnabled').checked = false;
                    updateSwitchStyles();
                    saveAlertSettings();
                }
                
                // æ£€æŸ¥ä¸‹é™é¢„è­¦
                if (alertState.lowerEnabled && !alertState.lowerTriggered && currentValue <= alertState.lowerThreshold) {
                    console.log('ğŸŸ¢ è§¦å‘ä¸‹é™é¢„è­¦:', currentValue, '<=', alertState.lowerThreshold);
                    
                    // æ’­æ”¾éŸ³æ•ˆ
                    playAlertSound();
                    
                    // æ˜¾ç¤ºå¼¹çª—
                    showAlertDialog('lower', currentValue, triggerCoins);
                    
                    // å‘é€Telegramé€šçŸ¥
                    const message = `ğŸŸ¢ è·Œå¹…é¢„è­¦è§¦å‘ï¼\n\nå½“å‰ç´¯è®¡æ¶¨è·Œå¹…: ${currentValue.toFixed(2)}%\né˜ˆå€¼: ${alertState.lowerThreshold}%\n\nè§¦å‘å¸ç§:\n${triggerCoins.map(c => `${c.symbol}: ${c.change > 0 ? '+' : ''}${c.change}%`).join('\n')}`;
                    sendTelegramAlert(message);
                    
                    // å…³é—­å¼€å…³
                    alertState.lowerEnabled = false;
                    alertState.lowerTriggered = true;
                    document.getElementById('downAlertEnabled').checked = false;
                    updateSwitchStyles();
                    saveAlertSettings();
                }
            }
            
            // ç»‘å®šé¢„è­¦è®¾ç½®äº‹ä»¶
            document.getElementById('upThreshold').addEventListener('change', (e) => {
                alertState.upperThreshold = parseFloat(e.target.value);
                alertState.upperTriggered = false; // é‡ç½®è§¦å‘çŠ¶æ€
                saveAlertSettings();
                console.log('ä¸Šé™é˜ˆå€¼å·²æ›´æ–°:', alertState.upperThreshold);
            });
            
            document.getElementById('downThreshold').addEventListener('change', (e) => {
                alertState.lowerThreshold = parseFloat(e.target.value);
                alertState.lowerTriggered = false; // é‡ç½®è§¦å‘çŠ¶æ€
                saveAlertSettings();
                console.log('ä¸‹é™é˜ˆå€¼å·²æ›´æ–°:', alertState.lowerThreshold);
            });
            
            document.getElementById('upAlertEnabled').addEventListener('change', (e) => {
                alertState.upperEnabled = e.target.checked;
                if (alertState.upperEnabled) {
                    alertState.upperTriggered = false; // é‡æ–°å¼€å¯æ—¶é‡ç½®è§¦å‘çŠ¶æ€
                }
                updateSwitchStyles();
                saveAlertSettings();
                console.log('ä¸Šé™é¢„è­¦', alertState.upperEnabled ? 'å·²å¼€å¯' : 'å·²å…³é—­');
            });
            
            document.getElementById('downAlertEnabled').addEventListener('change', (e) => {
                alertState.lowerEnabled = e.target.checked;
                if (alertState.lowerEnabled) {
                    alertState.lowerTriggered = false; // é‡æ–°å¼€å¯æ—¶é‡ç½®è§¦å‘çŠ¶æ€
                }
                updateSwitchStyles();
                saveAlertSettings();
                console.log('ä¸‹é™é¢„è­¦', alertState.lowerEnabled ? 'å·²å¼€å¯' : 'å·²å…³é—­');
            });
            
            // ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('saveAlertSettings').addEventListener('click', async () => {
                // è¯»å–å½“å‰è®¾ç½®
                alertState.upperThreshold = parseFloat(document.getElementById('upThreshold').value || 5);
                alertState.lowerThreshold = parseFloat(document.getElementById('downThreshold').value || -5);
                alertState.upperEnabled = document.getElementById('upAlertEnabled').checked;
                alertState.lowerEnabled = document.getElementById('downAlertEnabled').checked;
                alertState.tgEnabled = document.getElementById('tgEnabled').checked;
                
                // ä¿å­˜åˆ°åç«¯å’ŒlocalStorage
                await saveAlertSettings();
                
                // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
                const successDiv = document.getElementById('saveSuccess');
                successDiv.classList.remove('hidden');
                
                // 3ç§’åè‡ªåŠ¨éšè—
                setTimeout(() => {
                    successDiv.classList.add('hidden');
                }, 3000);
                
                console.log('âœ… é¢„è­¦è®¾ç½®å·²æ‰‹åŠ¨ä¿å­˜:', alertState);
            });
            
            // é‡ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('resetAlertSettings').addEventListener('click', async () => {
                // æ¢å¤é»˜è®¤å€¼
                alertState = {
                    upperEnabled: false,
                    lowerEnabled: false,
                    tgEnabled: false,
                    upperThreshold: 5,
                    lowerThreshold: -5,
                    upperTriggered: false,
                    lowerTriggered: false,
                    lastCheckTime: null
                };
                
                // æ›´æ–°UI
                document.getElementById('upThreshold').value = 5;
                document.getElementById('downThreshold').value = -5;
                document.getElementById('upAlertEnabled').checked = false;
                document.getElementById('downAlertEnabled').checked = false;
                document.getElementById('tgEnabled').checked = false;
                
                updateSwitchStyles();
                await saveAlertSettings();
                
                // æ˜¾ç¤ºæç¤º
                const alertLog = document.getElementById('alertLog');
                const alertMessage = document.getElementById('alertMessage');
                alertMessage.textContent = 'å·²æ¢å¤é»˜è®¤è®¾ç½®ï¼šä¸Šé™5%ï¼Œä¸‹é™-5%ï¼Œå¼€å…³å·²å…³é—­';
                alertLog.classList.remove('hidden');
                
                setTimeout(() => {
                    alertLog.classList.add('hidden');
                }, 3000);
                
                console.log('ğŸ”„ é¢„è­¦è®¾ç½®å·²æ¢å¤é»˜è®¤');
            });
            
            // åœ¨updateDataå‡½æ•°ä¸­æ·»åŠ é¢„è­¦æ£€æŸ¥ï¼ˆå·²ç¦ç”¨ï¼Œå› ä¸ºupdateDataä¸å­˜åœ¨ï¼‰
            // const originalUpdateData = updateData;
            // window.updateData = async function() {
            //     await originalUpdateData();
            //     
            //     // æ£€æŸ¥é¢„è­¦
            //     const latestResponse = await fetch('/api/coin-change-tracker/latest');
            //     if (latestResponse.ok) {
            //         const latestData = await latestResponse.json();
            //         checkAlerts(latestData);
            //     }
            // };
            
            // é¡µé¢åŠ è½½æ—¶åŠ è½½é¢„è­¦è®¾ç½®ï¼ˆç«‹å³æ‰§è¡Œï¼Œç¡®ä¿æœ€å…ˆåŠ è½½ï¼‰
            loadAlertSettings().then(() => {
                console.log('ğŸ¯ é¡µé¢åŠ è½½å®Œæˆï¼Œé¢„è­¦è®¾ç½®å·²åŠ è½½');
                // äºŒæ¬¡ç¡®è®¤ï¼š500msåå†æ¬¡éªŒè¯è¾“å…¥æ¡†çš„å€¼
                setTimeout(() => {
                    const upValue = document.getElementById('upThreshold').value;
                    const downValue = document.getElementById('downThreshold').value;
                    console.log('ğŸ” 500msåéªŒè¯ - ä¸Šé™è¾“å…¥æ¡†å€¼:', upValue, 'ä¸‹é™è¾“å…¥æ¡†å€¼:', downValue);
                    console.log('ğŸ” 500msåéªŒè¯ - alertState:', JSON.stringify(alertState));
                    
                    // å¦‚æœä¸åŒ¹é…ï¼Œå¼ºåˆ¶å†æ¬¡è®¾ç½®
                    if (upValue != alertState.upperThreshold || downValue != alertState.lowerThreshold) {
                        console.warn('âš ï¸ æ£€æµ‹åˆ°å€¼ä¸åŒ¹é…ï¼Œå¼ºåˆ¶é‡æ–°è®¾ç½®ï¼');
                        document.getElementById('upThreshold').value = alertState.upperThreshold;
                        document.getElementById('downThreshold').value = alertState.lowerThreshold;
                    }
                }, 500);
            });
            
            // ==================== é¢„è­¦åŠŸèƒ½ç»“æŸ ====================
            
            scheduleAutoPageRefresh();
            
            // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç»˜å›¾è¡¨
            window.addEventListener('resize', () => {
                trendChart.resize();
                rankChart.resize();
            });
        };
    </script>
</body>
</html>
