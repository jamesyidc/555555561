<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯æ’‘å‹åŠ›ç³»ç»Ÿ v2.0 - å®æ—¶ç›‘æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header .meta {
            color: #666;
            font-size: 14px;
        }

        .header .meta span {
            margin-right: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .label {
            color: #999;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .stat-card .value {
            color: #333;
            font-size: 24px;
            font-weight: bold;
        }

        .stat-card .subvalue {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .coin-selector {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .coin-selector h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .coin-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .coin-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .coin-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .coin-btn.active {
            background: #667eea;
            color: white;
        }

        .data-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .data-panel h3 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .sr-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .sr-box {
            padding: 20px;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .sr-box.resistance {
            border-left: 4px solid #f56565;
        }

        .sr-box.support {
            border-left: 4px solid #48bb78;
        }

        .sr-box .title {
            font-size: 14px;
            color: #999;
            margin-bottom: 10px;
        }

        .sr-box .price {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .sr-box.resistance .price {
            color: #f56565;
        }

        .sr-box.support .price {
            color: #48bb78;
        }

        .sr-box .detail {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }

        .trend-box {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .trend-box .label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .trend-box .value {
            font-size: 22px;
            font-weight: bold;
            color: #667eea;
        }

        .chart-container {
            height: 400px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            font-size: 24px;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 24px rgba(102, 126, 234, 0.6);
        }

        .refresh-btn.spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }

        .badge.up {
            background: #c6f6d5;
            color: #2f855a;
        }

        .badge.down {
            background: #fed7d7;
            color: #c53030;
        }

        .badge.sideways {
            background: #e2e8f0;
            color: #4a5568;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 22px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .coin-buttons {
                gap: 5px;
            }
            
            .coin-btn {
                padding: 8px 15px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ“Š æ”¯æ’‘å‹åŠ›ç³»ç»Ÿ v2.0 <span id="systemStatus" class="badge">åŠ è½½ä¸­...</span></h1>
            <div class="meta">
                <span>ğŸ”„ è‡ªåŠ¨åˆ·æ–°: 60ç§’</span>
                <span>â° æ›´æ–°æ—¶é—´: <span id="updateTime">--</span></span>
                <span>ğŸ“ˆ ç›‘æ§å¸ç§: <span id="symbolsCount">--</span></span>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">æ€»è®°å½•æ•°</div>
                <div class="value" id="totalRecords">--</div>
                <div class="subvalue">æ•°æ®ç‚¹</div>
            </div>
            <div class="stat-card">
                <div class="label">ç›‘æ§å¸ç§</div>
                <div class="value" id="totalSymbols">--</div>
                <div class="subvalue">æ´»è·ƒäº¤æ˜“å¯¹</div>
            </div>
            <div class="stat-card">
                <div class="label">äº¤æ˜“ä¿¡å·</div>
                <div class="value" id="totalSignals">--</div>
                <div class="subvalue">æ´»è·ƒä¿¡å·</div>
            </div>
            <div class="stat-card">
                <div class="label">æ•°æ®èŒƒå›´</div>
                <div class="value" id="dataRange">--</div>
                <div class="subvalue">æ—¶é—´è·¨åº¦</div>
            </div>
        </div>

        <!-- å¸ç§é€‰æ‹©å™¨ -->
        <div class="coin-selector">
            <h3>ğŸª™ é€‰æ‹©å¸ç§</h3>
            <div class="coin-buttons" id="coinButtons">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æ•°æ®é¢æ¿ -->
        <div class="data-panel">
            <h3>ğŸ“ <span id="currentCoin">BTC</span>-USDT-SWAP å®æ—¶æ•°æ®</h3>
            
            <!-- åŠ è½½ä¸­ -->
            <div id="loadingDiv" class="loading">
                <div>â³ æ­£åœ¨åŠ è½½æ•°æ®...</div>
            </div>

            <!-- é”™è¯¯æç¤º -->
            <div id="errorDiv" class="error" style="display: none;">
                <strong>âŒ åŠ è½½å¤±è´¥</strong>
                <div id="errorMessage"></div>
            </div>

            <!-- æ•°æ®å†…å®¹ -->
            <div id="dataContent" style="display: none;">
                <!-- è¶‹åŠ¿ä¿¡æ¯ -->
                <div class="trend-box">
                    <div class="label">å½“å‰è¶‹åŠ¿</div>
                    <div class="value">
                        <span id="trendDirection">--</span>
                        <span id="trendBadge"></span>
                    </div>
                    <div style="margin-top: 10px; font-size: 14px; color: #666;">
                        å¼ºåº¦: <span id="trendStrength">--</span> | 
                        æ³¢åŠ¨ç‡: <span id="volatility">--</span> | 
                        24hæˆäº¤é‡: <span id="volume24h">--</span>
                    </div>
                </div>

                <!-- æ”¯æ’‘å‹åŠ›ä½ -->
                <div class="sr-info">
                    <div class="sr-box resistance">
                        <div class="title">ğŸ”´ å‹åŠ›ä½ (Resistance)</div>
                        <div class="price" id="resistancePrice">--</div>
                        <div class="detail">
                            è·ç¦»: <span id="resistanceDistance">--</span> | 
                            è§¦åŠæ¬¡æ•°: <span id="resistanceCount">--</span><br>
                            ç½®ä¿¡åº¦: <span id="resistanceConfidence">--</span>
                        </div>
                    </div>

                    <div class="sr-box support">
                        <div class="title">ğŸŸ¢ æ”¯æ’‘ä½ (Support)</div>
                        <div class="price" id="supportPrice">--</div>
                        <div class="detail">
                            è·ç¦»: <span id="supportDistance">--</span> | 
                            è§¦åŠæ¬¡æ•°: <span id="supportCount">--</span><br>
                            ç½®ä¿¡åº¦: <span id="supportConfidence">--</span>
                        </div>
                    </div>
                </div>

                <!-- ä»·æ ¼å›¾è¡¨ -->
                <div class="chart-container" id="priceChart"></div>
            </div>
        </div>
    </div>

    <!-- åˆ·æ–°æŒ‰é’® -->
    <button class="refresh-btn" id="refreshBtn" onclick="loadData()">ğŸ”„</button>

    <script>
        // å…¨å±€å˜é‡
        let currentSymbol = 'BTC-USDT-SWAP';
        let priceChart = null;
        let autoRefreshInterval = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSystemStatus();
            loadData();
            startAutoRefresh();
        });

        // åŠ è½½ç³»ç»ŸçŠ¶æ€
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/sr-v2/status');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('systemStatus').textContent = 'åœ¨çº¿';
                    document.getElementById('systemStatus').className = 'badge up';
                    document.getElementById('symbolsCount').textContent = data.symbols_count;
                    document.getElementById('totalSymbols').textContent = data.symbols_count;
                    
                    // ç”Ÿæˆå¸ç§æŒ‰é’®
                    const buttonsContainer = document.getElementById('coinButtons');
                    buttonsContainer.innerHTML = '';
                    data.symbols.forEach(symbol => {
                        const coinName = symbol.replace('-USDT-SWAP', '');
                        const btn = document.createElement('button');
                        btn.className = 'coin-btn' + (symbol === currentSymbol ? ' active' : '');
                        btn.textContent = coinName;
                        btn.onclick = () => selectCoin(symbol, btn);
                        buttonsContainer.appendChild(btn);
                    });
                } else {
                    document.getElementById('systemStatus').textContent = 'ç¦»çº¿';
                    document.getElementById('systemStatus').className = 'badge down';
                }
            } catch (error) {
                console.error('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
                document.getElementById('systemStatus').textContent = 'é”™è¯¯';
                document.getElementById('systemStatus').className = 'badge down';
            }
        }

        // é€‰æ‹©å¸ç§
        function selectCoin(symbol, btn) {
            currentSymbol = symbol;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.coin-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // æ›´æ–°æ ‡é¢˜
            const coinName = symbol.replace('-USDT-SWAP', '');
            document.getElementById('currentCoin').textContent = coinName;
            
            // åŠ è½½æ•°æ®
            loadData();
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            const loadingDiv = document.getElementById('loadingDiv');
            const errorDiv = document.getElementById('errorDiv');
            const dataContent = document.getElementById('dataContent');
            const refreshBtn = document.getElementById('refreshBtn');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            dataContent.style.display = 'none';
            refreshBtn.classList.add('spinning');
            
            try {
                // åŠ è½½æœ€æ–°æ•°æ®
                const latestResponse = await fetch(`/api/sr-v2/latest?inst_id=${currentSymbol}&limit=1`);
                const latestData = await latestResponse.json();
                
                if (!latestData.success || !latestData.data || latestData.data.length === 0) {
                    throw new Error('æš‚æ— æ•°æ®');
                }
                
                const record = latestData.data[0];
                
                // åŠ è½½å†å²æ•°æ®ç”¨äºå›¾è¡¨
                const historyResponse = await fetch(`/api/sr-v2/history?inst_id=${currentSymbol}&hours=24`);
                const historyData = await historyResponse.json();
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                document.getElementById('totalRecords').textContent = latestData.total || '--';
                document.getElementById('updateTime').textContent = record.created_at || '--';
                
                // æ›´æ–°è¶‹åŠ¿ä¿¡æ¯
                const trendMap = {
                    'up': 'ä¸Šæ¶¨è¶‹åŠ¿ ğŸ“ˆ',
                    'down': 'ä¸‹è·Œè¶‹åŠ¿ ğŸ“‰',
                    'sideways': 'æ¨ªç›˜æ•´ç† â¡ï¸'
                };
                document.getElementById('trendDirection').textContent = trendMap[record.trend_direction] || '--';
                
                const trendBadgeClass = record.trend_direction === 'up' ? 'up' : 
                                       record.trend_direction === 'down' ? 'down' : 'sideways';
                document.getElementById('trendBadge').innerHTML = 
                    `<span class="badge ${trendBadgeClass}">${record.trend_direction}</span>`;
                
                document.getElementById('trendStrength').textContent = 
                    (record.trend_strength || 0).toFixed(2);
                document.getElementById('volatility').textContent = 
                    ((record.volatility || 0) * 100).toFixed(2) + '%';
                document.getElementById('volume24h').textContent = 
                    formatNumber(record.volume_24h || 0);
                
                // æ›´æ–°å‹åŠ›ä½
                document.getElementById('resistancePrice').textContent = 
                    formatPrice(record.resistance_price);
                document.getElementById('resistanceDistance').textContent = 
                    ((record.resistance_distance || 0) * 100).toFixed(2) + '%';
                document.getElementById('resistanceCount').textContent = 
                    record.resistance_touch_count || 0;
                document.getElementById('resistanceConfidence').textContent = 
                    ((record.resistance_confidence || 0) * 100).toFixed(0) + '%';
                
                // æ›´æ–°æ”¯æ’‘ä½
                document.getElementById('supportPrice').textContent = 
                    formatPrice(record.support_price);
                document.getElementById('supportDistance').textContent = 
                    ((record.support_distance || 0) * 100).toFixed(2) + '%';
                document.getElementById('supportCount').textContent = 
                    record.support_touch_count || 0;
                document.getElementById('supportConfidence').textContent = 
                    ((record.support_confidence || 0) * 100).toFixed(0) + '%';
                
                // ç»˜åˆ¶å›¾è¡¨
                drawChart(historyData.data || [], record);
                
                // æ˜¾ç¤ºå†…å®¹
                loadingDiv.style.display = 'none';
                dataContent.style.display = 'block';
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message;
            } finally {
                refreshBtn.classList.remove('spinning');
            }
        }

        // ç»˜åˆ¶å›¾è¡¨
        function drawChart(historyData, currentData) {
            if (!priceChart) {
                priceChart = echarts.init(document.getElementById('priceChart'));
            }
            
            // å‡†å¤‡æ•°æ®
            const times = historyData.map(d => d.snapshot_time);
            const prices = historyData.map(d => d.current_price);
            const resistances = historyData.map(d => d.resistance_price);
            const supports = historyData.map(d => d.support_price);
            
            const option = {
                title: {
                    text: 'ä»·æ ¼èµ°åŠ¿ä¸æ”¯æ’‘å‹åŠ›ä½',
                    left: 'center',
                    textStyle: {
                        color: '#333',
                        fontSize: 16
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                legend: {
                    data: ['å½“å‰ä»·æ ¼', 'å‹åŠ›ä½', 'æ”¯æ’‘ä½'],
                    top: 30
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLabel: {
                        formatter: function(value) {
                            return value.substring(11, 16);
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    scale: true
                },
                series: [
                    {
                        name: 'å½“å‰ä»·æ ¼',
                        type: 'line',
                        data: prices,
                        smooth: true,
                        lineStyle: {
                            color: '#667eea',
                            width: 2
                        },
                        itemStyle: {
                            color: '#667eea'
                        }
                    },
                    {
                        name: 'å‹åŠ›ä½',
                        type: 'line',
                        data: resistances,
                        lineStyle: {
                            color: '#f56565',
                            width: 2,
                            type: 'dashed'
                        },
                        itemStyle: {
                            color: '#f56565'
                        }
                    },
                    {
                        name: 'æ”¯æ’‘ä½',
                        type: 'line',
                        data: supports,
                        lineStyle: {
                            color: '#48bb78',
                            width: 2,
                            type: 'dashed'
                        },
                        itemStyle: {
                            color: '#48bb78'
                        }
                    }
                ]
            };
            
            priceChart.setOption(option);
        }

        // è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            autoRefreshInterval = setInterval(() => {
                loadData();
            }, 60000); // 60ç§’åˆ·æ–°ä¸€æ¬¡
        }

        // æ ¼å¼åŒ–ä»·æ ¼
        function formatPrice(price) {
            if (!price) return '--';
            return parseFloat(price).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num) {
            if (!num) return '--';
            return parseFloat(num).toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç»˜å›¾è¡¨
        window.addEventListener('resize', function() {
            if (priceChart) {
                priceChart.resize();
            }
        });
    </script>
</body>
</html>
