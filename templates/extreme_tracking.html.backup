<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>æå€¼è¿½è¸ªç³»ç»Ÿ - åŠ å¯†è´§å¸æ•°æ®åˆ†æ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #1e2139;
            color: #fff;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-nav {
            background: #2a2d47;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            justify-content: space-between;
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .home-btn {
            background: linear-gradient(135deg, #00d4ff 0%, #0099ff 100%);
            color: #fff;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }
        
        .home-btn:hover {
            background: linear-gradient(135deg, #0099ff 0%, #00d4ff 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.4);
        }
        
        .nav-title {
            font-size: 18px;
            font-weight: 500;
            color: #fff;
        }
        
        /* ç»Ÿè®¡å¡ç‰‡åŒº */
        .stats-section {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            background: #2a2d47;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #8b92b8;
            margin-bottom: 12px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
        }
        
        .stat-card .sub-value {
            font-size: 14px;
            color: #8b92b8;
        }
        
        /* è§¦å‘ç±»å‹ç»Ÿè®¡ */
        .trigger-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 12px;
        }
        
        .trigger-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .trigger-item .label {
            font-size: 12px;
            color: #8b92b8;
            margin-bottom: 4px;
        }
        
        .trigger-item .count {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
        }
        
        /* å¿«ç…§åˆ—è¡¨ */
        .snapshots-section {
            padding: 20px;
        }
        
        .snapshots-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .snapshots-header h2 {
            font-size: 20px;
            color: #fff;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
        }
        
        .filter-btn {
            background: #3a3d5c;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        
        .filter-btn:hover {
            background: #4a4d6c;
        }
        
        /* å¿«ç…§å¡ç‰‡ */
        .snapshot-card {
            background: #2a2d47;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .snapshot-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }
        
        .snapshot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #3a3d5c;
        }
        
        .snapshot-id {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }
        
        .snapshot-time {
            font-size: 13px;
            color: #8b92b8;
        }
        
        .snapshot-status {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-active {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }
        
        .status-completed {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
        }
        
        .triggers {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .trigger-tag {
            background: rgba(220, 38, 38, 0.2);
            color: #dc2626;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid rgba(220, 38, 38, 0.4);
        }
        
        .snapshot-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .detail-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
        }
        
        .detail-label {
            font-size: 12px;
            color: #8b92b8;
            margin-bottom: 4px;
        }
        
        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }
        
        /* ä»·æ ¼è¿½è¸ªè¡¨ */
        .tracking-table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
        }
        
        .tracking-table th,
        .tracking-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #3a3d5c;
        }
        
        .tracking-table th {
            font-size: 12px;
            color: #8b92b8;
            font-weight: 500;
        }
        
        .tracking-table td {
            font-size: 13px;
            color: #fff;
        }
        
        .positive {
            color: #10b981;
        }
        
        .negative {
            color: #ef4444;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            text-align: center;
            padding: 40px;
            color: #8b92b8;
            font-size: 14px;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #8b92b8;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="top-nav">
            <div class="nav-left">
                <a href="/" class="home-btn">
                    <span>ğŸ </span>
                    <span>è¿”å›é¦–é¡µ</span>
                </a>
                <div class="nav-title">âš ï¸ æå€¼è¿½è¸ªç³»ç»Ÿ v1.1</div>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡å¡ç‰‡åŒº -->
        <div class="stats-section">
            <div class="stat-card">
                <h3>å¿«ç…§æ€»æ•°</h3>
                <div class="value" id="total-snapshots">-</div>
                <div class="sub-value">æ€»è®¡æ•è·æå€¼äº‹ä»¶</div>
            </div>
            
            <div class="stat-card">
                <h3>æ´»è·ƒå¿«ç…§</h3>
                <div class="value" id="active-snapshots" style="color: #fbbf24;">-</div>
                <div class="sub-value">æ­£åœ¨è¿½è¸ªä»·æ ¼å˜åŒ–</div>
            </div>
            
            <div class="stat-card">
                <h3>å·²å®Œæˆå¿«ç…§</h3>
                <div class="value" id="completed-snapshots" style="color: #10b981;">-</div>
                <div class="sub-value">å·²å®Œæˆ24å°æ—¶è¿½è¸ª</div>
            </div>
            
            <div class="stat-card">
                <h3>è§¦å‘ç±»å‹ç»Ÿè®¡</h3>
                <div class="trigger-stats" id="trigger-stats-container">
                    <!-- åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
        
        <!-- å¿«ç…§åˆ—è¡¨ -->
        <div class="snapshots-section">
            <div class="snapshots-header">
                <h2>å¿«ç…§åˆ—è¡¨</h2>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-status="all">å…¨éƒ¨</button>
                    <button class="filter-btn" data-status="active">æ´»è·ƒä¸­</button>
                    <button class="filter-btn" data-status="completed">å·²å®Œæˆ</button>
                </div>
            </div>
            
            <div id="snapshots-container">
                <div class="loading">æ­£åœ¨åŠ è½½å¿«ç…§æ•°æ®...</div>
            </div>
        </div>
    </div>
    
    <script>
        let currentFilter = 'all';
        
        // æ ¼å¼åŒ–è§¦å‘ç±»å‹åç§°
        function formatTriggerType(type) {
            const typeNames = {
                '2h_peak': '2å°æ—¶å³°å€¼',
                '27coins_high': '27å¸æ¶¨å¹…>100%',
                '27coins_low': '27å¸è·Œå¹…<-80%',
                '24h_peak': '24å°æ—¶å³°å€¼',
                '1h_liquidation_high': '1hçˆ†ä»“>3000ä¸‡'
            };
            return typeNames[type] || type;
        }
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        function loadStats() {
            fetch('/api/extreme-tracking/stats')
                .then(res => res.json())
                .then(response => {
                    if (response.success && response.stats) {
                        const stats = response.stats;
                        
                        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                        document.getElementById('total-snapshots').textContent = stats.total_snapshots || 0;
                        document.getElementById('active-snapshots').textContent = stats.active_snapshots || 0;
                        document.getElementById('completed-snapshots').textContent = stats.completed_snapshots || 0;
                        
                        // æ›´æ–°è§¦å‘ç±»å‹ç»Ÿè®¡
                        const triggerStatsContainer = document.getElementById('trigger-stats-container');
                        triggerStatsContainer.innerHTML = '';
                        
                        if (stats.trigger_types && Object.keys(stats.trigger_types).length > 0) {
                            Object.entries(stats.trigger_types).forEach(([type, count]) => {
                                const item = document.createElement('div');
                                item.className = 'trigger-item';
                                item.innerHTML = `
                                    <div class="label">${formatTriggerType(type)}</div>
                                    <div class="count">${count}</div>
                                `;
                                triggerStatsContainer.appendChild(item);
                            });
                        } else {
                            triggerStatsContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #8b92b8;">æš‚æ— è§¦å‘äº‹ä»¶</div>';
                        }
                    }
                })
                .catch(err => {
                    console.error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥:', err);
                });
        }
        
        // åŠ è½½å¿«ç…§åˆ—è¡¨
        function loadSnapshots(status = 'all') {
            const container = document.getElementById('snapshots-container');
            container.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½å¿«ç…§æ•°æ®...</div>';
            
            let url = '/api/extreme-tracking/snapshots?limit=50';
            if (status !== 'all') {
                url += `&status=${status}`;
            }
            
            fetch(url)
                .then(res => res.json())
                .then(response => {
                    if (response.success) {
                        const snapshots = response.data || [];
                        
                        if (snapshots.length === 0) {
                            container.innerHTML = '<div class="no-data">æš‚æ— å¿«ç…§æ•°æ®</div>';
                            return;
                        }
                        
                        container.innerHTML = '';
                        
                        snapshots.forEach(snapshot => {
                            const card = createSnapshotCard(snapshot);
                            container.appendChild(card);
                        });
                    }
                })
                .catch(err => {
                    console.error('è·å–å¿«ç…§åˆ—è¡¨å¤±è´¥:', err);
                    container.innerHTML = '<div class="no-data">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
                });
        }
        
        // åˆ›å»ºå¿«ç…§å¡ç‰‡
        function createSnapshotCard(snapshot) {
            const card = document.createElement('div');
            card.className = 'snapshot-card';
            
            const statusClass = snapshot.status === 'active' ? 'status-active' : 'status-completed';
            const statusText = snapshot.status === 'active' ? 'è¿½è¸ªä¸­' : 'å·²å®Œæˆ';
            
            // è§¦å‘ç±»å‹æ ‡ç­¾
            const triggerTags = (snapshot.triggers || []).map(trigger => 
                `<span class="trigger-tag">${formatTriggerType(trigger.type)}</span>`
            ).join('');
            
            // å¿«ç…§ä¿¡æ¯
            const totalChange = snapshot.coins_snapshot?.total_change || 0;
            const totalChangeClass = totalChange >= 0 ? 'positive' : 'negative';
            
            // çˆ†ä»“æ•°æ®
            const liquidationInfo = snapshot.liquidation_snapshot ? `
                <div class="detail-item">
                    <div class="detail-label">1hçˆ†ä»“é‡‘é¢</div>
                    <div class="detail-value">${(snapshot.liquidation_snapshot.hour_1_amount_wan || 0).toFixed(2)} ä¸‡$</div>
                </div>
            ` : '';
            
            // è¿½è¸ªæ•°æ®
            let trackingHTML = '';
            if (snapshot.tracking && Object.keys(snapshot.tracking).length > 0) {
                trackingHTML = `
                    <table class="tracking-table">
                        <thead>
                            <tr>
                                <th>è¿½è¸ªæ—¶æ®µ</th>
                                <th>æ€»æ¶¨è·Œå¹…</th>
                                <th>è¿½è¸ªæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(snapshot.tracking).map(([period, data]) => {
                                if (!data) return '';
                                const change = data.total_change || 0;
                                const changeClass = change >= 0 ? 'positive' : 'negative';
                                const datetime = data.datetime || '-';
                                const hasCoinsData = data.coins_snapshot && data.coins_snapshot.length > 0;
                                
                                // ç”Ÿæˆå¸ç§è¯¦æƒ…HTML
                                let coinsDetailHTML = '';
                                if (hasCoinsData) {
                                    coinsDetailHTML = `
                                        <tr class="coins-detail-row" id="coins-${snapshot.snapshot_id}-${period}" style="display: none;">
                                            <td colspan="4" style="padding: 15px; background: rgba(0,0,0,0.3);">
                                                <div style="max-height: 400px; overflow-y: auto;">
                                                    <table class="tracking-table" style="margin: 0;">
                                                        <thead>
                                                            <tr>
                                                                <th>å¸ç§</th>
                                                                <th>è§¦å‘æ—¶ä»·æ ¼</th>
                                                                <th>å½“å‰ä»·æ ¼</th>
                                                                <th>ä»·æ ¼å˜åŒ–</th>
                                                                <th>è§¦å‘æ—¶æ—¥æ¶¨è·Œ</th>
                                                                <th>å½“å‰æ—¥æ¶¨è·Œ</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            ${data.coins_snapshot.map(coin => {
                                                                const priceChange = coin.price_change_from_trigger || 0;
                                                                const priceChangeClass = priceChange >= 0 ? 'positive' : 'negative';
                                                                const currentDayChange = coin.current_day_change || 0;
                                                                const currentDayChangeClass = currentDayChange >= 0 ? 'positive' : 'negative';
                                                                const triggerDayChange = coin.trigger_day_change || 0;
                                                                const triggerDayChangeClass = triggerDayChange >= 0 ? 'positive' : 'negative';
                                                                
                                                                return `
                                                                    <tr>
                                                                        <td style="font-weight: 600;">${coin.symbol}</td>
                                                                        <td>$${(coin.trigger_price || 0).toFixed(coin.trigger_price < 1 ? 6 : 2)}</td>
                                                                        <td>$${(coin.current_price || 0).toFixed(coin.current_price < 1 ? 6 : 2)}</td>
                                                                        <td class="${priceChangeClass}">${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}%</td>
                                                                        <td class="${triggerDayChangeClass}">${triggerDayChange >= 0 ? '+' : ''}${triggerDayChange.toFixed(2)}%</td>
                                                                        <td class="${currentDayChangeClass}">${currentDayChange >= 0 ? '+' : ''}${currentDayChange.toFixed(2)}%</td>
                                                                    </tr>
                                                                `;
                                                            }).join('')}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }
                                
                                return `
                                    <tr>
                                        <td><strong>${period}</strong></td>
                                        <td class="${changeClass}">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</td>
                                        <td>${datetime}</td>
                                        <td>
                                            ${hasCoinsData ? `
                                                <button onclick="toggleCoinsDetail('${snapshot.snapshot_id}', '${period}')" 
                                                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                                               color: white; border: none; padding: 5px 12px; 
                                                               border-radius: 6px; cursor: pointer; font-size: 12px; 
                                                               font-weight: 600;">
                                                    æŸ¥çœ‹27å¸è¯¦æƒ…
                                                </button>
                                            ` : '<span style="color: #888;">æ— æ•°æ®</span>'}
                                        </td>
                                    </tr>
                                    ${coinsDetailHTML}
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            // 27ä¸ªå¸çš„è¯¦ç»†ä¿¡æ¯
            let coinsHTML = '';
            if (snapshot.coins_snapshot && snapshot.coins_snapshot.coins && snapshot.coins_snapshot.coins.length > 0) {
                coinsHTML = `
                    <div style="margin-top: 20px;">
                        <h4 style="color: #fff; font-size: 14px; margin-bottom: 10px;">27ä¸ªå¸ç§å¿«ç…§ï¼ˆè§¦å‘æ—¶åˆ»: ${snapshot.coins_snapshot.datetime}ï¼‰</h4>
                        <table class="tracking-table">
                            <thead>
                                <tr>
                                    <th>å¸ç§</th>
                                    <th>å½“å‰ä»·æ ¼</th>
                                    <th>åŸºå‡†ä»·æ ¼</th>
                                    <th>æ¶¨è·Œå¹…</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${snapshot.coins_snapshot.coins.map(coin => {
                                    const changeClass = coin.day_change_percent >= 0 ? 'positive' : 'negative';
                                    const hasPrice = coin.current_price !== undefined && coin.current_price > 0;
                                    return `
                                        <tr>
                                            <td style="font-weight: 600;">${coin.symbol}</td>
                                            <td>${hasPrice ? '$' + coin.current_price.toFixed(coin.current_price < 1 ? 6 : 2) : '-'}</td>
                                            <td>${hasPrice && coin.base_price ? '$' + coin.base_price.toFixed(coin.base_price < 1 ? 6 : 2) : '-'}</td>
                                            <td class="${changeClass}">${coin.day_change_percent >= 0 ? '+' : ''}${coin.day_change_percent.toFixed(2)}%</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            card.innerHTML = `
                <div class="snapshot-header">
                    <div>
                        <div class="snapshot-id">${snapshot.snapshot_id}</div>
                        <div class="snapshot-time">è§¦å‘æ—¶é—´: ${snapshot.trigger_datetime}</div>
                    </div>
                    <span class="snapshot-status ${statusClass}">${statusText}</span>
                </div>
                
                <div class="triggers">
                    ${triggerTags}
                </div>
                
                <div class="snapshot-details">
                    <div class="detail-item">
                        <div class="detail-label">27å¸æ€»æ¶¨è·Œå¹…</div>
                        <div class="detail-value ${totalChangeClass}">${totalChange >= 0 ? '+' : ''}${totalChange.toFixed(2)}%</div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">2hé€ƒé¡¶ä¿¡å·</div>
                        <div class="detail-value">${snapshot.escape_snapshot?.signal_2h_count || 0}</div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">24hé€ƒé¡¶ä¿¡å·</div>
                        <div class="detail-value">${snapshot.escape_snapshot?.signal_24h_count || 0}</div>
                    </div>
                    
                    ${liquidationInfo}
                </div>
                
                ${trackingHTML}
                ${coinsHTML}
            `;
            
            return card;
        }
        
        // ç­›é€‰æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const status = btn.dataset.status;
                currentFilter = status;
                loadSnapshots(status === 'all' ? undefined : status);
            });
        });
        
        // åˆ‡æ¢å¸ç§è¯¦æƒ…æ˜¾ç¤º/éšè—
        function toggleCoinsDetail(snapshotId, period) {
            const detailRow = document.getElementById(`coins-${snapshotId}-${period}`);
            if (detailRow) {
                if (detailRow.style.display === 'none') {
                    detailRow.style.display = 'table-row';
                } else {
                    detailRow.style.display = 'none';
                }
            }
        }
        
        // åˆå§‹åŠ è½½
        loadStats();
        loadSnapshots();
        
        // å®šæ—¶åˆ·æ–°ï¼ˆæ¯30ç§’ï¼‰
        setInterval(() => {
            loadStats();
            loadSnapshots(currentFilter === 'all' ? undefined : currentFilter);
        }, 30000);
    </script>
</body>
</html>
