<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å›¾è¡¨ç®€åŒ–æµ‹è¯•</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.0/echarts.min.js"></script>
    <style>
        body { font-family: Arial; padding: 20px; }
        #log { background: #f5f5f5; padding: 15px; margin: 15px 0; font-family: monospace; font-size: 12px; }
        #chart { width: 100%; height: 500px; border: 2px solid #ddd; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>ç®€åŒ–å›¾è¡¨æµ‹è¯•</h1>
    <button onclick="testSimpleChart()">æµ‹è¯•1: ç®€å•å›¾è¡¨</button>
    <button onclick="testWithRealData()">æµ‹è¯•2: çœŸå®æ•°æ®</button>
    <div id="log"></div>
    <div id="chart"></div>
    
    <script>
        const log = (msg) => {
            const div = document.getElementById('log');
            div.innerHTML += new Date().toLocaleTimeString() + ' - ' + msg + '<br>';
            console.log(msg);
        };
        
        let chart = null;
        
        window.addEventListener('load', () => {
            log('âœ… é¡µé¢åŠ è½½å®Œæˆ');
            const chartDom = document.getElementById('chart');
            chart = echarts.init(chartDom);
            log('âœ… EChartså®ä¾‹åˆ›å»ºæˆåŠŸ');
        });
        
        function testSimpleChart() {
            log('ğŸ¨ æµ‹è¯•ç®€å•å›¾è¡¨...');
            try {
                chart.setOption({
                    title: { text: 'ç®€å•æµ‹è¯•å›¾è¡¨' },
                    xAxis: { type: 'category', data: ['A', 'B', 'C', 'D', 'E'] },
                    yAxis: { type: 'value' },
                    series: [{
                        name: 'æµ‹è¯•',
                        type: 'line',
                        data: [10, 20, 15, 25, 18]
                    }]
                });
                log('âœ… ç®€å•å›¾è¡¨æ¸²æŸ“æˆåŠŸï¼');
            } catch (e) {
                log('âŒ ç®€å•å›¾è¡¨æ¸²æŸ“å¤±è´¥: ' + e.message);
                console.error(e);
            }
        }
        
        async function testWithRealData() {
            log('ğŸ¨ æµ‹è¯•çœŸå®æ•°æ®å›¾è¡¨...');
            try {
                log('ğŸ“¡ è¯·æ±‚API...');
                const response = await fetch('/api/coin-change-tracker/history?limit=100');
                const result = await response.json();
                
                log(`âœ… APIå“åº”: ${result.count}æ¡è®°å½•`);
                
                if (!result.data || result.data.length === 0) {
                    log('âŒ æ²¡æœ‰æ•°æ®');
                    return;
                }
                
                // æå–æ—¶é—´å’Œæ¶¨è·Œå¹…
                const times = result.data.map(d => {
                    const bt = d.beijing_time || '';
                    return bt.split(' ')[1] || bt;
                });
                
                const changes = result.data.map(d => {
                    return d.total_change || 0;
                });
                
                log(`â° times: ${times.length}æ¡`);
                log(`ğŸ“ˆ changes: ${changes.length}æ¡`);
                log(`ğŸ“Š èŒƒå›´: ${Math.min(...changes).toFixed(2)}% ~ ${Math.max(...changes).toFixed(2)}%`);
                
                // æ¸²æŸ“å›¾è¡¨
                log('ğŸ¨ å¼€å§‹æ¸²æŸ“å›¾è¡¨...');
                chart.setOption({
                    title: { text: `çœŸå®æ•°æ®å›¾è¡¨ (${times.length}æ¡)` },
                    tooltip: { trigger: 'axis' },
                    xAxis: { 
                        type: 'category', 
                        data: times,
                        axisLabel: { interval: Math.floor(times.length / 10) }
                    },
                    yAxis: { 
                        type: 'value',
                        name: 'æ¶¨è·Œå¹… (%)'
                    },
                    series: [{
                        name: '27å¸æ¶¨è·Œå¹…',
                        type: 'line',
                        data: changes,
                        smooth: false
                    }]
                }, false, false);  // notMerge=false
                
                log('âœ… çœŸå®æ•°æ®å›¾è¡¨æ¸²æŸ“æˆåŠŸï¼');
                
            } catch (e) {
                log('âŒ çœŸå®æ•°æ®å›¾è¡¨æ¸²æŸ“å¤±è´¥: ' + e.message);
                console.error(e);
            }
        }
    </script>
</body>
</html>
