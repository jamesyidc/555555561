<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€ƒé¡¶ä¿¡å·ç³»ç»Ÿç»Ÿè®¡ - å†å²æ•°æ®æ˜ç»†</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: #ffffff;
            color: #000;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 2px solid rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 36px;
            margin-bottom: 15px;
            text-shadow: none;
            color: #000;
        }
        
        .home-btn {
            padding: 12px 24px;
            background: #f3f4f6;
            backdrop-filter: blur(10px);
            border: 2px solid #d1d5db;
            border-radius: 12px;
            color: #000;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .home-btn:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f9fafb;
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #4ade80;
        }
        
        .stat-card.danger .value {
            color: #ef4444;
        }
        
        .stat-card.warning .value {
            color: #f59e0b;
        }
        
        .chart-container {
            background: #f9fafb;
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            margin-bottom: 30px;
        }
        
        .chart-container h2 {
            margin-bottom: 20px;
            font-size: 20px;
            color: #000;
        }
        
        #trendChart {
            width: 100%;
            height: 400px;
        }
        
        #coinPriceChart {
            width: 100%;
            height: 400px;
        }
        
        .table-container {
            background: #f9fafb;
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            color: #000;
        }
        
        th {
            background: #f3f4f6;
            font-weight: 600;
            color: #000;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background: #f3f4f6;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
        }
        
        .chart-loading {
            text-align: center;
            padding: 180px 20px;
            font-size: 16px;
            color: #666;
        }
        
        .status-normal {
            color: #4ade80;
        }
        
        .status-rising {
            color: #f59e0b;
        }
        
        .status-danger {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <a href="/" class="home-btn">
                <span>ğŸ </span>
                <span>è¿”å›é¦–é¡µ</span>
            </a>
            <a href="/support-resistance" class="home-btn">
                <span>ğŸ“Š</span>
                <span>æ”¯æ’‘å‹åŠ›çº¿ç³»ç»Ÿ</span>
            </a>
        </div>
        
        <div class="header">
            <h1>ğŸ“Š é€ƒé¡¶ä¿¡å·ç³»ç»Ÿç»Ÿè®¡ - å†å²æ•°æ®æ˜ç»†</h1>
            <div id="pageLoadingIndicator" style="margin-top: 15px; padding: 10px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; display: none;">
                <span style="font-size: 16px;">â³ é¡µé¢æ­£åœ¨åŠ è½½æ•°æ®ï¼Œè¯·ç¨å€™...</span>
            </div>
        </div>
        
        <div class="stats-cards">
            <div class="stat-card">
                <h3>æ€»è®°å½•æ•°</h3>
                <div class="value" id="totalRecords">0</div>
            </div>
            <div class="stat-card danger">
                <h3>24å°æ—¶å†å²æå¤§å€¼</h3>
                <div class="value" id="max24h">0</div>
            </div>
            <div class="stat-card warning">
                <h3>24å°æ—¶å³æ—¶æ¬¡é«˜</h3>
                <div class="value" id="max2h">0</div>
            </div>
            <div class="stat-card">
                <h3>24å°æ—¶æ ·æœ¬æ•°</h3>
                <div class="value" id="sample24h">0</div>
            </div>
            <div class="stat-card">
                <h3>24å°æ—¶æ ·æœ¬ä¸­ä½</h3>
                <div class="value" id="median24h">0</div>
            </div>
        </div>
        
        <div class="chart-container">
            <h2>ğŸ“ˆ 27å¸æ¶¨è·Œå¹… & é€ƒé¡¶ä¿¡å·ç»¼åˆè¶‹åŠ¿å›¾ <span style="font-size: 14px; color: #666; font-weight: normal;">(æ—¶é—´è½´å¯¹é½)</span></h2>
            <div id="combinedChart" style="height: 500px;">
                <div class="chart-loading">â³ æ­£åœ¨åŠ è½½æ•°æ®...</div>
            </div>
        </div>
        
        <div class="table-container">
            <h2>ğŸ“‹ å†å²æå€¼ç»Ÿè®¡æ˜ç»† <span style="font-size: 14px; color: #666; font-weight: normal;">(æœ€è¿‘100æ¡)</span></h2>
            <div id="loading" class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
            <table id="dataTable" style="display: none;">
                <thead>
                    <tr>
                        <th>è®°å½•æ—¶é—´</th>
                        <th>24å°æ—¶ä¿¡å·æ•°</th>
                        <th>2å°æ—¶ä¿¡å·æ•°</th>
                        <th>OKX 27å¸æ¶¨è·Œ%</th>
                        <th>ä¸‹è·Œå¼ºåº¦</th>
                        <th>ä¸Šæ¶¨å¼ºåº¦</th>
                        <th>çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
    
    <script>
        let combinedChart = null;
        
        // å¸¦è¶…æ—¶çš„fetchå‡½æ•°
        function fetchWithTimeout(url, timeout = 60000) {
            return new Promise((resolve, reject) => {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    reject(new Error('è¯·æ±‚è¶…æ—¶'));
                }, timeout);
                
                fetch(url, { signal: controller.signal })
                    .then(response => {
                        clearTimeout(timeoutId);
                        resolve(response);
                    })
                    .catch(error => {
                        clearTimeout(timeoutId);
                        reject(error);
                    });
            });
        }
        
        // åˆå§‹åŒ–åˆå¹¶å›¾è¡¨
        function initCombinedChart() {
            const chartDom = document.getElementById('combinedChart');
            // æ¸…é™¤åŠ è½½æç¤º
            chartDom.innerHTML = '';
            combinedChart = echarts.init(chartDom);
            
            const option = {
                backgroundColor: '#ffffff',
                title: {
                    text: 'æ•°æ®ç‚¹: 0',
                    left: 'center',
                    textStyle: { fontSize: 14, color: '#000' }
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    borderColor: 'rgba(0,0,0,0.2)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        let result = `<div style="padding:10px;">
                            <div style="margin-bottom:5px; font-weight:bold;">${params[0].axisValue}</div>`;
                        
                        params.forEach(param => {
                            if (param.seriesName === '27å¸æ¶¨è·Œå¹…æ€»å’Œ') {
                                const value = parseFloat(param.value);
                                const color = value >= 0 ? '#10b981' : '#ef4444';
                                result += `<div style="color:${color}; font-size:14px;">
                                    ${param.marker} ${param.seriesName}: ${value >= 0 ? '+' : ''}${value}%
                                </div>`;
                            } else {
                                result += `<div style="font-size:14px;">
                                    ${param.marker} ${param.seriesName}: ${param.value}
                                </div>`;
                            }
                        });
                        
                        result += '</div>';
                        return result;
                    }
                },
                legend: {
                    data: ['27å¸æ¶¨è·Œå¹…æ€»å’Œ', '24å°æ—¶ä¿¡å·æ•°', '2å°æ—¶ä¿¡å·æ•°'],
                    textStyle: { color: '#000' },
                    top: 10
                },
                grid: {
                    left: '3%',
                    right: '6%',
                    bottom: '10%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: [],
                    axisLabel: {
                        rotate: 45,
                        interval: 'auto',
                        color: '#000'
                    },
                    name: 'æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ UTC+8ï¼‰',
                    nameLocation: 'middle',
                    nameGap: 50,
                    nameTextStyle: { color: '#000' },
                    axisLine: { lineStyle: { color: 'rgba(0,0,0,0.3)' } }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '27å¸æ¶¨è·Œå¹…æ€»å’Œï¼ˆ%ï¼‰',
                        nameTextStyle: { color: '#667eea' },
                        position: 'left',
                        axisLabel: {
                            formatter: '{value}%',
                            color: '#667eea'
                        },
                        axisLine: { lineStyle: { color: '#667eea' } },
                        splitLine: {
                            lineStyle: {
                                type: 'dashed',
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    {
                        type: 'value',
                        name: 'ä¿¡å·æ•°é‡',
                        nameTextStyle: { color: '#ef4444' },
                        position: 'right',
                        axisLabel: {
                            formatter: '{value}',
                            color: '#ef4444'
                        },
                        axisLine: { lineStyle: { color: '#ef4444' } },
                        splitLine: { show: false }
                    }
                ],
                series: [
                    {
                        name: '27å¸æ¶¨è·Œå¹…æ€»å’Œ',
                        type: 'line',
                        yAxisIndex: 0,
                        smooth: true,
                        data: [],
                        lineStyle: { color: '#667eea', width: 2 },
                        itemStyle: { color: '#667eea' },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(102, 126, 234, 0.3)' },
                                    { offset: 1, color: 'rgba(102, 126, 234, 0.05)' }
                                ]
                            }
                        },
                        markLine: {
                            silent: true,
                            data: [{ yAxis: 0 }],
                            lineStyle: {
                                type: 'dashed',
                                color: '#999',
                                width: 1
                            },
                            label: {
                                formatter: '0%'
                            }
                        }
                    },
                    {
                        name: '24å°æ—¶ä¿¡å·æ•°',
                        type: 'line',
                        yAxisIndex: 1,
                        smooth: true,
                        data: [],
                        lineStyle: { color: '#ef4444', width: 2 },
                        itemStyle: { color: '#ef4444' }
                    },
                    {
                        name: '2å°æ—¶ä¿¡å·æ•°',
                        type: 'line',
                        yAxisIndex: 1,
                        smooth: true,
                        data: [],
                        lineStyle: { color: '#f59e0b', width: 2 },
                        itemStyle: { color: '#f59e0b' }
                    }
                ]
            };
            
            combinedChart.setOption(option);
        }
        
        // æ›´æ–°27å¸æ¶¨è·Œå¹…å›¾è¡¨æ•°æ®
        async function loadCoinPriceData() {
            try {
                console.log('ğŸ“¡ å¼€å§‹åŠ è½½27å¸æ•°æ®ï¼ˆæœ€è¿‘3å¤©ï¼‰...');
                // åªåŠ è½½æœ€è¿‘3å¤©çš„æ•°æ®ï¼Œæ›´å¿«
                const response = await fetchWithTimeout('/api/coin-price-tracker/history?days=3&t=' + Date.now(), 10000);
                const result = await response.json();
                
                if (!result.success || !result.data || result.data.length === 0) {
                    console.error('27å¸æ•°æ®åŠ è½½å¤±è´¥');
                    return;
                }
                
                const times = [];
                const values = [];
                
                result.data.forEach(record => {
                    const time = record.collect_time.substring(5, 16); // MM-DD HH:MM
                    times.push(time);
                    
                    let totalSum = record.total_change;
                    if (totalSum === null || totalSum === undefined) {
                        totalSum = 0;
                        const changes = record.day_changes || record.coins || {};
                        Object.values(changes).forEach(coin => {
                            totalSum += (coin.change_pct || 0);
                        });
                    }
                    
                    values.push(totalSum.toFixed(2));
                });
                
                coinPriceChart.setOption({
                    title: {
                        text: `æ•°æ®ç‚¹: ${result.data.length}`
                    },
                    xAxis: {
                        data: times,
                        axisLabel: {
                            interval: Math.floor(times.length / 20)
                        }
                    },
                    series: [{
                        data: values
                    }]
                });
                
                console.log('âœ… 27å¸æ¶¨è·Œå¹…å›¾è¡¨æ•°æ®åŠ è½½å®Œæˆï¼Œå…±', result.data.length, 'æ¡');
                
            } catch (error) {
                console.error('âŒ åŠ è½½27å¸æ•°æ®å¤±è´¥:', error);
                const errorMsg = error.message === 'è¯·æ±‚è¶…æ—¶' ? '27å¸æ•°æ®åŠ è½½è¶…æ—¶ï¼Œæ•°æ®é‡è¾ƒå¤§' : error.message;
                // åœ¨å›¾è¡¨åŒºåŸŸæ˜¾ç¤ºé”™è¯¯
                const chartDom = document.getElementById('coinPriceChart');
                if (chartDom) {
                    chartDom.innerHTML = `
                        <div class="chart-loading" style="color: #ef4444;">
                            âŒ ${errorMsg}
                            <br><br>
                            <button onclick="loadCoinPriceData()" style="padding: 8px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                ğŸ”„ é‡è¯•
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const chartDom = document.getElementById('trendChart');
            // æ¸…é™¤åŠ è½½æç¤º
            chartDom.innerHTML = '';
            chart = echarts.init(chartDom);
            
            const option = {
                backgroundColor: '#ffffff',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    borderColor: 'rgba(0,0,0,0.2)',
                    textStyle: { color: '#fff' }
                },
                legend: {
                    data: ['24å°æ—¶ä¿¡å·æ•°', '2å°æ—¶ä¿¡å·æ•°'],
                    textStyle: { color: '#000' },
                    top: 10
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: [],
                    axisLine: { lineStyle: { color: 'rgba(0,0,0,0.3)' } },
                    axisLabel: { color: '#000', rotate: 45 }
                },
                yAxis: {
                    type: 'value',
                    name: 'ä¿¡å·æ•°é‡',
                    nameTextStyle: { color: '#000' },
                    axisLine: { lineStyle: { color: 'rgba(0,0,0,0.3)' } },
                    axisLabel: { color: '#000' },
                    splitLine: { lineStyle: { color: 'rgba(0,0,0,0.1)' } }
                },
                series: [
                    {
                        name: '24å°æ—¶ä¿¡å·æ•°',
                        type: 'line',
                        data: [],
                        smooth: true,
                        lineStyle: { color: '#ef4444', width: 2 },
                        itemStyle: { color: '#ef4444' },
                        areaStyle: { color: 'rgba(239, 68, 68, 0.2)' }
                    },
                    {
                        name: '2å°æ—¶ä¿¡å·æ•°',
                        type: 'line',
                        data: [],
                        smooth: true,
                        lineStyle: { color: '#f59e0b', width: 2 },
                        itemStyle: { color: '#f59e0b' },
                        areaStyle: { color: 'rgba(245, 158, 11, 0.2)' }
                    }
                ]
            };
            
            chart.setOption(option);
        }
        
        // åŠ è½½æ•°æ®
        function loadData() {
            console.log('ğŸ” å¼€å§‹åŠ è½½æ•°æ®ï¼ˆæœ€è¿‘100æ¡ï¼‰...');
            
            // åŒæ—¶è·å–é€ƒé¡¶ä¿¡å·æ•°æ®ã€ç©ºå•ç›ˆåˆ©æ•°æ®å’ŒOKXæ¶¨è·Œæ•°æ®
            // åªåŠ è½½æœ€è¿‘100æ¡è®°å½•ï¼Œå¤§å¹…æå‡é€Ÿåº¦
            Promise.all([
                fetchWithTimeout('/api/escape-signal-stats?limit=100&v=' + Date.now(), 10000).then(r => r.json()),
                fetchWithTimeout('/api/anchor-profit/latest', 10000).then(r => r.json()),
                fetchWithTimeout('/api/okx-day-change/latest?limit=200&v=' + Date.now(), 10000).then(r => r.json())
            ])
            .then(([escapeResult, profitResult, okxResult]) => {
                console.log('ğŸ“Š è§£æé€ƒé¡¶ä¿¡å·æ•°æ®:', escapeResult);
                console.log('ğŸ’° è§£æç©ºå•ç›ˆåˆ©æ•°æ®:', profitResult);
                console.log('ğŸ“ˆ è§£æOKXæ¶¨è·Œæ•°æ®:', okxResult);
                
                if (!escapeResult.success) {
                    throw new Error('è·å–é€ƒé¡¶ä¿¡å·æ•°æ®å¤±è´¥');
                }
                
                const result = escapeResult;
                const profitData = profitResult.data || [];
                
                // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                document.getElementById('totalRecords').textContent = result.total_count;
                document.getElementById('max24h').textContent = result.max_signal_24h;
                document.getElementById('max2h').textContent = result.max_signal_2h;
                document.getElementById('sample24h').textContent = result.sample_24h_count;
                document.getElementById('median24h').textContent = result.median_24h;
                        
                        // æ›´æ–°å›¾è¡¨
                        const times = result.recent_data.map(d => d.stat_time.substring(5, 16)); // MM-DD HH:MM
                        const signal24h = result.recent_data.map(d => d.signal_24h_count);
                        const signal2h = result.recent_data.map(d => d.signal_2h_count);
                        
                        // è®¡ç®—æ¯ä¸ªè‡ªç„¶æ—¥çš„2hæœ€é«˜ç‚¹ï¼ˆä»…æ ‡è®°>50çš„ï¼‰
                        const dailyPeaks = {};
                        result.recent_data.forEach((d, index) => {
                            const date = d.stat_time.substring(0, 10); // YYYY-MM-DD
                            const value = d.signal_2h_count;
                            
                            if (value > 50) {
                                if (!dailyPeaks[date] || value > dailyPeaks[date].value) {
                                    dailyPeaks[date] = {
                                        index: index,
                                        value: value,
                                        time: d.stat_time
                                    };
                                }
                            }
                        });
                        
                        // è®¡ç®—24å°æ—¶ä¿¡å·çš„48å°æ—¶çª—å£æœ€å¤§å€¼ï¼ˆä»…æ ‡è®°>200çš„ï¼‰
                        const window48hPeaks = [];
                        const windowSize = 48 * 60; // 48å°æ—¶ï¼Œå‡è®¾æ¯åˆ†é’Ÿä¸€ä¸ªæ•°æ®ç‚¹
                        
                        for (let i = 0; i < result.recent_data.length; i++) {
                            // æ‰¾åˆ°å½“å‰ä½ç½®å‰å48å°æ—¶å†…çš„æœ€å¤§å€¼
                            const startIndex = Math.max(0, i - windowSize / 2);
                            const endIndex = Math.min(result.recent_data.length - 1, i + windowSize / 2);
                            
                            let maxValue = 0;
                            let maxIndex = i;
                            
                            for (let j = startIndex; j <= endIndex; j++) {
                                const value = result.recent_data[j].signal_24h_count;
                                if (value > maxValue) {
                                    maxValue = value;
                                    maxIndex = j;
                                }
                            }
                            
                            // å¦‚æœå½“å‰ç‚¹æ˜¯çª—å£å†…çš„æœ€å¤§å€¼ï¼Œä¸”å¤§äº200ï¼Œåˆ™æ ‡è®°
                            if (maxIndex === i && maxValue > 200) {
                                // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨é™„è¿‘æ ‡è®°è¿‡ï¼ˆé¿å…é‡å¤æ ‡è®°ï¼‰
                                const isDuplicate = window48hPeaks.some(p => Math.abs(p.index - i) < windowSize / 4);
                                if (!isDuplicate) {
                                    window48hPeaks.push({
                                        index: i,
                                        value: maxValue,
                                        time: result.recent_data[i].stat_time
                                    });
                                }
                            }
                        }
                        
                        // æ„å»º2hä¿¡å·æ ‡è®°ç‚¹æ•°æ®ï¼ˆçº¢è‰²å°æ ‡è®°ï¼‰
                        const markPointData2h = Object.values(dailyPeaks).map(peak => ({
                            coord: [peak.index, peak.value],
                            value: peak.value,
                            itemStyle: {
                                color: '#ff4444',
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: true,
                                formatter: 'ğŸ”¥ {c}',
                                position: 'top',
                                color: '#ff4444',
                                fontSize: 12,
                                fontWeight: 'bold'
                            }
                        }));
                        
                        // æ„å»º24hä¿¡å·48å°æ—¶å³°å€¼æ ‡è®°ç‚¹æ•°æ®ï¼ˆç´«è‰²å¤§æ ‡è®°ï¼‰
                        const markPointData24h = window48hPeaks.map(peak => ({
                            coord: [peak.index, peak.value],
                            value: peak.value,
                            itemStyle: {
                                color: '#9333ea',
                                borderColor: '#fff',
                                borderWidth: 3
                            },
                            label: {
                                show: true,
                                formatter: 'â­ {c}',
                                position: 'top',
                                color: '#9333ea',
                                fontSize: 14,
                                fontWeight: 'bold'
                            }
                        }));
                        
                        // ğŸ†• æ·»åŠ ç©ºå•ç›ˆåˆ©â‰¥120%å’Œç©ºå•äºæŸçš„æ ‡è®°ï¼ˆæ¯å°æ—¶åªæ ‡è®°ä¸€æ¬¡ï¼‰
                        const shortProfitMarks = [];  // ç©ºå•ç›ˆåˆ©â‰¥120%æ ‡è®°ï¼ˆç»¿è‰²ï¼‰
                        const shortLossMarks = [];    // ç©ºå•äºæŸæ ‡è®°ï¼ˆçº¢è‰²ï¼‰
                        
                        // åˆ›å»ºæ—¶é—´æˆ³æ˜ å°„è¡¨ï¼ˆé€ƒé¡¶ä¿¡å·æ•°æ®çš„æ—¶é—´ -> ç´¢å¼•ï¼‰
                        const timeToIndexMap = {};
                        result.recent_data.forEach((d, index) => {
                            const timestamp = new Date(d.stat_time).getTime();
                            timeToIndexMap[timestamp] = index;
                        });
                        
                        // è¿½è¸ªä¸Šæ¬¡æ ‡è®°çš„å°æ—¶ï¼ˆé¿å…é‡å¤æ ‡è®°ï¼‰
                        let lastShortProfitHour = null;
                        let lastShortLossHour = null;
                        
                        // éå†ç©ºå•ç›ˆåˆ©æ•°æ®ï¼Œæ·»åŠ æ ‡è®°
                        profitData.forEach(pd => {
                            const pdTime = new Date(pd.datetime);
                            const pdHour = pdTime.getFullYear() + '-' + 
                                         String(pdTime.getMonth() + 1).padStart(2, '0') + '-' + 
                                         String(pdTime.getDate()).padStart(2, '0') + ' ' +
                                         String(pdTime.getHours()).padStart(2, '0');
                            
                            const stats = pd.stats?.short || {};
                            const shortProfit120 = stats.gte_120 || 0;
                            const shortLoss = stats.loss || 0;
                            
                            // ç©ºå•ç›ˆåˆ©â‰¥120% ä¸” æ•°é‡â‰¥3ï¼Œæ¯å°æ—¶åªæ ‡è®°ä¸€æ¬¡
                            if (shortProfit120 >= 3 && pdHour !== lastShortProfitHour) {
                                // æ‰¾åˆ°æœ€æ¥è¿‘çš„é€ƒé¡¶ä¿¡å·æ•°æ®ç‚¹
                                const pdTimestamp = pdTime.getTime();
                                let closestIndex = -1;
                                let minDiff = Infinity;
                                
                                result.recent_data.forEach((d, index) => {
                                    const diff = Math.abs(new Date(d.stat_time).getTime() - pdTimestamp);
                                    if (diff < minDiff) {
                                        minDiff = diff;
                                        closestIndex = index;
                                    }
                                });
                                
                                if (closestIndex >= 0 && minDiff < 3600000) { // 1å°æ—¶å†…
                                    const chartData = signal24h[closestIndex] || signal2h[closestIndex] || 0;
                                    shortProfitMarks.push({
                                        coord: [closestIndex, chartData],
                                        value: shortProfit120,
                                        itemStyle: {
                                            color: '#10b981',
                                            borderColor: '#fff',
                                            borderWidth: 2
                                        },
                                        label: {
                                            show: true,
                                            formatter: 'ğŸŸ¢ ' + shortProfit120,
                                            position: 'bottom',
                                            color: '#10b981',
                                            fontSize: 13,
                                            fontWeight: 'bold'
                                        }
                                    });
                                    lastShortProfitHour = pdHour;
                                }
                            }
                            
                            // ç©ºå•äºæŸ ä¸” æ•°é‡â‰¥3ï¼Œæ¯å°æ—¶åªæ ‡è®°ä¸€æ¬¡
                            if (shortLoss >= 3 && pdHour !== lastShortLossHour) {
                                // æ‰¾åˆ°æœ€æ¥è¿‘çš„é€ƒé¡¶ä¿¡å·æ•°æ®ç‚¹
                                const pdTimestamp = pdTime.getTime();
                                let closestIndex = -1;
                                let minDiff = Infinity;
                                
                                result.recent_data.forEach((d, index) => {
                                    const diff = Math.abs(new Date(d.stat_time).getTime() - pdTimestamp);
                                    if (diff < minDiff) {
                                        minDiff = diff;
                                        closestIndex = index;
                                    }
                                });
                                
                                if (closestIndex >= 0 && minDiff < 3600000) { // 1å°æ—¶å†…
                                    const chartData = signal24h[closestIndex] || signal2h[closestIndex] || 0;
                                    shortLossMarks.push({
                                        coord: [closestIndex, chartData],
                                        value: shortLoss,
                                        itemStyle: {
                                            color: '#ef4444',
                                            borderColor: '#fff',
                                            borderWidth: 2
                                        },
                                        label: {
                                            show: true,
                                            formatter: 'ğŸ”´ ' + shortLoss,
                                            position: 'bottom',
                                            color: '#ef4444',
                                            fontSize: 13,
                                            fontWeight: 'bold'
                                        }
                                    });
                                    lastShortLossHour = pdHour;
                                }
                            }
                        });
                        
                        console.log('ğŸŸ¢ ç©ºå•ç›ˆåˆ©â‰¥120%æ ‡è®°:', shortProfitMarks.length, 'ä¸ª');
                        console.log('ğŸ”´ ç©ºå•äºæŸæ ‡è®°:', shortLossMarks.length, 'ä¸ª');
                        
                        // å¤„ç†OKXæ¶¨è·Œæ•°æ® - ä½¿ç”¨æœ€è¿‘é‚»æ’å€¼
                        let okxChangeData = [];
                        if (okxResult && okxResult.success && okxResult.data && okxResult.data.length > 0) {
                            // å°†OKXæ•°æ®è½¬æ¢ä¸ºå¸¦æ—¶é—´æˆ³çš„æ•°ç»„
                            const okxDataArray = okxResult.data.map(d => ({
                                timestamp: new Date(d.record_time).getTime(),
                                value: d.total_change
                            })).sort((a, b) => a.timestamp - b.timestamp);
                            
                            // å¯¹æ¯ä¸ªé€ƒé¡¶ä¿¡å·æ—¶é—´ç‚¹ï¼Œæ‰¾åˆ°æœ€è¿‘çš„OKXæ•°æ®
                            result.recent_data.forEach(d => {
                                const targetTime = new Date(d.stat_time).getTime();
                                
                                // æ‰¾åˆ°æœ€è¿‘çš„OKXæ•°æ®ç‚¹ï¼ˆä½¿ç”¨æœ€è¿‘é‚»æ’å€¼ï¼‰
                                let closestData = null;
                                let minDiff = Infinity;
                                
                                for (const okxPoint of okxDataArray) {
                                    const diff = Math.abs(okxPoint.timestamp - targetTime);
                                    // åªä½¿ç”¨30åˆ†é’Ÿå†…çš„æ•°æ®ç‚¹
                                    if (diff < 30 * 60 * 1000 && diff < minDiff) {
                                        minDiff = diff;
                                        closestData = okxPoint.value;
                                    }
                                }
                                
                                okxChangeData.push(closestData);
                            });
                            
                            console.log('ğŸ“ˆ OKXæ¶¨è·Œæ•°æ®å·²å¯¹é½:', okxChangeData.filter(v => v !== null).length, 'ä¸ªç‚¹');
                        }
                        
                        console.log('ğŸ“ æ¯æ—¥2hæœ€é«˜ç‚¹æ ‡è®°:', markPointData2h.length, 'ä¸ª');
                        console.log('â­ 24hä¿¡å·48å°æ—¶å³°å€¼æ ‡è®°:', markPointData24h.length, 'ä¸ª');
                        
                        const series = [
                            { 
                                name: '24å°æ—¶ä¿¡å·æ•°',
                                data: signal24h,
                                markPoint: {
                                    symbol: 'pin',
                                    symbolSize: 60,
                                    data: [...markPointData24h, ...shortProfitMarks, ...shortLossMarks]
                                }
                            },
                            { 
                                name: '2å°æ—¶ä¿¡å·æ•°',
                                data: signal2h,
                                markPoint: {
                                    symbol: 'pin',
                                    symbolSize: 50,
                                    data: markPointData2h
                                }
                            }
                        ];
                        
                        // å¦‚æœæœ‰OKXæ•°æ®,æ·»åŠ ç¬¬ä¸‰æ¡æ›²çº¿
                        if (okxChangeData.length > 0 && okxChangeData.some(v => v !== null)) {
                            series.push({
                                name: 'OKX 27å¸ç§æ€»æ¶¨è·Œ%',
                                type: 'line',
                                yAxisIndex: 1,  // ä½¿ç”¨å³Yè½´
                                data: okxChangeData,
                                smooth: true,
                                itemStyle: { color: '#8b5cf6' },
                                lineStyle: { width: 3, color: '#8b5cf6' },
                                symbol: 'circle',
                                symbolSize: 6
                            });
                        }
                        
                        // è®¡ç®—OKXæ•°æ®çš„å®é™…èŒƒå›´
                        const validOkxData = okxChangeData.filter(v => v !== null && !isNaN(v));
                        let okxMin = 0, okxMax = 0;
                        if (validOkxData.length > 0) {
                            okxMin = Math.min(...validOkxData);
                            okxMax = Math.max(...validOkxData);
                            // æ·»åŠ 10%çš„è¾¹è·
                            const margin = Math.abs(okxMax - okxMin) * 0.1 || 5;
                            okxMin = okxMin - margin;
                            okxMax = okxMax + margin;
                        }
                        
                        console.log('ğŸ“Š OKXæ•°æ®èŒƒå›´:', { min: okxMin.toFixed(2), max: okxMax.toFixed(2), count: validOkxData.length });
                        
                        chart.setOption({
                            xAxis: { data: times },
                            legend: {
                                data: okxChangeData.length > 0 && okxChangeData.some(v => v !== null) 
                                    ? ['24å°æ—¶ä¿¡å·æ•°', '2å°æ—¶ä¿¡å·æ•°', 'OKX 27å¸ç§æ€»æ¶¨è·Œ%'] 
                                    : ['24å°æ—¶ä¿¡å·æ•°', '2å°æ—¶ä¿¡å·æ•°'],
                                textStyle: { color: '#000' },
                                top: 10
                            },
                            yAxis: [
                                {
                                    type: 'value',
                                    name: 'ä¿¡å·æ•°é‡',
                                    nameTextStyle: { color: '#000' },
                                    axisLine: { lineStyle: { color: 'rgba(0,0,0,0.3)' } },
                                    axisLabel: { color: '#000' },
                                    splitLine: { lineStyle: { color: 'rgba(0,0,0,0.1)' } }
                                },
                                {
                                    type: 'value',
                                    name: 'OKXæ€»æ¶¨è·Œ%',
                                    nameTextStyle: { color: '#8b5cf6' },
                                    position: 'right',
                                    min: validOkxData.length > 0 ? okxMin : undefined,
                                    max: validOkxData.length > 0 ? okxMax : undefined,
                                    axisLine: { 
                                        show: okxChangeData.length > 0 && okxChangeData.some(v => v !== null),
                                        lineStyle: { color: '#8b5cf6' } 
                                    },
                                    axisLabel: { 
                                        color: '#8b5cf6',
                                        formatter: '{value}%'
                                    },
                                    splitLine: { show: false }
                                }
                            ],
                            series: series
                        });
                        
                        // åˆ›å»ºOKXæ•°æ®çš„æ—¶é—´æ˜ å°„è¡¨ï¼ˆç”¨äºè¡¨æ ¼æŸ¥è¯¢ï¼‰
                        const okxDataMap = new Map();
                        if (okxResult && okxResult.success && okxResult.data && okxResult.data.length > 0) {
                            okxResult.data.forEach(d => {
                                const timestamp = new Date(d.record_time).getTime();
                                okxDataMap.set(timestamp, d.total_change);
                            });
                        }
                        
                        // æ›´æ–°è¡¨æ ¼
                        const tbody = document.getElementById('tableBody');
                        tbody.innerHTML = '';
                        
                        console.log('ğŸ”¢ å¼€å§‹æ¸²æŸ“è¡¨æ ¼ï¼Œè®°å½•æ•°:', result.history_data.length);
                        
                        result.history_data.forEach(record => {
                            const row = document.createElement('tr');
                            
                            // åˆ¤æ–­çŠ¶æ€
                            let status = 'æ­£å¸¸';
                            let statusClass = 'status-normal';
                            if (record.signal_24h_count > 600) {
                                status = 'æç«¯é€ƒé¡¶';
                                statusClass = 'status-danger';
                            } else if (record.signal_24h_count > 400) {
                                status = 'ä¸Šæ¶¨é¢„è­¦';
                                statusClass = 'status-rising';
                            }
                            
                            // æŸ¥æ‰¾åŒ¹é…çš„OKXæ•°æ®ï¼ˆ30åˆ†é’Ÿå†…ï¼‰
                            const targetTime = new Date(record.stat_time).getTime();
                            let okxValue = null;
                            let minDiff = Infinity;
                            
                            for (const [timestamp, value] of okxDataMap) {
                                const diff = Math.abs(timestamp - targetTime);
                                if (diff < 30 * 60 * 1000 && diff < minDiff) {
                                    minDiff = diff;
                                    okxValue = value;
                                }
                            }
                            
                            // æ ¼å¼åŒ–OKXæ˜¾ç¤ºï¼ˆæ·»åŠ é¢œè‰²ï¼‰
                            let okxDisplay = '-';
                            let okxClass = '';
                            if (okxValue !== null) {
                                const formattedValue = okxValue.toFixed(2);
                                if (okxValue > 0) {
                                    okxDisplay = `<span style="color: #10b981; font-weight: bold;">+${formattedValue}%</span>`;
                                } else if (okxValue < 0) {
                                    okxDisplay = `<span style="color: #ef4444; font-weight: bold;">${formattedValue}%</span>`;
                                } else {
                                    okxDisplay = `<span style="color: #6b7280;">${formattedValue}%</span>`;
                                }
                            }
                            
                            row.innerHTML = `
                                <td>${record.stat_time}</td>
                                <td>${record.signal_24h_count}</td>
                                <td>${record.signal_2h_count}</td>
                                <td>${okxDisplay}</td>
                                <td>${record.decline_strength_level || '-'}</td>
                                <td>${record.rise_strength_level || '-'}</td>
                                <td class="${statusClass}">${status}</td>
                            `;
                            tbody.appendChild(row);
                        });
                        
                        console.log('âœ… è¡¨æ ¼æ¸²æŸ“å®Œæˆï¼Œå…± ' + result.history_data.length + ' è¡Œ');
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('dataTable').style.display = 'table';
                        console.log('ğŸ“‹ è¡¨æ ¼å·²æ˜¾ç¤º');
                })
                .catch(error => {
                    console.error('âŒ è¯·æ±‚é”™è¯¯:', error);
                    const errorMsg = error.name === 'AbortError' ? 'è¯·æ±‚è¶…æ—¶ï¼Œæ•°æ®é‡è¾ƒå¤§ï¼Œè¯·ç¨åé‡è¯•' : error.message || error.toString();
                    document.getElementById('loading').innerHTML = `
                        <div style="color: #ef4444; font-weight: bold;">æ•°æ®åŠ è½½å¤±è´¥</div>
                        <div style="margin-top: 10px; font-size: 14px;">${errorMsg}</div>
                        <button onclick="location.reload()" style="margin-top: 15px; padding: 8px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ğŸ”„ é‡æ–°åŠ è½½
                        </button>
                    `;
                });
        }
        
        // è¡¨æ ¼æ•°æ®åŠ è½½å‡½æ•°
        async function loadTableData(escapeResult, profitResult, okxResult) {
            // åˆ›å»ºOKXæ•°æ®çš„æ—¶é—´æ˜ å°„è¡¨ï¼ˆç”¨äºè¡¨æ ¼æŸ¥è¯¢ï¼‰
            const okxDataMap = new Map();
            if (okxResult && okxResult.success && okxResult.data && okxResult.data.length > 0) {
                okxResult.data.forEach(d => {
                    const timestamp = new Date(d.record_time).getTime();
                    okxDataMap.set(timestamp, d.total_change);
                });
            }
            
            // æ›´æ–°è¡¨æ ¼
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            console.log('ğŸ”¢ å¼€å§‹æ¸²æŸ“è¡¨æ ¼ï¼Œè®°å½•æ•°:', escapeResult.history_data.length);
            
            escapeResult.history_data.forEach(record => {
                const row = document.createElement('tr');
                
                // åˆ¤æ–­çŠ¶æ€
                let status = 'æ­£å¸¸';
                let statusClass = 'status-normal';
                if (record.signal_24h_count > 600) {
                    status = 'æç«¯é€ƒé¡¶';
                    statusClass = 'status-danger';
                } else if (record.signal_24h_count > 400) {
                    status = 'ä¸Šæ¶¨é¢„è­¦';
                    statusClass = 'status-rising';
                }
                
                // æŸ¥æ‰¾åŒ¹é…çš„OKXæ•°æ®ï¼ˆ30åˆ†é’Ÿå†…ï¼‰
                const targetTime = new Date(record.stat_time).getTime();
                let okxValue = null;
                let minDiff = Infinity;
                
                for (const [timestamp, value] of okxDataMap) {
                    const diff = Math.abs(timestamp - targetTime);
                    if (diff < 30 * 60 * 1000 && diff < minDiff) {
                        minDiff = diff;
                        okxValue = value;
                    }
                }
                
                // æ ¼å¼åŒ–OKXæ˜¾ç¤ºï¼ˆæ·»åŠ é¢œè‰²ï¼‰
                let okxDisplay = '-';
                if (okxValue !== null) {
                    const formattedValue = okxValue.toFixed(2);
                    if (okxValue > 0) {
                        okxDisplay = `<span style="color: #10b981; font-weight: bold;">+${formattedValue}%</span>`;
                    } else if (okxValue < 0) {
                        okxDisplay = `<span style="color: #ef4444; font-weight: bold;">${formattedValue}%</span>`;
                    } else {
                        okxDisplay = `<span style="color: #6b7280;">${formattedValue}%</span>`;
                    }
                }
                
                row.innerHTML = `
                    <td>${record.stat_time}</td>
                    <td>${record.signal_24h_count}</td>
                    <td>${record.signal_2h_count}</td>
                    <td>${okxDisplay}</td>
                    <td>${record.decline_strength_level || '-'}</td>
                    <td>${record.rise_strength_level || '-'}</td>
                    <td class="${statusClass}">${status}</td>
                `;
                tbody.appendChild(row);
            });
            
            console.log('âœ… è¡¨æ ¼æ¸²æŸ“å®Œæˆï¼Œå…± ' + escapeResult.history_data.length + ' è¡Œ');
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dataTable').style.display = 'table';
            console.log('ğŸ“‹ è¡¨æ ¼å·²æ˜¾ç¤º');
        }
        
        // åˆå¹¶æ•°æ®åŠ è½½å‡½æ•°
        async function loadCombinedData() {
            try {
                console.log('ğŸ” å¼€å§‹åŠ è½½åˆå¹¶æ•°æ®...');
                
                // åŒæ—¶åŠ è½½27å¸å’Œé€ƒé¡¶ä¿¡å·æ•°æ®
                const [coinResult, escapeResult, profitResult, okxResult] = await Promise.all([
                    fetchWithTimeout('/api/coin-price-tracker/history?days=3&t=' + Date.now(), 10000).then(r => r.json()),
                    fetchWithTimeout('/api/escape-signal-stats?limit=200&v=' + Date.now(), 10000).then(r => r.json()),
                    fetchWithTimeout('/api/anchor-profit/latest', 10000).then(r => r.json()),
                    fetchWithTimeout('/api/okx-day-change/latest?limit=200&v=' + Date.now(), 10000).then(r => r.json())
                ]);
                
                if (!coinResult.success || !escapeResult.success) {
                    throw new Error('æ•°æ®åŠ è½½å¤±è´¥');
                }
                
                // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                document.getElementById('totalRecords').textContent = escapeResult.total_count;
                document.getElementById('max24h').textContent = escapeResult.max_signal_24h;
                document.getElementById('max2h').textContent = escapeResult.max_signal_2h;
                document.getElementById('sample24h').textContent = escapeResult.sample_24h_count;
                document.getElementById('median24h').textContent = escapeResult.median_24h;
                
                // åˆ›å»ºæ—¶é—´æ˜ å°„ - ä½¿ç”¨27å¸æ•°æ®çš„æ—¶é—´è½´ä½œä¸ºä¸»è½´
                const timeMap = new Map();
                const allTimes = [];
                
                // å…ˆæ·»åŠ 27å¸æ•°æ®
                coinResult.data.forEach(record => {
                    const time = record.collect_time.substring(5, 16); // MM-DD HH:MM
                    const timestamp = new Date(record.collect_time).getTime();
                    
                    let totalSum = record.total_change;
                    if (totalSum === null || totalSum === undefined) {
                        totalSum = 0;
                        const changes = record.day_changes || record.coins || {};
                        Object.values(changes).forEach(coin => {
                            totalSum += (coin.change_pct || 0);
                        });
                    }
                    
                    timeMap.set(timestamp, {
                        time: time,
                        coinChange: parseFloat(totalSum.toFixed(2)),
                        signal24h: null,
                        signal2h: null
                    });
                    allTimes.push(timestamp);
                });
                
                // å¡«å……é€ƒé¡¶ä¿¡å·æ•°æ®ï¼ˆæœ€è¿‘é‚»æ’å€¼ï¼‰
                escapeResult.recent_data.forEach(record => {
                    const timestamp = new Date(record.stat_time).getTime();
                    
                    // æ‰¾åˆ°æœ€è¿‘çš„27å¸æ—¶é—´ç‚¹
                    let closestTime = allTimes[0];
                    let minDiff = Math.abs(timestamp - closestTime);
                    
                    for (const t of allTimes) {
                        const diff = Math.abs(timestamp - t);
                        if (diff < minDiff) {
                            minDiff = diff;
                            closestTime = t;
                        }
                    }
                    
                    // å¦‚æœåœ¨30åˆ†é’Ÿå†…ï¼Œè®¤ä¸ºæ˜¯åŒä¸€ä¸ªæ—¶é—´ç‚¹
                    if (minDiff < 30 * 60 * 1000 && timeMap.has(closestTime)) {
                        const data = timeMap.get(closestTime);
                        data.signal24h = record.signal_24h_count;
                        data.signal2h = record.signal_2h_count;
                    }
                });
                
                // æŒ‰æ—¶é—´æ’åº
                allTimes.sort((a, b) => a - b);
                
                // å‡†å¤‡å›¾è¡¨æ•°æ®
                const times = [];
                const coinChanges = [];
                const signal24h = [];
                const signal2h = [];
                
                allTimes.forEach(timestamp => {
                    const data = timeMap.get(timestamp);
                    times.push(data.time);
                    coinChanges.push(data.coinChange);
                    signal24h.push(data.signal24h);
                    signal2h.push(data.signal2h);
                });
                
                // æ›´æ–°å›¾è¡¨
                combinedChart.setOption({
                    title: {
                        text: `æ•°æ®ç‚¹: ${times.length}`
                    },
                    xAxis: {
                        data: times,
                        axisLabel: {
                            interval: Math.floor(times.length / 20)
                        }
                    },
                    series: [
                        { data: coinChanges },  // 27å¸æ¶¨è·Œå¹…
                        { data: signal24h },    // 24å°æ—¶ä¿¡å·
                        { data: signal2h }      // 2å°æ—¶ä¿¡å·
                    ]
                });
                
                console.log('âœ… åˆå¹¶å›¾è¡¨æ•°æ®åŠ è½½å®Œæˆï¼Œå…±', times.length, 'ä¸ªæ•°æ®ç‚¹');
                console.log('   27å¸æ•°æ®:', coinResult.data.length, 'æ¡');
                console.log('   é€ƒé¡¶ä¿¡å·æ•°æ®:', escapeResult.recent_data.length, 'æ¡');
                
                // åŠ è½½è¡¨æ ¼æ•°æ®ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
                await loadTableData(escapeResult, profitResult, okxResult);
                
            } catch (error) {
                console.error('âŒ åŠ è½½åˆå¹¶æ•°æ®å¤±è´¥:', error);
                const chartDom = document.getElementById('combinedChart');
                if (chartDom) {
                    chartDom.innerHTML = `
                        <div class="chart-loading" style="color: #ef4444;">
                            âŒ ${error.message}
                            <br><br>
                            <button onclick="loadCombinedData()" style="padding: 8px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                ğŸ”„ é‡è¯•
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ˜¾ç¤ºåŠ è½½æç¤º
            const loadingIndicator = document.getElementById('pageLoadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'block';
            }
            
            // åˆå§‹åŒ–åˆå¹¶å›¾è¡¨
            initCombinedChart();
            
            // åŠ è½½åˆå¹¶æ•°æ®
            loadCombinedData().then(() => {
                // æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆï¼Œéšè—æç¤º
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                console.log('âœ… é¡µé¢åŠ è½½å®Œæˆ');
            }).catch(error => {
                console.error('âŒ é¡µé¢åŠ è½½å¤±è´¥:', error);
                if (loadingIndicator) {
                    loadingIndicator.innerHTML = '<span style="color: #ef4444;">âŒ æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</span>';
                }
            });
            
            // æ¯5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°
            setInterval(loadCombinedData, 300000);
        });
        
        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´å›¾è¡¨
        window.addEventListener('resize', function() {
            if (combinedChart) {
                combinedChart.resize();
            }
        });
    </script>
</body>
</html>
