<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>逃顶信号历史 v2.0 - 按天查看</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: #ffffff;
            color: #000;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 2px solid rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 36px;
            margin-bottom: 10px;
            color: #000;
        }
        
        .version {
            font-size: 14px;
            color: #666;
        }
        
        .home-btn {
            padding: 12px 24px;
            background: #f3f4f6;
            border: 2px solid #d1d5db;
            border-radius: 12px;
            color: #000;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .home-btn:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        /* 日期导航栏 */
        .date-navigator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #e5e7eb;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: #fff;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }
        
        .nav-btn:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #9ca3af;
            transform: translateY(-2px);
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #datePicker {
            padding: 10px 15px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: #fff;
        }
        
        .date-info {
            font-size: 18px;
            font-weight: 600;
            color: #000;
        }
        
        /* 日期摘要卡片 */
        .day-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        
        .summary-card .label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 10px;
        }
        
        .summary-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #000;
        }
        
        .summary-card.highlight .value {
            color: #ef4444;
        }
        
        /* 图表容器 */
        .chart-container {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            margin-bottom: 30px;
        }
        
        .chart-container h2 {
            margin-bottom: 20px;
            font-size: 20px;
            color: #000;
        }
        
        #dayChart {
            width: 100%;
            height: 500px;
        }
        
        /* 加载状态 */
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/" class="home-btn">← 返回首页</a>
            <h1>逃顶信号历史 v2.0</h1>
            <div class="version">按天查看模式 | 数据更新：实时</div>
        </div>
        
        <!-- 日期导航 -->
        <div class="date-navigator">
            <button id="prevDay" class="nav-btn">← 前一天</button>
            <input type="date" id="datePicker" value="">
            <button id="nextDay" class="nav-btn">后一天 →</button>
            <span class="date-info" id="dateInfo">加载中...</span>
        </div>
        
        <!-- 日期摘要 -->
        <div class="day-summary" id="daySummary">
            <div class="summary-card">
                <div class="label">记录数</div>
                <div class="value" id="recordCount">-</div>
            </div>
            <div class="summary-card">
                <div class="label">时间范围</div>
                <div class="value" id="timeRange" style="font-size: 18px;">-</div>
            </div>
            <div class="summary-card highlight">
                <div class="label">最大24h信号</div>
                <div class="value" id="maxSignal24h">-</div>
            </div>
            <div class="summary-card">
                <div class="label">最大2h信号</div>
                <div class="value" id="maxSignal2h">-</div>
            </div>
        </div>
        
        <!-- 图表 -->
        <div class="chart-container">
            <h2 id="chartTitle">信号趋势图</h2>
            <div id="dayChart"></div>
        </div>
        
        <div id="loadingMsg" class="loading" style="display: none;">
            正在加载数据...
        </div>
        <div id="errorMsg" class="error" style="display: none;"></div>
    </div>

    <script>
        // 全局变量
        let currentDate = null;
        let availableDates = [];
        let chart = null;
        
        // 初始化
        async function init() {
            // 初始化ECharts
            chart = echarts.init(document.getElementById('dayChart'));
            
            // 加载可用日期列表
            await loadAvailableDates();
            
            // 加载URL中的日期或最新日期
            const urlParams = new URLSearchParams(window.location.search);
            const dateParam = urlParams.get('date');
            
            if (dateParam && availableDates.includes(dateParam)) {
                currentDate = dateParam;
            } else {
                currentDate = availableDates[0];  // 最新日期
            }
            
            // 设置日期选择器
            document.getElementById('datePicker').value = currentDate;
            
            // 加载数据
            await loadDayData(currentDate);
            
            // 绑定事件
            bindEvents();
        }
        
        // 加载可用日期列表
        async function loadAvailableDates() {
            try {
                const response = await fetch('/api/escape-v2/dates');
                const result = await response.json();
                
                if (result.success) {
                    availableDates = result.dates;
                    console.log(`✅ 加载了 ${availableDates.length} 个可用日期`);
                } else {
                    throw new Error(result.error || '获取日期列表失败');
                }
            } catch (error) {
                console.error('❌ 加载日期列表失败:', error);
                showError('加载日期列表失败: ' + error.message);
            }
        }
        
        // 加载指定日期的数据
        async function loadDayData(date) {
            showLoading();
            
            try {
                const response = await fetch(`/api/escape-v2/day-data?date=${date}`);
                const result = await response.json();
                
                if (result.success) {
                    hideLoading();
                    
                    // 更新摘要
                    updateSummary(result.summary);
                    
                    // 更新导航按钮
                    updateNavigation(result.navigation);
                    
                    // 渲染图表
                    renderChart(result.data, date);
                    
                    // 更新URL
                    updateURL(date);
                    
                } else {
                    throw new Error(result.error || '加载数据失败');
                }
            } catch (error) {
                hideLoading();
                console.error('❌ 加载数据失败:', error);
                showError('加载数据失败: ' + error.message);
            }
        }
        
        // 更新摘要信息
        function updateSummary(summary) {
            document.getElementById('recordCount').textContent = summary.total_records || 0;
            document.getElementById('timeRange').textContent = summary.time_range || '-';
            document.getElementById('maxSignal24h').textContent = summary.max_signal_24h || 0;
            document.getElementById('maxSignal2h').textContent = summary.max_signal_2h || 0;
            document.getElementById('dateInfo').textContent = summary.date;
            document.getElementById('chartTitle').textContent = `${summary.date} 信号趋势图 (${summary.total_records}条记录)`;
        }
        
        // 更新导航按钮
        function updateNavigation(navigation) {
            const prevBtn = document.getElementById('prevDay');
            const nextBtn = document.getElementById('nextDay');
            
            prevBtn.disabled = !navigation.prev_date;
            nextBtn.disabled = !navigation.next_date;
            
            prevBtn.onclick = () => {
                if (navigation.prev_date) {
                    currentDate = navigation.prev_date;
                    document.getElementById('datePicker').value = currentDate;
                    loadDayData(currentDate);
                }
            };
            
            nextBtn.onclick = () => {
                if (navigation.next_date) {
                    currentDate = navigation.next_date;
                    document.getElementById('datePicker').value = currentDate;
                    loadDayData(currentDate);
                }
            };
        }
        
        // 渲染图表
        function renderChart(data, date) {
            if (!data || data.length === 0) {
                chart.setOption({
                    title: {
                        text: '暂无数据',
                        left: 'center',
                        top: 'center'
                    }
                });
                return;
            }
            
            // 提取数据
            const times = data.map(d => d.stat_time.split(' ')[1]);  // 只取时间部分
            const signal24h = data.map(d => d.signal_24h_count || 0);
            const signal2h = data.map(d => d.signal_2h_count || 0);
            
            const option = {
                title: {
                    text: `${date} 逃顶信号趋势`,
                    left: 'center',
                    textStyle: {
                        fontSize: 18,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                legend: {
                    data: ['24h信号数', '2h信号数'],
                    top: 40
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    top: '20%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: times,
                    axisLabel: {
                        rotate: 45,
                        interval: Math.floor(times.length / 20)  // 动态间隔
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '信号数量'
                },
                series: [
                    {
                        name: '24h信号数',
                        type: 'line',
                        data: signal24h,
                        smooth: true,
                        lineStyle: {
                            width: 2,
                            color: '#ef4444'
                        },
                        itemStyle: {
                            color: '#ef4444'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(239, 68, 68, 0.3)' },
                                { offset: 1, color: 'rgba(239, 68, 68, 0.05)' }
                            ])
                        }
                    },
                    {
                        name: '2h信号数',
                        type: 'line',
                        data: signal2h,
                        smooth: true,
                        lineStyle: {
                            width: 2,
                            color: '#3b82f6'
                        },
                        itemStyle: {
                            color: '#3b82f6'
                        }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        start: 0,
                        end: 100,
                        height: 30,
                        bottom: 20
                    }
                ]
            };
            
            chart.setOption(option);
        }
        
        // 绑定事件
        function bindEvents() {
            // 日期选择器
            document.getElementById('datePicker').addEventListener('change', (e) => {
                const selectedDate = e.target.value;
                if (availableDates.includes(selectedDate)) {
                    currentDate = selectedDate;
                    loadDayData(currentDate);
                } else {
                    alert('该日期没有数据');
                    e.target.value = currentDate;
                }
            });
            
            // 窗口大小变化时重绘图表
            window.addEventListener('resize', () => {
                if (chart) {
                    chart.resize();
                }
            });
        }
        
        // 更新URL
        function updateURL(date) {
            const newUrl = `${window.location.pathname}?date=${date}`;
            window.history.pushState({ date: date }, '', newUrl);
        }
        
        // 显示加载状态
        function showLoading() {
            document.getElementById('loadingMsg').style.display = 'block';
            document.getElementById('errorMsg').style.display = 'none';
            document.getElementById('daySummary').style.opacity = '0.5';
        }
        
        // 隐藏加载状态
        function hideLoading() {
            document.getElementById('loadingMsg').style.display = 'none';
            document.getElementById('daySummary').style.opacity = '1';
        }
        
        // 显示错误
        function showError(message) {
            document.getElementById('errorMsg').textContent = message;
            document.getElementById('errorMsg').style.display = 'block';
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
