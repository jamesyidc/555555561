<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 30px; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .status-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
        }
        .stat-item.warning { border-left-color: #ff9800; }
        .stat-item.danger { border-left-color: #f44336; }
        .stat-label { font-size: 0.9em; opacity: 0.8; margin-bottom: 5px; }
        .stat-value { font-size: 1.8em; font-weight: bold; }
        .process-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .process-table th, .process-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .process-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }
        .process-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .refresh-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            display: block;
            margin: 20px auto;
            transition: all 0.3s;
        }
        .refresh-btn:hover { background: #45a049; transform: translateY(-2px); }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .alert.danger { background: rgba(244, 67, 54, 0.3); border-left: 4px solid #f44336; }
        .alert.warning { background: rgba(255, 152, 0, 0.3); border-left: 4px solid #ff9800; }
        .alert.info { background: rgba(33, 150, 243, 0.3); border-left: 4px solid #2196F3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç³»ç»Ÿå†…å­˜æ³„æ¼æ£€æµ‹</h1>
        
        <div id="alerts"></div>
        
        <div class="status-card">
            <h2>ğŸ“Š ç³»ç»Ÿå†…å­˜çŠ¶æ€</h2>
            <div class="status-grid">
                <div class="stat-item" id="total-memory">
                    <div class="stat-label">æ€»å†…å­˜</div>
                    <div class="stat-value">-</div>
                </div>
                <div class="stat-item" id="used-memory">
                    <div class="stat-label">å·²ä½¿ç”¨</div>
                    <div class="stat-value">-</div>
                </div>
                <div class="stat-item" id="free-memory">
                    <div class="stat-label">ç©ºé—²</div>
                    <div class="stat-value">-</div>
                </div>
                <div class="stat-item" id="memory-percent">
                    <div class="stat-label">ä½¿ç”¨ç‡</div>
                    <div class="stat-value">-</div>
                </div>
            </div>
        </div>

        <div class="status-card">
            <h2>ğŸ”„ è¿›ç¨‹é‡å¯ç»Ÿè®¡ï¼ˆå¯èƒ½çš„å´©æºƒ/æ³„æ¼ä¿¡å·ï¼‰</h2>
            <table class="process-table" id="restart-table">
                <thead>
                    <tr>
                        <th>è¿›ç¨‹å</th>
                        <th>é‡å¯æ¬¡æ•°</th>
                        <th>å†…å­˜å ç”¨</th>
                        <th>è¿è¡Œæ—¶é•¿</th>
                        <th>çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="status-card">
            <h2>ğŸ’¾ å†…å­˜å ç”¨æ’è¡Œï¼ˆTOP 10ï¼‰</h2>
            <table class="process-table" id="memory-table">
                <thead>
                    <tr>
                        <th>è¿›ç¨‹å</th>
                        <th>å†…å­˜å ç”¨</th>
                        <th>CPUå ç”¨</th>
                        <th>PID</th>
                        <th>è¿è¡Œæ—¶é•¿</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <button class="refresh-btn" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        
        <div class="status-card">
            <h2>ğŸ“ æ£€æµ‹è¯´æ˜</h2>
            <ul style="line-height: 2; margin-left: 20px;">
                <li><strong>é‡å¯æ¬¡æ•°è¿‡å¤š</strong>ï¼šå¦‚æœæŸä¸ªè¿›ç¨‹é‡å¯æ¬¡æ•°è¶…è¿‡50æ¬¡ï¼Œå¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼æˆ–å´©æºƒé—®é¢˜</li>
                <li><strong>å†…å­˜å ç”¨å¼‚å¸¸</strong>ï¼šFlaskåº”ç”¨æ­£å¸¸å†…å­˜åº”åœ¨50-150MBï¼Œè¶…è¿‡200MBéœ€è¦å…³æ³¨</li>
                <li><strong>å†…å­˜å¢é•¿è¶‹åŠ¿</strong>ï¼šå®šæœŸåˆ·æ–°æ­¤é¡µé¢ï¼Œè§‚å¯Ÿå†…å­˜å ç”¨æ˜¯å¦æŒç»­å¢é•¿</li>
                <li><strong>ç³»ç»Ÿå†…å­˜ä¸è¶³</strong>ï¼šå½“å¯ç”¨å†…å­˜ä½äº1GBæ—¶ï¼Œç³»ç»Ÿå¯èƒ½ä¼šè§¦å‘OOM Killer</li>
            </ul>
        </div>
    </div>

    <script>
        async function loadData() {
            try {
                // è·å–ç³»ç»Ÿå†…å­˜ä¿¡æ¯
                const memResponse = await fetch('/api/system/memory');
                const memData = await memResponse.json();
                
                // æ›´æ–°å†…å­˜æ˜¾ç¤º
                updateMemoryDisplay(memData);
                
                // è·å–è¿›ç¨‹ä¿¡æ¯
                const procResponse = await fetch('/api/system/processes');
                const procData = await procResponse.json();
                
                // æ›´æ–°è¡¨æ ¼
                updateRestartTable(procData.restart_stats);
                updateMemoryTable(procData.memory_stats);
                
                // æ˜¾ç¤ºè­¦å‘Š
                showAlerts(memData, procData);
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        function updateMemoryDisplay(data) {
            const totalMem = document.querySelector('#total-memory .stat-value');
            const usedMem = document.querySelector('#used-memory .stat-value');
            const freeMem = document.querySelector('#free-memory .stat-value');
            const percentMem = document.querySelector('#memory-percent .stat-value');
            
            totalMem.textContent = data.total;
            usedMem.textContent = data.used;
            freeMem.textContent = data.free;
            percentMem.textContent = data.percent + '%';
            
            // æ ¹æ®ä½¿ç”¨ç‡è°ƒæ•´é¢œè‰²
            const usedItem = document.getElementById('used-memory');
            const percentItem = document.getElementById('memory-percent');
            if (data.percent > 80) {
                usedItem.classList.add('danger');
                percentItem.classList.add('danger');
            } else if (data.percent > 60) {
                usedItem.classList.add('warning');
                percentItem.classList.add('warning');
            }
        }

        function updateRestartTable(data) {
            const tbody = document.querySelector('#restart-table tbody');
            tbody.innerHTML = '';
            
            data.sort((a, b) => b.restarts - a.restarts).slice(0, 10).forEach(proc => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${proc.name}</td>
                    <td style="color: ${proc.restarts > 50 ? '#f44336' : proc.restarts > 10 ? '#ff9800' : '#4CAF50'}">${proc.restarts}</td>
                    <td>${proc.memory}</td>
                    <td>${proc.uptime}</td>
                    <td style="color: ${proc.status === 'online' ? '#4CAF50' : '#f44336'}">${proc.status}</td>
                `;
            });
        }

        function updateMemoryTable(data) {
            const tbody = document.querySelector('#memory-table tbody');
            tbody.innerHTML = '';
            
            data.sort((a, b) => parseFloat(b.memory) - parseFloat(a.memory)).slice(0, 10).forEach(proc => {
                const row = tbody.insertRow();
                const memValue = parseFloat(proc.memory);
                row.innerHTML = `
                    <td>${proc.name}</td>
                    <td style="color: ${memValue > 150 ? '#f44336' : memValue > 100 ? '#ff9800' : '#4CAF50'}">${proc.memory}</td>
                    <td>${proc.cpu}%</td>
                    <td>${proc.pid}</td>
                    <td>${proc.uptime}</td>
                `;
            });
        }

        function showAlerts(memData, procData) {
            const alertsDiv = document.getElementById('alerts');
            alertsDiv.innerHTML = '';
            
            // æ£€æŸ¥å†…å­˜ä½¿ç”¨ç‡
            if (memData.percent > 80) {
                alertsDiv.innerHTML += `
                    <div class="alert danger">
                        ğŸš¨ <strong>ä¸¥é‡è­¦å‘Š</strong>ï¼šç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡è¾¾åˆ° ${memData.percent}%ï¼Œå¯èƒ½è§¦å‘OOM Killerï¼
                    </div>
                `;
            } else if (memData.percent > 60) {
                alertsDiv.innerHTML += `
                    <div class="alert warning">
                        âš ï¸ <strong>è­¦å‘Š</strong>ï¼šç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡è¾¾åˆ° ${memData.percent}%ï¼Œéœ€è¦å…³æ³¨ã€‚
                    </div>
                `;
            }
            
            // æ£€æŸ¥é‡å¯æ¬¡æ•°
            const highRestarts = procData.restart_stats.filter(p => p.restarts > 50);
            if (highRestarts.length > 0) {
                alertsDiv.innerHTML += `
                    <div class="alert warning">
                        âš ï¸ <strong>å‘ç°å¼‚å¸¸é‡å¯</strong>ï¼šä»¥ä¸‹è¿›ç¨‹é‡å¯æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½å­˜åœ¨å´©æºƒæˆ–æ³„æ¼é—®é¢˜ï¼š<br>
                        ${highRestarts.map(p => `${p.name} (${p.restarts}æ¬¡)`).join(', ')}
                    </div>
                `;
            }
            
            // æ£€æŸ¥é«˜å†…å­˜å ç”¨
            const highMemory = procData.memory_stats.filter(p => parseFloat(p.memory) > 150);
            if (highMemory.length > 0) {
                alertsDiv.innerHTML += `
                    <div class="alert info">
                        â„¹ï¸ <strong>é«˜å†…å­˜å ç”¨</strong>ï¼šä»¥ä¸‹è¿›ç¨‹å†…å­˜å ç”¨è¾ƒé«˜ï¼š<br>
                        ${highMemory.map(p => `${p.name} (${p.memory})`).join(', ')}
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–æ•°æ®
        loadData();
        
        // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
        setInterval(loadData, 30000);
    </script>
</body>
</html>
