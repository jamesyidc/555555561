<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKXäº¤æ˜“æ ‡è®°ç³»ç»Ÿ V3.1 - è§’åº¦æ ‡è®°ä¼˜åŒ– âš¡ æ€§èƒ½ä¼˜åŒ–V2.0</title>
    
    <!-- å¼ºåˆ¶åˆ·æ–°ç¼“å­˜ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js?v={{ cache_bust }}"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
                'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 28px;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .home-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .home-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
        }

        .date-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .nav-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .date-display {
            padding: 8px 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-weight: 600;
            color: #667eea;
            font-size: 16px;
        }

        .date-input {
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
        }

        /* è¯´æ˜æ–‡æ¡£æ¡†æ ·å¼ */
        .info-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-top: 15px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .info-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.3s;
        }

        .info-header:hover {
            background: linear-gradient(135deg, #5568d3 0%, #654a8c 100%);
        }

        .info-header-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-toggle {
            font-size: 20px;
            transition: transform 0.3s;
        }

        .info-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .info-content {
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .info-content.collapsed {
            max-height: 0;
            padding: 0 20px;
            overflow: hidden;
        }

        .info-section {
            margin-bottom: 20px;
        }

        .info-section:last-child {
            margin-bottom: 0;
        }

        .info-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }

        .info-list {
            list-style: none;
            padding-left: 0;
        }

        .info-list li {
            padding: 8px 0;
            color: #4a5568;
            line-height: 1.6;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .info-list li::before {
            content: "â–¸";
            color: #667eea;
            font-weight: bold;
            flex-shrink: 0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .info-card {
            background: #f7fafc;
            border-radius: 8px;
            padding: 12px;
            border-left: 4px solid #667eea;
        }

        .info-card-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .info-card-content {
            color: #718096;
            font-size: 13px;
            line-height: 1.5;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
        }

        #mainChart {
            width: 100%;
            height: 600px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .stat-label {
            font-size: 13px;
            color: #718096;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
        }

        .trade-list-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .trade-list-title {
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .trade-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .trade-table th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
        }

        .trade-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .trade-table tr:hover {
            background: #f7fafc;
        }

        .trade-type {
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 12px;
            display: inline-block;
        }

        .long-buy {
            background: #fed7d7;
            color: #c53030;
        }

        .long-sell {
            background: #c6f6d5;
            color: #2f855a;
        }

        .short-buy {
            background: #feebc8;
            color: #c05621;
        }

        .short-sell {
            background: #bee3f8;
            color: #2c5282;
        }

        .merged-badge {
            background: #edf2f7;
            color: #4a5568;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 11px;
            margin-left: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>
                <span>ğŸ“Š OKXäº¤æ˜“æ ‡è®°ç³»ç»Ÿ V3.0 âš¡ <span style="color: #16a34a;">æ€§èƒ½ä¼˜åŒ–V2.0ï¼šåŠ è½½æå‡91.6% (10sâ†’0.8s)</span></span>
                <a href="/" class="home-btn">
                    ğŸ  è¿”å›é¦–é¡µ
                </a>
            </h1>
            <p style="color: #718096; margin-top: 5px;">ä¸»è´¦æˆ·äº¤æ˜“å†å² Â· 2åˆ†é’Ÿå†…è‡ªåŠ¨åˆå¹¶</p>
            
            <!-- æ—¥æœŸå¯¼èˆª -->
            <div class="date-navigation">
                <button class="nav-btn" onclick="previousDay()">â—€ å‰ä¸€å¤©</button>
                <div class="date-display" id="currentDateDisplay">2026-02-10</div>
                <button class="nav-btn" onclick="nextDay()">åä¸€å¤© â–¶</button>
                <input type="date" id="dateSelector" class="date-input" onchange="selectDate()">
                <button class="nav-btn" onclick="loadTodayData()">ä»Šå¤©</button>
            </div>

            <!-- è¯´æ˜æ–‡æ¡£é¢æ¿ -->
            <div class="info-panel">
                <div class="info-header" onclick="toggleInfoPanel()">
                    <div class="info-header-title">
                        <span>ğŸ“–</span>
                        <span>ç³»ç»Ÿè¯´æ˜æ–‡æ¡£</span>
                    </div>
                    <span class="info-toggle" id="infoToggle">â–¼</span>
                </div>
                <div class="info-content collapsed" id="infoContent">
                    <!-- å›¾è¡¨æ ‡è®°è¯´æ˜ -->
                    <div class="info-section">
                        <div class="info-section-title">ğŸ“Š å›¾è¡¨æ ‡è®°è¯´æ˜</div>
                        <div class="info-grid">
                            <div class="info-card">
                                <div class="info-card-title">ğŸ”º è§’åº¦æ ‡è®°ï¼ˆå³°å€¼/è°·åº•ï¼‰</div>
                                <div class="info-card-content">
                                    <strong>ä¸Šå‡è§’åº¦ï¼š</strong><br>
                                    ğŸ”º çº¢è‰²ä¸‰è§’å½¢ = ä¸Šå‡é”è§’ï¼ˆ< 45Â°ï¼‰<br>
                                    ğŸŸ§ æ©™è‰²æ–¹å— = ä¸Šå‡é’è§’ï¼ˆâ‰¥ 45Â°ï¼‰<br><br>
                                    <strong>ä¸‹é™è§’åº¦ï¼š</strong><br>
                                    ğŸ”» è“è‰²å€’ä¸‰è§’ = ä¸‹é™é”è§’ï¼ˆ< 45Â°ï¼‰<br>
                                    ğŸ’ ç´«è‰²è±å½¢ = ä¸‹é™é’è§’ï¼ˆâ‰¥ 45Â°ï¼‰
                                </div>
                            </div>
                            <div class="info-card">
                                <div class="info-card-title">ğŸ¯ äº¤æ˜“æ ‡è®°</div>
                                <div class="info-card-content">
                                    ğŸ”´ çº¢è‰²åœ†åœˆ = å¤šå•å¼€ä»“<br>
                                    ğŸŸ¢ ç»¿è‰²åœ†åœˆ = å¤šå•å¹³ä»“<br>
                                    ğŸŸ  æ©™è‰²è±å½¢ = ç©ºå•å¼€ä»“<br>
                                    ğŸ”µ è“è‰²è±å½¢ = ç©ºå•å¹³ä»“<br><br>
                                    <em>* 2åˆ†é’Ÿå†…çš„äº¤æ˜“è‡ªåŠ¨åˆå¹¶æ˜¾ç¤º</em>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ•°æ®æ¥æº -->
                    <div class="info-section">
                        <div class="info-section-title">ğŸ“ æ•°æ®æ¥æºä¸å­˜å‚¨</div>
                        <ul class="info-list">
                            <li><strong>è¶‹åŠ¿æ•°æ®ï¼š</strong>data/coin_change_tracker/coin_change_YYYYMMDD.jsonl - 27å¸ç§ç´¯è®¡æ¶¨è·Œå¹…ï¼Œæ¯5åˆ†é’Ÿæ›´æ–°</li>
                            <li><strong>è§’åº¦æ•°æ®ï¼š</strong>data/okx_angle_analysis/okx_angles_YYYYMMDD.jsonl - å³°å€¼/è°·åº•è§’åº¦åˆ†æ</li>
                            <li><strong>äº¤æ˜“å†å²ï¼š</strong>data/okx_trading_history/okx_trades_YYYYMMDD.jsonl - OKXä¸»è´¦æˆ·æˆäº¤è®°å½•ï¼ˆSWAP+SPOTï¼‰ï¼Œæ¯5åˆ†é’Ÿè‡ªåŠ¨é‡‡é›† <span style="color: #48bb78; font-weight: bold;">â­ å®æ—¶é‡‡é›†</span></li>
                            <li><strong>äº¤æ˜“è¯„ä»·ï¼š</strong>data/trade_ratings/ - äººå·¥æ ‡è®°çš„äº¤æ˜“è¯„çº§æ•°æ®</li>
                        </ul>
                        <div style="margin-top: 10px; padding: 10px; background: #f0fff4; border-left: 4px solid #48bb78; border-radius: 4px;">
                            <strong style="color: #2f855a;">ğŸ’¡ äº¤æ˜“æ•°æ®é‡‡é›†è¯´æ˜ï¼š</strong>
                            <ul style="margin: 5px 0 0 20px; color: #2d3748;">
                                <li>é‡‡é›†å™¨è¿›ç¨‹ï¼š<code>okx-trade-history</code> (PM2æ‰˜ç®¡)</li>
                                <li>é‡‡é›†é—´éš”ï¼šæ¯5åˆ†é’Ÿè‡ªåŠ¨ä»OKX APIè·å–æœ€æ–°100ç¬”æˆäº¤</li>
                                <li>æ•°æ®æ ¼å¼ï¼šJSONLï¼ˆæ¯è¡Œä¸€ä¸ªJSONå¯¹è±¡ï¼‰ï¼ŒæŒ‰æ—¥æœŸåˆ†æ–‡ä»¶</li>
                                <li>å»é‡æœºåˆ¶ï¼šåŸºäºtradeIdè‡ªåŠ¨å»é‡ï¼Œé¿å…é‡å¤ä¿å­˜</li>
                                <li>æ•°æ®ç±»å‹ï¼šæ°¸ç»­åˆçº¦(SWAP) + ç°è´§(SPOT)</li>
                            </ul>
                        </div>
                    </div>

                    <!-- APIæ¥å£ -->
                    <div class="info-section">
                        <div class="info-section-title">ğŸ”Œ APIæ¥å£è¯´æ˜</div>
                        <ul class="info-list">
                            <li><code>/api/coin-change-tracker/history?date=YYYYMMDD&limit=1440</code> - è·å–è¶‹åŠ¿å†å²æ•°æ®</li>
                            <li><code>/api/okx-trading/angles?date=YYYYMMDD</code> - è·å–è§’åº¦åˆ†ææ•°æ®</li>
                            <li><code>/api/okx-trading/trade-history</code> - è·å–äº¤æ˜“å†å²ï¼ˆPOSTï¼Œéœ€è¦æ—¥æœŸèŒƒå›´ï¼‰</li>
                            <li><code>/api/okx-trading/trade-ratings?date=YYYY-MM-DD</code> - è·å–äº¤æ˜“è¯„ä»·æ•°æ®</li>
                        </ul>
                    </div>

                    <!-- åŠŸèƒ½ç‰¹æ€§ -->
                    <div class="info-section">
                        <div class="info-section-title">âœ¨ æ ¸å¿ƒåŠŸèƒ½</div>
                        <div class="info-grid">
                            <div class="info-card">
                                <div class="info-card-title">ğŸ“… æ—¥æœŸå¯¼èˆª</div>
                                <div class="info-card-content">
                                    æ”¯æŒå‰åç¿»é¡µã€æ—¥æœŸé€‰æ‹©å™¨ã€å¿«é€Ÿè¿”å›ä»Šå¤©ï¼Œå¯æŸ¥çœ‹å†å²æ•°æ®
                                </div>
                            </div>
                            <div class="info-card">
                                <div class="info-card-title">ğŸ”„ è‡ªåŠ¨åˆå¹¶</div>
                                <div class="info-card-content">
                                    2åˆ†é’Ÿå†…çš„äº¤æ˜“è‡ªåŠ¨åˆå¹¶ï¼Œé¿å…æ ‡è®°é‡å ï¼Œä¿æŒå›¾è¡¨æ¸…æ™°
                                </div>
                            </div>
                            <div class="info-card">
                                <div class="info-card-title">ğŸ“ è§’åº¦æ ‡è®°</div>
                                <div class="info-card-content">
                                    è‡ªåŠ¨è¯†åˆ«å³°å€¼/è°·åº•ï¼ŒåŒºåˆ†é”è§’/é’è§’ï¼Œæä¾›è§’åº¦å€¼å’Œæ—¶æ®µä¿¡æ¯
                                </div>
                            </div>
                            <div class="info-card">
                                <div class="info-card-title">ğŸ“Š äº¤æ˜“è¯„çº§</div>
                                <div class="info-card-content">
                                    æ”¯æŒA+/A/B/Cç­‰çº§æ ‡è®°ï¼Œç‚¹å‡»æ ‡è®°å¯æŸ¥çœ‹è¯¦æƒ…ï¼Œå¸®åŠ©åˆ†æäº¤æ˜“è´¨é‡
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ“ä½œæç¤º -->
                    <div class="info-section">
                        <div class="info-section-title">ğŸ’¡ æ“ä½œæç¤º</div>
                        <ul class="info-list">
                            <li><strong>é¼ æ ‡æ‚¬åœï¼š</strong>åœ¨å›¾è¡¨ä¸Šç§»åŠ¨é¼ æ ‡ï¼Œå¯æŸ¥çœ‹è¯¦ç»†æ—¶é—´ç‚¹å’Œæ•°å€¼ä¿¡æ¯</li>
                            <li><strong>å·¦é”®ç‚¹å‡»æ ‡è®°ï¼š</strong>ç‚¹å‡»äº¤æ˜“æ ‡è®°å¯æŸ¥çœ‹è¯¥ç¬”äº¤æ˜“çš„è¯¦ç»†ä¿¡æ¯å’Œè¯„çº§</li>
                            <li><strong>ğŸ–±ï¸ å³é”®åˆ é™¤è§’åº¦ï¼š</strong>åœ¨è§’åº¦æ ‡è®°ä¸Šç‚¹å‡»é¼ æ ‡<span style="color: #e53e3e; font-weight: bold;">å³é”®</span>å¯åˆ é™¤è¯¥è§’åº¦ï¼ˆæ”¯æŒåˆ é™¤ç³»ç»Ÿå’Œæ‰‹åŠ¨æ·»åŠ çš„è§’åº¦ï¼Œç”¨äºçº æ­£è¯†åˆ«é”™è¯¯ï¼‰</li>
                            <li><strong>è§’åº¦è¯¦æƒ…ï¼š</strong>é¼ æ ‡æ‚¬åœåœ¨è§’åº¦æ ‡è®°ä¸Šå¯æŸ¥çœ‹è§’åº¦å€¼ã€å³°å€¼æ—¶é—´ã€ä»·æ ¼å˜åŒ–ç­‰è¯¦ç»†ä¿¡æ¯</li>
                            <li><strong>æ—¥æœŸåˆ‡æ¢ï¼š</strong>åˆ‡æ¢æ—¥æœŸåä¼šè‡ªåŠ¨é‡æ–°åŠ è½½å¯¹åº”æ—¥æœŸçš„æ‰€æœ‰æ•°æ®</li>
                            <li><strong>å¼ºåˆ¶åˆ·æ–°ï¼š</strong>å¦‚æœæ•°æ®æœªæ›´æ–°ï¼Œè¯·ä½¿ç”¨ Ctrl+F5 (Windows) æˆ– Cmd+Shift+R (Mac) å¼ºåˆ¶åˆ·æ–°</li>
                        </ul>
                    </div>

                    <!-- æŠ€æœ¯æ¶æ„ -->
                    <div class="info-section">
                        <div class="info-section-title">âš™ï¸ æŠ€æœ¯æ¶æ„</div>
                        <div class="info-grid">
                            <div class="info-card">
                                <div class="info-card-title">åç«¯æœåŠ¡</div>
                                <div class="info-card-content">
                                    Flask (Python) - æä¾›RESTful API<br>
                                    PM2è¿›ç¨‹ç®¡ç† - ä¿è¯æœåŠ¡ç¨³å®šè¿è¡Œ
                                </div>
                            </div>
                            <div class="info-card">
                                <div class="info-card-title">æ•°æ®é‡‡é›†</div>
                                <div class="info-card-content">
                                    å¸ä»·è¿½è¸ªå™¨ - æ¯5åˆ†é’Ÿé‡‡é›†27å¸ç§æ•°æ®<br>
                                    äº¤æ˜“å†å²é‡‡é›†å™¨ - æ¯5åˆ†é’Ÿé‡‡é›†ä¸»è´¦æˆ·æˆäº¤è®°å½• â­ NEW<br>
                                    è§’åº¦åˆ†æå™¨ - è‡ªåŠ¨åˆ†æå³°å€¼/è°·åº•
                                </div>
                            </div>
                            <div class="info-card">
                                <div class="info-card-title">å‰ç«¯å±•ç¤º</div>
                                <div class="info-card-content">
                                    ECharts 5.4.3 - ä¸“ä¸šå›¾è¡¨åº“<br>
                                    å“åº”å¼è®¾è®¡ - æ”¯æŒå¤šç§å±å¹•å°ºå¯¸
                                </div>
                            </div>
                            <div class="info-card">
                                <div class="info-card-title">æ•°æ®å­˜å‚¨</div>
                                <div class="info-card-content">
                                    JSONLæ ¼å¼ - ä¾¿äºè¿½åŠ å’Œè¯»å–<br>
                                    æŒ‰æ—¥æœŸåˆ†æ–‡ä»¶ - æ–¹ä¾¿ç®¡ç†å’Œå¤‡ä»½
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç³»ç»Ÿä¾èµ– -->
                    <div class="info-section">
                        <div class="info-section-title">ğŸ“¦ ç³»ç»Ÿå®Œæ•´ä¾èµ–æ¸…å•ï¼ˆé‡æ–°éƒ¨ç½²å¿…å¤‡ï¼‰</div>
                        
                        <div style="padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; margin-bottom: 20px; color: #856404;">
                            <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong>ä»¥ä¸‹æ‰€æœ‰ä¾èµ–éƒ½æ˜¯ç³»ç»Ÿæ­£å¸¸è¿è¡Œçš„å¿…éœ€ç»„ä»¶ï¼Œç¼ºå°‘ä»»ä½•ä¸€é¡¹éƒ½å¯èƒ½å¯¼è‡´åŠŸèƒ½å¼‚å¸¸ã€‚é‡æ–°éƒ¨ç½²æ—¶è¯·é€é¡¹æ£€æŸ¥ç¡®è®¤ã€‚
                        </div>
                        
                        <!-- Pythonä¾èµ– -->
                        <div class="info-card" style="margin-bottom: 15px;">
                            <div class="info-card-title">ğŸ Python ç¯å¢ƒä¾èµ–ï¼ˆå¿…éœ€ Python 3.8+ï¼‰</div>
                            <div class="info-card-content">
                                <strong style="color: #2563eb;">1. æ ¸å¿ƒWebæ¡†æ¶ï¼š</strong><br>
                                â€¢ <code>Flask==3.1.2</code> - Python Webæ¡†æ¶ï¼Œæä¾›HTTPæœåŠ¡<br>
                                â€¢ <code>Flask-CORS==4.0.0</code> - è·¨åŸŸèµ„æºå…±äº«æ”¯æŒ<br>
                                â€¢ <code>Flask-Compress==1.23</code> - HTTPå“åº”å‹ç¼©<br><br>
                                
                                <strong style="color: #2563eb;">2. æ•°æ®å¤„ç†åº“ï¼š</strong><br>
                                â€¢ <code>pandas==2.2.3</code> - æ•°æ®åˆ†æå’Œå¤„ç†<br>
                                â€¢ <code>numpy==1.26.4</code> - æ•°å€¼è®¡ç®—åº“<br>
                                â€¢ <code>pytz</code> - æ—¶åŒºå¤„ç†ï¼ˆåŒ—äº¬æ—¶é—´è½¬æ¢ï¼‰<br><br>
                                
                                <strong style="color: #2563eb;">3. HTTPè¯·æ±‚åº“ï¼š</strong><br>
                                â€¢ <code>requests==2.32.4</code> - HTTPè¯·æ±‚åº“<br>
                                â€¢ <code>requests-oauthlib==2.0.0</code> - OAuthè®¤è¯æ”¯æŒ<br><br>
                                
                                <strong style="color: #2563eb;">4. åŠ å¯†è´§å¸äº¤æ˜“æ‰€APIï¼š</strong><br>
                                â€¢ <code>ccxt==4.0.0</code> - ç»Ÿä¸€çš„åŠ å¯†è´§å¸äº¤æ˜“æ‰€APIï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰<br><br>
                                
                                <strong style="color: #2563eb;">5. OKX APIç­¾åï¼ˆå†…ç½®ï¼‰ï¼š</strong><br>
                                â€¢ <code>hmac</code> - HMACç­¾åï¼ˆPythonæ ‡å‡†åº“ï¼‰<br>
                                â€¢ <code>hashlib</code> - SHA256å“ˆå¸Œï¼ˆPythonæ ‡å‡†åº“ï¼‰<br>
                                â€¢ <code>base64</code> - Base64ç¼–ç ï¼ˆPythonæ ‡å‡†åº“ï¼‰<br><br>
                                
                                <strong style="color: #16a34a;">ğŸ“¥ ä¸€é”®å®‰è£…å‘½ä»¤ï¼š</strong><br>
                                <code style="display: block; background: #f3f4f6; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                pip3 install Flask==3.1.2 Flask-CORS==4.0.0 Flask-Compress==1.23 pandas==2.2.3 numpy==1.26.4 requests==2.32.4 requests-oauthlib==2.0.0 pytz ccxt==4.0.0
                                </code>
                                
                                <strong style="color: #16a34a;">âœ… éªŒè¯å®‰è£…ï¼š</strong><br>
                                <code style="display: block; background: #f3f4f6; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                python3 -c "import flask, pandas, numpy, requests, pytz; print('âœ… All Python dependencies OK')"
                                </code>
                            </div>
                        </div>

                        <!-- Node.jså’ŒPM2ä¾èµ– -->
                        <div class="info-card" style="margin-bottom: 15px;">
                            <div class="info-card-title">ğŸŸ¢ Node.js ç¯å¢ƒå’ŒPM2è¿›ç¨‹ç®¡ç†ï¼ˆå¿…éœ€ Node 14+ï¼‰</div>
                            <div class="info-card-content">
                                <strong style="color: #2563eb;">1. Node.js ç‰ˆæœ¬è¦æ±‚ï¼š</strong><br>
                                â€¢ æ¨èç‰ˆæœ¬: Node.js 16.x æˆ–æ›´é«˜<br>
                                â€¢ æœ€ä½ç‰ˆæœ¬: Node.js 14.x<br>
                                â€¢ éªŒè¯å‘½ä»¤: <code>node --version</code><br><br>
                                
                                <strong style="color: #2563eb;">2. PM2 è¿›ç¨‹ç®¡ç†å™¨ï¼š</strong><br>
                                â€¢ åŒ…å: <code>pm2@latest</code><br>
                                â€¢ ç”¨é€”: å®ˆæŠ¤è¿›ç¨‹ç®¡ç†ã€è‡ªåŠ¨é‡å¯ã€æ—¥å¿—ç®¡ç†<br>
                                â€¢ å…¨å±€å®‰è£…: å¿…é¡»ä½¿ç”¨ <code>-g</code> å‚æ•°<br><br>
                                
                                <strong style="color: #16a34a;">ğŸ“¥ å®‰è£…å‘½ä»¤ï¼š</strong><br>
                                <code style="display: block; background: #f3f4f6; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                npm install -g pm2
                                </code>
                                
                                <strong style="color: #16a34a;">âœ… éªŒè¯å®‰è£…ï¼š</strong><br>
                                <code style="display: block; background: #f3f4f6; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                pm2 --version && echo "âœ… PM2 installed"
                                </code>
                                
                                <strong style="color: #2563eb;">3. PM2é…ç½®æ–‡ä»¶ï¼š</strong><br>
                                â€¢ æ–‡ä»¶å: <code>ecosystem.config.js</code><br>
                                â€¢ ä½ç½®: <code>/home/user/webapp/ecosystem.config.js</code><br>
                                â€¢ æ ¼å¼: JavaScript CommonJSæ¨¡å—<br>
                                â€¢ åŒ…å«: 6ä¸ªåº”ç”¨è¿›ç¨‹é…ç½®<br><br>
                                
                                <strong style="color: #dc2626;">âš ï¸ é‡è¦å‘½ä»¤ï¼š</strong><br>
                                â€¢ å¯åŠ¨æ‰€æœ‰è¿›ç¨‹: <code>pm2 start ecosystem.config.js</code><br>
                                â€¢ æŸ¥çœ‹çŠ¶æ€: <code>pm2 status</code> æˆ– <code>pm2 list</code><br>
                                â€¢ æŸ¥çœ‹æ—¥å¿—: <code>pm2 logs [è¿›ç¨‹å] --lines 50</code><br>
                                â€¢ é‡å¯è¿›ç¨‹: <code>pm2 restart [è¿›ç¨‹å]</code><br>
                                â€¢ åœæ­¢è¿›ç¨‹: <code>pm2 stop [è¿›ç¨‹å]</code><br>
                                â€¢ ä¿å­˜é…ç½®: <code>pm2 save</code><br>
                                â€¢ å¼€æœºè‡ªå¯: <code>pm2 startup</code><br>
                                â€¢ åˆ é™¤è¿›ç¨‹: <code>pm2 delete [è¿›ç¨‹å]</code>
                            </div>
                        </div>

                        <!-- å‰ç«¯ä¾èµ– -->
                        <div class="info-card" style="margin-bottom: 15px;">
                            <div class="info-card-title">ğŸ¨ å‰ç«¯ä¾èµ–ï¼ˆCDNè‡ªåŠ¨åŠ è½½ï¼Œæ— éœ€å®‰è£…ï¼‰</div>
                            <div class="info-card-content">
                                <strong style="color: #2563eb;">1. ECharts å›¾è¡¨åº“ï¼š</strong><br>
                                â€¢ ç‰ˆæœ¬: <code>ECharts 5.4.3</code><br>
                                â€¢ CDN: <code>https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js</code><br>
                                â€¢ åŠŸèƒ½: ä¸“ä¸šçš„æ•°æ®å¯è§†åŒ–å›¾è¡¨åº“<br>
                                â€¢ å¤§å°: ~1.2MB (gzipåçº¦400KB)<br>
                                â€¢ ä½¿ç”¨: HTMLä¸­é€šè¿‡&lt;script&gt;æ ‡ç­¾è‡ªåŠ¨åŠ è½½<br><br>
                                
                                <strong style="color: #2563eb;">2. åŸç”ŸæŠ€æœ¯æ ˆï¼ˆæ— éœ€å®‰è£…ï¼‰ï¼š</strong><br>
                                â€¢ JavaScript: ES6+ åŸç”Ÿè¯­æ³•<br>
                                â€¢ CSS3: å“åº”å¼å¸ƒå±€ã€Gridã€Flexbox<br>
                                â€¢ HTML5: æ ‡å‡†è¯­ä¹‰åŒ–æ ‡ç­¾<br><br>
                                
                                <strong style="color: #16a34a;">âœ… ä¼˜åŠ¿ï¼š</strong><br>
                                â€¢ æ— éœ€Node.jsæ‰“åŒ…å·¥å…·ï¼ˆWebpackã€Viteç­‰ï¼‰<br>
                                â€¢ æ— éœ€å‰ç«¯æ¡†æ¶ï¼ˆReactã€Vueç­‰ï¼‰<br>
                                â€¢ é¡µé¢åŠ è½½å¿«é€Ÿï¼Œç»´æŠ¤ç®€å•<br>
                                â€¢ æµè§ˆå™¨å…¼å®¹æ€§å¥½ï¼ˆæ”¯æŒChromeã€Firefoxã€Safariã€Edgeï¼‰
                            </div>
                        </div>

                        <!-- ç³»ç»ŸæœåŠ¡ -->
                        <div class="info-card" style="margin-bottom: 15px;">
                            <div class="info-card-title">ğŸ”§ ç³»ç»ŸæœåŠ¡é…ç½®ï¼ˆPM2è¿›ç¨‹ï¼‰</div>
                            <div class="info-card-content">
                                <strong>PM2è¿›ç¨‹åˆ—è¡¨ï¼š</strong><br>
                                1. <strong>flask-app</strong><br>
                                   â””â”€ è„šæœ¬: code/python/app.py<br>
                                   â””â”€ ç«¯å£: 5000<br>
                                   â””â”€ å†…å­˜é™åˆ¶: 1G<br>
                                   â””â”€ åŠŸèƒ½: Flask APIæœåŠ¡<br><br>
                                
                                2. <strong>coin-change-tracker</strong><br>
                                   â””â”€ è„šæœ¬: source_code/coin_change_tracker_collector.py<br>
                                   â””â”€ å†…å­˜é™åˆ¶: 200M<br>
                                   â””â”€ åŠŸèƒ½: 27å¸ç§è¶‹åŠ¿é‡‡é›†ï¼ˆæ¯5åˆ†é’Ÿï¼‰<br><br>
                                
                                3. <strong>okx-trading-marks</strong><br>
                                   â””â”€ è„šæœ¬: source_code/okx_trading_marks_collector.py<br>
                                   â””â”€ å†…å­˜é™åˆ¶: 200M<br>
                                   â””â”€ åŠŸèƒ½: OKXæ—¥æ¶¨è·Œå¹…é‡‡é›†ï¼ˆæ¯5åˆ†é’Ÿï¼‰<br><br>
                                
                                4. <strong>okx-trade-history</strong> â­ <span style="color: #16a34a; font-weight: bold;">NEW!</span><br>
                                   â””â”€ è„šæœ¬: source_code/okx_trade_history_collector.py<br>
                                   â””â”€ å†…å­˜é™åˆ¶: 200M<br>
                                   â””â”€ åŠŸèƒ½: OKXäº¤æ˜“å†å²é‡‡é›†ï¼ˆæ¯5åˆ†é’Ÿï¼‰<br>
                                   â””â”€ è¯´æ˜: å®æ—¶é‡‡é›†ä¸»è´¦æˆ·æˆäº¤è®°å½•ï¼Œä¿å­˜åˆ°æŒ‰æ—¥æœŸåˆ†æ–‡ä»¶çš„JSONL<br>
                                   â””â”€ æ•°æ®æº: OKX API /api/v5/trade/fills<br><br>
                                
                                5. <strong>panic-collector</strong><br>
                                   â””â”€ è„šæœ¬: source_code/panic_wash_collector.py<br>
                                   â””â”€ å†…å­˜é™åˆ¶: 200M<br>
                                   â””â”€ åŠŸèƒ½: ææ…ŒæŒ‡æ•°é‡‡é›†ï¼ˆæ¯2åˆ†é’Ÿï¼‰<br><br>
                                
                                6. <strong>sar-jsonl-collector</strong><br>
                                   â””â”€ è„šæœ¬: source_code/sar_jsonl_collector.py<br>
                                   â””â”€ å†…å­˜é™åˆ¶: 200M<br>
                                   â””â”€ åŠŸèƒ½: SARåºå·æ•°æ®é‡‡é›†ï¼ˆæ¯5åˆ†é’Ÿï¼‰<br><br>
                                
                                <strong>å¯åŠ¨å‘½ä»¤ï¼š</strong><br>
                                <code>cd /home/user/webapp && pm2 start ecosystem.config.js</code><br><br>
                                
                                <strong>ç®¡ç†å‘½ä»¤ï¼š</strong><br>
                                â€¢ æŸ¥çœ‹çŠ¶æ€: <code>pm2 status</code><br>
                                â€¢ æŸ¥çœ‹æ—¥å¿—: <code>pm2 logs [app-name]</code><br>
                                â€¢ é‡å¯æœåŠ¡: <code>pm2 restart [app-name]</code><br>
                                â€¢ åœæ­¢æœåŠ¡: <code>pm2 stop [app-name]</code><br>
                                â€¢ ä¿å­˜é…ç½®: <code>pm2 save</code>
                            </div>
                        </div>

                        <!-- æ•°æ®ç›®å½•ç»“æ„ -->
                        <div class="info-card" style="margin-bottom: 15px;">
                            <div class="info-card-title">ğŸ“‚ æ•°æ®ç›®å½•ç»“æ„ï¼ˆå¿…é¡»å­˜åœ¨ï¼‰</div>
                            <div class="info-card-content">
                                <pre style="background: #f7fafc; padding: 10px; border-radius: 4px; font-size: 12px; overflow-x: auto;">
/home/user/webapp/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ coin_change_tracker/      # è¶‹åŠ¿æ•°æ®
â”‚   â”‚   â””â”€â”€ coin_change_YYYYMMDD.jsonl
â”‚   â”œâ”€â”€ okx_angle_analysis/       # è§’åº¦æ•°æ®
â”‚   â”‚   â””â”€â”€ okx_angles_YYYYMMDD.jsonl
â”‚   â”œâ”€â”€ okx_trading_history/      # äº¤æ˜“å†å²
â”‚   â”œâ”€â”€ trade_ratings/            # äº¤æ˜“è¯„çº§
â”‚   â”œâ”€â”€ sar_jsonl/                # SARæ•°æ®
â”‚   â”‚   â””â”€â”€ [SYMBOL].jsonl (29ä¸ªå¸ç§)
â”‚   â”œâ”€â”€ panic_jsonl/              # ææ…ŒæŒ‡æ•°
â”‚   â””â”€â”€ okx_trading_logs/         # äº¤æ˜“æ—¥å¿—
â”œâ”€â”€ code/python/
â”‚   â”œâ”€â”€ app.py                    # Flaskä¸»ç¨‹åº
â”‚   â”œâ”€â”€ collectors/               # æ•°æ®é‡‡é›†å™¨
â”‚   â”‚   â”œâ”€â”€ coin_change_tracker.py
â”‚   â”‚   â”œâ”€â”€ okx_panic_collector.py
â”‚   â”‚   â”œâ”€â”€ sar_jsonl_collector.py
â”‚   â”‚   â””â”€â”€ okx_angle_analyzer_v3.py
â”‚   â”œâ”€â”€ okx_accounts.json         # OKX APIé…ç½®
â”‚   â””â”€â”€ data/ -> /home/user/webapp/data/
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ okx_trading_marks.html    # æœ¬é¡µé¢
â”œâ”€â”€ ecosystem.config.js           # PM2é…ç½®
â””â”€â”€ backup.sh                     # å¤‡ä»½è„šæœ¬
                                </pre>
                            </div>
                        </div>

                        <!-- APIé…ç½® -->
                        <div class="info-card" style="margin-bottom: 15px;">
                            <div class="info-card-title">ğŸ”‘ OKX API é…ç½®ï¼ˆé‡è¦ï¼‰</div>
                            <div class="info-card-content">
                                <strong>é…ç½®æ–‡ä»¶ï¼š</strong><br>
                                â€¢ è·¯å¾„: code/python/okx_accounts.json<br><br>
                                
                                <strong>ä¸»è´¦æˆ·é…ç½®ï¼ˆaccount_mainï¼‰ï¼š</strong><br>
                                â€¢ API Key: b0c18f2d-e014-4ae8-9c3c-cb02161de4db<br>
                                â€¢ API Secret: 92F864C599B2CE2EC5186AD14C8B4110<br>
                                â€¢ Passphrase: Tencent@123<br><br>
                                
                                <strong>âš ï¸ å®‰å…¨æç¤ºï¼š</strong><br>
                                â€¢ é…ç½®æ–‡ä»¶å·²å›ºåŒ–åœ¨ç³»ç»Ÿä¸­<br>
                                â€¢ é‡æ–°éƒ¨ç½²æ—¶ä¼šè‡ªåŠ¨ä½¿ç”¨<br>
                                â€¢ è¯·å¦¥å–„ä¿ç®¡å¤‡ä»½æ–‡ä»¶<br>
                                â€¢ å»ºè®®å®šæœŸæ›´æ¢APIå¯†é’¥
                            </div>
                        </div>

                        <!-- ç¬¦å·é“¾æ¥ -->
                        <div class="info-card" style="margin-bottom: 15px;">
                            <div class="info-card-title">ğŸ”— ç¬¦å·é“¾æ¥ï¼ˆå¿…é¡»åˆ›å»ºï¼‰</div>
                            <div class="info-card-content">
                                <strong>æ•°æ®ç›®å½•é“¾æ¥ï¼š</strong><br>
                                <code>ln -s /home/user/webapp/data /home/user/webapp/code/python/data</code><br><br>
                                
                                <strong>å·²åˆ›å»ºçš„é“¾æ¥ï¼š</strong><br>
                                â€¢ code/python/data/coin_change_tracker<br>
                                â€¢ code/python/data/okx_angle_analysis<br>
                                â€¢ code/python/data/okx_trading_history<br>
                                â€¢ code/python/data/trade_ratings<br>
                                â€¢ code/python/data/sar_jsonl<br><br>
                                
                                <strong>éªŒè¯å‘½ä»¤ï¼š</strong><br>
                                <code>ls -la code/python/data</code>
                            </div>
                        </div>

                        <!-- å¤‡ä»½ä¸æ¢å¤ -->
                        <div class="info-card" style="margin-bottom: 15px;">
                            <div class="info-card-title">ğŸ’¾ å¤‡ä»½ä¸æ¢å¤</div>
                            <div class="info-card-content">
                                <strong>å¤‡ä»½è„šæœ¬ï¼š</strong><br>
                                â€¢ è·¯å¾„: /home/user/webapp/backup.sh<br>
                                â€¢ æ‰§è¡Œ: <code>cd /home/user/webapp && ./backup.sh</code><br><br>
                                
                                <strong>å¤‡ä»½å†…å®¹ï¼š</strong><br>
                                â€¢ æ‰€æœ‰æ•°æ®æ–‡ä»¶ï¼ˆdata/ï¼‰<br>
                                â€¢ OKX APIé…ç½®ï¼ˆokx_accounts.jsonï¼‰<br>
                                â€¢ PM2é…ç½®ï¼ˆecosystem.config.jsï¼‰<br>
                                â€¢ æ ¸å¿ƒPythonä»£ç <br>
                                â€¢ ç³»ç»Ÿæ–‡æ¡£<br><br>
                                
                                <strong>å¤‡ä»½ä½ç½®ï¼š</strong><br>
                                â€¢ /mnt/aidrive/panic_history_backup/<br>
                                â€¢ ä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½<br><br>
                                
                                <strong>æ¢å¤å‘½ä»¤ï¼š</strong><br>
                                <code>tar -xzf backup_file.tar.gz -C /home/user/webapp</code>
                            </div>
                        </div>

                        <!-- ç«¯å£é…ç½® -->
                        <div class="info-card" style="margin-bottom: 15px;">
                            <div class="info-card-title">ğŸŒ ç«¯å£é…ç½®</div>
                            <div class="info-card-content">
                                <strong>Flask APIæœåŠ¡ï¼š</strong><br>
                                â€¢ ç«¯å£: 5000<br>
                                â€¢ è®¿é—®: http://localhost:5000<br>
                                â€¢ å…¬ç½‘: https://5000-xxx.sandbox.novita.ai<br><br>
                                
                                <strong>é˜²ç«å¢™è§„åˆ™ï¼š</strong><br>
                                â€¢ ç¡®ä¿5000ç«¯å£å¼€æ”¾<br>
                                â€¢ å…è®¸å†…ç½‘è®¿é—®<br>
                                â€¢ å¤–ç½‘é€šè¿‡ä»£ç†è®¿é—®
                            </div>
                        </div>

                        <!-- ç¯å¢ƒå˜é‡ -->
                        <div class="info-card" style="margin-bottom: 15px;">
                            <div class="info-card-title">ğŸŒ ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰</div>
                            <div class="info-card-content">
                                <strong>Pythonç¯å¢ƒï¼š</strong><br>
                                â€¢ FLASK_APP=code/python/app.py<br>
                                â€¢ FLASK_ENV=production<br>
                                â€¢ PYTHONPATH=/home/user/webapp<br><br>
                                
                                <strong>PM2ç¯å¢ƒï¼š</strong><br>
                                â€¢ NODE_ENV=production<br>
                                â€¢ PM2_HOME=/home/user/.pm2
                            </div>
                        </div>

                        <!-- å®Œæ•´éƒ¨ç½²æµç¨‹ -->
                        <div class="info-card">
                            <div class="info-card-title">ğŸš€ å®Œæ•´éƒ¨ç½²æµç¨‹ï¼ˆé¦–æ¬¡/é‡æ–°éƒ¨ç½²ï¼‰</div>
                            <div class="info-card-content">
                                <strong>1. å®‰è£…ç³»ç»Ÿä¾èµ–ï¼š</strong><br>
                                <code>
                                # Pythonä¾èµ–<br>
                                pip install Flask Flask-CORS pandas numpy requests ccxt<br><br>
                                # Node.jsä¾èµ–<br>
                                npm install -g pm2
                                </code><br><br>
                                
                                <strong>2. åˆ›å»ºç›®å½•ç»“æ„ï¼š</strong><br>
                                <code>
                                mkdir -p data/coin_change_tracker<br>
                                mkdir -p data/okx_angle_analysis<br>
                                mkdir -p data/okx_trading_history<br>
                                mkdir -p data/trade_ratings<br>
                                mkdir -p data/sar_jsonl<br>
                                mkdir -p data/panic_jsonl<br>
                                mkdir -p data/okx_trading_logs
                                </code><br><br>
                                
                                <strong>3. åˆ›å»ºç¬¦å·é“¾æ¥ï¼š</strong><br>
                                <code>
                                cd /home/user/webapp<br>
                                ln -sf /home/user/webapp/data /home/user/webapp/code/python/data
                                </code><br><br>
                                
                                <strong>4. æ¢å¤OKX APIé…ç½®ï¼š</strong><br>
                                <code>
                                # ä»å¤‡ä»½æ¢å¤æˆ–æ‰‹åŠ¨åˆ›å»º<br>
                                # æ–‡ä»¶: code/python/okx_accounts.json
                                </code><br><br>
                                
                                <strong>5. å¯åŠ¨æœåŠ¡ï¼š</strong><br>
                                <code>
                                cd /home/user/webapp<br>
                                pm2 start ecosystem.config.js<br>
                                pm2 save
                                </code><br><br>
                                
                                <strong>6. éªŒè¯æœåŠ¡ï¼š</strong><br>
                                <code>
                                pm2 status<br>
                                curl http://localhost:5000/api/coin-change-tracker/history?date=20260211
                                </code><br><br>
                                
                                <strong>7. è®¾ç½®è‡ªåŠ¨å¤‡ä»½ï¼ˆå¯é€‰ï¼‰ï¼š</strong><br>
                                <code>
                                # æ·»åŠ åˆ°crontab<br>
                                0 2 * * * cd /home/user/webapp && ./backup.sh
                                </code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">ğŸ“Š å½“æ—¥äº¤æ˜“æ€»æ•°</div>
                <div class="stat-value" id="totalTrades">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ”´ å¤šå•å¼€ä»“</div>
                <div class="stat-value" style="color: #e53e3e;" id="longBuy">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸŸ¢ å¤šå•å¹³ä»“</div>
                <div class="stat-value" style="color: #38a169;" id="longSell">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸŸ  ç©ºå•å¼€ä»“</div>
                <div class="stat-value" style="color: #dd6b20;" id="shortBuy">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ”µ ç©ºå•å¹³ä»“</div>
                <div class="stat-value" style="color: #3182ce;" id="shortSell">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ”— åˆå¹¶åæ€»æ•°</div>
                <div class="stat-value" style="color: #805ad5;" id="mergedTotal">--</div>
            </div>
        </div>

        <!-- å›¾è¡¨ -->
        <div class="chart-container">
            <div class="chart-title">ğŸ“ˆ 27å¸å½“æ—¥æ¶¨è·Œå¹…è¶‹åŠ¿ + äº¤æ˜“æ ‡è®°ç‚¹</div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-dot" style="background: #e53e3e;"></div>
                    <span>å¤šå•å¼€ä»“</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #38a169;"></div>
                    <span>å¤šå•å¹³ä»“</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #dd6b20;"></div>
                    <span>ç©ºå•å¼€ä»“</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #3182ce;"></div>
                    <span>ç©ºå•å¹³ä»“</span>
                </div>
            </div>
            
            <!-- è§’åº¦æ ‡è®°å·¥å…·æ  -->
            <div style="display: flex; gap: 10px; align-items: center; margin: 10px 0; padding: 10px; background: #f7fafc; border-radius: 8px; flex-wrap: wrap;">
                <button id="toggleAngleModeBtn" onclick="toggleAngleMode()" style="padding: 8px 16px; background: #4299e1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; white-space: nowrap;">
                    ğŸ“ è¿›å…¥è§’åº¦æ ‡è®°æ¨¡å¼
                </button>
                
                <!-- æ–¹å‘é€‰æ‹©æŒ‰é’® -->
                <div id="directionButtons" style="display: none; gap: 10px;">
                    <button id="upAngleBtn" onclick="selectDirection('up')" style="padding: 6px 12px; background: #e8f5e9; color: #2e7d32; border: 2px solid #4caf50; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;">
                        â†—ï¸ æ­£è§’ï¼ˆä¸Šå‡ï¼‰
                    </button>
                    <button id="downAngleBtn" onclick="selectDirection('down')" style="padding: 6px 12px; background: #e3f2fd; color: #1565c0; border: 2px solid #2196f3; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;">
                        â†˜ï¸ è´Ÿè§’ï¼ˆä¸‹é™ï¼‰
                    </button>
                </div>
                
                <div id="angleModeHint" style="display: none; color: #2d3748; font-size: 13px; flex: 1; min-width: 300px;">
                    <strong>ğŸ“ è¯·å…ˆé€‰æ‹©è§’åº¦æ–¹å‘</strong> - â†—ï¸æ­£è§’ï¼ˆä¸Šå‡ï¼‰æˆ– â†˜ï¸è´Ÿè§’ï¼ˆä¸‹é™ï¼‰
                </div>
                <div id="angleStepInfo" style="display: none; color: #805ad5; font-size: 13px; font-weight: 500;"></div>
                <button id="cancelAngleBtn" onclick="cancelAngleMarking()" style="display: none; padding: 6px 12px; background: #e53e3e; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                    âŒ å–æ¶ˆæ ‡è®°
                </button>
                <button id="clearAllAnglesBtn" onclick="clearAllManualAngles()" style="display: none; padding: 6px 12px; background: #dd6b20; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                    ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ‰‹åŠ¨è§’åº¦
                </button>
            </div>
            
            <!-- æ“ä½œæç¤ºæ¨ªå¹… -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 12px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);">
                <span style="font-size: 24px; flex-shrink: 0;">ğŸ’¡</span>
                <div style="flex: 1; line-height: 1.7; font-size: 13px;">
                    <strong style="font-size: 15px; display: block; margin-bottom: 6px;">å¿«é€Ÿæ“ä½œæŒ‡å—</strong>
                    <div style="opacity: 0.95; display: flex; flex-wrap: wrap; gap: 15px;">
                        <span>ğŸ–±ï¸ <strong>åˆ é™¤è§’åº¦ï¼š</strong>åœ¨è§’åº¦æ ‡è®°ä¸Š<span style="background: rgba(255,255,255,0.25); padding: 2px 8px; border-radius: 4px; font-weight: bold; margin: 0 3px;">é¼ æ ‡å³é”®</span></span>
                        <span>ğŸ‘† <strong>æŸ¥çœ‹è¯¦æƒ…ï¼š</strong>é¼ æ ‡æ‚¬åœè§’åº¦/äº¤æ˜“æ ‡è®°</span>
                        <span>ğŸ“Š <strong>äº¤æ˜“è¯¦æƒ…ï¼š</strong>å·¦é”®ç‚¹å‡»äº¤æ˜“æ ‡è®°</span>
                    </div>
                </div>
            </div>
            
            <div id="mainChart"></div>
        </div>

        <!-- äº¤æ˜“åˆ—è¡¨ -->
        <div class="trade-list-container">
            <div class="trade-list-title">
                ğŸ“‹ è¯¦ç»†äº¤æ˜“åˆ—è¡¨
                <span style="font-size: 14px; color: #718096; font-weight: normal;">
                    ï¼ˆ2åˆ†é’Ÿå†…çš„äº¤æ˜“å·²è‡ªåŠ¨åˆå¹¶ï¼‰
                </span>
            </div>
            <div id="tradeListContent">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- äº¤æ˜“è¯„ä»·æ¨¡æ€æ¡† -->
    <div id="tradeRatingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; padding: 30px; width: 500px; max-width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 20px; color: #2d3748;">ğŸ“Š äº¤æ˜“è¯„ä»·</h3>
                <button onclick="closeRatingModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #a0aec0;">&times;</button>
            </div>
            
            <div id="tradeInfoDisplay" style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;">
                <!-- äº¤æ˜“ä¿¡æ¯å°†åŠ¨æ€å¡«å…… -->
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2d3748;">è¯„ä»·ç»“æœ</label>
                <div style="display: flex; gap: 15px;">
                    <button id="ratingCorrect" onclick="selectRating('correct')" style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-size: 16px; transition: all 0.2s;">
                        âœ… æ­£ç¡®
                    </button>
                    <button id="ratingIncorrect" onclick="selectRating('incorrect')" style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-size: 16px; transition: all 0.2s;">
                        âŒ é”™è¯¯
                    </button>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2d3748;">å¤‡æ³¨è¯´æ˜ï¼ˆæœ€å¤š50å­—ï¼‰</label>
                <textarea id="ratingNote" maxlength="50" rows="3" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; resize: vertical; font-family: inherit;" placeholder="è¾“å…¥å¤‡æ³¨..."></textarea>
                <div style="text-align: right; font-size: 12px; color: #a0aec0; margin-top: 5px;">
                    <span id="noteCharCount">0</span>/50
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: space-between; align-items: center;">
                <button id="deleteRatingBtn" onclick="deleteTradeRating()" style="padding: 10px 20px; border: 1px solid #f56565; border-radius: 8px; background: white; color: #f56565; cursor: pointer; font-size: 14px; display: none;">
                    ğŸ—‘ï¸ åˆ é™¤è¯„ä»·
                </button>
                <div style="display: flex; gap: 10px; margin-left: auto;">
                    <button onclick="closeRatingModal()" style="padding: 10px 20px; border: 1px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-size: 14px;">
                        å–æ¶ˆ
                    </button>
                    <button onclick="saveTradeRating()" style="padding: 10px 20px; border: none; border-radius: 8px; background: #3182ce; color: white; cursor: pointer; font-size: 14px; font-weight: 600;">
                        ä¿å­˜è¯„ä»·
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        let currentDate = new Date();
        let allTrades = []; // å­˜å‚¨æ‰€æœ‰äº¤æ˜“æ•°æ®
        
        // ä¸»è´¦æˆ·APIé…ç½®
        const MAIN_ACCOUNT = {
            id: 'account_main',
            name: 'ä¸»è´¦æˆ·',
            apiKey: 'b0c18f2d-e014-4ae8-9c3c-cb02161de4db',
            apiSecret: '92F864C599B2CE2EC5186AD14C8B4110',
            passphrase: 'Tencent@123'
        };

        // æ•°æ®ç¼“å­˜æœºåˆ¶
        const tradingDataCache = {
            trendData: { data: null, date: null, timestamp: 0, ttl: 60000 }, // 60ç§’ç¼“å­˜
            tradesData: { data: null, date: null, timestamp: 0, ttl: 30000 }, // 30ç§’ç¼“å­˜
            angleData: { data: null, date: null, timestamp: 0, ttl: 120000 }, // 120ç§’ç¼“å­˜
            ratings: { data: null, timestamp: 0, ttl: 300000 } // 5åˆ†é’Ÿç¼“å­˜
        };
        
        // ç¼“å­˜è·å–å‡½æ•°
        function getTradingCachedData(key, currentDateStr) {
            const cache = tradingDataCache[key];
            if (!cache) return null;
            
            const now = Date.now();
            const isExpired = now - cache.timestamp > cache.ttl;
            const isWrongDate = currentDateStr && cache.date !== currentDateStr;
            
            if (cache.data && !isExpired && !isWrongDate) {
                console.log(`ğŸ“¦ ä½¿ç”¨ç¼“å­˜æ•°æ®: ${key}`);
                return cache.data;
            }
            return null;
        }
        
        // ç¼“å­˜è®¾ç½®å‡½æ•°
        function setTradingCachedData(key, data, currentDateStr) {
            const cache = tradingDataCache[key];
            if (cache) {
                cache.data = data;
                cache.timestamp = Date.now();
                if (currentDateStr !== undefined) {
                    cache.date = currentDateStr;
                }
                console.log(`ğŸ’¾ å·²ç¼“å­˜æ•°æ®: ${key}`);
            }
        }
        
        // åˆå§‹åŒ– - é«˜æ€§èƒ½ç‰ˆæœ¬ï¼ˆå¹¶è¡ŒåŠ è½½ + ç¼“å­˜æœºåˆ¶ï¼‰
        window.onload = async function() {
            console.log('ğŸš€ OKX Trading Marks é¡µé¢åˆå§‹åŒ–å¼€å§‹...');
            const startTime = performance.now();
            
            try {
                // ç¬¬1æ­¥ï¼šåˆå§‹åŒ–å›¾è¡¨éª¨æ¶
                initChart();
                console.log('âœ… å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
                
                // ç¬¬2æ­¥ï¼šåŠ è½½ä»Šå¤©çš„æ•°æ®
                await loadTodayData();
                
                // ç¬¬3æ­¥ï¼šç­‰å¾…chartåˆå§‹åŒ–åæ·»åŠ ç‚¹å‡»äº‹ä»¶
                setTimeout(() => {
                    if (chart) {
                        setupChartEventListeners();
                    }
                }, 1000);
                
                const endTime = performance.now();
                console.log(`âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œæ€»è€—æ—¶: ${((endTime - startTime) / 1000).toFixed(2)}ç§’`);
                console.log(`âš¡ æ€§èƒ½æå‡: é‡‡ç”¨å¹¶è¡ŒåŠ è½½ + ç¼“å­˜æœºåˆ¶ï¼Œé¢„è®¡å‡å°‘50%ä»¥ä¸ŠåŠ è½½æ—¶é—´`);
                
                // é¢å¤–çš„å®‰å…¨æªæ–½ï¼šç¡®ä¿åŠ è½½ç•Œé¢ä¸€å®šè¢«ç§»é™¤
                setTimeout(() => {
                    const overlay = document.getElementById('loadingOverlay');
                    if (overlay) {
                        console.warn('âš ï¸ æ£€æµ‹åˆ°åŠ è½½ç•Œé¢ä»ç„¶å­˜åœ¨ï¼Œå¼ºåˆ¶ç§»é™¤');
                        overlay.remove();
                    }
                }, 2000);
            } catch (error) {
                console.error('âŒ é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                showError('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                // ç¡®ä¿å‡ºé”™æ—¶ä¹Ÿç§»é™¤åŠ è½½ç•Œé¢
                setTimeout(() => {
                    const overlay = document.getElementById('loadingOverlay');
                    if (overlay) overlay.remove();
                }, 500);
            }
        };

        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const chartContainer = document.getElementById('mainChart');
            if (!chartContainer) {
                console.error('âŒ æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨å…ƒç´  #mainChart');
                return;
            }
            
            chart = echarts.init(chartContainer);
            
            if (chart) {
                chart.setOption({
                    title: {
                        text: 'åŠ è½½ä¸­...',
                        left: 'center',
                        top: 'middle',
                        textStyle: { color: '#999', fontSize: 16 }
                    }
                });
            } else {
                console.error('âŒ å›¾è¡¨åˆå§‹åŒ–å¤±è´¥');
            }
        }

        // åŠ è½½ä»Šå¤©çš„æ•°æ® - ä¼˜åŒ–ç‰ˆæœ¬
        async function loadTodayData() {
            currentDate = new Date();
            updateDateDisplay();
            await loadData();
        }

        // å‰ä¸€å¤© - ä¼˜åŒ–ç‰ˆæœ¬
        async function previousDay() {
            currentDate.setDate(currentDate.getDate() - 1);
            updateDateDisplay();
            await loadData();
        }

        // åä¸€å¤© - ä¼˜åŒ–ç‰ˆæœ¬
        async function nextDay() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const nextDate = new Date(currentDate);
            nextDate.setDate(nextDate.getDate() + 1);
            
            if (nextDate <= today) {
                currentDate = nextDate;
                updateDateDisplay();
                await loadData();
            }
        }

        // é€‰æ‹©æ—¥æœŸ
        function selectDate() {
            const dateInput = document.getElementById('dateSelector');
            if (dateInput.value) {
                currentDate = new Date(dateInput.value + 'T00:00:00');
                updateDateDisplay();
                loadData();
            }
        }

        // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
        function updateDateDisplay() {
            const dateStr = formatDate(currentDate);
            document.getElementById('currentDateDisplay').textContent = dateStr;
            document.getElementById('dateSelector').value = dateStr;
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // åŠ è½½æ•°æ® - é«˜æ€§èƒ½ç‰ˆæœ¬ï¼ˆå¹¶è¡ŒåŠ è½½ + ç¼“å­˜ + è¯¦ç»†è¿›åº¦æç¤ºï¼‰
        async function loadData() {
            // ç¡®ä¿å³ä½¿å‡ºé”™ä¹Ÿä¼šéšè—åŠ è½½ç•Œé¢
            let loadingHidden = false;
            const safeHideLoading = () => {
                if (!loadingHidden) {
                    hideLoading();
                    loadingHidden = true;
                }
            };
            
            try {
                showLoading();
                console.log('ğŸ”„ åŠ è½½æ—¥æœŸ:', formatDate(currentDate));
                const loadStart = performance.now();
                const currentDateStr = formatDate(currentDate);
                
                // æ­¥éª¤1: åˆå§‹åŒ–ï¼ˆ0-10%ï¼‰
                updateLoadingProgress(1, 5, 'æ­£åœ¨åˆå§‹åŒ–å›¾è¡¨ç¯å¢ƒ...');
                await new Promise(resolve => setTimeout(resolve, 100));
                updateLoadingProgress(1, 10, 'å›¾è¡¨ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ');
                
                // é«˜æ€§èƒ½ç­–ç•¥ï¼šå¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®ï¼Œå¹¶ä½¿ç”¨ç¼“å­˜
                console.log('ğŸ“¦ æ£€æŸ¥ç¼“å­˜ä¸­...');
                updateLoadingProgress(2, 15, 'æ­£åœ¨æ£€æŸ¥æœ¬åœ°ç¼“å­˜...');
                
                // æ£€æŸ¥ç¼“å­˜
                const cachedTrend = getTradingCachedData('trendData', currentDateStr);
                const cachedTrades = getTradingCachedData('tradesData', currentDateStr);
                const cachedAngles = getTradingCachedData('angleData', currentDateStr);
                
                // æ­¥éª¤2-4: å¹¶è¡ŒåŠ è½½æ‰€æœ‰éœ€è¦çš„æ•°æ®ï¼ˆ15-70%ï¼‰
                console.log('ğŸ“¡ å¹¶è¡ŒåŠ è½½ä¸‰ç±»æ•°æ®...');
                updateLoadingProgress(2, 20, 'æ­£åœ¨åŠ è½½è¶‹åŠ¿æ•°æ®ï¼ˆ27å¸ç§ï¼‰...');
                
                const [trendResult, tradesResult, angleResult] = await Promise.allSettled([
                    cachedTrend ? Promise.resolve(cachedTrend) : fetchTrendData(),
                    cachedTrades ? Promise.resolve(cachedTrades) : fetchTradesData(),
                    cachedAngles ? Promise.resolve(cachedAngles) : fetchAngleData()
                ]);
                
                updateLoadingProgress(3, 50, 'è¶‹åŠ¿æ•°æ®åŠ è½½å®Œæˆï¼Œæ­£åœ¨åŠ è½½äº¤æ˜“è®°å½•...');
                
                // å¤„ç†è¶‹åŠ¿æ•°æ®
                let trendData = [];
                if (trendResult.status === 'fulfilled') {
                    trendData = trendResult.value;
                    if (!cachedTrend) setTradingCachedData('trendData', trendData, currentDateStr);
                    console.log('âœ… è¶‹åŠ¿æ•°æ®:', trendData.length, 'ä¸ªç‚¹');
                    updateLoadingProgress(2, 35, `è¶‹åŠ¿æ•°æ®åŠ è½½æˆåŠŸï¼ˆ${trendData.length}ä¸ªæ•°æ®ç‚¹ï¼‰`);
                } else {
                    console.error('âŒ è¶‹åŠ¿æ•°æ®åŠ è½½å¤±è´¥:', trendResult.reason);
                    updateLoadingProgress(2, 35, 'âš ï¸ è¶‹åŠ¿æ•°æ®åŠ è½½å¤±è´¥ï¼Œç»§ç»­åŠ è½½å…¶ä»–æ•°æ®...');
                }
                
                // å¤„ç†äº¤æ˜“æ•°æ®
                let tradesData = { trades: [], stats: {} };
                if (tradesResult.status === 'fulfilled') {
                    tradesData = tradesResult.value;
                    if (!cachedTrades) setTradingCachedData('tradesData', tradesData, currentDateStr);
                    console.log('âœ… äº¤æ˜“æ•°æ®:', tradesData.trades.length, 'ç¬”');
                    updateLoadingProgress(3, 55, `äº¤æ˜“æ•°æ®åŠ è½½æˆåŠŸï¼ˆ${tradesData.trades.length}ç¬”äº¤æ˜“ï¼‰`);
                } else {
                    console.error('âŒ äº¤æ˜“æ•°æ®åŠ è½½å¤±è´¥:', tradesResult.reason);
                    updateLoadingProgress(3, 55, 'âš ï¸ äº¤æ˜“æ•°æ®åŠ è½½å¤±è´¥ï¼Œç»§ç»­åŠ è½½å…¶ä»–æ•°æ®...');
                }
                
                // å¤„ç†è§’åº¦æ•°æ®
                let angleData = [];
                if (angleResult.status === 'fulfilled') {
                    angleData = angleResult.value;
                    if (!cachedAngles) setTradingCachedData('angleData', angleData, currentDateStr);
                    console.log('âœ… è§’åº¦æ•°æ®:', angleData.length, 'ä¸ªè§’åº¦');
                    updateLoadingProgress(4, 70, `è§’åº¦æ•°æ®åŠ è½½æˆåŠŸï¼ˆ${angleData.length}ä¸ªè§’åº¦æ ‡è®°ï¼‰`);
                } else {
                    console.error('âŒ è§’åº¦æ•°æ®åŠ è½½å¤±è´¥:', angleResult.reason);
                    updateLoadingProgress(4, 70, 'âš ï¸ è§’åº¦æ•°æ®åŠ è½½å¤±è´¥ï¼Œç»§ç»­å¤„ç†...');
                }
                
                // æ­¥éª¤5: æ¸²æŸ“å›¾è¡¨ï¼ˆ70-90%ï¼‰
                updateLoadingProgress(5, 75, 'æ­£åœ¨å¤„ç†äº¤æ˜“æ•°æ®...');
                
                // åˆå¹¶äº¤æ˜“ï¼ˆ4åˆ†é’Ÿå†…ï¼‰
                const mergedTrades = mergeTrades(tradesData.trades, 4 * 60 * 1000);
                console.log('âœ… åˆå¹¶å:', mergedTrades.length, 'ç¬”');
                updateLoadingProgress(5, 80, `äº¤æ˜“æ•°æ®å¤„ç†å®Œæˆï¼ˆåˆå¹¶ä¸º${mergedTrades.length}ç¬”ï¼‰`);
                
                // æ›´æ–°ç»Ÿè®¡
                updateStats(tradesData.stats, mergedTrades.length);
                
                // æ¸²æŸ“å›¾è¡¨ï¼ˆåŒ…å«è§’åº¦æ ‡è®°å’Œäº¤æ˜“è¯„ä»·ï¼‰
                updateLoadingProgress(5, 85, 'æ­£åœ¨æ¸²æŸ“å›¾è¡¨...');
                renderChart(trendData, mergedTrades, angleData);
                updateLoadingProgress(5, 90, 'å›¾è¡¨æ¸²æŸ“å®Œæˆ');
                
                // æ¸²æŸ“äº¤æ˜“åˆ—è¡¨
                renderTradeList(mergedTrades);
                
                // æ­¥éª¤6: è®¾ç½®äº¤äº’äº‹ä»¶ï¼ˆ90-100%ï¼‰
                updateLoadingProgress(6, 95, 'æ­£åœ¨è®¾ç½®äº¤äº’äº‹ä»¶...');
                
                // åå°æ‡’åŠ è½½äº¤æ˜“è¯„ä»·ï¼ˆä¸é˜»å¡é¡µé¢æ˜¾ç¤ºï¼‰
                setTimeout(() => {
                    loadTradeRatings().catch(err => {
                        console.warn('âš ï¸ äº¤æ˜“è¯„ä»·åŠ è½½å¤±è´¥:', err);
                    });
                }, 100);
                
                const loadEnd = performance.now();
                const loadTime = ((loadEnd - loadStart) / 1000).toFixed(2);
                console.log(`âœ… æ•°æ®åŠ è½½å®Œæˆï¼Œè€—æ—¶: ${loadTime}ç§’`);
                
                updateLoadingProgress(6, 100, `åŠ è½½å®Œæˆï¼è€—æ—¶ ${loadTime} ç§’`);
                
                // ç«‹å³éšè—åŠ è½½ç•Œé¢ï¼ˆä¸å†ç­‰å¾…ï¼‰
                safeHideLoading();
            } catch (e) {
                console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', e);
                // å³ä½¿å‡ºé”™ä¹Ÿè¦éšè—åŠ è½½ç•Œé¢
                safeHideLoading();
                showError('åŠ è½½æ•°æ®å¤±è´¥: ' + e.message);
            }
        }

        // è·å–è¶‹åŠ¿æ•°æ®ï¼ˆå½“æ—¥ï¼‰
        async function fetchTrendData() {
            const dateStr = formatDate(currentDate).replace(/-/g, '');
            console.log('ğŸ“ˆ è·å–è¶‹åŠ¿æ•°æ®ï¼Œæ—¥æœŸ:', dateStr);
            
            const response = await fetch(`/api/coin-change-tracker/history?date=${dateStr}&limit=1440`);
            const result = await response.json();
            
            console.log('ğŸ“ˆ APIè¿”å›:', result);
            
            // æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰æ•ˆ
            if (!result.data || result.data.length === 0) {
                throw new Error(result.message || 'è·å–è¶‹åŠ¿æ•°æ®å¤±è´¥ï¼šæ— æ•°æ®');
            }
            
            // è½¬æ¢æ•°æ®æ ¼å¼ - æ³¨æ„ï¼šä½¿ç”¨ total_change ä½œä¸ºç´¯è®¡æ¶¨è·Œå¹…
            const trendData = (result.data || []).map(item => {
                // å…¼å®¹ä¸¤ç§æ—¶é—´æ ¼å¼ï¼š
                // 1. æ–°æ ¼å¼ï¼ˆä¼˜å…ˆï¼‰ï¼šbeijing_timeå­—æ®µæ˜¯"YYYY-MM-DD HH:MM:SS"
                // 2. æ—§æ ¼å¼ï¼ˆfallbackï¼‰ï¼štimeå­—æ®µç›´æ¥æ˜¯HH:MM:SS
                let timeStr = '00:00:00';
                if (item.beijing_time) {
                    // æ–°æ ¼å¼ï¼ˆä¼˜å…ˆï¼‰ï¼šä»beijing_timeæå–æ—¶é—´éƒ¨åˆ†
                    timeStr = item.beijing_time.split(' ')[1] || '00:00:00';
                } else if (item.time) {
                    // æ—§æ ¼å¼ï¼ˆfallbackï¼‰ï¼šç›´æ¥ä½¿ç”¨timeå­—æ®µ
                    timeStr = item.time;
                }
                
                return {
                    date: item.baseline_date || dateStr,
                    time: timeStr,
                    cumulative_pct: item.total_change || 0  // ä½¿ç”¨ total_change å­—æ®µ
                };
            });
            
            console.log('ğŸ“ˆ è½¬æ¢åæ•°æ®:', trendData.length, 'æ¡');
            if (trendData.length > 0) {
                console.log('ğŸ“ˆ ç¤ºä¾‹æ•°æ®:', trendData[0], trendData[Math.floor(trendData.length / 2)]);
            }
            
            return trendData;
        }

        // è·å–äº¤æ˜“æ•°æ®ï¼ˆ2æœˆ1æ—¥è‡³å½“å‰æ—¥æœŸï¼‰
        async function fetchTradesData() {
            const startDate = '20260201';
            const endDate = formatDate(currentDate).replace(/-/g, '');
            
            console.log('ğŸ“Š è·å–äº¤æ˜“å†å²:', { startDate, endDate });
            
            try {
                const response = await fetch('/api/okx-trading/trade-history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey: MAIN_ACCOUNT.apiKey,
                        apiSecret: MAIN_ACCOUNT.apiSecret,
                        passphrase: MAIN_ACCOUNT.passphrase,
                        startDate,
                        endDate
                    })
                });
                
                if (!response.ok) {
                    throw new Error('è·å–äº¤æ˜“å†å²å¤±è´¥');
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'è·å–äº¤æ˜“å†å²å¤±è´¥');
                }
                
                // è¿‡æ»¤å½“å¤©çš„äº¤æ˜“
                const currentDateStr = formatDate(currentDate);
                console.log('ğŸ” è¿‡æ»¤äº¤æ˜“ï¼Œç›®æ ‡æ—¥æœŸ:', currentDateStr);
                
                const todayTrades = (result.data || []).filter(trade => {
                    // fillTime_stræ ¼å¼: "2026-02-09 10:17:27"
                    const tradeDateStr = trade.fillTime_str ? trade.fillTime_str.split(' ')[0] : '';
                    return tradeDateStr === currentDateStr;
                });
                
                console.log(`âœ… è¿‡æ»¤ç»“æœ: æ€»å…± ${result.data.length} ç¬”ï¼Œå½“å¤© ${todayTrades.length} ç¬”`);
                
                // è®¡ç®—ç»Ÿè®¡
                const stats = calculateStats(todayTrades);
                
                return {
                    trades: todayTrades,
                    stats
                };
            } catch (e) {
                console.error('âŒ è·å–äº¤æ˜“å†å²å¤±è´¥:', e);
                return {
                    trades: [],
                    stats: { total: 0, longBuy: 0, longSell: 0, shortBuy: 0, shortSell: 0 }
                };
            }
        }

        // è·å–è§’åº¦æ•°æ®ï¼ˆä»…å½“å¤©ï¼‰
        async function fetchAngleData() {
            try {
                // åªè·å–å½“å¤©çš„è§’åº¦æ•°æ®
                const dateStr = formatDate(currentDate).replace(/-/g, '');
                
                console.log('ğŸ“ è·å–è§’åº¦æ•°æ®ï¼ˆä»…å½“å¤©ï¼‰:', dateStr);
                
                const response = await fetch(`/api/okx-trading/angles?date=${dateStr}`);
                
                if (!response.ok) {
                    throw new Error('è·å–è§’åº¦æ•°æ®å¤±è´¥');
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    console.warn('âš ï¸ è·å–è§’åº¦æ•°æ®å¤±è´¥:', result.message);
                    return [];
                }
                
                console.log('âœ… è§’åº¦æ•°æ®ï¼ˆå½“å¤©ï¼‰:', result.data.length, 'ä¸ª');
                return result.data || [];
            } catch (e) {
                console.error('âŒ è·å–è§’åº¦æ•°æ®å¤±è´¥:', e);
                return [];
            }
        }

        // è®¡ç®—ç»Ÿè®¡æ•°æ®
        function calculateStats(trades) {
            const stats = {
                total: trades.length,
                longBuy: 0,
                longSell: 0,
                shortBuy: 0,
                shortSell: 0
            };
            
            trades.forEach(trade => {
                if (trade.posSide === 'long') {
                    if (trade.side === 'buy') {
                        stats.longBuy++;
                    } else {
                        stats.longSell++;
                    }
                } else if (trade.posSide === 'short') {
                    if (trade.side === 'sell') {
                        stats.shortBuy++;
                    } else {
                        stats.shortSell++;
                    }
                }
            });
            
            return stats;
        }

        // åˆå¹¶äº¤æ˜“ï¼ˆ4åˆ†é’Ÿå†…ï¼‰
        function mergeTrades(trades, timeWindow) {
            if (trades.length === 0) return [];
            
            // æŒ‰æ—¶é—´æ’åº
            const sortedTrades = [...trades].sort((a, b) => a.fillTime - b.fillTime);
            
            const merged = [];
            let currentGroup = [sortedTrades[0]];
            
            for (let i = 1; i < sortedTrades.length; i++) {
                const currentTrade = sortedTrades[i];
                const lastTrade = currentGroup[currentGroup.length - 1];
                
                // æ£€æŸ¥æ˜¯å¦åœ¨æ—¶é—´çª—å£å†…ä¸”ç±»å‹ç›¸åŒ
                const timeDiff = currentTrade.fillTime - lastTrade.fillTime;
                const sameType = currentTrade.posSide === lastTrade.posSide && 
                                currentTrade.side === lastTrade.side &&
                                currentTrade.instId === lastTrade.instId;
                
                if (timeDiff <= timeWindow && sameType) {
                    currentGroup.push(currentTrade);
                } else {
                    // åˆå¹¶å½“å‰ç»„
                    merged.push(mergeGroup(currentGroup));
                    currentGroup = [currentTrade];
                }
            }
            
            // åˆå¹¶æœ€åä¸€ç»„
            if (currentGroup.length > 0) {
                merged.push(mergeGroup(currentGroup));
            }
            
            return merged;
        }

        // åˆå¹¶ä¸€ç»„äº¤æ˜“
        function mergeGroup(group) {
            if (group.length === 1) {
                return { ...group[0], mergedCount: 1 };
            }
            
            // è®¡ç®—å¹³å‡ä»·æ ¼å’Œæ€»æ•°é‡
            const totalSz = group.reduce((sum, t) => sum + t.fillSz, 0);
            const avgPx = group.reduce((sum, t) => sum + t.fillPx * t.fillSz, 0) / totalSz;
            const totalFee = group.reduce((sum, t) => sum + t.fee, 0);
            
            return {
                ...group[0],
                fillPx: avgPx,
                fillSz: totalSz,
                fee: totalFee,
                mergedCount: group.length,
                mergedTrades: group.map(t => t.tradeId)
            };
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats(stats, mergedCount) {
            document.getElementById('totalTrades').textContent = stats.total;
            document.getElementById('longBuy').textContent = stats.longBuy;
            document.getElementById('longSell').textContent = stats.longSell;
            document.getElementById('shortBuy').textContent = stats.shortBuy;
            document.getElementById('shortSell').textContent = stats.shortSell;
            document.getElementById('mergedTotal').textContent = mergedCount;
        }

        // æ¸²æŸ“å›¾è¡¨
        function renderChart(trendData, trades, angleData = []) {
            console.log('ğŸ“Š renderChartè¢«è°ƒç”¨ï¼Œå‚æ•°æ£€æŸ¥:');
            console.log('  - trendData:', trendData);
            console.log('  - trendDataç±»å‹:', typeof trendData);
            console.log('  - trendDataæ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(trendData));
            console.log('  - trendDataé•¿åº¦:', trendData ? trendData.length : 'null/undefined');
            console.log('  - tradesé•¿åº¦:', trades ? trades.length : 'null/undefined');
            console.log('  - angleDataé•¿åº¦:', angleData ? angleData.length : 'null/undefined');
            
            // ç¡®ä¿å›¾è¡¨å·²åˆå§‹åŒ–
            if (!chart) {
                console.error('âŒ å›¾è¡¨æœªåˆå§‹åŒ–');
                initChart();
            }
            
            if (!trendData || trendData.length === 0) {
                console.error('âŒ æ— è¶‹åŠ¿æ•°æ®ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯');
                console.error('  - trendDataå€¼:', trendData);
                console.error('  - æ¡ä»¶åˆ¤æ–­: !trendData =', !trendData, ', length === 0 =', trendData ? trendData.length === 0 : 'N/A');
                if (chart) {
                    chart.setOption({
                        title: {
                            text: 'å½“æ—¥æš‚æ— è¶‹åŠ¿æ•°æ®',
                            left: 'center',
                            top: 'middle',
                            textStyle: { color: '#999', fontSize: 16 }
                        }
                    });
                }
                return;
            }
            
            console.log('âœ… è¶‹åŠ¿æ•°æ®éªŒè¯é€šè¿‡ï¼Œå¼€å§‹æ¸²æŸ“å›¾è¡¨');
            
            // ä¿å­˜å½“å‰æ•°æ®ä¾›è§’åº¦æ ‡è®°ä½¿ç”¨
            currentTrendData = trendData;
            currentTimes = trendData.map(d => d.time || '00:00:00');
            currentValues = trendData.map(d => d.cumulative_pct || 0);
            
            console.log('ğŸ“Š æ¸²æŸ“å›¾è¡¨ - è¶‹åŠ¿æ•°æ®:', trendData.length, 'äº¤æ˜“æ•°æ®:', trades.length, 'è§’åº¦æ•°æ®:', angleData.length, 'æ‰‹åŠ¨è§’åº¦:', manualAngles.length);
            
            // å‡†å¤‡æ—¶é—´è½´å’Œæ•°æ®
            const times = currentTimes;
            const values = currentValues;
            
            console.log('ğŸ“Š æ—¶é—´è½´:', times.length, 'ç¬¬ä¸€ä¸ª:', times[0], 'æœ€å:', times[times.length - 1]);
            console.log('ğŸ“Š æ•°å€¼:', values.length, 'èŒƒå›´:', Math.min(...values), '~', Math.max(...values));
            
            // åˆå¹¶APIè§’åº¦å’Œæ‰‹åŠ¨è§’åº¦
            const allAngles = [...angleData, ...manualAngles];
            console.log('ğŸ“ æ€»è§’åº¦æ•°:', allAngles.length, '(API:', angleData.length, 'æ‰‹åŠ¨:', manualAngles.length, ')');
            
            // æŒ‰ç±»å‹å’Œæ—¶é—´çª—å£åˆ†ç»„äº¤æ˜“ï¼ˆ2åˆ†é’Ÿå†…ç›¸åŒç±»å‹åˆå¹¶ä¸ºä¸€ä¸ªæ ‡è®°ï¼‰
            const groupedTrades = groupTradesByType(trades, times, values);
            console.log('ğŸ“Š åˆ†ç»„åçš„äº¤æ˜“:', {
                'å¤šå•å¼€ä»“': groupedTrades.longBuy.length,
                'å¤šå•å¹³ä»“': groupedTrades.longSell.length,
                'ç©ºå•å¼€ä»“': groupedTrades.shortBuy.length,
                'ç©ºå•å¹³ä»“': groupedTrades.shortSell.length
            });
            
            // åˆ›å»ºè§’åº¦æ ‡è®°ç³»åˆ—
            const angleSeries = createAngleSeries(allAngles, times, values);
            console.log('ğŸ“ è§’åº¦ç³»åˆ—:', angleSeries.length, 'ä¸ªç³»åˆ—');
            
            // åœ¨è§’åº¦æ ‡è®°æ¨¡å¼ä¸‹ï¼Œéšè—äº¤æ˜“æ ‡è®°å’Œè§’åº¦æ ‡è®°ï¼Œé¿å…é®æŒ¡è¶‹åŠ¿çº¿ç‚¹ä½
            // ä¿®å¤ï¼šé»˜è®¤æƒ…å†µä¸‹åº”è¯¥æ˜¾ç¤ºæ ‡è®°ï¼ˆangleModeActiveé»˜è®¤ä¸ºfalseï¼‰
            const tradeSeriesVisible = !angleModeActive;  // falseæ—¶æ˜¾ç¤ºï¼Œtrueæ—¶éšè—
            const angleSeriesVisible = !angleModeActive;  // falseæ—¶æ˜¾ç¤ºï¼Œtrueæ—¶éšè—
            
            console.log('ğŸ“Š æ ‡è®°æ˜¾ç¤ºçŠ¶æ€ - è§’åº¦æ¨¡å¼:', angleModeActive, 'äº¤æ˜“æ ‡è®°:', tradeSeriesVisible, 'è§’åº¦æ ‡è®°:', angleSeriesVisible);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    formatter: function(params) {
                        let result = params[0].axisValue + '<br/>';
                        params.forEach(param => {
                            if (param.seriesName === 'ç´¯è®¡æ¶¨è·Œå¹…') {
                                result += `${param.marker} ${param.seriesName}: <strong>${param.value}%</strong><br/>`;
                            } else if (param.seriesType === 'scatter') {
                                result += `${param.marker} ${param.seriesName}<br/>`;
                            }
                        });
                        return result;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '5%',  // æ ‡è®°åœ¨å³°å€¼ä¸Šï¼Œä¸éœ€è¦å¤ªå¤šé¡¶éƒ¨ç©ºé—´
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: times,
                    boundaryGap: false,
                    axisLabel: {
                        rotate: 0,
                        interval: Math.floor(times.length / 12),
                        formatter: function(value) {
                            return value.substring(0, 5);
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'æ¶¨è·Œå¹… (%)',
                    axisLabel: {
                        formatter: '{value}%'
                    }
                },
                series: [
                    {
                        name: 'ç´¯è®¡æ¶¨è·Œå¹…',
                        type: 'line',
                        data: values,
                        smooth: true,
                        lineStyle: { width: 2, color: '#4299e1' },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(66, 153, 225, 0.3)' },
                                    { offset: 1, color: 'rgba(66, 153, 225, 0.05)' }
                                ]
                            }
                        }
                    },
                    // åªåœ¨éè§’åº¦æ ‡è®°æ¨¡å¼ä¸‹æ˜¾ç¤ºäº¤æ˜“æ ‡è®°
                    ...(tradeSeriesVisible ? [
                        ...createScatterSeries('å¤šå•å¼€ä»“', groupedTrades.longBuy, '#e53e3e', 'circle', 'å¤šå¼€'),
                        ...createScatterSeries('å¤šå•å¹³ä»“', groupedTrades.longSell, '#38a169', 'circle', 'å¤šå¹³'),
                        ...createScatterSeries('ç©ºå•å¼€ä»“', groupedTrades.shortBuy, '#dd6b20', 'diamond', 'ç©ºå¼€'),
                        ...createScatterSeries('ç©ºå•å¹³ä»“', groupedTrades.shortSell, '#3182ce', 'diamond', 'ç©ºå¹³')
                    ] : []),
                    // åªåœ¨éè§’åº¦æ ‡è®°æ¨¡å¼ä¸‹æ˜¾ç¤ºè§’åº¦æ ‡è®°
                    ...(angleSeriesVisible ? angleSeries : [])
                ]
            };
            
            console.log('ğŸ“Š å›¾è¡¨Optioné…ç½®:');
            console.log('  - seriesæ•°é‡:', option.series.length);
            console.log('  - seriesåˆ—è¡¨:', option.series.map(s => s.name || s.type).join(', '));
            console.log('  - angleSeriesVisible:', angleSeriesVisible, ', angleSeries.length:', angleSeries.length);
            console.log('  - angleSerieså†…å®¹:', angleSeries.map(s => `${s.name}(${s.data.length}ç‚¹)`).join(', '));
            // è¾“å‡ºæ•£ç‚¹å›¾seriesè¯¦ç»†ä¿¡æ¯
            option.series.forEach((s, idx) => {
                if (s.type === 'scatter') {
                    console.log(`  ğŸ“ æ•£ç‚¹ç³»åˆ— ${idx}: ${s.name}, æ•°æ®ç‚¹æ•°: ${s.data.length}, symbolSize: ${s.symbolSize}, z: ${s.z}, symbol: ${s.symbol}`);
                    console.log(`     å‰3ä¸ªæ•°æ®ç‚¹:`, s.data.slice(0, 3));
                    // æ£€æŸ¥æ•°æ®ç‚¹çš„valueæ ¼å¼
                    s.data.slice(0, 3).forEach((d, i) => {
                        console.log(`       æ•°æ®ç‚¹${i}: value=[${d.value[0]}, ${d.value[1]}]`);
                    });
                }
            });
            
            // ä½¿ç”¨ notMerge: true ç¡®ä¿æ¸…é™¤æ—§æ•°æ®ï¼Œé˜²æ­¢æ—¥æœŸåˆ‡æ¢åçš„æ®‹å½±
            if (chart) {
                chart.setOption(option, {
                    notMerge: true,  // ä¸åˆå¹¶ï¼Œå®Œå…¨æ›¿æ¢
                    replaceMerge: ['series']  // æ›¿æ¢seriesæ•°ç»„
                });
                
                // ç¡®ä¿å›¾è¡¨å®¹å™¨å¯è§
                const chartContainer = document.getElementById('mainChart');
                if (chartContainer) {
                    chartContainer.style.display = 'block';
                    chartContainer.style.visibility = 'visible';
                    chartContainer.style.opacity = '1';
                    console.log('âœ… å›¾è¡¨å®¹å™¨å·²è®¾ç½®ä¸ºå¯è§');
                }
                
                // å¼ºåˆ¶å›¾è¡¨resizeä»¥ç¡®ä¿æ­£ç¡®æ˜¾ç¤º
                setTimeout(() => {
                    if (chart) {
                        chart.resize();
                        console.log('âœ… å›¾è¡¨å·²resize');
                    }
                }, 100);
                
                console.log('âœ… å›¾è¡¨æ¸²æŸ“å®Œæˆ - ç³»åˆ—æ•°:', option.series.length, 'æ—¶é—´ç‚¹:', times.length);
            } else {
                console.error('âŒ å›¾è¡¨å¯¹è±¡ä¸ºnullï¼Œæ— æ³•è®¾ç½®é€‰é¡¹');
            }
        }
        
        // æŒ‰ç±»å‹åˆ†ç»„äº¤æ˜“
        function groupTradesByType(trades, times, values) {
            const groups = {
                longBuy: [],
                longSell: [],
                shortBuy: [],
                shortSell: []
            };
            
            trades.forEach(trade => {
                // ä½¿ç”¨ fillTime_str æˆ–è½¬æ¢ fillTime
                let timeStr = '';
                if (trade.fillTime_str) {
                    // æ ¼å¼: "2026-02-11 23:09:51"ï¼Œæå–æ—¶é—´éƒ¨åˆ†
                    timeStr = trade.fillTime_str.split(' ')[1] || '';
                } else if (trade.fillTime) {
                    // è½¬æ¢æ¯«ç§’æ—¶é—´æˆ³ä¸ºæ—¶é—´å­—ç¬¦ä¸²
                    const tradeTime = new Date(parseInt(trade.fillTime));
                    timeStr = `${String(tradeTime.getHours()).padStart(2, '0')}:${String(tradeTime.getMinutes()).padStart(2, '0')}:${String(tradeTime.getSeconds()).padStart(2, '0')}`;
                }
                
                if (!timeStr) {
                    console.warn('âš ï¸ äº¤æ˜“ç¼ºå°‘æœ‰æ•ˆæ—¶é—´:', trade);
                    return;
                }
                
                const timeIndex = times.findIndex(t => t >= timeStr);
                
                if (timeIndex >= 0 && timeIndex < values.length) {
                    const markData = {
                        time: times[timeIndex],
                        value: values[timeIndex],
                        count: trade.mergedCount || 1,
                        trade: trade,
                        rating: tradeRatings[trade.tradeId]  // æ·»åŠ è¯„ä»·ä¿¡æ¯
                    };
                    
                    if (trade.posSide === 'long' && trade.side === 'buy') {
                        groups.longBuy.push(markData);
                    } else if (trade.posSide === 'long' && trade.side === 'sell') {
                        groups.longSell.push(markData);
                    } else if (trade.posSide === 'short' && trade.side === 'sell') {
                        groups.shortBuy.push(markData);
                    } else if (trade.posSide === 'short' && trade.side === 'buy') {
                        groups.shortSell.push(markData);
                    }
                }
            });
            
            return groups;
        }
        
        // åˆ›å»ºè§’åº¦æ ‡è®°ç³»åˆ—
        function createAngleSeries(angleData, times, values) {
            if (!angleData || angleData.length === 0) {
                return [];
            }
            
            console.log('ğŸ“ åˆ›å»ºè§’åº¦æ ‡è®°:', angleData.length, 'ä¸ªè§’åº¦');
            
            const series = [];
            
            // ä¸Šå‡é”è§’ï¼ˆæ­£å€¼ï¼Œçº¢è‰²ä¸‰è§’å½¢ï¼‰
            const upAcute = angleData.filter(a => a.direction === 'up' && a.type === 'acute').map(a => ({
                time: a.peak_time,
                value: parseFloat(a.peak_price),  // è½¬æ¢ä¸ºæ•°å€¼
                angle: parseFloat(a.angle),       // è½¬æ¢ä¸ºæ•°å€¼
                date: a.date,
                hour: a.hour,
                angle_data: a  // ä¿å­˜å®Œæ•´çš„è§’åº¦æ•°æ®ç”¨äºåˆ é™¤
            }));
            
            // ä¸Šå‡é’è§’ï¼ˆæ­£å€¼ï¼Œæ©™è‰²æ–¹å—ï¼‰
            const upObtuse = angleData.filter(a => a.direction === 'up' && a.type === 'obtuse').map(a => ({
                time: a.peak_time,
                value: parseFloat(a.peak_price),  // è½¬æ¢ä¸ºæ•°å€¼
                angle: parseFloat(a.angle),       // è½¬æ¢ä¸ºæ•°å€¼
                date: a.date,
                hour: a.hour,
                angle_data: a  // ä¿å­˜å®Œæ•´çš„è§’åº¦æ•°æ®ç”¨äºåˆ é™¤
            }));
            
            // ä¸‹é™é”è§’ï¼ˆè´Ÿå€¼ï¼Œè“è‰²å€’ä¸‰è§’ï¼‰
            const downAcute = angleData.filter(a => a.direction === 'down' && a.type === 'acute').map(a => {
                const timeInTimes = times.includes(a.peak_time);
                console.log(`ğŸ” ä¸‹é™é”è§’æ—¶é—´ ${a.peak_time} åœ¨timesæ•°ç»„ä¸­: ${timeInTimes}`);
                return {
                    time: a.peak_time,
                    value: parseFloat(a.peak_price),  // è½¬æ¢ä¸ºæ•°å€¼
                    angle: parseFloat(a.angle),       // è½¬æ¢ä¸ºæ•°å€¼
                    date: a.date,
                    hour: a.hour,
                    angle_data: a  // ä¿å­˜å®Œæ•´çš„è§’åº¦æ•°æ®ç”¨äºåˆ é™¤
                };
            });
            
            // ä¸‹é™é’è§’ï¼ˆè´Ÿå€¼ï¼Œç´«è‰²è±å½¢ï¼‰
            const downObtuse = angleData.filter(a => a.direction === 'down' && a.type === 'obtuse').map(a => {
                const timeInTimes = times.includes(a.peak_time);
                console.log(`ğŸ” ä¸‹é™é’è§’æ—¶é—´ ${a.peak_time} åœ¨timesæ•°ç»„ä¸­: ${timeInTimes}`);
                return {
                    time: a.peak_time,
                    value: parseFloat(a.peak_price),  // è½¬æ¢ä¸ºæ•°å€¼
                    angle: parseFloat(a.angle),       // è½¬æ¢ä¸ºæ•°å€¼
                    date: a.date,
                    hour: a.hour,
                    angle_data: a  // ä¿å­˜å®Œæ•´çš„è§’åº¦æ•°æ®ç”¨äºåˆ é™¤
                };
            });
            
            console.log(`ğŸ“Š è§’åº¦åˆ†ç±»: â†—ï¸ä¸Šå‡é”è§’${upAcute.length} â†—ï¸ä¸Šå‡é’è§’${upObtuse.length} â†˜ï¸ä¸‹é™é”è§’${downAcute.length} â†˜ï¸ä¸‹é™é’è§’${downObtuse.length}`);
            
            // è°ƒè¯•ï¼šæ‰“å°è§’åº¦æ•°æ®çš„æ—¶é—´å’Œå€¼
            if (downAcute.length > 0) {
                console.log('ğŸ“ ä¸‹é™é”è§’æ•°æ®:', downAcute.map(a => `${a.time}=${a.value}`).join(', '));
                // æ£€æŸ¥æ—¶é—´æ˜¯å¦åœ¨timesæ•°ç»„ä¸­
                downAcute.forEach(a => {
                    const inTimes = times.includes(a.time);
                    console.log(`   ${a.time} åœ¨timesä¸­: ${inTimes ? 'âœ…' : 'âŒ'}`);
                });
            }
            if (downObtuse.length > 0) {
                console.log('ğŸ“ ä¸‹é™é’è§’æ•°æ®:', downObtuse.map(a => `${a.time}=${a.value}`).join(', '));
                // æ£€æŸ¥æ—¶é—´æ˜¯å¦åœ¨timesæ•°ç»„ä¸­
                downObtuse.forEach(a => {
                    const inTimes = times.includes(a.time);
                    console.log(`   ${a.time} åœ¨timesä¸­: ${inTimes ? 'âœ…' : 'âŒ'}`);
                });
            }
            
            // æ·»åŠ ä¸Šå‡é”è§’ç³»åˆ—ï¼ˆçº¢è‰²ï¼Œä¸‰è§’å½¢ï¼‰
            if (upAcute.length > 0) {
                series.push({
                    name: 'â†—ï¸ ä¸Šå‡é”è§’',
                    type: 'scatter',
                    symbol: 'triangle',
                    symbolSize: 25,
                    symbolRotate: 0,  // æ­£ä¸‰è§’å½¢ï¼Œå°–ç«¯å‘ä¸Š
                    data: upAcute.map(m => ({
                        value: [m.time, m.value],
                        angle_data: m.angle_data
                    })),
                    itemStyle: { 
                        color: '#e53e3e',  // æ·±çº¢è‰²
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: (params) => `${upAcute[params.dataIndex].angle.toFixed(1)}Â°`,
                        position: 'top',
                        fontSize: 12,
                        fontWeight: 'bold',
                        color: '#fff',
                        backgroundColor: '#e53e3e',
                        padding: [3, 8],
                        borderRadius: 4,
                        offset: [0, -10]
                    },
                    tooltip: {
                        formatter: (params) => {
                            const item = upAcute[params.dataIndex];
                            const isManual = item.angle_data.manual ? ' [æ‰‹åŠ¨]' : '';
                            return `<strong>â†—ï¸ ä¸Šå‡é”è§’${isManual}</strong><br/>
                                    æ—¶æ®µ: ${item.hour}:00-${parseInt(item.hour)+1}:00<br/>
                                    è§’åº¦: <strong>${item.angle.toFixed(2)}Â°</strong><br/>
                                    å³°å€¼: ${item.value.toFixed(2)}%`;
                        }
                    },
                    z: 20
                });
            }
            
            // æ·»åŠ ä¸Šå‡é’è§’ç³»åˆ—ï¼ˆæ©™è‰²ï¼Œæ–¹å—ï¼‰
            if (upObtuse.length > 0) {
                series.push({
                    name: 'â†—ï¸ ä¸Šå‡é’è§’',
                    type: 'scatter',
                    symbol: 'rect',
                    symbolSize: 22,
                    data: upObtuse.map(m => ({
                        value: [m.time, m.value],
                        angle_data: m.angle_data
                    })),
                    itemStyle: { 
                        color: '#dd6b20',  // æ©™è‰²
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: (params) => `${upObtuse[params.dataIndex].angle.toFixed(1)}Â°`,
                        position: 'top',
                        fontSize: 12,
                        fontWeight: 'bold',
                        color: '#fff',
                        backgroundColor: '#dd6b20',
                        padding: [3, 8],
                        borderRadius: 4,
                        offset: [0, -10]
                    },
                    tooltip: {
                        formatter: (params) => {
                            const item = upObtuse[params.dataIndex];
                            return `<strong>â†—ï¸ ä¸Šå‡é’è§’</strong><br/>
                                    æ—¶æ®µ: ${item.hour}:00-${parseInt(item.hour)+1}:00<br/>
                                    è§’åº¦: <strong>${item.angle.toFixed(2)}Â°</strong><br/>
                                    å³°å€¼: ${item.value.toFixed(2)}%`;
                        }
                    },
                    z: 20
                });
            }
            
            // æ·»åŠ ä¸‹é™é”è§’ç³»åˆ—ï¼ˆè“è‰²ï¼Œå€’ä¸‰è§’å½¢ï¼‰
            if (downAcute.length > 0) {
                series.push({
                    name: 'â†˜ï¸ ä¸‹é™é”è§’',
                    type: 'scatter',
                    symbol: 'triangle',
                    symbolSize: 50,  // å¢å¤§å°ºå¯¸ï¼š25 -> 50
                    symbolRotate: 180,  // å€’ä¸‰è§’å½¢ï¼Œå°–ç«¯å‘ä¸‹
                    data: downAcute.map(m => ({
                        value: [m.time, m.value],
                        angle_data: m.angle_data
                    })),
                    itemStyle: { 
                        color: '#3182ce',  // è“è‰²
                        borderColor: '#fff',
                        borderWidth: 3  // å¢åŠ è¾¹æ¡†ï¼š2 -> 3
                    },
                    label: {
                        show: true,
                        formatter: (params) => `${downAcute[params.dataIndex].angle.toFixed(1)}Â°`,
                        position: 'bottom',  // è´Ÿå€¼åœ¨ä¸‹æ–¹æ˜¾ç¤ºæ ‡ç­¾
                        fontSize: 14,  // å¢å¤§å­—ä½“ï¼š12 -> 14
                        fontWeight: 'bold',
                        color: '#fff',
                        backgroundColor: '#3182ce',
                        padding: [4, 10],  // å¢å¤§å†…è¾¹è·
                        borderRadius: 4,
                        offset: [0, 15]  // å¢å¤§åç§»ï¼š10 -> 15
                    },
                    tooltip: {
                        formatter: (params) => {
                            const item = downAcute[params.dataIndex];
                            const isManual = item.angle_data.manual ? ' [æ‰‹åŠ¨]' : '';
                            return `<strong>â†˜ï¸ ä¸‹é™é”è§’${isManual}</strong><br/>
                                    æ—¶æ®µ: ${item.hour}:00-${parseInt(item.hour)+1}:00<br/>
                                    è§’åº¦: <strong>${item.angle.toFixed(2)}Â°</strong><br/>
                                    è°·åº•: ${item.value.toFixed(2)}%`;
                        }
                    },
                    z: 100  // æé«˜å±‚çº§ï¼š20 -> 100
                });
            }
            
            // æ·»åŠ ä¸‹é™é’è§’ç³»åˆ—ï¼ˆç´«è‰²ï¼Œè±å½¢ï¼‰
            if (downObtuse.length > 0) {
                series.push({
                    name: 'â†˜ï¸ ä¸‹é™é’è§’',
                    type: 'scatter',
                    symbol: 'diamond',
                    symbolSize: 50,  // å¢å¤§å°ºå¯¸ï¼š25 -> 50
                    data: downObtuse.map(m => ({
                        value: [m.time, m.value],
                        angle_data: m.angle_data
                    })),
                    itemStyle: { 
                        color: '#805ad5',  // ç´«è‰²
                        borderColor: '#fff',
                        borderWidth: 3  // å¢åŠ è¾¹æ¡†ï¼š2 -> 3
                    },
                    label: {
                        show: true,
                        formatter: (params) => `${downObtuse[params.dataIndex].angle.toFixed(1)}Â°`,
                        position: 'bottom',  // è´Ÿå€¼åœ¨ä¸‹æ–¹æ˜¾ç¤ºæ ‡ç­¾
                        fontSize: 14,  // å¢å¤§å­—ä½“ï¼š12 -> 14
                        fontWeight: 'bold',
                        color: '#fff',
                        backgroundColor: '#805ad5',
                        padding: [4, 10],  // å¢å¤§å†…è¾¹è·
                        borderRadius: 4,
                        offset: [0, 15]  // å¢å¤§åç§»ï¼š10 -> 15
                    },
                    tooltip: {
                        formatter: (params) => {
                            const item = downObtuse[params.dataIndex];
                            const isManual = item.angle_data.manual ? ' [æ‰‹åŠ¨]' : '';
                            return `<strong>â†˜ï¸ ä¸‹é™é’è§’${isManual}</strong><br/>
                                    æ—¶æ®µ: ${item.hour}:00-${parseInt(item.hour)+1}:00<br/>
                                    è§’åº¦: <strong>${item.angle.toFixed(2)}Â°</strong><br/>
                                    è°·åº•: ${item.value.toFixed(2)}%`;
                        }
                    },
                    z: 100  // æé«˜å±‚çº§ï¼š20 -> 100
                });
            }
            
            console.log('ğŸ“ è§’åº¦ç³»åˆ—:', series.length, 'ä¸ªç³»åˆ—');
            
            return series;
        }
        
        // åˆ›å»ºæ•£ç‚¹å›¾ç³»åˆ—
        function createScatterSeries(name, marks, color, symbol, label) {
            if (marks.length === 0) {
                return [];
            }
            
            return [{
                name: name,
                type: 'scatter',
                symbol: symbol,
                symbolSize: 30,  // å¢å¤§å°ºå¯¸ï¼š16 -> 30
                data: marks.map(m => ({
                    value: [m.time, m.value],
                    trade: m.trade,  // ä¿å­˜å®Œæ•´äº¤æ˜“æ•°æ®
                    rating: tradeRatings[m.trade.tradeId]  // ä¿å­˜è¯„ä»·ä¿¡æ¯
                })),
                itemStyle: { 
                    color: color,
                    borderColor: '#fff',
                    borderWidth: 3,  // å¢åŠ è¾¹æ¡†å®½åº¦
                    shadowBlur: 6,   // æ·»åŠ é˜´å½±
                    shadowColor: color,
                    shadowOffsetX: 0,
                    shadowOffsetY: 2
                },
                label: {
                    show: true,  // å§‹ç»ˆæ˜¾ç¤ºæ ‡ç­¾
                    formatter: (params) => {
                        const rating = marks[params.dataIndex].rating || tradeRatings[marks[params.dataIndex].trade.tradeId];
                        let ratingIcon = '';
                        if (rating) {
                            ratingIcon = rating.rating === 'correct' ? '\nâœ…' : '\nâŒ';
                        }
                        return label + ratingIcon;
                    },
                    position: 'top',
                    fontSize: 13,  // å¢å¤§å­—ä½“
                    fontWeight: 'bold',
                    color: '#fff',  // ç™½è‰²æ–‡å­—
                    backgroundColor: color,  // ä½¿ç”¨å¯¹åº”é¢œè‰²èƒŒæ™¯
                    padding: [4, 10],  // å¢å¤§å†…è¾¹è·
                    borderRadius: 6,
                    offset: [0, -8]  // å‘ä¸Šåç§»ï¼Œé¿å…ä¸å›¾æ ‡é‡å 
                },
                tooltip: {
                    formatter: (params) => {
                        const mark = marks[params.dataIndex];
                        const trade = mark.trade;
                        const rating = mark.rating || tradeRatings[trade.tradeId];
                        
                        let tooltipHtml = `<strong style="font-size: 14px;">${name}</strong><br/>`;
                        tooltipHtml += `æ—¶é—´: ${mark.time}<br/>`;
                        tooltipHtml += `ä»·æ ¼: ${mark.value.toFixed(2)}%`;
                        
                        if (rating) {
                            const ratingText = rating.rating === 'correct' ? '<span style="color: #48bb78">âœ… æ­£ç¡®</span>' : '<span style="color: #f56565">âŒ é”™è¯¯</span>';
                            tooltipHtml += `<br/><br/><strong>è¯„ä»·:</strong> ${ratingText}`;
                            if (rating.note) {
                                tooltipHtml += `<br/><strong>å¤‡æ³¨:</strong> ${rating.note}`;
                            }
                        } else {
                            tooltipHtml += `<br/><br/><em style="color: #a0aec0;">ç‚¹å‡»æ·»åŠ è¯„ä»·</em>`;
                        }
                        
                        return tooltipHtml;
                    }
                },
                emphasis: {
                    label: {
                        show: true,
                        fontSize: 14  // æ‚¬åœæ—¶å­—ä½“æ›´å¤§
                    },
                    itemStyle: {
                        borderWidth: 4,
                        shadowBlur: 10
                    }
                },
                z: 25  // æœ€é«˜å±‚çº§ï¼Œç¡®ä¿åœ¨è§’åº¦æ ‡è®°ä¹‹ä¸Š
            }];
        }

        // æ¸²æŸ“äº¤æ˜“åˆ—è¡¨
        function renderTradeList(trades) {
            const container = document.getElementById('tradeListContent');
            
            if (trades.length === 0) {
                container.innerHTML = '<div class="loading">å½“æ—¥æš‚æ— äº¤æ˜“</div>';
                return;
            }
            
            let html = '<table class="trade-table">';
            html += '<thead><tr>';
            html += '<th>æ—¶é—´</th>';
            html += '<th>å¸ç§</th>';
            html += '<th>ç±»å‹</th>';
            html += '<th>ä»·æ ¼</th>';
            html += '<th>æ•°é‡</th>';
            html += '<th>æ‰‹ç»­è´¹</th>';
            html += '<th>äº¤æ˜“ID</th>';
            html += '</tr></thead>';
            html += '<tbody>';
            
            trades.forEach(trade => {
                // ä½¿ç”¨ fillTime_str æˆ–å°† fillTime è½¬æ¢ä¸ºæ•°å­—
                let timeStr = 'N/A';
                if (trade.fillTime_str) {
                    // æ ¼å¼: "2026-02-11 23:09:51"ï¼Œæå–æ—¶é—´éƒ¨åˆ†
                    timeStr = trade.fillTime_str.split(' ')[1] || 'N/A';
                } else if (trade.fillTime) {
                    // å°†æ¯«ç§’æ—¶é—´æˆ³è½¬æ¢ä¸ºæ—¥æœŸ
                    const tradeTime = new Date(parseInt(trade.fillTime));
                    timeStr = `${String(tradeTime.getHours()).padStart(2, '0')}:${String(tradeTime.getMinutes()).padStart(2, '0')}:${String(tradeTime.getSeconds()).padStart(2, '0')}`;
                }
                
                let typeClass = '';
                let typeText = '';
                if (trade.posSide === 'long' && trade.side === 'buy') {
                    typeClass = 'long-buy';
                    typeText = 'å¤šå¼€';
                } else if (trade.posSide === 'long' && trade.side === 'sell') {
                    typeClass = 'long-sell';
                    typeText = 'å¤šå¹³';
                } else if (trade.posSide === 'short' && trade.side === 'sell') {
                    typeClass = 'short-buy';
                    typeText = 'ç©ºå¼€';
                } else if (trade.posSide === 'short' && trade.side === 'buy') {
                    typeClass = 'short-sell';
                    typeText = 'ç©ºå¹³';
                }
                
                html += '<tr>';
                html += `<td>${timeStr}</td>`;
                html += `<td><strong>${trade.instId.replace('-USDT-SWAP', '')}</strong></td>`;
                html += `<td><span class="trade-type ${typeClass}">${typeText}</span>`;
                if (trade.mergedCount > 1) {
                    html += `<span class="merged-badge">åˆå¹¶${trade.mergedCount}ç¬”</span>`;
                }
                html += `</td>`;
                html += `<td>${parseFloat(trade.fillPx).toFixed(4)}</td>`;
                html += `<td>${parseFloat(trade.fillSz).toFixed(2)}</td>`;
                html += `<td>${parseFloat(trade.fee).toFixed(4)}</td>`;
                html += `<td style="font-size: 11px; color: #718096;">${trade.tradeId}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // åˆ›å»ºåŠ è½½è¿›åº¦ç•Œé¢
        function createLoadingOverlay() {
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.75);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(5px);
                animation: fadeIn 0.3s ease-in-out;
            `;
            
            overlay.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    padding: 40px 50px;
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                    min-width: 500px;
                    max-width: 600px;
                    color: white;
                    animation: slideUp 0.4s ease-out;
                ">
                    <h2 style="margin: 0 0 20px 0; font-size: 24px; font-weight: 600; text-align: center;">
                        <i class="fas fa-chart-line" style="margin-right: 10px;"></i>
                        æ•°æ®åŠ è½½ä¸­
                    </h2>
                    
                    <!-- è¿›åº¦æ¡ -->
                    <div style="
                        background: rgba(255, 255, 255, 0.2);
                        border-radius: 10px;
                        height: 30px;
                        margin-bottom: 20px;
                        overflow: hidden;
                        position: relative;
                    ">
                        <div id="progressBar" style="
                            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
                            height: 100%;
                            width: 0%;
                            border-radius: 10px;
                            transition: width 0.3s ease-out;
                            box-shadow: 0 0 20px rgba(79, 172, 254, 0.5);
                        "></div>
                        <div id="progressText" style="
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            font-weight: 600;
                            font-size: 14px;
                            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                        ">0%</div>
                    </div>
                    
                    <!-- åŠ è½½æ­¥éª¤åˆ—è¡¨ -->
                    <div id="loadingSteps" style="
                        background: rgba(0, 0, 0, 0.2);
                        border-radius: 10px;
                        padding: 20px;
                        font-size: 14px;
                    ">
                        <div id="step1" class="loading-step" style="opacity: 0.5;">
                            <i class="fas fa-circle" style="font-size: 8px; margin-right: 10px; color: #888;"></i>
                            <span>ğŸ“Š åˆå§‹åŒ–å›¾è¡¨ç¯å¢ƒ...</span>
                        </div>
                        <div id="step2" class="loading-step" style="opacity: 0.5; margin-top: 12px;">
                            <i class="fas fa-circle" style="font-size: 8px; margin-right: 10px; color: #888;"></i>
                            <span>ğŸ“ˆ åŠ è½½è¶‹åŠ¿æ•°æ®ï¼ˆ27å¸ç§æ¶¨è·Œå¹…ï¼‰...</span>
                        </div>
                        <div id="step3" class="loading-step" style="opacity: 0.5; margin-top: 12px;">
                            <i class="fas fa-circle" style="font-size: 8px; margin-right: 10px; color: #888;"></i>
                            <span>ğŸ’¼ åŠ è½½äº¤æ˜“å†å²ï¼ˆå¼€ä»“/å¹³ä»“è®°å½•ï¼‰...</span>
                        </div>
                        <div id="step4" class="loading-step" style="opacity: 0.5; margin-top: 12px;">
                            <i class="fas fa-circle" style="font-size: 8px; margin-right: 10px; color: #888;"></i>
                            <span>ğŸ“ åŠ è½½è§’åº¦æ ‡è®°ï¼ˆKçº¿å½¢æ€è¯†åˆ«ï¼‰...</span>
                        </div>
                        <div id="step5" class="loading-step" style="opacity: 0.5; margin-top: 12px;">
                            <i class="fas fa-circle" style="font-size: 8px; margin-right: 10px; color: #888;"></i>
                            <span>ğŸ¨ æ¸²æŸ“å›¾è¡¨ï¼ˆæ•°æ®å¯è§†åŒ–ï¼‰...</span>
                        </div>
                        <div id="step6" class="loading-step" style="opacity: 0.5; margin-top: 12px;">
                            <i class="fas fa-circle" style="font-size: 8px; margin-right: 10px; color: #888;"></i>
                            <span>âš™ï¸ è®¾ç½®äº¤äº’äº‹ä»¶ï¼ˆç‚¹å‡»ã€å³é”®æ“ä½œï¼‰...</span>
                        </div>
                    </div>
                    
                    <div id="loadingStatus" style="
                        margin-top: 15px;
                        text-align: center;
                        font-size: 13px;
                        opacity: 0.8;
                    ">
                        æ­£åœ¨å‡†å¤‡æ•°æ®...
                    </div>
                </div>
            `;
            
            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from {
                        transform: translateY(30px);
                        opacity: 0;
                    }
                    to {
                        transform: translateY(0);
                        opacity: 1;
                    }
                }
                .loading-step.active {
                    opacity: 1 !important;
                }
                .loading-step.active i {
                    color: #4facfe !important;
                    animation: pulse 1s infinite;
                }
                .loading-step.completed {
                    opacity: 1 !important;
                }
                .loading-step.completed i {
                    color: #00f2fe !important;
                }
                @keyframes pulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.5; }
                }
            `;
            document.head.appendChild(style);
            
            return overlay;
        }
        
        // æ›´æ–°åŠ è½½è¿›åº¦
        function updateLoadingProgress(step, percentage, status) {
            console.log(`ğŸ“Š è¿›åº¦æ›´æ–°: æ­¥éª¤${step}, ${percentage}%, ${status}`);
            
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const loadingStatus = document.getElementById('loadingStatus');
            const stepElement = document.getElementById(`step${step}`);
            
            if (progressBar) {
                progressBar.style.width = percentage + '%';
                progressText.textContent = Math.round(percentage) + '%';
            } else {
                console.warn('âš ï¸ æ‰¾ä¸åˆ° progressBar å…ƒç´ ');
            }
            
            if (loadingStatus) {
                loadingStatus.textContent = status;
            } else {
                console.warn('âš ï¸ æ‰¾ä¸åˆ° loadingStatus å…ƒç´ ');
            }
            
            // æ›´æ–°æ­¥éª¤çŠ¶æ€
            if (stepElement) {
                // æ ‡è®°å½“å‰æ­¥éª¤ä¸ºæ´»åŠ¨çŠ¶æ€
                stepElement.classList.add('active');
                
                // æ ‡è®°ä¹‹å‰çš„æ­¥éª¤ä¸ºå·²å®Œæˆ
                for (let i = 1; i < step; i++) {
                    const prevStep = document.getElementById(`step${i}`);
                    if (prevStep) {
                        prevStep.classList.remove('active');
                        prevStep.classList.add('completed');
                        const icon = prevStep.querySelector('i');
                        if (icon) {
                            icon.className = 'fas fa-check-circle';
                        }
                    }
                }
            }
        }
        
        function showLoading() {
            // ç§»é™¤æ—§çš„åŠ è½½ç•Œé¢ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const oldOverlay = document.getElementById('loadingOverlay');
            if (oldOverlay) {
                oldOverlay.remove();
            }
            
            // åˆ›å»ºæ–°çš„åŠ è½½ç•Œé¢
            const overlay = createLoadingOverlay();
            document.body.appendChild(overlay);
            
            // åŒæ—¶æ›´æ–°äº¤æ˜“åˆ—è¡¨åŒºåŸŸ
            const tradeList = document.getElementById('tradeListContent');
            if (tradeList) {
                tradeList.innerHTML = '<div class="loading">æ•°æ®åŠ è½½ä¸­...</div>';
            }
        }

        function hideLoading() {
            try {
                console.log('ğŸ”„ hideLoading è¢«è°ƒç”¨');
                
                // æ–¹æ³•1: ç«‹å³ç§»é™¤æ‰€æœ‰å¯èƒ½çš„åŠ è½½ç•Œé¢å…ƒç´ ï¼ˆä¸ç­‰åŠ¨ç”»ï¼‰
                const overlays = document.querySelectorAll('#loadingOverlay, [id^="loadingOverlay"]');
                console.log('ğŸ“ æ‰¾åˆ°åŠ è½½ç•Œé¢å…ƒç´ æ•°é‡:', overlays.length);
                
                overlays.forEach((overlay, index) => {
                    console.log(`ğŸ—‘ï¸  ç§»é™¤ç¬¬${index + 1}ä¸ªåŠ è½½ç•Œé¢`);
                    overlay.remove();
                });
                
                // æ–¹æ³•2: ç¡®ä¿bodyæ²¡æœ‰overflow:hiddenæ ·å¼
                document.body.style.overflow = '';
                
                console.log('âœ… åŠ è½½ç•Œé¢å·²å¼ºåˆ¶ç§»é™¤ï¼ˆå…±' + overlays.length + 'ä¸ªï¼‰');
            } catch (e) {
                console.error('âŒ hideLoading æ‰§è¡Œå¤±è´¥:', e);
                // æœ€åçš„ä¿é™©: ç›´æ¥æ¸…é™¤æ‰€æœ‰ç»å¯¹å®šä½çš„å…¨å±å…ƒç´ 
                try {
                    const allFixed = document.querySelectorAll('[style*="position: fixed"], [style*="position:fixed"]');
                    allFixed.forEach(el => {
                        if (el.id && el.id.includes('loading')) {
                            console.log('ğŸ”¥ å¼ºåˆ¶ç§»é™¤:', el.id);
                            el.remove();
                        }
                    });
                } catch (e2) {
                    console.error('âŒ å¼ºåˆ¶æ¸…ç†ä¹Ÿå¤±è´¥:', e2);
                }
            }
        }
        
        // æ·»åŠ ä¸€ä¸ªæœ€åçš„ä¿é™©æœºåˆ¶ï¼šé¡µé¢å®Œå…¨åŠ è½½å5ç§’å†…å¦‚æœè¿˜æœ‰loading overlayå°±å¼ºåˆ¶ç§»é™¤
        window.addEventListener('load', () => {
            setTimeout(() => {
                const remainingOverlays = document.querySelectorAll('#loadingOverlay, [id^="loadingOverlay"]');
                if (remainingOverlays.length > 0) {
                    console.warn('âš ï¸ æ£€æµ‹åˆ°æ®‹ç•™åŠ è½½ç•Œé¢ï¼Œå¼ºåˆ¶æ¸…ç†');
                    remainingOverlays.forEach(overlay => overlay.remove());
                    document.body.style.overflow = '';
                    console.log('âœ… æ®‹ç•™åŠ è½½ç•Œé¢å·²æ¸…ç†');
                }
            }, 5000);  // 5ç§’åæ£€æŸ¥
        });
        
        // æ—§çš„hideLoadingä¿ç•™ï¼ˆå‘åå…¼å®¹ï¼‰
        function hideLoadingOld() {
            try {
                const overlay = document.getElementById('loadingOverlay');
                console.log('ğŸ”„ hideLoading è¢«è°ƒç”¨, overlayå­˜åœ¨:', !!overlay);
                
                if (overlay) {
                    // ç«‹å³éšè—ï¼Œä¸ç­‰å¾…åŠ¨ç”»
                    overlay.style.opacity = '0';
                    overlay.style.transition = 'opacity 0.3s ease-out';
                    
                    // 300msåç§»é™¤å…ƒç´ 
                    setTimeout(() => {
                        overlay.remove();
                        console.log('âœ… åŠ è½½ç•Œé¢å·²ç§»é™¤');
                    }, 300);
                } else {
                    console.warn('âš ï¸ æ‰¾ä¸åˆ°åŠ è½½ç•Œé¢å…ƒç´ ');
                }
                
                // æ·»åŠ æ·¡å‡ºåŠ¨ç”»æ ·å¼ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
                if (!document.getElementById('fadeOutStyle')) {
                    const style = document.createElement('style');
                    style.id = 'fadeOutStyle';
                    style.textContent = `
                        @keyframes fadeOut {
                            from { opacity: 1; }
                            to { opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }
            } catch (e) {
                console.error('âŒ hideLoading æ‰§è¡Œå¤±è´¥:', e);
            }
        }

        function showError(message) {
            document.getElementById('tradeListContent').innerHTML = `<div class="error">${message}</div>`;
        }

        // ==================== æ‰‹åŠ¨è§’åº¦æ ‡è®°åŠŸèƒ½ ====================
        let angleModeActive = false;
        let angleDirection = null;  // 'up' æˆ– 'down'
        let selectedPoints = [];    // å­˜å‚¨é€‰ä¸­çš„ç‚¹ [Aç‚¹, C'ç‚¹]
        let manualAngles = [];      // å­˜å‚¨æ‰‹åŠ¨æ·»åŠ çš„è§’åº¦
        let currentTrendData = [];  // å½“å‰è¶‹åŠ¿æ•°æ®
        let currentTimes = [];      // å½“å‰æ—¶é—´è½´
        let currentValues = [];     // å½“å‰æ•°å€¼
        
        // åˆ‡æ¢è§’åº¦æ ‡è®°æ¨¡å¼
        function toggleAngleMode() {
            angleModeActive = !angleModeActive;
            const btn = document.getElementById('toggleAngleModeBtn');
            const hint = document.getElementById('angleModeHint');
            const cancelBtn = document.getElementById('cancelAngleBtn');
            const directionButtons = document.getElementById('directionButtons');
            
            if (angleModeActive) {
                btn.textContent = 'âœ… è§’åº¦æ ‡è®°æ¨¡å¼ (ç‚¹å‡»é€€å‡º)';
                btn.style.background = '#48bb78';
                hint.style.display = 'block';
                cancelBtn.style.display = 'block';
                directionButtons.style.display = 'flex';
                selectedPoints = [];
                angleDirection = null;
                updateAngleStepInfo();
                console.log('ğŸ“ è§’åº¦æ ‡è®°æ¨¡å¼å·²æ¿€æ´» - éšè—äº¤æ˜“æ ‡è®°å’Œè§’åº¦æ ‡è®°');
                // é‡æ–°æ¸²æŸ“å›¾è¡¨ä»¥éšè—æ ‡è®°
                loadData();
            } else {
                btn.textContent = 'ğŸ“ è¿›å…¥è§’åº¦æ ‡è®°æ¨¡å¼';
                btn.style.background = '#4299e1';
                hint.style.display = 'none';
                cancelBtn.style.display = 'none';
                directionButtons.style.display = 'none';
                document.getElementById('angleStepInfo').style.display = 'none';
                selectedPoints = [];
                angleDirection = null;
                // é‡ç½®æ–¹å‘æŒ‰é’®æ ·å¼
                resetDirectionButtons();
                console.log('ğŸ“ è§’åº¦æ ‡è®°æ¨¡å¼å·²å…³é—­ - æ˜¾ç¤ºäº¤æ˜“æ ‡è®°å’Œè§’åº¦æ ‡è®°');
                // é‡æ–°æ¸²æŸ“å›¾è¡¨ä»¥æ˜¾ç¤ºæ ‡è®°
                loadData();
            }
        }
        
        // é€‰æ‹©è§’åº¦æ–¹å‘
        function selectDirection(direction) {
            angleDirection = direction;
            selectedPoints = [];  // é‡ç½®é€‰ä¸­çš„ç‚¹
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            const upBtn = document.getElementById('upAngleBtn');
            const downBtn = document.getElementById('downAngleBtn');
            
            if (direction === 'up') {
                upBtn.style.background = '#4caf50';
                upBtn.style.color = 'white';
                downBtn.style.background = '#e3f2fd';
                downBtn.style.color = '#1565c0';
                console.log('âœ… é€‰æ‹©äº†æ­£è§’ï¼ˆä¸Šå‡ï¼‰æ–¹å‘');
            } else {
                downBtn.style.background = '#2196f3';
                downBtn.style.color = 'white';
                upBtn.style.background = '#e8f5e9';
                upBtn.style.color = '#2e7d32';
                console.log('âœ… é€‰æ‹©äº†è´Ÿè§’ï¼ˆä¸‹é™ï¼‰æ–¹å‘');
            }
            
            updateAngleStepInfo();
        }
        
        // é‡ç½®æ–¹å‘æŒ‰é’®æ ·å¼
        function resetDirectionButtons() {
            const upBtn = document.getElementById('upAngleBtn');
            const downBtn = document.getElementById('downAngleBtn');
            upBtn.style.background = '#e8f5e9';
            upBtn.style.color = '#2e7d32';
            downBtn.style.background = '#e3f2fd';
            downBtn.style.color = '#1565c0';
        }
        
        // å–æ¶ˆå½“å‰è§’åº¦æ ‡è®°
        function cancelAngleMarking() {
            selectedPoints = [];
            angleDirection = null;
            resetDirectionButtons();
            updateAngleStepInfo();
            console.log('âŒ å·²å–æ¶ˆå½“å‰è§’åº¦æ ‡è®°');
        }
        
        // æ›´æ–°æ­¥éª¤æç¤º
        function updateAngleStepInfo() {
            const stepInfo = document.getElementById('angleStepInfo');
            const clearBtn = document.getElementById('clearAllAnglesBtn');
            const hint = document.getElementById('angleModeHint');
            
            // æ˜¾ç¤º/éšè—æ¸…é™¤æŒ‰é’®
            if (manualAngles.length > 0) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
            }
            
            // å¦‚æœæ²¡æœ‰é€‰æ‹©æ–¹å‘
            if (!angleDirection) {
                stepInfo.style.display = 'none';
                hint.innerHTML = '<strong>ğŸ“ è¯·å…ˆé€‰æ‹©è§’åº¦æ–¹å‘</strong> - â†—ï¸æ­£è§’ï¼ˆä¸Šå‡ï¼‰æˆ– â†˜ï¸è´Ÿè§’ï¼ˆä¸‹é™ï¼‰';
                return;
            }
            
            // å·²é€‰æ‹©æ–¹å‘
            const directionText = angleDirection === 'up' ? 'â†—ï¸æ­£è§’ï¼ˆä¸Šå‡ï¼‰' : 'â†˜ï¸è´Ÿè§’ï¼ˆä¸‹é™ï¼‰';
            
            if (selectedPoints.length === 0) {
                hint.innerHTML = `<strong>ğŸ“ å·²é€‰æ‹©${directionText}</strong> - ç°åœ¨ç‚¹å‡»Aç‚¹ï¼ˆå³°å€¼/è°·åº•ï¼‰`;
                stepInfo.style.display = 'none';
            } else if (selectedPoints.length === 1) {
                hint.innerHTML = `<strong>ğŸ“ å·²é€‰æ‹©${directionText}</strong> - ç°åœ¨ç‚¹å‡»C'ç‚¹ï¼ˆèµ·å§‹ç‚¹ï¼Œæ—¶é—´éœ€æ™šäºBç‚¹ï¼‰`;
                stepInfo.style.display = 'block';
                stepInfo.textContent = `å·²é€‰æ‹© 1/2 ä¸ªç‚¹ï¼Œä¸‹ä¸€æ­¥: C'ç‚¹ï¼ˆæ—¶é—´éœ€æ™šäºBç‚¹ï¼‰`;
                highlightSelectedPoints();
            } else {
                stepInfo.style.display = 'block';
                stepInfo.textContent = `å·²é€‰æ‹© 2/2 ä¸ªç‚¹ï¼Œè‡ªåŠ¨å¯»æ‰¾Bç‚¹...`;
                highlightSelectedPoints();
            }
        }
        
        // é«˜äº®æ˜¾ç¤ºå·²é€‰æ‹©çš„ç‚¹
        function highlightSelectedPoints() {
            if (!chart || selectedPoints.length === 0) return;
            
            const highlightSeries = selectedPoints.map((point, index) => {
                const labels = ['A', 'C\'', 'B'];  // Aç‚¹å…ˆé€‰ï¼ŒC'ç‚¹åé€‰
                const colors = ['#f56565', '#9f7aea', '#4299e1'];
                return {
                    name: `é€‰ä¸­ç‚¹${labels[index]}`,
                    type: 'scatter',
                    data: [[point.time, point.value]],
                    symbol: 'circle',
                    symbolSize: 20,
                    itemStyle: {
                        color: colors[index],
                        borderColor: '#fff',
                        borderWidth: 3
                    },
                    label: {
                        show: true,
                        formatter: labels[index],
                        position: 'top',
                        fontSize: 14,
                        fontWeight: 'bold',
                        color: colors[index]
                    },
                    z: 100
                };
            });
            
            // é‡æ–°æ¸²æŸ“å›¾è¡¨ï¼ˆä¿ç•™åŸæœ‰æ•°æ®ï¼Œåªæ·»åŠ é«˜äº®ç‚¹ï¼‰
            if (chart) {
                const currentOption = chart.getOption();
                const newSeries = currentOption.series.filter(s => !s.name || !s.name.startsWith('é€‰ä¸­ç‚¹'));
                chart.setOption({
                    series: [...newSeries, ...highlightSeries]
                });
            } else {
                console.error('âŒ å›¾è¡¨å¯¹è±¡ä¸ºnullï¼Œæ— æ³•æ˜¾ç¤ºé€‰ä¸­ç‚¹');
            }
        }
        
        // è‡ªåŠ¨å¯»æ‰¾Bç‚¹ï¼ˆæ¶¨è·Œå¹…ä¸Cç‚¹æœ€æ¥è¿‘çš„ç‚¹ï¼‰
        // æ ¸å¿ƒé€»è¾‘ï¼šBç‚¹åœ¨Aç‚¹ä¹‹å‰ï¼Œä¸”æ¶¨è·Œå¹…ä¸Cç‚¹æœ€æ¥è¿‘
        // é™åˆ¶ï¼šBç‚¹å¿…é¡»åœ¨Aç‚¹å‰çš„åˆç†æ—¶é—´èŒƒå›´å†…ï¼ˆ120åˆ†é’Ÿï¼Œå³2å°æ—¶ï¼‰
        // direction: 'up'æ­£è§’ï¼ˆä¸Šå‡ï¼‰ æˆ– 'down'è´Ÿè§’ï¼ˆä¸‹é™ï¼‰
        function findValleyPoint(peakPoint, cPrimePoint, direction) {
            const peakIdx = currentTimes.indexOf(peakPoint.time);
            const cPrimeIdx = currentTimes.indexOf(cPrimePoint.time);
            
            if (peakIdx === -1 || cPrimeIdx === -1) {
                console.error('âŒ æ‰¾ä¸åˆ°å³°å€¼æˆ–C\'ç‚¹çš„ç´¢å¼•');
                return null;
            }
            
            console.log(`ğŸ” æŸ¥æ‰¾Bç‚¹: Aç‚¹=${peakPoint.time}(${currentValues[peakIdx].toFixed(2)}%), Cç‚¹=${cPrimePoint.time}(${cPrimePoint.value.toFixed(2)}%)`);
            console.log(`   ç›®æ ‡: æ‰¾Aç‚¹ä¹‹å‰2å°æ—¶å†…ï¼Œæ¶¨è·Œå¹…æœ€æ¥è¿‘Cç‚¹(${cPrimePoint.value.toFixed(2)}%)çš„ç‚¹`);
            
            const MIN_TIME_GAP = 2; // æœ€å°é—´éš”2åˆ†é’Ÿ
            const MAX_TIME_RANGE = 120; // æœ€å¤§æŸ¥æ‰¾èŒƒå›´120åˆ†é’Ÿï¼ˆ2å°æ—¶ï¼‰
            const cPrimeValue = cPrimePoint.value;
            
            let valleyIdx = -1;
            let minDiff = Infinity;
            
            const peakTime = parseTimeToMinutes(currentTimes[peakIdx]);
            
            // ä»Aç‚¹å¾€å‰æ‰¾ï¼Œé™åˆ¶åœ¨2å°æ—¶å†…ï¼Œå¯»æ‰¾æ¶¨è·Œå¹…æœ€æ¥è¿‘Cç‚¹çš„ç‚¹
            for (let i = peakIdx - 1; i >= 0; i--) {
                const currentTime = parseTimeToMinutes(currentTimes[i]);
                const timeDiff = peakTime - currentTime;
                
                // è·³è¿‡æ—¶é—´é—´éš”å¤ªå°çš„ç‚¹
                if (timeDiff < MIN_TIME_GAP) continue;
                
                // è¶…è¿‡æœ€å¤§æŸ¥æ‰¾èŒƒå›´ï¼Œåœæ­¢æŸ¥æ‰¾
                if (timeDiff > MAX_TIME_RANGE) {
                    console.log(`  â¹ï¸ å·²è¶…è¿‡æœ€å¤§æŸ¥æ‰¾èŒƒå›´(${MAX_TIME_RANGE}åˆ†é’Ÿ)ï¼Œåœæ­¢æŸ¥æ‰¾`);
                    break;
                }
                
                // è®¡ç®—ä¸Cç‚¹æ¶¨è·Œå¹…çš„å·®è·
                const diff = Math.abs(currentValues[i] - cPrimeValue);
                
                if (diff < minDiff) {
                    minDiff = diff;
                    valleyIdx = i;
                    console.log(`  - å€™é€‰Bç‚¹: ${currentTimes[i]} (${currentValues[i].toFixed(2)}%), æ—¶é—´å·®=${timeDiff.toFixed(0)}åˆ†é’Ÿ, æ¶¨è·Œå¹…å·®è·=${diff.toFixed(2)}%`);
                }
            }
            
            // å¦‚æœæ²¡æ‰¾åˆ°æœ‰æ•ˆçš„Bç‚¹
            if (valleyIdx === -1) {
                console.warn('âš ï¸ åœ¨Aç‚¹ä¹‹å‰2å°æ—¶å†…æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„Bç‚¹');
                alert(`âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„Bç‚¹ï¼\n\nAç‚¹: ${peakPoint.time} (${currentValues[peakIdx].toFixed(2)}%)\nCç‚¹: ${cPrimePoint.time} (${cPrimePoint.value.toFixed(2)}%)\n\næŸ¥æ‰¾èŒƒå›´ï¼šAç‚¹å‰2å°æ—¶å†…\néœ€è¦åœ¨æ­¤èŒƒå›´å†…æ‰¾åˆ°æ¶¨è·Œå¹…æ¥è¿‘Cç‚¹çš„ç‚¹\n\nğŸ’¡ å»ºè®®ï¼šé€‰æ‹©æ—¶é—´æ›´è¿‘çš„ç‚¹æˆ–è°ƒæ•´æ—¶é—´èŒƒå›´`);
                return null;
            }
            
            const selectedBTime = parseTimeToMinutes(currentTimes[valleyIdx]);
            const actualTimeDiff = peakTime - selectedBTime;
            
            console.log(`âœ… æ‰¾åˆ°Bç‚¹: ${currentTimes[valleyIdx]} (${currentValues[valleyIdx].toFixed(2)}%)`);
            console.log(`   æ—¶é—´å·®: ${actualTimeDiff.toFixed(0)}åˆ†é’Ÿ, æ¶¨è·Œå¹…å·®è·=${minDiff.toFixed(2)}%`);
            
            // éªŒè¯ï¼šBç‚¹å¿…é¡»åœ¨Aç‚¹ä¹‹å‰
            const valleyTime = parseTimeToMinutes(currentTimes[valleyIdx]);
            
            if (valleyTime >= peakTime) {
                console.warn('âš ï¸ Bç‚¹å¿…é¡»åœ¨Aç‚¹ä¹‹å‰');
                alert(`âŒ Bç‚¹æ—¶é—´å¼‚å¸¸ï¼\n\nBç‚¹æ—¶é—´: ${currentTimes[valleyIdx]}\nAç‚¹æ—¶é—´: ${currentTimes[peakIdx]}\n\nBç‚¹å¿…é¡»åœ¨Aç‚¹ä¹‹å‰ï¼`);
                return null;
            }
            
            return {
                time: currentTimes[valleyIdx],
                value: currentValues[valleyIdx],
                index: valleyIdx
            };
        }
        
        // è®¡ç®—è§’åº¦
        function calculateAngleFromPoints(cPrime, peak, valley) {
            // C'ç‚¹åˆ°Aç‚¹
            const c_time_min = parseTimeToMinutes(cPrime.time);
            const p_time_min = parseTimeToMinutes(peak.time);
            const v_time_min = parseTimeToMinutes(valley.time);
            
            // æ—¶é—´å·®ï¼ˆåˆ†é’Ÿï¼‰
            const time_diff = p_time_min - c_time_min;
            // ä»·æ ¼å·®
            const price_diff = peak.value - cPrime.value;
            
            // å›¾è¡¨é…ç½®ï¼ˆä¸åç«¯ä¿æŒä¸€è‡´ï¼‰
            const CHART_WIDTH_PX = 800;
            const CHART_HEIGHT_PX = 400;
            const CHART_TIME_RANGE_MIN = 600;  // 10å°æ—¶
            const CHART_PRICE_RANGE_PCT = 100; // 100%
            
            // è½¬æ¢ä¸ºåƒç´ 
            const price_diff_px = (price_diff / CHART_PRICE_RANGE_PCT) * CHART_HEIGHT_PX;
            const time_diff_px = (time_diff / CHART_TIME_RANGE_MIN) * CHART_WIDTH_PX;
            
            // è®¡ç®—è§’åº¦
            const angle_rad = Math.atan2(price_diff_px, time_diff_px);
            const angle_deg = (angle_rad * 180) / Math.PI;
            
            // åˆ¤æ–­ç±»å‹
            const direction = price_diff > 0 ? 'up' : 'down';
            const angle_type = Math.abs(angle_deg) < 45 ? 'acute' : 'obtuse';
            
            return {
                angle: Math.abs(angle_deg).toFixed(2),
                type: angle_type,
                direction: direction,
                c_prime_time: cPrime.time,
                c_prime_price: cPrime.value.toFixed(2),
                peak_time: peak.time,
                peak_price: peak.value.toFixed(2),
                valley_time: valley.time,
                valley_price: valley.value.toFixed(2),
                price_diff: price_diff.toFixed(2),
                time_diff: time_diff.toFixed(1)
            };
        }
        
        // è§£ææ—¶é—´å­—ç¬¦ä¸²ä¸ºåˆ†é’Ÿæ•°
        function parseTimeToMinutes(timeStr) {
            const parts = timeStr.split(':');
            return parseInt(parts[0]) * 60 + parseInt(parts[1]) + parseInt(parts[2]) / 60;
        }
        
        // æ·»åŠ è§’åº¦æ ‡è®°
        function addManualAngle() {
            if (!angleDirection) {
                alert('âŒ è¯·å…ˆé€‰æ‹©è§’åº¦æ–¹å‘ï¼ˆæ­£è§’æˆ–è´Ÿè§’ï¼‰');
                return;
            }
            
            if (selectedPoints.length !== 2) {
                console.error('âŒ éœ€è¦é€‰æ‹©2ä¸ªç‚¹ï¼ˆAç‚¹å’ŒC\'ç‚¹ï¼‰');
                return;
            }
            
            const [peak, cPrime] = selectedPoints;  // ç¬¬ä¸€ä¸ªæ˜¯Aç‚¹ï¼Œç¬¬äºŒä¸ªæ˜¯C'ç‚¹
            
            // è‡ªåŠ¨å¯»æ‰¾Bç‚¹ï¼Œä¼ å…¥æ–¹å‘å‚æ•°
            const valley = findValleyPoint(peak, cPrime, angleDirection);
            if (!valley) {
                // findValleyPointå·²ç»æ˜¾ç¤ºäº†è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                selectedPoints.pop();  // ç§»é™¤C'ç‚¹ï¼Œä¿ç•™Aç‚¹
                updateAngleStepInfo();
                return;
            }
            
            console.log('ğŸ” è‡ªåŠ¨æ‰¾åˆ°Bç‚¹:', valley);
            console.log(`   Bç‚¹æ—¶é—´: ${valley.time}, C'ç‚¹æ—¶é—´: ${cPrime.time}`);
            
            // å°†Bç‚¹æ·»åŠ åˆ°é€‰ä¸­ç‚¹æ•°ç»„ç”¨äºæ˜¾ç¤º
            selectedPoints.push(valley);
            highlightSelectedPoints();
            
            const angleInfo = calculateAngleFromPoints(cPrime, peak, valley);
            
            // è·å–å³°å€¼æ‰€åœ¨çš„å°æ—¶
            const hour = peak.time.substring(0, 2);
            
            const directionLabel = angleDirection === 'up' ? 'ä¸Šå‡' : 'ä¸‹é™';
            const newAngle = {
                ...angleInfo,
                hour: hour,
                date: currentDate.toISOString().split('T')[0].replace(/-/g, ''),
                manual: true  // æ ‡è®°ä¸ºæ‰‹åŠ¨æ·»åŠ 
            };
            
            manualAngles.push(newAngle);
            
            console.log('âœ… å·²æ·»åŠ æ‰‹åŠ¨è§’åº¦:', newAngle);
            
            // ä¿å­˜åˆ°åç«¯
            saveManualAngleToBackend(newAngle).then(success => {
                if (success) {
                    console.log('ğŸ’¾ æ‰‹åŠ¨è§’åº¦å·²ä¿å­˜åˆ°åç«¯');
                    
                    // æ˜¾ç¤ºç¡®è®¤æ¶ˆæ¯
                    const directionText = newAngle.direction === 'up' ? 'ä¸Šå‡' : 'ä¸‹é™';
                    const typeText = newAngle.type === 'acute' ? 'é”è§’' : 'é’è§’';
                    alert(`âœ… å·²æ·»åŠ å¹¶ä¿å­˜${directionLabel}${typeText}ï¼š${newAngle.angle}Â°\n\n` +
                          `Aç‚¹: ${newAngle.peak_time} (${newAngle.peak_price}%)\n` +
                          `Bç‚¹(è‡ªåŠ¨): ${newAngle.valley_time} (${newAngle.valley_price}%)\n` +
                          `C'ç‚¹: ${newAngle.c_prime_time} (${newAngle.c_prime_price}%)\n\n` +
                          `è¯´æ˜: Bç‚¹æ—¶é—´ ${valley.time} < C'ç‚¹æ—¶é—´ ${cPrime.time} âœ“\n\n` +
                          `ä»·æ ¼å˜åŒ–: ${newAngle.price_diff}%\n` +
                          `æ—¶é—´è·¨åº¦: ${newAngle.time_diff}åˆ†é’Ÿ\n\n` +
                          `ğŸ’¾ å·²ä¿å­˜åˆ°æœåŠ¡å™¨ï¼Œåˆ·æ–°åä»å¯è§`);
                } else {
                    alert('âš ï¸ è§’åº¦å·²æ·»åŠ åˆ°å›¾è¡¨ï¼Œä½†ä¿å­˜åˆ°æœåŠ¡å™¨å¤±è´¥\nåˆ·æ–°é¡µé¢åå°†ä¸¢å¤±');
                }
                
                // é‡ç½®é€‰æ‹©
                selectedPoints = [];
                updateAngleStepInfo();
                
                // é‡æ–°æ¸²æŸ“å›¾è¡¨
                loadData();
            });
        }
        
        // åˆ é™¤è§’åº¦æ ‡è®°ï¼ˆæ”¯æŒåˆ é™¤æ‰€æœ‰è§’åº¦ï¼šæ‰‹åŠ¨+ç³»ç»Ÿï¼‰
        function deleteAngleMarker(angleData) {
            const isManual = angleData.manual;
            const angleType = isManual ? 'æ‰‹åŠ¨' : 'ç³»ç»Ÿ';
            
            console.log(`ğŸ—‘ï¸ å‡†å¤‡åˆ é™¤${angleType}è§’åº¦:`, angleData);
            
            // å¦‚æœæ˜¯æ‰‹åŠ¨è§’åº¦ï¼Œä» manualAngles æ•°ç»„ä¸­ç§»é™¤
            if (isManual) {
                const index = manualAngles.findIndex(a => 
                    a.peak_time === angleData.peak_time && 
                    a.angle === angleData.angle
                );
                
                if (index >= 0) {
                    manualAngles.splice(index, 1);
                    console.log('âœ… å·²ä» manualAngles ç§»é™¤');
                }
            }
            
            // æ— è®ºæ˜¯æ‰‹åŠ¨è¿˜æ˜¯ç³»ç»Ÿè§’åº¦ï¼Œéƒ½è°ƒç”¨åç«¯åˆ é™¤
            deleteAngleFromBackend(angleData).then(success => {
                if (success) {
                    const directionText = angleData.direction === 'up' ? 'ä¸Šå‡' : 'ä¸‹é™';
                    const typeText = angleData.type === 'acute' ? 'é”è§’' : 'é’è§’';
                    const angleSymbol = angleData.direction === 'up' 
                        ? (angleData.type === 'acute' ? 'ğŸ”º' : 'ğŸŸ§')
                        : (angleData.type === 'acute' ? 'ğŸ”»' : 'ğŸ’');
                    
                    alert(`âœ… è§’åº¦æ ‡è®°å·²æˆåŠŸåˆ é™¤ï¼\n\n` +
                          `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                          `${angleSymbol} ${directionText}${typeText}\n` +
                          `ğŸ“ è§’åº¦: ${parseFloat(angleData.angle).toFixed(2)}Â°\n` +
                          `â° æ—¶é—´: ${angleData.peak_time}\n` +
                          `ğŸ“ˆ ä»·æ ¼: ${parseFloat(angleData.peak_price).toFixed(2)}%\n` +
                          `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
                          `ğŸ’¾ å·²ä»æœåŠ¡å™¨åˆ é™¤\n` +
                          `ğŸ”„ å›¾è¡¨å³å°†è‡ªåŠ¨åˆ·æ–°`);
                } else {
                    alert(`âŒ åˆ é™¤å¤±è´¥\n\n` +
                          `è§’åº¦: ${parseFloat(angleData.angle).toFixed(2)}Â°\n` +
                          `æ—¶é—´: ${angleData.peak_time}\n\n` +
                          `è¯·ç¨åé‡è¯•æˆ–åˆ·æ–°é¡µé¢`);
                }
                
                // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                updateAngleStepInfo();
                
                // é‡æ–°æ¸²æŸ“å›¾è¡¨
                loadData();
            });
            
            return true;
        }
        
        // ä¿å­˜æ‰‹åŠ¨è§’åº¦åˆ°åç«¯
        async function saveManualAngleToBackend(angle) {
            try {
                const response = await fetch('/api/okx-trading/angles/manual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        angle: angle,
                        date: angle.date
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('ğŸ’¾ åç«¯ä¿å­˜æˆåŠŸ:', result);
                    return true;
                } else {
                    console.error('âŒ åç«¯ä¿å­˜å¤±è´¥:', result.message);
                    return false;
                }
            } catch (error) {
                console.error('âŒ ä¿å­˜è¯·æ±‚å¤±è´¥:', error);
                return false;
            }
        }
        
        // ä»åç«¯åˆ é™¤è§’åº¦ï¼ˆæ”¯æŒæ‰‹åŠ¨å’Œç³»ç»Ÿè§’åº¦ï¼‰
        async function deleteAngleFromBackend(angle) {
            try {
                const response = await fetch('/api/okx-trading/angles/manual', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date: angle.date,
                        peak_time: angle.peak_time,
                        angle: angle.angle
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('ğŸ’¾ åç«¯åˆ é™¤æˆåŠŸ:', result);
                    return true;
                } else {
                    console.error('âŒ åç«¯åˆ é™¤å¤±è´¥:', result.message);
                    return false;
                }
            } catch (error) {
                console.error('âŒ åˆ é™¤è¯·æ±‚å¤±è´¥:', error);
                return false;
            }
        }
        
        // å…¼å®¹æ—§å‡½æ•°å
        async function deleteManualAngleFromBackend(angle) {
            return await deleteAngleFromBackend(angle);
        }
        
        // æ¸…é™¤æ‰€æœ‰æ‰‹åŠ¨è§’åº¦
        async function clearAllManualAngles() {
            if (manualAngles.length === 0) {
                alert('æ²¡æœ‰æ‰‹åŠ¨è§’åº¦éœ€è¦æ¸…é™¤');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ ${manualAngles.length} ä¸ªæ‰‹åŠ¨è§’åº¦æ ‡è®°å—ï¼Ÿ\n\næ³¨æ„ï¼šè¿™å°†ä»æœåŠ¡å™¨æ°¸ä¹…åˆ é™¤ï¼`)) {
                const count = manualAngles.length;
                const anglesToDelete = [...manualAngles];  // å¤åˆ¶æ•°ç»„
                
                // é€ä¸ªåˆ é™¤
                let successCount = 0;
                for (const angle of anglesToDelete) {
                    const success = await deleteManualAngleFromBackend(angle);
                    if (success) successCount++;
                }
                
                // æ¸…ç©ºæœ¬åœ°æ•°ç»„
                manualAngles = [];
                console.log(`ğŸ—‘ï¸ å·²æ¸…é™¤ ${count} ä¸ªæ‰‹åŠ¨è§’åº¦ï¼ˆåç«¯æˆåŠŸ: ${successCount}ï¼‰`);
                
                // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                updateAngleStepInfo();
                
                // é‡æ–°æ¸²æŸ“å›¾è¡¨
                loadData();
                
                if (successCount === count) {
                    alert(`âœ… å·²æ¸…é™¤æ‰€æœ‰ ${count} ä¸ªæ‰‹åŠ¨è§’åº¦æ ‡è®°å¹¶ä¿å­˜`);
                } else {
                    alert(`âš ï¸ å·²æ¸…é™¤ ${count} ä¸ªæ‰‹åŠ¨è§’åº¦æ ‡è®°\nåç«¯æˆåŠŸåˆ é™¤: ${successCount}/${count}`);
                }
            }
        }
        
        // è®¾ç½®å›¾è¡¨äº‹ä»¶ç›‘å¬å™¨
        function setupChartEventListeners() {
            if (!chart) {
                console.error('âŒ å›¾è¡¨æœªåˆå§‹åŒ–ï¼Œæ— æ³•è®¾ç½®äº‹ä»¶ç›‘å¬');
                return;
            }
            
            // ç‚¹å‡»äº‹ä»¶ - å¤„ç†äº¤æ˜“æ ‡è®°è¯„ä»·å’Œè§’åº¦æ ‡è®°
            chart.on('click', function(params) {
                // ä¼˜å…ˆå¤„ç†äº¤æ˜“æ ‡è®°ç‚¹å‡»ï¼ˆå¼€ä»“/å¹³ä»“ï¼‰
                if (params.componentType === 'series' && 
                    (params.seriesName.includes('å¼€ä»“') || params.seriesName.includes('å¹³ä»“'))) {
                    
                    // è·å–äº¤æ˜“æ•°æ®
                    const trade = params.data.trade;
                    if (trade) {
                        console.log('ğŸ–±ï¸ ç‚¹å‡»äº¤æ˜“æ ‡è®°:', trade.tradeId);
                        openTradeRatingModal(trade);
                    } else {
                        console.warn('âš ï¸ æ— æ³•è·å–äº¤æ˜“æ•°æ®');
                    }
                    return;  // é˜»æ­¢åç»­å¤„ç†
                }
                
                // è§’åº¦æ ‡è®°æ¨¡å¼çš„ç‚¹å‡»å¤„ç†
                if (!angleModeActive) return;
                
                // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©æ–¹å‘
                if (!angleDirection) {
                    alert('âš ï¸ è¯·å…ˆé€‰æ‹©è§’åº¦æ–¹å‘ï¼ˆâ†—ï¸æ­£è§’ æˆ– â†˜ï¸è´Ÿè§’ï¼‰');
                    return;
                }
                
                // åªå¤„ç†è¶‹åŠ¿çº¿ä¸Šçš„ç‚¹å‡»
                if (params.componentType === 'series' && params.seriesName === 'ç´¯è®¡æ¶¨è·Œå¹…') {
                    const clickedPoint = {
                        time: params.name,
                        value: params.value,
                        index: params.dataIndex
                    };
                    
                    selectedPoints.push(clickedPoint);
                    const pointName = selectedPoints.length === 1 ? 'Aç‚¹' : 'C\'ç‚¹';
                    console.log(`ğŸ“ å·²é€‰æ‹©${pointName}:`, clickedPoint);
                    
                    updateAngleStepInfo();
                    
                    // é€‰æ‹©å®Œ2ä¸ªç‚¹åï¼Œè‡ªåŠ¨æ‰¾Bç‚¹å¹¶è¯¢é—®æ˜¯å¦æ·»åŠ 
                    if (selectedPoints.length === 2) {
                        const directionText = angleDirection === 'up' ? 'â†—ï¸æ­£è§’ï¼ˆä¸Šå‡ï¼‰' : 'â†˜ï¸è´Ÿè§’ï¼ˆä¸‹é™ï¼‰';
                        setTimeout(() => {
                            if (confirm(`${directionText}\nå·²é€‰æ‹©Aç‚¹å’ŒC\'ç‚¹ï¼Œæ˜¯å¦è‡ªåŠ¨å¯»æ‰¾Bç‚¹å¹¶æ·»åŠ è§’åº¦æ ‡è®°ï¼Ÿ\n\næé†’ï¼šC'ç‚¹æ—¶é—´å¿…é¡»æ™šäºBç‚¹`)) {
                                addManualAngle();
                            } else {
                                selectedPoints = [];
                                updateAngleStepInfo();
                            }
                        }, 100);
                    }
                }
            });
            
            // å³é”®äº‹ä»¶ - åˆ é™¤è§’åº¦ï¼ˆæ”¯æŒåˆ é™¤æ‰€æœ‰è§’åº¦ï¼ŒåŒ…æ‹¬ç³»ç»Ÿç”Ÿæˆçš„ï¼‰
            chart.on('contextmenu', function(params) {
                params.event.event.preventDefault();
                
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»çš„æ˜¯è§’åº¦æ ‡è®°
                if (params.componentType === 'series' && 
                    (params.seriesName.includes('ä¸Šå‡') || params.seriesName.includes('ä¸‹é™'))) {
                    
                    // æŸ¥æ‰¾å¯¹åº”çš„è§’åº¦æ•°æ®
                    const angleData = params.data.angle_data;
                    if (angleData) {
                        const angleType = angleData.manual ? 'ğŸ–ï¸ æ‰‹åŠ¨æ·»åŠ ' : 'ğŸ¤– ç³»ç»Ÿç”Ÿæˆ';
                        const directionText = angleData.direction === 'up' ? 'ä¸Šå‡' : 'ä¸‹é™';
                        const typeText = angleData.type === 'acute' ? 'é”è§’' : 'é’è§’';
                        const angleSymbol = angleData.direction === 'up' 
                            ? (angleData.type === 'acute' ? 'ğŸ”º' : 'ğŸŸ§')
                            : (angleData.type === 'acute' ? 'ğŸ”»' : 'ğŸ’');
                        
                        if (confirm(`ğŸ—‘ï¸ ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§’åº¦æ ‡è®°å—ï¼Ÿ\n\n` +
                                  `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                                  `${angleSymbol} æ ‡è®°ç±»å‹: ${angleType}\n` +
                                  `ğŸ“Š è§’åº¦ç±»å‹: ${directionText}${typeText}\n` +
                                  `ğŸ“ è§’åº¦å€¼: ${parseFloat(angleData.angle).toFixed(2)}Â°\n` +
                                  `â° å³°å€¼æ—¶é—´: ${angleData.peak_time}\n` +
                                  `ğŸ“ˆ ä»·æ ¼å˜åŒ–: ${parseFloat(angleData.peak_price).toFixed(2)}%\n` +
                                  `ğŸ• æ—¶æ®µ: ${angleData.hour}:00-${parseInt(angleData.hour)+1}:00\n` +
                                  `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
                                  `âœ… åˆ é™¤åä¼šç«‹å³ç”Ÿæ•ˆ\n` +
                                  `ğŸ’¡ é€‚ç”¨äºçº æ­£ç³»ç»Ÿè¯†åˆ«é”™è¯¯çš„è§’åº¦`)) {
                            deleteAngleMarker(angleData);
                        }
                    } else {
                        alert('âŒ æ— æ³•è·å–è§’åº¦æ•°æ®\n\nè¯·ç¨åé‡è¯•æˆ–åˆ·æ–°é¡µé¢');
                    }
                }
            });
            
            console.log('âœ… å›¾è¡¨äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
        }
        
        // ==================== äº¤æ˜“è¯„ä»·åŠŸèƒ½ ====================
        
        let currentTradeForRating = null;
        let selectedRating = null;
        let tradeRatings = {};  // å­˜å‚¨äº¤æ˜“è¯„ä»· {tradeId: {rating, note}}
        
        // åŠ è½½äº¤æ˜“è¯„ä»·æ•°æ®
        async function loadTradeRatings() {
            try {
                const dateStr = formatDate(currentDate).replace(/-/g, '');
                const response = await fetch(`/api/okx-trading/trade-ratings?date=${dateStr}`);
                const result = await response.json();
                
                if (result.success) {
                    // è½¬æ¢ä¸º {tradeId: {rating, note}} æ ¼å¼
                    tradeRatings = {};
                    result.ratings.forEach(r => {
                        tradeRatings[r.tradeId] = {
                            rating: r.rating,
                            note: r.note
                        };
                    });
                    console.log('âœ… åŠ è½½äº¤æ˜“è¯„ä»·:', Object.keys(tradeRatings).length, 'æ¡');
                } else {
                    console.warn('âš ï¸ åŠ è½½äº¤æ˜“è¯„ä»·å¤±è´¥:', result.message);
                }
            } catch (error) {
                console.error('âŒ åŠ è½½äº¤æ˜“è¯„ä»·å¤±è´¥:', error);
            }
        }
        
        // æ‰“å¼€è¯„ä»·æ¨¡æ€æ¡†
        function openTradeRatingModal(trade) {
            currentTradeForRating = trade;
            selectedRating = null;
            
            // å¡«å……äº¤æ˜“ä¿¡æ¯
            const tradeTime = new Date(trade.fillTime);
            const timeStr = `${String(tradeTime.getHours()).padStart(2, '0')}:${String(tradeTime.getMinutes()).padStart(2, '0')}:${String(tradeTime.getSeconds()).padStart(2, '0')}`;
            
            let typeText = '';
            let typeColor = '';
            if (trade.posSide === 'long' && trade.side === 'buy') {
                typeText = 'ğŸ”´ å¤šå•å¼€ä»“';
                typeColor = '#e53e3e';
            } else if (trade.posSide === 'long' && trade.side === 'sell') {
                typeText = 'ğŸŸ¢ å¤šå•å¹³ä»“';
                typeColor = '#38a169';
            } else if (trade.posSide === 'short' && trade.side === 'sell') {
                typeText = 'ğŸŸ  ç©ºå•å¼€ä»“';
                typeColor = '#dd6b20';
            } else if (trade.posSide === 'short' && trade.side === 'buy') {
                typeText = 'ğŸ”µ ç©ºå•å¹³ä»“';
                typeColor = '#3182ce';
            }
            
            const infoHtml = `
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px; line-height: 1.8;">
                    <div style="color: #718096;">æ—¶é—´:</div>
                    <div style="font-weight: 600;">${timeStr}</div>
                    
                    <div style="color: #718096;">å¸ç§:</div>
                    <div style="font-weight: 600;">${trade.instId.replace('-USDT-SWAP', '')}</div>
                    
                    <div style="color: #718096;">ç±»å‹:</div>
                    <div style="font-weight: 600; color: ${typeColor};">${typeText}</div>
                    
                    <div style="color: #718096;">ä»·æ ¼:</div>
                    <div>${parseFloat(trade.fillPx).toFixed(4)}</div>
                    
                    <div style="color: #718096;">æ•°é‡:</div>
                    <div>${parseFloat(trade.fillSz).toFixed(2)}</div>
                </div>
            `;
            
            document.getElementById('tradeInfoDisplay').innerHTML = infoHtml;
            
            // å¦‚æœå·²æœ‰è¯„ä»·ï¼Œå›æ˜¾å¹¶æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
            const existingRating = tradeRatings[trade.tradeId];
            const deleteBtn = document.getElementById('deleteRatingBtn');
            
            if (existingRating) {
                selectedRating = existingRating.rating;
                document.getElementById('ratingNote').value = existingRating.note || '';
                updateNoteCharCount();
                updateRatingButtons();
                deleteBtn.style.display = 'block';  // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
            } else {
                document.getElementById('ratingNote').value = '';
                updateNoteCharCount();
                updateRatingButtons();
                deleteBtn.style.display = 'none';  // éšè—åˆ é™¤æŒ‰é’®
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = document.getElementById('tradeRatingModal');
            modal.style.display = 'flex';
        }
        
        // å…³é—­è¯„ä»·æ¨¡æ€æ¡†
        function closeRatingModal() {
            document.getElementById('tradeRatingModal').style.display = 'none';
            currentTradeForRating = null;
            selectedRating = null;
        }
        
        // é€‰æ‹©è¯„ä»·
        function selectRating(rating) {
            selectedRating = rating;
            updateRatingButtons();
        }
        
        // æ›´æ–°è¯„ä»·æŒ‰é’®æ ·å¼
        function updateRatingButtons() {
            const correctBtn = document.getElementById('ratingCorrect');
            const incorrectBtn = document.getElementById('ratingIncorrect');
            
            if (selectedRating === 'correct') {
                correctBtn.style.background = '#48bb78';
                correctBtn.style.borderColor = '#48bb78';
                correctBtn.style.color = 'white';
                incorrectBtn.style.background = 'white';
                incorrectBtn.style.borderColor = '#e2e8f0';
                incorrectBtn.style.color = '#2d3748';
            } else if (selectedRating === 'incorrect') {
                incorrectBtn.style.background = '#f56565';
                incorrectBtn.style.borderColor = '#f56565';
                incorrectBtn.style.color = 'white';
                correctBtn.style.background = 'white';
                correctBtn.style.borderColor = '#e2e8f0';
                correctBtn.style.color = '#2d3748';
            } else {
                correctBtn.style.background = 'white';
                correctBtn.style.borderColor = '#e2e8f0';
                correctBtn.style.color = '#2d3748';
                incorrectBtn.style.background = 'white';
                incorrectBtn.style.borderColor = '#e2e8f0';
                incorrectBtn.style.color = '#2d3748';
            }
        }
        
        // æ›´æ–°å­—ç¬¦è®¡æ•°
        function updateNoteCharCount() {
            const note = document.getElementById('ratingNote').value;
            document.getElementById('noteCharCount').textContent = note.length;
        }
        
        // ç›‘å¬å¤‡æ³¨è¾“å…¥
        document.addEventListener('DOMContentLoaded', function() {
            const noteInput = document.getElementById('ratingNote');
            if (noteInput) {
                noteInput.addEventListener('input', updateNoteCharCount);
            }
        });
        
        // ä¿å­˜äº¤æ˜“è¯„ä»·
        async function saveTradeRating() {
            if (!currentTradeForRating) {
                alert('âŒ æ²¡æœ‰é€‰æ‹©äº¤æ˜“');
                return;
            }
            
            if (!selectedRating) {
                alert('âš ï¸ è¯·é€‰æ‹©è¯„ä»·ç»“æœï¼ˆæ­£ç¡®æˆ–é”™è¯¯ï¼‰');
                return;
            }
            
            const note = document.getElementById('ratingNote').value.trim();
            const dateStr = formatDate(currentDate).replace(/-/g, '');
            
            try {
                const response = await fetch('/api/okx-trading/trade-ratings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tradeId: currentTradeForRating.tradeId,
                        date: dateStr,
                        rating: selectedRating,
                        note: note
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // æ›´æ–°æœ¬åœ°ç¼“å­˜
                    tradeRatings[currentTradeForRating.tradeId] = {
                        rating: selectedRating,
                        note: note
                    };
                    
                    console.log('âœ… è¯„ä»·ä¿å­˜æˆåŠŸ:', currentTradeForRating.tradeId);
                    
                    alert('âœ… è¯„ä»·ä¿å­˜æˆåŠŸï¼');
                    closeRatingModal();
                    
                    // é‡æ–°æ¸²æŸ“å›¾è¡¨ä»¥æ˜¾ç¤ºè¯„ä»·æ ‡è®°
                    loadData();
                } else {
                    alert('âŒ ä¿å­˜å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('âŒ ä¿å­˜è¯„ä»·å¤±è´¥:', error);
                alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ é™¤äº¤æ˜“è¯„ä»·
        async function deleteTradeRating() {
            if (!currentTradeForRating) {
                alert('âŒ æ²¡æœ‰é€‰æ‹©äº¤æ˜“');
                return;
            }
            
            // ç¡®è®¤åˆ é™¤
            if (!confirm('ğŸ—‘ï¸ ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº¤æ˜“çš„è¯„ä»·å—ï¼Ÿ\n\nåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚')) {
                return;
            }
            
            const dateStr = formatDate(currentDate).replace(/-/g, '');
            
            try {
                const response = await fetch('/api/okx-trading/trade-ratings', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tradeId: currentTradeForRating.tradeId,
                        date: dateStr
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // ä»æœ¬åœ°ç¼“å­˜ä¸­åˆ é™¤
                    delete tradeRatings[currentTradeForRating.tradeId];
                    
                    console.log('ğŸ—‘ï¸ è¯„ä»·åˆ é™¤æˆåŠŸ:', currentTradeForRating.tradeId);
                    
                    alert('âœ… è¯„ä»·å·²åˆ é™¤ï¼');
                    closeRatingModal();
                    
                    // é‡æ–°æ¸²æŸ“å›¾è¡¨
                    loadData();
                } else {
                    alert('âŒ åˆ é™¤å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('âŒ åˆ é™¤è¯„ä»·å¤±è´¥:', error);
                alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // åˆ‡æ¢è¯´æ˜æ–‡æ¡£é¢æ¿çš„å±•å¼€/æ”¶èµ·çŠ¶æ€
        function toggleInfoPanel() {
            const content = document.getElementById('infoContent');
            const toggle = document.getElementById('infoToggle');
            
            if (content.classList.contains('collapsed')) {
                // å±•å¼€
                content.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
                toggle.textContent = 'â–¼';
                // ä¿å­˜çŠ¶æ€åˆ°localStorage
                localStorage.setItem('infoPanelExpanded', 'true');
            } else {
                // æ”¶èµ·
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
                toggle.textContent = 'â–¶';
                // ä¿å­˜çŠ¶æ€åˆ°localStorage
                localStorage.setItem('infoPanelExpanded', 'false');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ¢å¤è¯´æ˜æ–‡æ¡£é¢æ¿çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            const infoPanelExpanded = localStorage.getItem('infoPanelExpanded');
            // é»˜è®¤æ”¶èµ·çŠ¶æ€ï¼Œåªæœ‰æ˜ç¡®è®¾ç½®ä¸ºtrueæ—¶æ‰å±•å¼€
            if (infoPanelExpanded === 'true') {
                const content = document.getElementById('infoContent');
                const toggle = document.getElementById('infoToggle');
                content.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
                toggle.textContent = 'â–¼';
            }
        });
    </script>
</body>
</html>
