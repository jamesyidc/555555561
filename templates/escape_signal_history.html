<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>é€ƒé¡¶ä¿¡å·ç³»ç»Ÿç»Ÿè®¡ - å†å²æ•°æ®æ˜ç»† v2.2-20260122</title>
    <script>
        // ğŸ”¥ å¼ºåˆ¶ç‰ˆæœ¬æ£€æŸ¥å’Œç¼“å­˜æ¸…é™¤
        const CURRENT_VERSION = '2.2-20260122';
        const storedVersion = localStorage.getItem('escape_signal_history_version');
        if (storedVersion !== CURRENT_VERSION) {
            console.log('ğŸ”„ æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼Œæ¸…é™¤ç¼“å­˜...');
            localStorage.setItem('escape_signal_history_version', CURRENT_VERSION);
            // å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼Œç»•è¿‡ç¼“å­˜
            if (storedVersion) {  // åªæœ‰åœ¨æœ‰æ—§ç‰ˆæœ¬æ—¶æ‰åˆ·æ–°
                location.reload(true);
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: #ffffff;
            color: #000;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 2px solid rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 36px;
            margin-bottom: 15px;
            text-shadow: none;
            color: #000;
        }
        
        .home-btn {
            padding: 12px 24px;
            background: #f3f4f6;
            backdrop-filter: blur(10px);
            border: 2px solid #d1d5db;
            border-radius: 12px;
            color: #000;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .home-btn:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f9fafb;
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #4ade80;
        }
        
        .stat-card.danger .value {
            color: #ef4444;
        }
        
        .stat-card.warning .value {
            color: #f59e0b;
        }
        
        .chart-container {
            background: #f9fafb;
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            margin-bottom: 30px;
        }
        
        .chart-container h2 {
            margin-bottom: 20px;
            font-size: 20px;
            color: #000;
        }
        
        #trendChart {
            width: 100%;
            height: 400px;
        }
        
        .extreme-stats-container {
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #e5e7eb;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .extreme-stats-container h2 {
            margin-bottom: 20px;
            font-size: 22px;
            color: #000;
            text-align: center;
            font-weight: 700;
        }
        
        .extreme-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .extreme-stat-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 3px solid;
        }
        
        .extreme-stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .extreme-stat-card.extreme-high {
            border-color: #ff0000;
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
            animation: pulse-red 2s ease-in-out infinite;
        }
        
        .extreme-stat-card.extreme-low {
            border-color: #000000;
            background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%);
            animation: pulse-black 2s ease-in-out infinite;
        }
        
        .extreme-stat-card.no-extreme {
            border-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
        }
        
        @keyframes pulse-red {
            0%, 100% { 
                box-shadow: 0 4px 12px rgba(255, 0, 0, 0.2);
                border-color: #ff0000;
            }
            50% { 
                box-shadow: 0 8px 24px rgba(255, 0, 0, 0.4);
                border-color: #ff3333;
            }
        }
        
        @keyframes pulse-black {
            0%, 100% { 
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                border-color: #000000;
            }
            50% { 
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
                border-color: #333333;
            }
        }
        
        .extreme-icon {
            font-size: 48px;
            margin-bottom: 15px;
            animation: bounce 1s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .extreme-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
        }
        
        .extreme-count {
            font-size: 42px;
            font-weight: 900;
            margin-bottom: 15px;
        }
        
        .extreme-stat-card.extreme-high .extreme-count {
            color: #ff0000;
            text-shadow: 2px 2px 4px rgba(255, 0, 0, 0.2);
        }
        
        .extreme-stat-card.extreme-low .extreme-count {
            color: #000000;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .extreme-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e5e7eb;
        }
        
        .extreme-time {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .extreme-value {
            font-size: 20px;
            font-weight: 700;
            margin-top: 8px;
        }
        
        .extreme-stat-card.extreme-high .extreme-value {
            color: #ff0000;
        }
        
        .extreme-stat-card.extreme-low .extreme-value {
            color: #000000;
        }
        
        .extreme-message {
            font-size: 16px;
            color: #10b981;
            font-weight: 600;
            margin: 20px 0;
        }
        
        .extreme-range {
            font-size: 14px;
            color: #6b7280;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .table-container {
            background: #f9fafb;
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            color: #000;
        }
        
        th {
            background: #f3f4f6;
            font-weight: 600;
            color: #000;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background: #f3f4f6;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
        }
        
        /* åŠ è½½è¿›åº¦æ¡æ ·å¼ - ç½®é¡¶æ˜¾ç¤º */
        .loading-progress {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15);
            backdrop-filter: blur(10px);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .progress-title {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        
        .progress-time {
            font-size: 16px;
            font-weight: bold;
            color: #f59e0b;
            font-family: 'Courier New', monospace;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 25px;
        }
        
        .progress-bar {
            height: 100%%;
            background: linear-gradient(90deg, #667eea 0%%, #764ba2 100%%);
            width: 0%%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        .progress-steps {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }
        
        .progress-step {
            text-align: center;
            padding: 15px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .progress-step.active {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .progress-step.completed {
            background: rgba(34, 197, 94, 0.1);
            border-color: #22c55e;
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: #999;
            transition: all 0.3s ease;
        }
        
        .progress-step.active .step-icon {
            background: #667eea;
            color: #fff;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .progress-step.completed .step-icon {
            background: #22c55e;
            color: #fff;
        }
        
        .progress-step.completed .step-icon::before {
            content: 'âœ“';
        }
        
        .step-label {
            font-size: 13px;
            font-weight: 500;
            color: #fff;
            margin-bottom: 5px;
        }
        
        .step-status {
            font-size: 11px;
            color: #999;
        }
        
        .progress-step.active .step-status {
            color: #667eea;
            font-weight: bold;
        }
        
        .progress-step.completed .step-status {
            color: #22c55e;
        }
        
        @keyframes pulse {
            0%%, 100%% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
            }
            50%% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
            }
        }
        
        .status-normal {
            color: #4ade80;
        }
        
        .status-rising {
            color: #f59e0b;
        }
        
        .status-danger {
            color: #ef4444;
        }
        
        .status-extreme-high {
            color: #ff0000;
            font-weight: bold;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .status-extreme-low {
            color: #000000;
            font-weight: bold;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ğŸ”¥ åŠ è½½è¿›åº¦æ¡ - ç½®é¡¶æ˜¾ç¤º -->
        <div id="loadingProgress" class="loading-progress" style="margin-bottom: 20px;">
            <div class="progress-header">
                <span class="progress-title">ğŸ“Š æ•°æ®åŠ è½½ä¸­...</span>
                <span class="progress-time" id="loadingTime">0.0ç§’</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-steps">
                <div class="progress-step" id="step1">
                    <div class="step-icon">âœ“1</div>
                    <div class="step-label">å…³é”®ç‚¹æ•°æ®</div>
                    <div class="step-status">ç­‰å¾…ä¸­...</div>
                </div>
                <div class="progress-step" id="step2">
                    <div class="step-icon">âœ“2</div>
                    <div class="step-label">ç›ˆåˆ©æ•°æ®</div>
                    <div class="step-status">ç­‰å¾…ä¸­...</div>
                </div>
                <div class="progress-step" id="step3">
                    <div class="step-icon">âœ“3</div>
                    <div class="step-label">27å¸æ•°æ®</div>
                    <div class="step-status">ç­‰å¾…ä¸­...</div>
                </div>
                <div class="progress-step" id="step4">
                    <div class="step-icon">4</div>
                    <div class="step-label">æ¸²æŸ“å›¾è¡¨</div>
                    <div class="step-status">ç­‰å¾…ä¸­...</div>
                </div>
                <div class="progress-step" id="step5">
                    <div class="step-icon">5</div>
                    <div class="step-label">è¡¨æ ¼æ•°æ®</div>
                    <div class="step-status">ç­‰å¾…ä¸­...</div>
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <a href="/" class="home-btn">
                <span>ğŸ </span>
                <span>è¿”å›é¦–é¡µ</span>
            </a>
            <a href="/support-resistance" class="home-btn">
                <span>ğŸ“Š</span>
                <span>æ”¯æ’‘å‹åŠ›çº¿ç³»ç»Ÿ</span>
            </a>
        </div>
        
        <div class="header">
            <h1>ğŸ“Š é€ƒé¡¶ä¿¡å·ç³»ç»Ÿç»Ÿè®¡ - å†å²æ•°æ®æ˜ç»† <span style="font-size: 14px; color: #10b981; font-weight: normal;">(v2.2-20260122)</span></h1>
            <div style="margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 15px;">
                <span style="color: #666; font-size: 14px;">ğŸ“… æœ€åæ›´æ–°: <span id="lastUpdateTime" style="color: #10b981; font-weight: 600;">--</span></span>
                <button onclick="loadData(); this.blur();" style="padding: 8px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s;">ğŸ”„ ç«‹å³åˆ·æ–°</button>
                <button onclick="window.location.reload(true); this.blur();" style="padding: 8px 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s;">ğŸ’ª å¼ºåˆ¶åˆ·æ–°</button>
                <span style="color: #999; font-size: 12px;">â° æ¯30ç§’è‡ªåŠ¨åˆ·æ–°</span>
            </div>
        </div>
        
        <div class="stats-cards">
            <div class="stat-card">
                <h3>æ€»è®°å½•æ•°</h3>
                <div class="value" id="totalRecords">0</div>
            </div>
            <div class="stat-card danger">
                <h3>24å°æ—¶å†å²æå¤§å€¼</h3>
                <div class="value" id="max24h">0</div>
            </div>
            <div class="stat-card warning">
                <h3>24å°æ—¶å³æ—¶æ¬¡é«˜</h3>
                <div class="value" id="max2h">0</div>
            </div>
            <div class="stat-card">
                <h3>24å°æ—¶æ ·æœ¬æ•°</h3>
                <div class="value" id="sample24h">0</div>
            </div>
            <div class="stat-card">
                <h3>24å°æ—¶æ ·æœ¬ä¸­ä½</h3>
                <div class="value" id="median24h">0</div>
            </div>
        </div>
        
        <div class="chart-container">
            <h2>ğŸ“ˆ é€ƒé¡¶ä¿¡å·è¶‹åŠ¿å›¾</h2>
            <div id="trendChart"></div>
        </div>
        
        <!-- å½“å¤©æå€¼ç»Ÿè®¡ -->
        <div class="extreme-stats-container">
            <h2>ğŸš¨ å½“å¤©æå€¼ç»Ÿè®¡</h2>
            <div class="extreme-stats-grid">
                <div class="extreme-stat-card extreme-high" id="extremeHighCard" style="display: none;">
                    <div class="extreme-icon">ğŸ’¥</div>
                    <div class="extreme-title">æç«¯ä¸Šæ¶¨äº‹ä»¶</div>
                    <div class="extreme-count" id="extremeHighCount">0</div>
                    <div class="extreme-details">
                        <div class="extreme-time" id="extremeHighTime">-</div>
                        <div class="extreme-value" id="extremeHighValue">-</div>
                    </div>
                </div>
                
                <div class="extreme-stat-card extreme-low" id="extremeLowCard" style="display: none;">
                    <div class="extreme-icon">ğŸ’€</div>
                    <div class="extreme-title">æç«¯æš´è·Œäº‹ä»¶</div>
                    <div class="extreme-count" id="extremeLowCount">0</div>
                    <div class="extreme-details">
                        <div class="extreme-time" id="extremeLowTime">-</div>
                        <div class="extreme-value" id="extremeLowValue">-</div>
                    </div>
                </div>
                
                <div class="extreme-stat-card no-extreme" id="noExtremeCard">
                    <div class="extreme-icon">âœ…</div>
                    <div class="extreme-title">å¸‚åœºçŠ¶æ€æ­£å¸¸</div>
                    <div class="extreme-message">å½“å¤©æœªå‡ºç°æç«¯å¸‚åœºæƒ…å†µ</div>
                    <div class="extreme-details">
                        <div class="extreme-range">é˜ˆå€¼èŒƒå›´: -80% ~ +100%</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <h2>ğŸ“‹ å†å²æå€¼ç»Ÿè®¡æ˜ç»† <span id="tableDataInfo" style="font-size: 14px; color: #999; font-weight: normal;"></span></h2>
            
            <div id="loading" class="loading" style="display: none;">æ­£åœ¨åŠ è½½æ•°æ®...</div>
            <table id="dataTable" style="display: none;">
                <thead>
                    <tr>
                        <th>è®°å½•æ—¶é—´ â¬‡ï¸ (æœ€æ–°åœ¨å‰)</th>
                        <th>24å°æ—¶ä¿¡å·æ•°</th>
                        <th>2å°æ—¶ä¿¡å·æ•°</th>
                        <th>27å¸æ¶¨è·Œå¹…æ€»å’Œ</th>
                        <th>ä¸‹è·Œå¼ºåº¦</th>
                        <th>ä¸Šæ¶¨å¼ºåº¦</th>
                        <th>çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
    
    <script>
        let chart = null;
        let isLoading = false;  // é˜²æ­¢é‡å¤åŠ è½½
        let fullHistoryData = [];  // ä¿å­˜å®Œæ•´æ•°æ®
        let loadStartTime = 0;  // åŠ è½½å¼€å§‹æ—¶é—´
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(step, status, message) {
            const stepEl = document.getElementById(`step${step}`);
            const statusEl = stepEl.querySelector('.step-status');
            const progressBar = document.getElementById('progressBar');
            const timeEl = document.getElementById('loadingTime');
            
            // æ›´æ–°æ—¶é—´
            const elapsed = ((performance.now() - loadStartTime) / 1000).toFixed(1);
            timeEl.textContent = `${elapsed}ç§’`;
            
            // æ›´æ–°è¿›åº¦æ¡
            const progress = (step / 5) * 100;
            progressBar.style.width = `${progress}%`;
            
            // æ›´æ–°æ­¥éª¤çŠ¶æ€
            if (status === 'active') {
                stepEl.classList.add('active');
                stepEl.classList.remove('completed');
                statusEl.textContent = message || 'è¿›è¡Œä¸­...';
            } else if (status === 'completed') {
                stepEl.classList.remove('active');
                stepEl.classList.add('completed');
                statusEl.textContent = message || 'å®Œæˆ âœ“';
            }
        }
        
        // éšè—è¿›åº¦æ¡
        function hideProgress() {
            const progressEl = document.getElementById('loadingProgress');
            if (progressEl) {
                setTimeout(() => {
                    progressEl.style.display = 'none';
                }, 500);
            }
        }
        
        // æ›´æ–°å½“å¤©æå€¼ç»Ÿè®¡
        function updateTodayExtremeStats(extremeHighMarks, extremeLowMarks, coinChangeData, historyData) {
            const today = new Date().toISOString().split('T')[0]; // æ ¼å¼: 2026-01-18
            
            // ç­›é€‰å½“å¤©çš„æç«¯äº‹ä»¶
            let todayHighEvents = [];
            let todayLowEvents = [];
            
            extremeHighMarks.forEach(mark => {
                const record = historyData[mark.coord[0]];
                if (record && record.stat_time.startsWith(today)) {
                    todayHighEvents.push({
                        time: record.stat_time,
                        value: mark.value
                    });
                }
            });
            
            extremeLowMarks.forEach(mark => {
                const record = historyData[mark.coord[0]];
                if (record && record.stat_time.startsWith(today)) {
                    todayLowEvents.push({
                        time: record.stat_time,
                        value: mark.value
                    });
                }
            });
            
            // æ›´æ–°UI
            const extremeHighCard = document.getElementById('extremeHighCard');
            const extremeLowCard = document.getElementById('extremeLowCard');
            const noExtremeCard = document.getElementById('noExtremeCard');
            
            const hasExtremes = todayHighEvents.length > 0 || todayLowEvents.length > 0;
            
            if (hasExtremes) {
                noExtremeCard.style.display = 'none';
                
                // æ›´æ–°æç«¯ä¸Šæ¶¨å¡ç‰‡
                if (todayHighEvents.length > 0) {
                    extremeHighCard.style.display = 'block';
                    document.getElementById('extremeHighCount').textContent = todayHighEvents.length + ' æ¬¡';
                    
                    // æ˜¾ç¤ºæœ€è¿‘ä¸€æ¬¡
                    const latest = todayHighEvents[todayHighEvents.length - 1];
                    document.getElementById('extremeHighTime').textContent = 'æœ€è¿‘: ' + latest.time.split(' ')[1];
                    document.getElementById('extremeHighValue').textContent = '+' + latest.value + '%';
                } else {
                    extremeHighCard.style.display = 'none';
                }
                
                // æ›´æ–°æç«¯æš´è·Œå¡ç‰‡
                if (todayLowEvents.length > 0) {
                    extremeLowCard.style.display = 'block';
                    document.getElementById('extremeLowCount').textContent = todayLowEvents.length + ' æ¬¡';
                    
                    // æ˜¾ç¤ºæœ€è¿‘ä¸€æ¬¡
                    const latest = todayLowEvents[todayLowEvents.length - 1];
                    document.getElementById('extremeLowTime').textContent = 'æœ€è¿‘: ' + latest.time.split(' ')[1];
                    document.getElementById('extremeLowValue').textContent = latest.value + '%';
                } else {
                    extremeLowCard.style.display = 'none';
                }
            } else {
                // æ²¡æœ‰æç«¯äº‹ä»¶ï¼Œæ˜¾ç¤ºæ­£å¸¸çŠ¶æ€
                extremeHighCard.style.display = 'none';
                extremeLowCard.style.display = 'none';
                noExtremeCard.style.display = 'block';
                
                // æ˜¾ç¤ºå½“å‰æœ€æ–°æ•°æ®
                if (coinChangeData.length > 0 && historyData.length > 0) {
                    const latestValue = coinChangeData[coinChangeData.length - 1];
                    const latestTime = historyData[historyData.length - 1].stat_time;
                    if (latestValue !== null) {
                        const message = `å½“å‰æ¶¨è·Œå¹…: ${parseFloat(latestValue).toFixed(2)}% (${latestTime.split(' ')[1]})`;
                        document.querySelector('.extreme-message').textContent = message;
                    }
                }
            }
            
            console.log('ğŸ“Š å½“å¤©æå€¼ç»Ÿè®¡å·²æ›´æ–°:', {
                é«˜æ¶¨äº‹ä»¶: todayHighEvents.length,
                æš´è·Œäº‹ä»¶: todayLowEvents.length
            });
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            console.log('ğŸ¨ å¼€å§‹åˆå§‹åŒ–è¶‹åŠ¿å›¾è¡¨...');
            const chartDom = document.getElementById('trendChart');
            if (!chartDom) {
                console.error('âŒ æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨ #trendChart');
                return;
            }
            
            console.log('ğŸ“ å›¾è¡¨å®¹å™¨ä¿¡æ¯:', {
                width: chartDom.offsetWidth,
                height: chartDom.offsetHeight,
                display: window.getComputedStyle(chartDom).display
            });
            
            // é”€æ¯æ—§å›¾è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (chart) {
                chart.dispose();
            }
            
            // åˆ›å»ºæ–°å›¾è¡¨
            chart = echarts.init(chartDom);
            console.log('âœ… å›¾è¡¨å®ä¾‹åˆ›å»ºæˆåŠŸ');
            
            // è®¾ç½®åˆå§‹é…ç½®
            const option = {
                backgroundColor: '#ffffff',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    borderColor: 'rgba(0,0,0,0.2)',
                    textStyle: { color: '#fff' },
                    axisPointer: {
                        type: 'cross',
                        label: {
                            backgroundColor: '#6a7985'
                        }
                    }
                },
                legend: {
                    data: ['24å°æ—¶ä¿¡å·æ•°', '2å°æ—¶ä¿¡å·æ•°', '27å¸æ¶¨è·Œå¹…æ€»å’Œ'],
                    textStyle: { color: '#000', fontSize: 12 },
                    top: 10,
                    left: 'center'
                },
                grid: {
                    left: '3%',
                    right: '8%',
                    bottom: '15%',
                    top: 50,
                    containLabel: true
                },
                dataZoom: [
                    {
                        type: 'slider',
                        show: true,
                        xAxisIndex: [0],
                        start: 0,
                        end: 100,
                        bottom: 5,
                        height: 25,
                        showDataShadow: true,
                        handleSize: '80%',
                        textStyle: { color: '#000' },
                        filterMode: 'none'
                    },
                    {
                        type: 'inside',
                        xAxisIndex: [0],
                        start: 0,
                        end: 100,
                        zoomOnMouseWheel: true,
                        moveOnMouseMove: true
                    }
                ],
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: [],
                    axisLine: { lineStyle: { color: 'rgba(0,0,0,0.3)' } },
                    axisLabel: { color: '#000', rotate: 45, fontSize: 10 }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'ä¿¡å·æ•°é‡',
                        nameTextStyle: { color: '#000', fontSize: 12 },
                        axisLine: { show: true, lineStyle: { color: 'rgba(0,0,0,0.3)' } },
                        axisLabel: { color: '#000', fontSize: 10 },
                        splitLine: { lineStyle: { color: 'rgba(0,0,0,0.1)' } },
                        min: 0
                    },
                    {
                        type: 'value',
                        name: '27å¸æ¶¨è·Œå¹…(%)',
                        nameTextStyle: { color: '#667eea', fontSize: 12 },
                        position: 'right',
                        axisLine: { show: true, lineStyle: { color: '#667eea' } },
                        axisLabel: { 
                            color: '#667eea',
                            fontSize: 10,
                            formatter: '{value}%'
                        },
                        splitLine: { show: false }
                    }
                ],
                series: [
                    {
                        name: '24å°æ—¶ä¿¡å·æ•°',
                        type: 'line',
                        yAxisIndex: 0,
                        data: [],
                        smooth: true,
                        sampling: 'lttb',
                        lineStyle: { color: '#ef4444', width: 2 },
                        itemStyle: { color: '#ef4444' },
                        showSymbol: false,
                        areaStyle: { color: 'rgba(239, 68, 68, 0.2)' }
                    },
                    {
                        name: '2å°æ—¶ä¿¡å·æ•°',
                        type: 'line',
                        yAxisIndex: 0,
                        data: [],
                        smooth: true,
                        sampling: 'lttb',
                        lineStyle: { color: '#f59e0b', width: 2 },
                        itemStyle: { color: '#f59e0b' },
                        showSymbol: false,
                        areaStyle: { color: 'rgba(245, 158, 11, 0.2)' }
                    },
                    {
                        name: '27å¸æ¶¨è·Œå¹…æ€»å’Œ',
                        type: 'line',
                        yAxisIndex: 1,
                        data: [],
                        smooth: true,
                        lineStyle: { color: '#667eea', width: 3 },
                        itemStyle: { color: '#667eea' },
                        symbol: 'circle',
                        symbolSize: 6
                    }
                ]
            };
            
            chart.setOption(option);
        }
        
        // åŠ è½½æ•°æ® - ä¼˜åŒ–ç‰ˆæœ¬ï¼šå›¾è¡¨åŠ è½½å…³é”®ç‚¹ï¼Œè¡¨æ ¼åŠ è½½å®Œæ•´æ•°æ®
        function loadData() {
            // ğŸ”’ é˜²æ­¢é‡å¤åŠ è½½
            if (isLoading) {
                console.warn('âš ï¸ æ•°æ®æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚');
                return;
            }
            isLoading = true;
            loadStartTime = performance.now();
            console.log('ğŸ” å¼€å§‹åŠ è½½æ•°æ®ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰...');
            const startTime = performance.now();
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            const progressEl = document.getElementById('loadingProgress');
            if (progressEl) progressEl.style.display = 'block';
            
            // æ­¥éª¤1ï¼šåŠ è½½å…³é”®ç‚¹æ•°æ®
            updateProgress(1, 'active', 'æ­£åœ¨åŠ è½½...');
            const keypointsPromise = fetch('/api/escape-signal-stats/keypoints?v=' + Date.now())
                .then(r => r.json())
                .then(data => {
                    updateProgress(1, 'completed', `å®Œæˆ (${data.keypoint_count || 0}ç‚¹)`);
                    return data;
                });
            
            // æ­¥éª¤2ï¼šåŠ è½½ç›ˆåˆ©æ•°æ®
            const profitPromise = keypointsPromise.then(() => {
                updateProgress(2, 'active', 'æ­£åœ¨åŠ è½½...');
                return fetch('/api/anchor-profit/latest?minutes=10').then(r => r.json());
            }).then(data => {
                updateProgress(2, 'completed', `å®Œæˆ (${data.count || 0}æ¡)`);
                return data;
            });
            
            // æ­¥éª¤3ï¼šåŠ è½½27å¸æ•°æ®
            const coinPromise = profitPromise.then(() => {
                updateProgress(3, 'active', 'æ­£åœ¨åŠ è½½...');
                return fetch('/api/coin-price-tracker/history?all=true&t=' + Date.now()).then(r => r.json());
            }).then(data => {
                updateProgress(3, 'completed', `å®Œæˆ (${data.count || 0}æ¡)`);
                return data;
            });
            
            // åˆ†é˜¶æ®µåŠ è½½ï¼š
            // 1. å…ˆåŠ è½½å…³é”®ç‚¹æ•°æ®ï¼ˆå¿«é€Ÿæ¸²æŸ“å›¾è¡¨ï¼‰
            // 2. å†åŠ è½½å®Œæ•´æ•°æ®ï¼ˆç”¨äºè¡¨æ ¼ï¼‰
            Promise.all([keypointsPromise, profitPromise, coinPromise])
            .then(([keypointsResult, profitResult, coinResult]) => {
                const loadTime = ((performance.now() - startTime) / 1000).toFixed(2);
                console.log(`âš¡ å…³é”®ç‚¹æ•°æ®åŠ è½½å®Œæˆï¼Œè€—æ—¶: ${loadTime}ç§’`);
                console.log('ğŸ“Š å…³é”®ç‚¹æ•°æ®:', keypointsResult);
                console.log('ğŸ’° ç©ºå•ç›ˆåˆ©æ•°æ®:', profitResult);
                console.log('ğŸ’µ 27å¸æ•°æ®:', coinResult);
                
                if (!keypointsResult.success) {
                    throw new Error('è·å–å…³é”®ç‚¹æ•°æ®å¤±è´¥: ' + (keypointsResult.error || ''));
                }
                
                const profitData = profitResult.data || [];
                
                // æ›´æ–°ç»Ÿè®¡å¡ç‰‡ï¼ˆä½¿ç”¨å…³é”®ç‚¹APIè¿”å›çš„ç»Ÿè®¡ä¿¡æ¯ï¼‰
                const totalRecordsEl = document.getElementById('totalRecords');
                const max24hEl = document.getElementById('max24h');
                const max2hEl = document.getElementById('max2h');
                const sample24hEl = document.getElementById('sample24h');
                const median24hEl = document.getElementById('median24h');
                const lastUpdateTimeEl = document.getElementById('lastUpdateTime');
                
                if (totalRecordsEl) totalRecordsEl.textContent = keypointsResult.total_records.toLocaleString();
                if (max24hEl) max24hEl.textContent = keypointsResult.max_signal_24h;
                if (max2hEl) max2hEl.textContent = keypointsResult.max_signal_2h;
                if (sample24hEl) sample24hEl.textContent = keypointsResult.keypoint_count;
                if (median24hEl) median24hEl.textContent = '-';  // æš‚æ—¶ä¸è®¡ç®—ä¸­ä½æ•°
                
                console.log('ğŸ“Š ç»Ÿè®¡å¡ç‰‡æ›´æ–°:', {
                    totalRecords: keypointsResult.total_records,
                    max24h: keypointsResult.max_signal_24h,
                    max2h: keypointsResult.max_signal_2h,
                    sample24h: keypointsResult.keypoint_count,
                    å…ƒç´ å­˜åœ¨: {
                        totalRecords: !!totalRecordsEl,
                        max24h: !!max24hEl,
                        max2h: !!max2hEl,
                        sample24h: !!sample24hEl
                    }
                });
                
                // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                if (lastUpdateTimeEl) lastUpdateTimeEl.textContent = timeStr;
                
                console.log(`ğŸ“Š æ•°æ®è§„æ¨¡: åŸå§‹=${keypointsResult.total_records.toLocaleString()}, æ¸²æŸ“=${keypointsResult.keypoint_count}, å‹ç¼©ç‡=${keypointsResult.compression_rate}`);
                        
                        // ğŸ”¥ ä½¿ç”¨åç«¯è®¡ç®—çš„å…³é”®ç‚¹æ•°æ®ï¼ˆå·²ä¼˜åŒ–ï¼‰
                        const sampledData = keypointsResult.keypoints;
                        console.log('âœ… å…³é”®ç‚¹æ•°æ®å·²åŠ è½½:', sampledData.length, 'ä¸ªç‚¹');
                        
                        // ğŸ¨ å‡†å¤‡å›¾è¡¨æ•°æ®ï¼ˆä½¿ç”¨åç«¯è®¡ç®—çš„å…³é”®ç‚¹ï¼‰
                        const times = sampledData.map(d => d.stat_time.substring(5, 16)); // MM-DD HH:MM
                        const signal24h = sampledData.map(d => d.signal_24h_count);
                        const signal2h = sampledData.map(d => d.signal_2h_count);
                        
                        // è®¡ç®—æ¯ä¸ªè‡ªç„¶æ—¥çš„2hæœ€é«˜ç‚¹ï¼ˆä»…æ ‡è®°>50çš„ï¼‰
                        const dailyPeaks = {};
                        sampledData.forEach((d, index) => {
                            const date = d.stat_time.substring(0, 10); // YYYY-MM-DD
                            const value = d.signal_2h_count;
                            
                            if (value > 50) {
                                if (!dailyPeaks[date] || value > dailyPeaks[date].value) {
                                    dailyPeaks[date] = {
                                        index: index,
                                        value: value,
                                        time: d.stat_time
                                    };
                                }
                            }
                        });
                        
                        // è®¡ç®—24å°æ—¶ä¿¡å·çš„48å°æ—¶çª—å£æœ€å¤§å€¼ï¼ˆä»…æ ‡è®°>200çš„ï¼‰
                        const window48hPeaks = [];
                        // æ™ºèƒ½é‡‡æ ·åï¼Œçª—å£å¤§å°åŸºäºé‡‡æ ·åçš„æ•°æ®ç‚¹æ•°
                        const windowSize = Math.max(50, Math.floor(sampledData.length / (keypointsResult.total_records / (48 * 60))));
                        
                        for (let i = 0; i < sampledData.length; i++) {
                            // æ‰¾åˆ°å½“å‰ä½ç½®å‰å48å°æ—¶å†…çš„æœ€å¤§å€¼
                            const startIndex = Math.max(0, Math.floor(i - windowSize / 2));
                            const endIndex = Math.min(sampledData.length - 1, Math.floor(i + windowSize / 2));
                            
                            let maxValue = 0;
                            let maxIndex = i;
                            
                            for (let j = Math.floor(startIndex); j <= Math.floor(endIndex); j++) {
                                if (!sampledData[j]) continue; // å®‰å…¨æ£€æŸ¥
                                const value = sampledData[j].signal_24h_count;
                                if (value > maxValue) {
                                    maxValue = value;
                                    maxIndex = j;
                                }
                            }
                            
                            // å¦‚æœå½“å‰ç‚¹æ˜¯çª—å£å†…çš„æœ€å¤§å€¼ï¼Œä¸”å¤§äº200ï¼Œåˆ™æ ‡è®°
                            if (maxIndex === i && maxValue > 200) {
                                // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨é™„è¿‘æ ‡è®°è¿‡ï¼ˆé¿å…é‡å¤æ ‡è®°ï¼‰
                                const isDuplicate = window48hPeaks.some(p => Math.abs(p.index - i) < windowSize / 4);
                                if (!isDuplicate) {
                                    window48hPeaks.push({
                                        index: i,
                                        value: maxValue,
                                        time: sampledData[i].stat_time
                                    });
                                }
                            }
                        }
                        
                        // æ„å»º2hä¿¡å·æ ‡è®°ç‚¹æ•°æ®ï¼ˆçº¢è‰²å°æ ‡è®°ï¼‰
                        const markPointData2h = Object.values(dailyPeaks).map(peak => ({
                            coord: [peak.index, peak.value],
                            value: peak.value,
                            symbol: 'pin',
                            symbolSize: 60,
                            symbolOffset: [0, '-50%'],
                            itemStyle: {
                                color: '#ef4444',
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: true,
                                formatter: function(params) {
                                    return 'ğŸ”¥ ' + params.value;
                                },
                                position: 'inside',
                                color: '#fff',
                                fontSize: 11,
                                fontWeight: 'bold',
                                offset: [0, 10]
                            }
                        }));
                        
                        // æ„å»º24hä¿¡å·48å°æ—¶å³°å€¼æ ‡è®°ç‚¹æ•°æ®ï¼ˆç´«è‰²å¤§æ ‡è®°ï¼‰
                        const markPointData24h = window48hPeaks.map(peak => ({
                            coord: [peak.index, peak.value],
                            value: peak.value,
                            symbol: 'pin',
                            symbolSize: 70,
                            symbolOffset: [0, '-50%'],
                            itemStyle: {
                                color: '#8b5cf6',
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: true,
                                formatter: function(params) {
                                    return 'â­ ' + params.value;
                                },
                                position: 'inside',
                                color: '#fff',
                                fontSize: 12,
                                fontWeight: 'bold',
                                offset: [0, 12]
                            }
                        }));
                        
                        // ğŸ†• æ·»åŠ ç©ºå•ç›ˆåˆ©â‰¥120%å’Œç©ºå•äºæŸçš„æ ‡è®°ï¼ˆæ¯å°æ—¶åªæ ‡è®°ä¸€æ¬¡ï¼‰
                        const shortProfitMarks = [];  // ç©ºå•ç›ˆåˆ©â‰¥120%æ ‡è®°ï¼ˆç»¿è‰²ï¼‰
                        const shortLossMarks = [];    // ç©ºå•äºæŸæ ‡è®°ï¼ˆçº¢è‰²ï¼‰
                        
                        // åˆ›å»ºæ—¶é—´æˆ³æ˜ å°„è¡¨ï¼ˆé€ƒé¡¶ä¿¡å·æ•°æ®çš„æ—¶é—´ -> ç´¢å¼•ï¼‰
                        const timeToIndexMap = {};
                        sampledData.forEach((d, index) => {
                            const timestamp = new Date(d.stat_time).getTime();
                            timeToIndexMap[timestamp] = index;
                        });
                        
                        // è¿½è¸ªä¸Šæ¬¡æ ‡è®°çš„å°æ—¶ï¼ˆé¿å…é‡å¤æ ‡è®°ï¼‰
                        let lastShortProfitHour = null;
                        let lastShortLossHour = null;
                        
                        // éå†ç©ºå•ç›ˆåˆ©æ•°æ®ï¼Œæ·»åŠ æ ‡è®°
                        profitData.forEach(pd => {
                            const pdTime = new Date(pd.datetime);
                            const pdHour = pdTime.getFullYear() + '-' + 
                                         String(pdTime.getMonth() + 1).padStart(2, '0') + '-' + 
                                         String(pdTime.getDate()).padStart(2, '0') + ' ' +
                                         String(pdTime.getHours()).padStart(2, '0');
                            
                            const stats = pd.stats?.short || {};
                            const shortProfit120 = stats.gte_120 || 0;
                            const shortLoss = stats.loss || 0;
                            
                            // ç©ºå•ç›ˆåˆ©â‰¥120% ä¸” æ•°é‡â‰¥3ï¼Œæ¯å°æ—¶åªæ ‡è®°ä¸€æ¬¡
                            if (shortProfit120 >= 3 && pdHour !== lastShortProfitHour) {
                                // æ‰¾åˆ°æœ€æ¥è¿‘çš„é€ƒé¡¶ä¿¡å·æ•°æ®ç‚¹
                                const pdTimestamp = pdTime.getTime();
                                let closestIndex = -1;
                                let minDiff = Infinity;
                                
                                sampledData.forEach((d, index) => {
                                    const diff = Math.abs(new Date(d.stat_time).getTime() - pdTimestamp);
                                    if (diff < minDiff) {
                                        minDiff = diff;
                                        // ä½¿ç”¨ç´¢å¼•æ˜ å°„æ‰¾åˆ°é‡‡æ ·åçš„ç´¢å¼•
                                        if (window._indexMapping && window._indexMapping.has(index)) {
                                            closestIndex = window._indexMapping.get(index);
                                        } else {
                                            // å¦‚æœæ²¡æœ‰ç²¾ç¡®æ˜ å°„ï¼Œä½¿ç”¨æœ€æ¥è¿‘çš„é‡‡æ ·ç‚¹
                                            closestIndex = index;
                                        }
                                    }
                                });
                                
                                if (closestIndex >= 0 && minDiff < 3600000) { // 1å°æ—¶å†…
                                    const chartData = signal24h[closestIndex] || signal2h[closestIndex] || 0;
                                    shortProfitMarks.push({
                                        coord: [closestIndex, chartData],
                                        value: shortProfit120,
                                        itemStyle: {
                                            color: '#10b981',
                                            borderColor: '#fff',
                                            borderWidth: 2
                                        },
                                        label: {
                                            show: true,
                                            formatter: 'ğŸŸ¢ ' + shortProfit120,
                                            position: 'bottom',
                                            color: '#10b981',
                                            fontSize: 13,
                                            fontWeight: 'bold'
                                        }
                                    });
                                    lastShortProfitHour = pdHour;
                                }
                            }
                            
                            // ç©ºå•äºæŸ ä¸” æ•°é‡â‰¥3ï¼Œæ¯å°æ—¶åªæ ‡è®°ä¸€æ¬¡
                            if (shortLoss >= 3 && pdHour !== lastShortLossHour) {
                                // æ‰¾åˆ°æœ€æ¥è¿‘çš„é€ƒé¡¶ä¿¡å·æ•°æ®ç‚¹
                                const pdTimestamp = pdTime.getTime();
                                let closestIndex = -1;
                                let minDiff = Infinity;
                                
                                sampledData.forEach((d, index) => {
                                    const diff = Math.abs(new Date(d.stat_time).getTime() - pdTimestamp);
                                    if (diff < minDiff) {
                                        minDiff = diff;
                                        // ä½¿ç”¨ç´¢å¼•æ˜ å°„æ‰¾åˆ°é‡‡æ ·åçš„ç´¢å¼•
                                        if (window._indexMapping && window._indexMapping.has(index)) {
                                            closestIndex = window._indexMapping.get(index);
                                        } else {
                                            // å¦‚æœæ²¡æœ‰ç²¾ç¡®æ˜ å°„ï¼Œä½¿ç”¨æœ€æ¥è¿‘çš„é‡‡æ ·ç‚¹
                                            closestIndex = index;
                                        }
                                    }
                                });
                                
                                if (closestIndex >= 0 && minDiff < 3600000) { // 1å°æ—¶å†…
                                    const chartData = signal24h[closestIndex] || signal2h[closestIndex] || 0;
                                    shortLossMarks.push({
                                        coord: [closestIndex, chartData],
                                        value: shortLoss,
                                        itemStyle: {
                                            color: '#ef4444',
                                            borderColor: '#fff',
                                            borderWidth: 2
                                        },
                                        label: {
                                            show: true,
                                            formatter: 'ğŸ”´ ' + shortLoss,
                                            position: 'bottom',
                                            color: '#ef4444',
                                            fontSize: 13,
                                            fontWeight: 'bold'
                                        }
                                    });
                                    lastShortLossHour = pdHour;
                                }
                            }
                        });
                        
                        console.log('ğŸŸ¢ ç©ºå•ç›ˆåˆ©â‰¥120%æ ‡è®°:', shortProfitMarks.length, 'ä¸ª');
                        console.log('ğŸ”´ ç©ºå•äºæŸæ ‡è®°:', shortLossMarks.length, 'ä¸ª');
                        
                        console.log('ğŸ“ æ¯æ—¥2hæœ€é«˜ç‚¹æ ‡è®°:', markPointData2h.length, 'ä¸ª');
                        console.log('â­ 24hä¿¡å·48å°æ—¶å³°å€¼æ ‡è®°:', markPointData24h.length, 'ä¸ª');
                        
                        // æç«¯å¸‚åœºæ ‡è®°æ•°ç»„
                        let extremeHighMarks = [];
                        let extremeLowMarks = [];
                        
                        // å¤„ç†27å¸æ•°æ® - å¯¹é½åˆ°é€ƒé¡¶ä¿¡å·æ—¶é—´è½´
                        let coinChangeData = [];  // ç”¨äºå›¾è¡¨ï¼ˆé‡‡æ ·åçš„æ•°æ®ï¼‰
                        let coinChangeDataFull = []; // ç”¨äºè¡¨æ ¼ï¼ˆå®Œæ•´æ•°æ®ï¼‰
                        
                        if (coinResult && coinResult.success && coinResult.data && coinResult.data.length > 0) {
                            // åˆ›å»º27å¸æ•°æ®çš„æ—¶é—´æ˜ å°„
                            const coinDataMap = new Map();
                            coinResult.data.forEach(record => {
                                const timestamp = new Date(record.collect_time).getTime();
                                let totalSum = record.total_change;
                                if (totalSum === null || totalSum === undefined) {
                                    totalSum = 0;
                                    const changes = record.day_changes || record.coins || {};
                                    Object.values(changes).forEach(coin => {
                                        totalSum += (coin.change_pct || 0);
                                    });
                                }
                                coinDataMap.set(timestamp, totalSum);
                            });
                            
                            // å¯¹æ¯ä¸ªé‡‡æ ·åçš„é€ƒé¡¶ä¿¡å·æ—¶é—´ç‚¹ï¼Œæ‰¾æœ€è¿‘çš„27å¸æ•°æ®ï¼ˆç”¨äºå›¾è¡¨ï¼‰
                            sampledData.forEach((d, index) => {
                                const targetTime = new Date(d.stat_time).getTime();
                                let closestValue = null;
                                let minDiff = Infinity;
                                
                                for (const [timestamp, value] of coinDataMap) {
                                    const diff = Math.abs(timestamp - targetTime);
                                    if (diff < 30 * 60 * 1000 && diff < minDiff) {
                                        minDiff = diff;
                                        closestValue = value;
                                    }
                                }
                                
                                // è°ƒè¯•ï¼šè¾“å‡ºå‰5ä¸ªå’Œå5ä¸ªå¯¹é½ç»“æœ
                                if (index < 5 || index >= sampledData.length - 5) {
                                    console.log(`å›¾è¡¨å¯¹é½ #${index}: ${d.stat_time} -> ${closestValue?.toFixed(2)}% (diff: ${(minDiff/60000).toFixed(1)}åˆ†é’Ÿ)`);
                                }
                                
                                coinChangeData.push(closestValue !== null ? closestValue.toFixed(2) : null);
                            });
                            
                            // å¯¹æ‰€æœ‰åŸå§‹æ•°æ®ç‚¹ï¼Œæ‰¾æœ€è¿‘çš„27å¸æ•°æ®ï¼ˆç”¨äºè¡¨æ ¼ï¼‰
                            sampledData.forEach((d, index) => {
                                const targetTime = new Date(d.stat_time).getTime();
                                let closestValue = null;
                                let minDiff = Infinity;
                                
                                for (const [timestamp, value] of coinDataMap) {
                                    const diff = Math.abs(timestamp - targetTime);
                                    if (diff < 30 * 60 * 1000 && diff < minDiff) {
                                        minDiff = diff;
                                        closestValue = value;
                                    }
                                }
                                
                                coinChangeDataFull.push(closestValue !== null ? closestValue.toFixed(2) : null);
                            });
                            
                            console.log('ğŸ’µ 27å¸æ•°æ®å¯¹é½å®Œæˆï¼Œå…±', coinChangeData.length, 'ä¸ªç‚¹ï¼Œæœ‰æ•ˆæ•°æ®', coinChangeData.filter(v => v !== null).length, 'ä¸ª');
                            console.log('ğŸ’µ 27å¸æ•°æ®ç¤ºä¾‹ (å‰10ä¸ª):', coinChangeData.slice(0, 10));
                            console.log('ğŸ’µ 27å¸æ•°æ®èŒƒå›´:', 
                                'min=' + Math.min(...coinChangeData.filter(v => v !== null)).toFixed(2) + '%,', 
                                'max=' + Math.max(...coinChangeData.filter(v => v !== null)).toFixed(2) + '%');
                            
                            // æ£€æµ‹æç«¯å¸‚åœºæƒ…å†µï¼ˆ>=100% æˆ– <=-80%ï¼‰ï¼Œ1å°æ—¶å†…åªæ ‡è®°ä¸€æ¬¡
                            let lastExtremeHighHour = null;
                            let lastExtremeLowHour = null;
                            
                            coinChangeData.forEach((value, index) => {
                                if (value === null) return;
                                
                                const numValue = parseFloat(value);
                                const record = sampledData[index];
                                const statTime = new Date(record.stat_time);
                                const hourKey = `${statTime.getFullYear()}-${statTime.getMonth()+1}-${statTime.getDate()}-${statTime.getHours()}`;
                                
                                // æ£€æµ‹æç«¯ä¸Šæ¶¨ (>=100%)
                                if (numValue >= 100.0 && hourKey !== lastExtremeHighHour) {
                                    extremeHighMarks.push({
                                        coord: [index, numValue],
                                        value: numValue.toFixed(2),
                                        symbol: 'pin',
                                        symbolSize: 80,
                                        symbolOffset: [0, '-50%'],
                                        itemStyle: {
                                            color: '#ff0000',
                                            borderColor: '#fff',
                                            borderWidth: 3
                                        },
                                        label: {
                                            show: true,
                                            position: 'inside',
                                            formatter: 'ğŸ’¥ ' + numValue.toFixed(1) + '%',
                                            color: '#fff',
                                            fontSize: 12,
                                            fontWeight: 'bold',
                                            offset: [0, 12]
                                        }
                                    });
                                    lastExtremeHighHour = hourKey;
                                }
                                
                                // æ£€æµ‹æç«¯æš´è·Œ (<=-80%)
                                if (numValue <= -80.0 && hourKey !== lastExtremeLowHour) {
                                    extremeLowMarks.push({
                                        coord: [index, numValue],
                                        value: numValue.toFixed(2),
                                        symbol: 'pin',
                                        symbolSize: 80,
                                        symbolOffset: [0, '-50%'],
                                        itemStyle: {
                                            color: '#000000',
                                            borderColor: '#fff',
                                            borderWidth: 3
                                        },
                                        label: {
                                            show: true,
                                            position: 'inside',
                                            formatter: 'ğŸ’€ ' + numValue.toFixed(1) + '%',
                                            color: '#fff',
                                            fontSize: 12,
                                            fontWeight: 'bold',
                                            offset: [0, 12]
                                        }
                                    });
                                    lastExtremeLowHour = hourKey;
                                }
                            });
                            
                            console.log('ğŸ’¥ æç«¯ä¸Šæ¶¨æ ‡è®° (>=100%):', extremeHighMarks.length, 'ä¸ª');
                            console.log('ğŸ’€ æç«¯æš´è·Œæ ‡è®° (<=-80%):', extremeLowMarks.length, 'ä¸ª');
                            
                            // æ›´æ–°å½“å¤©æå€¼ç»Ÿè®¡å¡ç‰‡
                            updateTodayExtremeStats(extremeHighMarks, extremeLowMarks, coinChangeData, sampledData);
                        } else {
                            // å¦‚æœæ²¡æœ‰27å¸æ•°æ®ï¼Œå¡«å……null
                            coinChangeData = new Array(times.length).fill(null);
                            console.log('âš ï¸ æœªè·å–åˆ°27å¸æ•°æ®');
                        }
                        
                        chart.setOption({
                            xAxis: { data: times },
                            legend: {
                                data: coinChangeData.some(v => v !== null) ? 
                                    ['24å°æ—¶ä¿¡å·æ•°', '2å°æ—¶ä¿¡å·æ•°', '27å¸æ¶¨è·Œå¹…æ€»å’Œ'] : 
                                    ['24å°æ—¶ä¿¡å·æ•°', '2å°æ—¶ä¿¡å·æ•°']
                            },
                            series: [
                                { 
                                    name: '24å°æ—¶ä¿¡å·æ•°',
                                    data: signal24h,
                                    markPoint: {
                                        symbol: 'pin',
                                        symbolSize: 60,
                                        data: [...markPointData24h, ...shortProfitMarks, ...shortLossMarks]
                                    }
                                },
                                { 
                                    name: '2å°æ—¶ä¿¡å·æ•°',
                                    data: signal2h,
                                    markPoint: {
                                        symbol: 'pin',
                                        symbolSize: 50,
                                        data: markPointData2h
                                    }
                                },
                                {
                                    name: '27å¸æ¶¨è·Œå¹…æ€»å’Œ',
                                    type: 'line',
                                    yAxisIndex: 1,
                                    data: coinChangeData,
                                    smooth: true,
                                    lineStyle: { color: '#667eea', width: 3 },
                                    itemStyle: { color: '#667eea' },
                                    symbol: 'circle',
                                    symbolSize: 6,
                                    markPoint: {
                                        symbol: 'pin',
                                        symbolSize: 80,
                                        data: [...extremeHighMarks, ...extremeLowMarks]
                                    }
                                }
                            ]
                        });
                        
                        console.log('ğŸ“Š å›¾è¡¨setOptionå®Œæˆï¼Œå¼€å§‹resize');
                        
                        // æ­¥éª¤4ï¼šæ¸²æŸ“å›¾è¡¨å®Œæˆ
                        updateProgress(4, 'completed', `å®Œæˆ (${sampledData.length}ç‚¹)`);
                        
                        const chartDom = document.getElementById('trendChart');
                        console.log('ğŸ“ å›¾è¡¨å®¹å™¨å°ºå¯¸:', {
                            width: chartDom.offsetWidth,
                            height: chartDom.offsetHeight,
                            display: window.getComputedStyle(chartDom).display
                        });
                        
                        // ğŸ”¥ å›¾è¡¨æ¸²æŸ“å®Œæˆåï¼Œç«‹å³éšè—loadingï¼ˆä¸ç­‰å¾…è¡¨æ ¼æ•°æ®ï¼‰
                        const loadingEl = document.getElementById('loading');
                        if (loadingEl) {
                            loadingEl.style.display = 'none';
                            loadingEl.style.visibility = 'hidden';
                            console.log('âœ… Loadingå·²éšè—');
                        }
                        
                        setTimeout(() => {
                            if (chart) {
                                chart.resize();
                                console.log('âœ… å›¾è¡¨resizeå®Œæˆ');
                            }
                        }, 100);
                        
                        // ğŸ”¥ å¼‚æ­¥åŠ è½½å®Œæ•´æ•°æ®ç”¨äºè¡¨æ ¼ï¼ˆä¸é˜»å¡å›¾è¡¨æ¸²æŸ“ï¼‰
                        console.log('ğŸ”„ å¼€å§‹å¼‚æ­¥åŠ è½½å®Œæ•´æ•°æ®ï¼ˆç”¨äºè¡¨æ ¼ï¼‰...');
                        
                        // æ­¥éª¤5ï¼šåŠ è½½å®Œæ•´è¡¨æ ¼æ•°æ®
                        updateProgress(5, 'active', 'æ­£åœ¨åŠ è½½...');
                        
                        fetch('/api/escape-signal-stats?limit=10000&v=' + Date.now())
                            .then(r => r.json())
                            .then(fullResult => {
                                if (!fullResult.success || !fullResult.history_data) {
                                    console.warn('âš ï¸ å®Œæ•´æ•°æ®åŠ è½½å¤±è´¥');
                                    return;
                                }
                                
                                const historyDataReversed = fullResult.history_data;  // å·²ç»æ˜¯å€’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰
                                fullHistoryData = historyDataReversed;  // ä¿å­˜åˆ°å…¨å±€å˜é‡
                                console.log('âœ… å®Œæ•´æ•°æ®åŠ è½½å®Œæˆ:', historyDataReversed.length, 'æ¡è®°å½•');
                                
                                // æ¸²æŸ“è¡¨æ ¼
                                const tbody = document.getElementById('tableBody');
                                tbody.innerHTML = '';
                                
                                console.log('ğŸ”¢ å¼€å§‹æ¸²æŸ“è¡¨æ ¼ï¼Œè®°å½•æ•°:', historyDataReversed.length);
                                
                                // å€’åºæ¸²æŸ“è¡¨æ ¼ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼Œæœ€æ—©çš„åœ¨åï¼‰
                                for (let i = 0; i < Math.min(historyDataReversed.length, 1000); i++) {  // å…ˆåªæ¸²æŸ“å‰1000æ¡
                                    const record = historyDataReversed[i];
                                    const row = document.createElement('tr');
                                    
                                    // åˆ¤æ–­çŠ¶æ€
                                    let status = 'æ­£å¸¸';
                                    let statusClass = 'status-normal';
                                    
                                    if (record.signal_24h_count > 600) {
                                        status = 'æç«¯é€ƒé¡¶';
                                        statusClass = 'status-danger';
                                    } else if (record.signal_24h_count > 400) {
                                        status = 'ä¸Šæ¶¨é¢„è­¦';
                                        statusClass = 'status-rising';
                                    }
                                    
                                    row.innerHTML = `
                                        <td>${record.stat_time}</td>
                                        <td>${record.signal_24h_count}</td>
                                        <td>${record.signal_2h_count}</td>
                                        <td>-</td>
                                        <td>${record.decline_strength_level || '-'}</td>
                                        <td>${record.rise_strength_level || '-'}</td>
                                        <td class="${statusClass}">${status}</td>
                                    `;
                                    tbody.appendChild(row);
                                }
                        
                        console.log('âœ… è¡¨æ ¼æ¸²æŸ“å®Œæˆï¼Œå…± ' + historyDataReversed.length + ' è¡Œï¼ˆå€’åºæ˜¾ç¤ºï¼‰');
                        
                        // æ­¥éª¤5ï¼šè¡¨æ ¼æ•°æ®åŠ è½½å®Œæˆ
                        updateProgress(5, 'completed', `å®Œæˆ (${historyDataReversed.length}æ¡)`);
                        
                        // éšè—è¿›åº¦æ¡
                        hideProgress();
                        
                        // ğŸ“Š æ›´æ–°è¡¨æ ¼æ•°æ®èŒƒå›´æ˜¾ç¤º
                        if (historyDataReversed.length > 0) {
                            const firstRecord = historyDataReversed[0];  // æœ€æ–°çš„
                            const lastIdx = Math.min(historyDataReversed.length - 1, 999);
                            const lastRecord = historyDataReversed[lastIdx];  // æœ€æ—§çš„ï¼ˆæ˜¾ç¤ºèŒƒå›´å†…ï¼‰
                            const infoEl = document.getElementById('tableDataInfo');
                            if (infoEl) {
                                infoEl.textContent = `(æ˜¾ç¤º ${Math.min(1000, historyDataReversed.length)} æ¡ï¼Œæœ€æ–°: ${firstRecord.stat_time})`;
                            }
                        }
                        
                        // ğŸ”¥ æ˜¾ç¤ºè¡¨æ ¼
                        const tableEl = document.getElementById('dataTable');
                        if (tableEl) {
                            tableEl.style.display = 'table';
                            tableEl.style.visibility = 'visible';
                        }
                        console.log('ğŸ“‹ è¡¨æ ¼å·²æ˜¾ç¤º');
                            })
                            .catch(error => {
                                console.error('âŒ è¡¨æ ¼æ•°æ®åŠ è½½é”™è¯¯:', error);
                                document.getElementById('loading').textContent = 'è¡¨æ ¼æ•°æ®åŠ è½½é”™è¯¯: ' + error;
                            });
                })
                .catch(error => {
                    console.error('âŒ è¯·æ±‚é”™è¯¯:', error);
                    document.getElementById('loading').textContent = 'æ•°æ®åŠ è½½é”™è¯¯: ' + error;
                })
                .finally(() => {
                    isLoading = false;  // åŠ è½½å®Œæˆï¼Œè§£é”
                    console.log('ğŸ”“ æ•°æ®åŠ è½½å®Œæˆï¼Œå·²è§£é”');
                });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            loadData();
            
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(loadData, 30000);
            
            // ç›‘å¬çª—å£resizeäº‹ä»¶
            window.addEventListener('resize', function() {
                if (chart) {
                    chart.resize();
                }
            });
        });
    </script>
</body>
</html>
