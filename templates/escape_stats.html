<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€ƒé¡¶ç»Ÿè®¡ç³»ç»Ÿ - ä»·æ ¼ä½ç½®é¢„è­¦</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
        }
        
        .date-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .date-nav button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .date-nav button:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }
        
        .date-nav button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .date-nav input[type="date"] {
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 1em;
        }
        
        #chartContainer {
            height: 500px;
            margin-bottom: 30px;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .badge-danger {
            background: #fee;
            color: #c33;
        }
        
        .badge-warning {
            background: #ffeaa7;
            color: #d63031;
        }
        
        .badge-success {
            background: #d5f4e6;
            color: #00b894;
        }
        
        .badge-info {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75em;
            font-weight: bold;
        }
        
        .progress-low {
            background: linear-gradient(90deg, #00b894, #00cec9);
        }
        
        .progress-medium {
            background: linear-gradient(90deg, #fdcb6e, #e17055);
        }
        
        .progress-high {
            background: linear-gradient(90deg, #fd79a8, #e84393);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
        }
        
        .price-change {
            font-weight: bold;
        }
        
        .price-up {
            color: #00b894;
        }
        
        .price-down {
            color: #d63031;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š é€ƒé¡¶ç»Ÿè®¡ç³»ç»Ÿ</h1>
            <p>åŸºäºä»·æ ¼ä½ç½®ç™¾åˆ†æ¯”çš„é€ƒé¡¶é¢„è­¦ | æ¯60ç§’æ›´æ–°</p>
        </div>
        
        <!-- æ—¥æœŸå¯¼èˆª -->
        <div class="card">
            <div class="date-nav">
                <button id="btnPrevDay" onclick="navigateDate(-1)">â—€ å‰ä¸€å¤©</button>
                <input type="date" id="datePicker" onchange="loadDateData()">
                <button id="btnNextDay" onclick="navigateDate(1)">åä¸€å¤© â–¶</button>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>24å°æ—¶é€ƒé¡¶ä¿¡å·</h3>
                <div class="value" id="stat24h">-</div>
            </div>
            <div class="stat-card">
                <h3>2å°æ—¶é€ƒé¡¶ä¿¡å·</h3>
                <div class="value" id="stat2h">-</div>
            </div>
            <div class="stat-card">
                <h3>å½“å‰ç¬¦åˆå¸ç§</h3>
                <div class="value" id="statCurrent">-</div>
            </div>
            <div class="stat-card">
                <h3>æ•°æ®ç‚¹æ•°é‡</h3>
                <div class="value" id="statPoints">-</div>
            </div>
        </div>
        
        <!-- è¶‹åŠ¿å›¾ -->
        <div class="card">
            <h2 style="margin-bottom: 20px;">ğŸ“ˆ é€ƒé¡¶ä¿¡å·æ—¶é—´çº¿ï¼ˆ24h vs 2hï¼‰</h2>
            <div id="chartContainer"></div>
        </div>
        
        <!-- 27ä¸ªå¸ç§è¯¦æƒ…è¡¨ -->
        <div class="card">
            <h2 style="margin-bottom: 20px;">ğŸ’° 27ä¸ªå¸ç§å®æ—¶ä½ç½®</h2>
            <div class="table-container">
                <table id="coinTable">
                    <thead>
                        <tr>
                            <th>å¸ç§</th>
                            <th>å½“å‰ä»·æ ¼</th>
                            <th>48hä½ç½®</th>
                            <th>7å¤©ä½ç½®</th>
                            <th>48håŒºé—´</th>
                            <th>7å¤©åŒºé—´</th>
                            <th>é¢„è­¦çŠ¶æ€</th>
                            <th>æ›´æ–°æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="coinTableBody">
                        <tr><td colspan="8" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        let currentDate = new Date().toISOString().split('T')[0];
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            setDatePicker(currentDate);
            loadDateData();
            loadCoinDetails();
            
            // æ¯60ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(() => {
                if (currentDate === new Date().toISOString().split('T')[0]) {
                    loadDateData();
                    loadCoinDetails();
                }
            }, 60000);
        });
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            chart = echarts.init(document.getElementById('chartContainer'));
            const option = {
                title: {
                    text: 'é€ƒé¡¶ä¿¡å·è¶‹åŠ¿',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                legend: {
                    data: ['24å°æ—¶é€ƒé¡¶', '2å°æ—¶é€ƒé¡¶'],
                    bottom: 10
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: [],
                    axisLabel: {
                        rotate: 45,
                        interval: 'auto'
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'å¸ç§æ•°é‡',
                    minInterval: 1
                },
                series: [
                    {
                        name: '24å°æ—¶é€ƒé¡¶',
                        type: 'line',
                        data: [],
                        smooth: true,
                        lineStyle: {
                            color: '#e74c3c',
                            width: 3
                        },
                        itemStyle: {
                            color: '#e74c3c'
                        },
                        areaStyle: {
                            color: 'rgba(231, 76, 60, 0.2)'
                        }
                    },
                    {
                        name: '2å°æ—¶é€ƒé¡¶',
                        type: 'line',
                        data: [],
                        smooth: true,
                        lineStyle: {
                            color: '#f39c12',
                            width: 3
                        },
                        itemStyle: {
                            color: '#f39c12'
                        },
                        areaStyle: {
                            color: 'rgba(243, 156, 18, 0.2)'
                        }
                    }
                ]
            };
            chart.setOption(option);
        }
        
        // è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨
        function setDatePicker(date) {
            document.getElementById('datePicker').value = date;
            currentDate = date;
            
            // ç¦ç”¨æœªæ¥æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('btnNextDay').disabled = (date >= today);
        }
        
        // æ—¥æœŸå¯¼èˆª
        function navigateDate(offset) {
            const date = new Date(currentDate);
            date.setDate(date.getDate() + offset);
            const newDate = date.toISOString().split('T')[0];
            setDatePicker(newDate);
            loadDateData();
        }
        
        // åŠ è½½æ—¥æœŸæ•°æ®
        async function loadDateData() {
            try {
                const response = await fetch(`/api/escape-stats/data?date=${currentDate}`);
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    updateChart(result.data);
                    updateStats(result.data);
                } else {
                    console.warn('No data for date:', currentDate);
                    chart.setOption({
                        xAxis: { data: [] },
                        series: [
                            { data: [] },
                            { data: [] }
                        ]
                    });
                }
            } catch (error) {
                console.error('Error loading date data:', error);
            }
        }
        
        // æ›´æ–°å›¾è¡¨
        function updateChart(data) {
            const times = data.map(d => {
                const time = d.time.split(' ')[1].substring(0, 5);
                return time;
            });
            
            const escape24h = data.map(d => d.escape_24h_count);
            const escape2h = data.map(d => d.escape_2h_count);
            
            chart.setOption({
                xAxis: {
                    data: times
                },
                series: [
                    { data: escape24h },
                    { data: escape2h }
                ]
            });
        }
        
        // æ›´æ–°ç»Ÿè®¡
        function updateStats(data) {
            // ç»Ÿè®¡24hå†…çš„é€ƒé¡¶ä¿¡å·
            const escape24hCounts = data.filter(d => d.escape_24h_count > 0);
            document.getElementById('stat24h').textContent = escape24hCounts.length;
            
            // ç»Ÿè®¡2hå†…çš„é€ƒé¡¶ä¿¡å·
            const escape2hCounts = data.filter(d => d.escape_2h_count > 0);
            document.getElementById('stat2h').textContent = escape2hCounts.length;
            
            // æœ€æ–°ä¸€æ¡æ•°æ®
            const latest = data[data.length - 1];
            if (latest) {
                const currentSymbols = new Set([...latest.escape_24h_symbols, ...latest.escape_2h_symbols]);
                document.getElementById('statCurrent').textContent = currentSymbols.size;
            }
            
            document.getElementById('statPoints').textContent = data.length;
        }
        
        // åŠ è½½å¸ç§è¯¦æƒ…
        async function loadCoinDetails() {
            try {
                const response = await fetch('/api/price-position/list-detailed');
                const result = await response.json();
                
                if (result.success) {
                    renderCoinTable(result.data);
                }
            } catch (error) {
                console.error('Error loading coin details:', error);
            }
        }
        
        // æ¸²æŸ“å¸ç§è¡¨æ ¼
        function renderCoinTable(coins) {
            const tbody = document.getElementById('coinTableBody');
            
            if (coins.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">æš‚æ— æ•°æ®</td></tr>';
                return;
            }
            
            // æŒ‰48hä½ç½®é™åºæ’åº
            coins.sort((a, b) => b.position_48h - a.position_48h);
            
            tbody.innerHTML = coins.map(coin => {
                const alerts = [];
                if (coin.alert_48h_high) alerts.push('<span class="badge badge-danger">48hé«˜ä½</span>');
                if (coin.alert_48h_low) alerts.push('<span class="badge badge-success">48hä½ä½</span>');
                if (coin.alert_7d_high) alerts.push('<span class="badge badge-warning">7å¤©é«˜ä½</span>');
                if (coin.alert_7d_low) alerts.push('<span class="badge badge-info">7å¤©ä½ä½</span>');
                
                const alertHtml = alerts.length > 0 ? alerts.join(' ') : '<span style="color:#999;">æ­£å¸¸</span>';
                
                // 48hè¿›åº¦æ¡
                const pos48hColor = coin.position_48h >= 95 ? 'progress-high' : 
                                   coin.position_48h <= 5 ? 'progress-low' : 'progress-medium';
                const pos48hHtml = `
                    <div class="progress-bar">
                        <div class="progress-fill ${pos48hColor}" style="width: ${coin.position_48h}%">
                            ${coin.position_48h.toFixed(1)}%
                        </div>
                    </div>
                `;
                
                // 7å¤©è¿›åº¦æ¡
                const pos7dColor = coin.position_7d >= 95 ? 'progress-high' : 
                                  coin.position_7d <= 5 ? 'progress-low' : 'progress-medium';
                const pos7dHtml = `
                    <div class="progress-bar">
                        <div class="progress-fill ${pos7dColor}" style="width: ${coin.position_7d}%">
                            ${coin.position_7d.toFixed(1)}%
                        </div>
                    </div>
                `;
                
                return `
                    <tr>
                        <td><strong>${coin.symbol}</strong></td>
                        <td><strong>${coin.current_price.toFixed(coin.current_price < 1 ? 4 : 2)}</strong></td>
                        <td>${pos48hHtml}</td>
                        <td>${pos7dHtml}</td>
                        <td style="font-size:0.85em;color:#666;">
                            ${coin.low_48h.toFixed(coin.low_48h < 1 ? 4 : 2)} ~ ${coin.high_48h.toFixed(coin.high_48h < 1 ? 4 : 2)}
                        </td>
                        <td style="font-size:0.85em;color:#666;">
                            ${coin.low_7d.toFixed(coin.low_7d < 1 ? 4 : 2)} ~ ${coin.high_7d.toFixed(coin.high_7d < 1 ? 4 : 2)}
                        </td>
                        <td>${alertHtml}</td>
                        <td style="font-size:0.85em;color:#999;">
                            ${coin.snapshot_time.split(' ')[1]}
                        </td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>
</html>
