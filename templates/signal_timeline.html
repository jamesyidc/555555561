<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»·æ ¼ä½ç½®é¢„è­¦ç³»ç»Ÿ v2.0 - ä¿¡å·æ—¶é—´çº¿</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .header h1 { color: #667eea; font-size: 28px; margin-bottom: 10px; }
        .header .meta { color: #666; font-size: 14px; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .stat-card .label { color: #999; font-size: 12px; text-transform: uppercase; margin-bottom: 8px; }
        .stat-card .value { color: #333; font-size: 24px; font-weight: bold; }
        .stat-card .subvalue { color: #666; font-size: 14px; margin-top: 5px; }
        
        .chart-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .chart-panel h3 {
            margin-bottom: 15px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .date-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-nav button {
            padding: 8px 16px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .date-nav button:hover { background: #5568d3; }
        .date-nav .current-date { font-size: 16px; font-weight: bold; color: #667eea; }
        
        .chart-container { height: 500px; }
        .legend { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .legend-item { display: inline-block; margin-right: 20px; font-size: 14px; }
        .legend-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; }
        
        .loading { text-align: center; padding: 40px; color: #999; }
        .error { background: #fee; color: #c33; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ“Š ä»·æ ¼ä½ç½®é¢„è­¦ç³»ç»Ÿ v2.0 - ä¿¡å·æ—¶é—´çº¿</h1>
            <div class="meta">
                <span>ğŸ• æ•°æ®é¢‘ç‡: 3åˆ†é’Ÿ/æ¬¡</span>
                <span style="margin-left: 20px;">ğŸ“ˆ ç›‘æ§: 27ä¸ªå¸ç§</span>
                <span style="margin-left: 20px;">â° æ›´æ–°: <span id="lastUpdate">--</span></span>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">24å°æ—¶ æŠ„åº•ä¿¡å·</div>
                <div class="value" id="buy24h">--</div>
                <div class="subvalue">æ¬¡</div>
            </div>
            <div class="stat-card">
                <div class="label">24å°æ—¶ é€ƒé¡¶ä¿¡å·</div>
                <div class="value" id="sell24h">--</div>
                <div class="subvalue">æ¬¡</div>
            </div>
            <div class="stat-card">
                <div class="label">2å°æ—¶ æŠ„åº•ä¿¡å·</div>
                <div class="value" id="buy2h">--</div>
                <div class="subvalue">æ¬¡</div>
            </div>
            <div class="stat-card">
                <div class="label">2å°æ—¶ é€ƒé¡¶ä¿¡å·</div>
                <div class="value" id="sell2h">--</div>
                <div class="subvalue">æ¬¡</div>
            </div>
        </div>

        <!-- å›¾è¡¨é¢æ¿ -->
        <div class="chart-panel">
            <h3>
                <span>ğŸ“ˆ å››æ¡çº¿è¶‹åŠ¿å›¾</span>
                <div class="date-nav">
                    <button onclick="prevDay()">â† å‰ä¸€å¤©</button>
                    <span class="current-date" id="currentDate">--</span>
                    <button onclick="nextDay()">åä¸€å¤© â†’</button>
                    <button onclick="today()" style="background: #48bb78;">ä»Šå¤©</button>
                </div>
            </h3>
            
            <div id="loadingDiv" class="loading">â³ æ­£åœ¨åŠ è½½æ•°æ®...</div>
            <div id="errorDiv" class="error" style="display: none;"></div>
            <div id="chartContainer" class="chart-container" style="display: none;"></div>
            
            <div class="legend">
                <div class="legend-item">
                    <span class="legend-dot" style="background: #48bb78;"></span>
                    <span>æ”¯æ’‘çº¿1 (48hâ‰¤5%)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot" style="background: #38a169;"></span>
                    <span>æ”¯æ’‘çº¿2 (7dâ‰¤5%)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot" style="background: #f56565;"></span>
                    <span>å‹åŠ›çº¿1 (48hâ‰¥95%)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot" style="background: #e53e3e;"></span>
                    <span>å‹åŠ›çº¿2 (7dâ‰¥95%)</span>
                </div>
                <div class="legend-item">
                    <span style="font-weight: bold; color: #48bb78;">ğŸŸ¢ æŠ„åº•ä¿¡å·</span>
                    <span style="color: #666;"> (æ”¯æ’‘1+2â‰¥20ä¸”â‰¥1)</span>
                </div>
                <div class="legend-item">
                    <span style="font-weight: bold; color: #f56565;">ğŸ”´ é€ƒé¡¶ä¿¡å·</span>
                    <span style="color: #666;"> (å‹åŠ›1+2â‰¥8ä¸”â‰¥1)</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        let currentDate = new Date().toISOString().split('T')[0];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadChart(currentDate);
            startAutoRefresh();
        });

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const response = await fetch('/api/signal-timeline/stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('buy24h').textContent = data.stats_24h.buy_signals;
                    document.getElementById('sell24h').textContent = data.stats_24h.sell_signals;
                    document.getElementById('buy2h').textContent = data.stats_2h.buy_signals;
                    document.getElementById('sell2h').textContent = data.stats_2h.sell_signals;
                    
                    if (data.latest) {
                        document.getElementById('lastUpdate').textContent = data.latest.time;
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // åŠ è½½å›¾è¡¨
        async function loadChart(date) {
            const loadingDiv = document.getElementById('loadingDiv');
            const errorDiv = document.getElementById('errorDiv');
            const chartContainer = document.getElementById('chartContainer');
            
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            chartContainer.style.display = 'none';
            
            document.getElementById('currentDate').textContent = date;
            
            try {
                const response = await fetch(`/api/signal-timeline/data?date=${date}`);
                const data = await response.json();
                
                if (!data.success || data.count === 0) {
                    throw new Error('æš‚æ— æ•°æ®');
                }
                
                // å‡†å¤‡æ•°æ®
                const times = data.data.map(d => d.time.substring(11, 16));
                const support48h = data.data.map(d => d.support_48h);
                const support7d = data.data.map(d => d.support_7d);
                const pressure48h = data.data.map(d => d.pressure_48h);
                const pressure7d = data.data.map(d => d.pressure_7d);
                
                // ä¿¡å·æ ‡è®°
                const buySignals = [];
                const sellSignals = [];
                
                data.data.forEach((d, idx) => {
                    if (d.signal_triggered === 1) {
                        buySignals.push([times[idx], 25, d.trigger_reason]);
                    } else if (d.signal_triggered === 2) {
                        sellSignals.push([times[idx], 25, d.trigger_reason]);
                    }
                });
                
                // ç»˜åˆ¶å›¾è¡¨
                drawChart(times, support48h, support7d, pressure48h, pressure7d, buySignals, sellSignals);
                
                loadingDiv.style.display = 'none';
                chartContainer.style.display = 'block';
                
            } catch (error) {
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'âŒ ' + error.message;
            }
        }

        // ç»˜åˆ¶å›¾è¡¨
        function drawChart(times, support48h, support7d, pressure48h, pressure7d, buySignals, sellSignals) {
            if (!chart) {
                chart = echarts.init(document.getElementById('chartContainer'));
            }
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                legend: {
                    data: ['æ”¯æ’‘çº¿1 (48h)', 'æ”¯æ’‘çº¿2 (7d)', 'å‹åŠ›çº¿1 (48h)', 'å‹åŠ›çº¿2 (7d)', 'æŠ„åº•ä¿¡å·', 'é€ƒé¡¶ä¿¡å·'],
                    top: 10
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: times,
                    boundaryGap: false
                },
                yAxis: {
                    type: 'value',
                    name: 'å¸ç§æ•°é‡',
                    min: 0,
                    max: 27
                },
                series: [
                    {
                        name: 'æ”¯æ’‘çº¿1 (48h)',
                        type: 'line',
                        data: support48h,
                        smooth: true,
                        lineStyle: { color: '#48bb78', width: 2 },
                        itemStyle: { color: '#48bb78' }
                    },
                    {
                        name: 'æ”¯æ’‘çº¿2 (7d)',
                        type: 'line',
                        data: support7d,
                        smooth: true,
                        lineStyle: { color: '#38a169', width: 2, type: 'dashed' },
                        itemStyle: { color: '#38a169' }
                    },
                    {
                        name: 'å‹åŠ›çº¿1 (48h)',
                        type: 'line',
                        data: pressure48h,
                        smooth: true,
                        lineStyle: { color: '#f56565', width: 2 },
                        itemStyle: { color: '#f56565' }
                    },
                    {
                        name: 'å‹åŠ›çº¿2 (7d)',
                        type: 'line',
                        data: pressure7d,
                        smooth: true,
                        lineStyle: { color: '#e53e3e', width: 2, type: 'dashed' },
                        itemStyle: { color: '#e53e3e' }
                    },
                    {
                        name: 'æŠ„åº•ä¿¡å·',
                        type: 'scatter',
                        data: buySignals.map(s => [s[0], s[1]]),
                        symbolSize: 20,
                        itemStyle: { color: '#48bb78' },
                        label: {
                            show: true,
                            formatter: 'ğŸŸ¢',
                            fontSize: 16
                        }
                    },
                    {
                        name: 'é€ƒé¡¶ä¿¡å·',
                        type: 'scatter',
                        data: sellSignals.map(s => [s[0], s[1]]),
                        symbolSize: 20,
                        itemStyle: { color: '#f56565' },
                        label: {
                            show: true,
                            formatter: 'ğŸ”´',
                            fontSize: 16
                        }
                    }
                ]
            };
            
            chart.setOption(option);
        }

        // æ—¥æœŸå¯¼èˆª
        function prevDay() {
            const date = new Date(currentDate);
            date.setDate(date.getDate() - 1);
            currentDate = date.toISOString().split('T')[0];
            loadChart(currentDate);
        }

        function nextDay() {
            const date = new Date(currentDate);
            date.setDate(date.getDate() + 1);
            currentDate = date.toISOString().split('T')[0];
            loadChart(currentDate);
        }

        function today() {
            currentDate = new Date().toISOString().split('T')[0];
            loadChart(currentDate);
        }

        // è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            setInterval(() => {
                const today_date = new Date().toISOString().split('T')[0];
                if (currentDate === today_date) {
                    loadStats();
                    loadChart(currentDate);
                }
            }, 180000); // 3åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡
        }

        // çª—å£å¤§å°æ”¹å˜
        window.addEventListener('resize', function() {
            if (chart) {
                chart.resize();
            }
        });
    </script>
</body>
</html>
