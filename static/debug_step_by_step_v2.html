<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€æ­¥è°ƒè¯• - æ‰¾å‡ºTooltipé—®é¢˜</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #0f0f23;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%);
            border-radius: 15px;
            margin-bottom: 30px;
        }
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .steps {
            display: grid;
            gap: 20px;
        }
        .step {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s;
        }
        .step.active {
            border-color: #52c41a;
            background: rgba(82, 196, 26, 0.1);
        }
        .step.error {
            border-color: #ff4d4f;
            background: rgba(255, 77, 79, 0.1);
        }
        .step-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .step-title {
            font-size: 1.5em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .step-number {
            background: #1890ff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }
        .step.active .step-number {
            background: #52c41a;
        }
        .step.error .step-number {
            background: #ff4d4f;
        }
        .step-status {
            font-size: 2em;
        }
        .step-content {
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-top: 15px;
        }
        .data-display {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.8;
            max-height: 400px;
            overflow-y: auto;
        }
        .data-row {
            padding: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .data-row:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .key {
            color: #ffd700;
            font-weight: bold;
        }
        .value {
            color: #52c41a;
        }
        .error-value {
            color: #ff4d4f;
            font-weight: bold;
        }
        .button {
            background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%);
            color: #fff;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(24, 144, 255, 0.4);
        }
        .button:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
        }
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        #debugChart {
            width: 100%;
            height: 500px;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .comparison-box {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid;
        }
        .expected {
            border-color: #52c41a;
        }
        .actual {
            border-color: #ff4d4f;
        }
        .highlight {
            background: rgba(255, 215, 0, 0.2);
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
        }
        .code-block {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            margin: 10px 0;
        }
        .warning {
            background: rgba(250, 173, 20, 0.2);
            border: 2px solid #faad14;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .array-display {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 5px;
            margin: 10px 0;
        }
        .array-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            font-family: 'Courier New', monospace;
        }
        .array-item.highlight {
            background: rgba(255, 215, 0, 0.3);
            border: 2px solid #ffd700;
        }
        .progress {
            width: 100%;
            height: 30px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #52c41a 0%, #95de64 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” é€æ­¥è°ƒè¯• Tooltip é—®é¢˜</h1>
            <p style="font-size: 1.2em; margin-top: 10px;">ä¸€æ­¥æ­¥åŠ è½½æ•°æ®ï¼Œæ‰¾å‡ºé—®é¢˜æ ¹æº</p>
        </div>

        <div class="progress">
            <div class="progress-bar" id="progress" style="width: 0%">0%</div>
        </div>

        <div style="text-align: center; margin-bottom: 30px;">
            <button class="button" onclick="startDebug()">ğŸš€ å¼€å§‹è°ƒè¯•</button>
            <button class="button" onclick="resetDebug()">ğŸ”„ é‡ç½®</button>
            <button class="button" onclick="runAll()">âš¡ å…¨éƒ¨è¿è¡Œ</button>
        </div>

        <div class="steps">
            <!-- Step 1: Load API Data -->
            <div class="step" id="step1">
                <div class="step-header">
                    <div class="step-title">
                        <div class="step-number">1</div>
                        <span>åŠ è½½ API æ•°æ®</span>
                    </div>
                    <div class="step-status" id="status1">â¸ï¸</div>
                </div>
                <div class="step-content" id="content1">
                    <p>ä»åç«¯ API è·å–åŸå§‹æ•°æ®...</p>
                    <button class="button" onclick="runStep1()">è¿è¡Œæ­¥éª¤ 1</button>
                </div>
            </div>

            <!-- Step 2: Parse and Deduplicate -->
            <div class="step" id="step2">
                <div class="step-header">
                    <div class="step-title">
                        <div class="step-number">2</div>
                        <span>è§£æå¹¶å»é‡</span>
                    </div>
                    <div class="step-status" id="status2">â¸ï¸</div>
                </div>
                <div class="step-content" id="content2">
                    <p>è§£æ API æ•°æ®å¹¶ç§»é™¤é‡å¤é¡¹...</p>
                    <button class="button" onclick="runStep2()" disabled>è¿è¡Œæ­¥éª¤ 2</button>
                </div>
            </div>

            <!-- Step 3: Calculate Statistics -->
            <div class="step" id="step3">
                <div class="step-header">
                    <div class="step-title">
                        <div class="step-number">3</div>
                        <span>è®¡ç®—ç»Ÿè®¡æ•°æ®</span>
                    </div>
                    <div class="step-status" id="status3">â¸ï¸</div>
                </div>
                <div class="step-content" id="content3">
                    <p>è®¡ç®— 24h å’Œ 2h é€ƒé¡¶ä¿¡å·æ•°...</p>
                    <button class="button" onclick="runStep3()" disabled>è¿è¡Œæ­¥éª¤ 3</button>
                </div>
            </div>

            <!-- Step 4: Prepare Chart Data -->
            <div class="step" id="step4">
                <div class="step-header">
                    <div class="step-title">
                        <div class="step-number">4</div>
                        <span>å‡†å¤‡å›¾è¡¨æ•°æ®</span>
                    </div>
                    <div class="step-status" id="status4">â¸ï¸</div>
                </div>
                <div class="step-content" id="content4">
                    <p>å‡†å¤‡ sell24hData, sell2hData, fullTimes...</p>
                    <button class="button" onclick="runStep4()" disabled>è¿è¡Œæ­¥éª¤ 4</button>
                </div>
            </div>

            <!-- Step 5: Create Tooltip Variables -->
            <div class="step" id="step5">
                <div class="step-header">
                    <div class="step-title">
                        <div class="step-number">5</div>
                        <span>åˆ›å»º Tooltip å˜é‡</span>
                    </div>
                    <div class="step-status" id="status5">â¸ï¸</div>
                </div>
                <div class="step-content" id="content5">
                    <p>åˆ›å»º chartData24h, chartData2h, chartFullTimes...</p>
                    <button class="button" onclick="runStep5()" disabled>è¿è¡Œæ­¥éª¤ 5</button>
                </div>
            </div>

            <!-- Step 6: Render Chart -->
            <div class="step" id="step6">
                <div class="step-header">
                    <div class="step-title">
                        <div class="step-number">6</div>
                        <span>æ¸²æŸ“å›¾è¡¨</span>
                    </div>
                    <div class="step-status" id="status6">â¸ï¸</div>
                </div>
                <div class="step-content" id="content6">
                    <p>ä½¿ç”¨ ECharts æ¸²æŸ“å›¾è¡¨å¹¶é…ç½® Tooltip...</p>
                    <button class="button" onclick="runStep6()" disabled>è¿è¡Œæ­¥éª¤ 6</button>
                </div>
            </div>

            <!-- Step 7: Test Tooltip -->
            <div class="step" id="step7">
                <div class="step-header">
                    <div class="step-title">
                        <div class="step-number">7</div>
                        <span>æµ‹è¯• Tooltip</span>
                    </div>
                    <div class="step-status" id="status7">â¸ï¸</div>
                </div>
                <div class="step-content" id="content7">
                    <p>æ¨¡æ‹Ÿæ‚¬åœåœ¨æœ€å³ä¾§æ•°æ®ç‚¹ï¼Œæ£€æŸ¥ Tooltip æ˜¾ç¤º...</p>
                    <button class="button" onclick="runStep7()" disabled>è¿è¡Œæ­¥éª¤ 7</button>
                </div>
            </div>
        </div>

        <div class="chart-container" id="chartContainer" style="display: none;">
            <h2>ğŸ“Š è°ƒè¯•å›¾è¡¨</h2>
            <div id="debugChart"></div>
        </div>
    </div>

    <script>
        let apiData = null;
        let allData = [];
        let displayData = [];
        let sell24hData = [];
        let sell2hData = [];
        let fullTimes = [];
        let chartData24h = [];
        let chartData2h = [];
        let chartFullTimes = [];
        let chart = null;
        let currentStep = 0;

        function updateProgress(step) {
            const percent = (step / 7) * 100;
            document.getElementById('progress').style.width = percent + '%';
            document.getElementById('progress').textContent = Math.round(percent) + '%';
        }

        function setStepStatus(step, status) {
            const stepEl = document.getElementById('step' + step);
            const statusEl = document.getElementById('status' + step);
            
            stepEl.classList.remove('active', 'error');
            
            if (status === 'running') {
                stepEl.classList.add('active');
                statusEl.textContent = 'â³';
            } else if (status === 'success') {
                stepEl.classList.add('active');
                statusEl.textContent = 'âœ…';
            } else if (status === 'error') {
                stepEl.classList.add('error');
                statusEl.textContent = 'âŒ';
            }
        }

        function enableNextStep(step) {
            if (step < 7) {
                const nextBtn = document.querySelector(`#step${step + 1} button`);
                if (nextBtn) nextBtn.disabled = false;
            }
        }

        async function runStep1() {
            setStepStatus(1, 'running');
            const content = document.getElementById('content1');
            
            try {
                content.innerHTML = '<p>æ­£åœ¨è¯·æ±‚ API...</p>';
                
                const response = await fetch('/api/price-position/list-detailed');
                apiData = await response.json();
                
                content.innerHTML = `
                    <div class="data-display">
                        <div class="data-row"><span class="key">API çŠ¶æ€:</span> <span class="value">${response.status}</span></div>
                        <div class="data-row"><span class="key">å“åº”æˆåŠŸ:</span> <span class="value">${apiData.success}</span></div>
                        <div class="data-row"><span class="key">æ•°æ®é•¿åº¦:</span> <span class="value">${apiData.data ? apiData.data.length : 0}</span></div>
                        <div class="data-row"><span class="key">åŸå§‹æ•°æ®å‰ 3 æ¡:</span></div>
                        <div class="code-block">${JSON.stringify(apiData.data.slice(0, 3), null, 2)}</div>
                    </div>
                `;
                
                setStepStatus(1, 'success');
                enableNextStep(1);
                currentStep = 1;
                updateProgress(1);
            } catch (error) {
                content.innerHTML = `<div class="warning">âŒ é”™è¯¯: ${error.message}</div>`;
                setStepStatus(1, 'error');
            }
        }

        async function runStep2() {
            setStepStatus(2, 'running');
            const content = document.getElementById('content2');
            
            try {
                content.innerHTML = '<p>æ­£åœ¨è§£æå’Œå»é‡...</p>';
                
                allData = apiData.data.map(item => ({
                    ...item,
                    timestamp: new Date(item.timestamp).getTime()
                }));
                
                // å»é‡
                const seen = new Set();
                const beforeCount = allData.length;
                allData = allData.filter(item => {
                    const key = `${item.timestamp}_${item.coin}`;
                    if (seen.has(key)) return false;
                    seen.add(key);
                    return true;
                });
                const afterCount = allData.length;
                const removed = beforeCount - afterCount;
                
                // æ’åº
                allData.sort((a, b) => a.timestamp - b.timestamp);
                
                // è·å–å½“å‰æ—¥æœŸçš„æ•°æ®
                const today = new Date().toISOString().split('T')[0];
                displayData = allData.filter(item => 
                    item.timestamp_str.startsWith(today)
                );
                
                content.innerHTML = `
                    <div class="data-display">
                        <div class="data-row"><span class="key">å»é‡å‰:</span> <span class="value">${beforeCount} æ¡</span></div>
                        <div class="data-row"><span class="key">å»é‡å:</span> <span class="value">${afterCount} æ¡</span></div>
                        <div class="data-row"><span class="key">ç§»é™¤é‡å¤:</span> <span class="error-value">${removed} æ¡</span></div>
                        <div class="data-row"><span class="key">å½“å‰æ—¥æœŸæ•°æ®:</span> <span class="value">${displayData.length} æ¡</span></div>
                        <div class="data-row"><span class="key">æ—¶é—´èŒƒå›´:</span></div>
                        <div class="code-block">
ä»: ${allData[0].timestamp_str}
åˆ°: ${allData[allData.length - 1].timestamp_str}
                        </div>
                    </div>
                `;
                
                setStepStatus(2, 'success');
                enableNextStep(2);
                currentStep = 2;
                updateProgress(2);
            } catch (error) {
                content.innerHTML = `<div class="warning">âŒ é”™è¯¯: ${error.message}</div>`;
                setStepStatus(2, 'error');
            }
        }

        async function runStep3() {
            setStepStatus(3, 'running');
            const content = document.getElementById('content3');
            
            try {
                content.innerHTML = '<p>æ­£åœ¨è®¡ç®—ç»Ÿè®¡æ•°æ®...</p>';
                
                // è®¡ç®—æ¯ä¸ªæ—¶é—´ç‚¹çš„ 24h å’Œ 2h ç»Ÿè®¡
                const stats = [];
                
                for (let i = 0; i < displayData.length; i++) {
                    const currentTime = displayData[i].timestamp;
                    const time24hAgo = currentTime - 24 * 60 * 60 * 1000;
                    const time2hAgo = currentTime - 2 * 60 * 60 * 1000;
                    
                    // è®¡ç®— 24h å†…çš„å–å‡ºä¿¡å·
                    const count24h = allData.filter(item => 
                        item.timestamp > time24hAgo && 
                        item.timestamp <= currentTime && 
                        item.signal_type === 'sell'
                    ).length;
                    
                    // è®¡ç®— 2h å†…çš„å–å‡ºä¿¡å·
                    const count2h = allData.filter(item => 
                        item.timestamp > time2hAgo && 
                        item.timestamp <= currentTime && 
                        item.signal_type === 'sell'
                    ).length;
                    
                    stats.push({
                        time: displayData[i].timestamp_str,
                        sell24h: count24h,
                        sell2h: count2h,
                        index: i
                    });
                }
                
                // æœ€åä¸€ä¸ªæ•°æ®ç‚¹çš„ç»Ÿè®¡
                const lastStat = stats[stats.length - 1];
                
                content.innerHTML = `
                    <div class="data-display">
                        <div class="data-row"><span class="key">ç»Ÿè®¡ç‚¹æ•°:</span> <span class="value">${stats.length} ä¸ª</span></div>
                        <div class="data-row"><span class="key">æœ€åä¸€ä¸ªç‚¹:</span></div>
                        <div class="code-block">
æ—¶é—´: ${lastStat.time}
24h é€ƒé¡¶: ${lastStat.sell24h} æ¬¡
2h é€ƒé¡¶: ${lastStat.sell2h} æ¬¡
ç´¢å¼•: ${lastStat.index}
                        </div>
                        <div class="data-row"><span class="key">æœ€å 10 ä¸ªç‚¹çš„ 24h ç»Ÿè®¡:</span></div>
                        <div class="array-display">
                            ${stats.slice(-10).map((s, idx) => `
                                <div class="array-item ${idx === 9 ? 'highlight' : ''}">
                                    <div style="font-size: 0.8em;">[${s.index}]</div>
                                    <div style="font-size: 1.2em; font-weight: bold;">${s.sell24h}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                // ä¿å­˜ç»Ÿè®¡æ•°æ®
                window.debugStats = stats;
                
                setStepStatus(3, 'success');
                enableNextStep(3);
                currentStep = 3;
                updateProgress(3);
            } catch (error) {
                content.innerHTML = `<div class="warning">âŒ é”™è¯¯: ${error.message}</div>`;
                setStepStatus(3, 'error');
            }
        }

        async function runStep4() {
            setStepStatus(4, 'running');
            const content = document.getElementById('content4');
            
            try {
                content.innerHTML = '<p>æ­£åœ¨å‡†å¤‡å›¾è¡¨æ•°æ®...</p>';
                
                const stats = window.debugStats;
                
                // æ„å»ºæ•°ç»„
                sell24hData = stats.map(s => s.sell24h);
                sell2hData = stats.map(s => s.sell2h);
                fullTimes = stats.map(s => s.time);
                
                content.innerHTML = `
                    <div class="data-display">
                        <div class="data-row"><span class="key">sell24hData é•¿åº¦:</span> <span class="value">${sell24hData.length}</span></div>
                        <div class="data-row"><span class="key">sell2hData é•¿åº¦:</span> <span class="value">${sell2hData.length}</span></div>
                        <div class="data-row"><span class="key">fullTimes é•¿åº¦:</span> <span class="value">${fullTimes.length}</span></div>
                        <div class="data-row"><span class="key">sell24hData æœ€å 5 ä¸ªå€¼:</span></div>
                        <div class="code-block">${JSON.stringify(sell24hData.slice(-5))}</div>
                        <div class="data-row"><span class="key">sell2hData æœ€å 5 ä¸ªå€¼:</span></div>
                        <div class="code-block">${JSON.stringify(sell2hData.slice(-5))}</div>
                        <div class="data-row"><span class="key">fullTimes æœ€å 3 ä¸ª:</span></div>
                        <div class="code-block">${JSON.stringify(fullTimes.slice(-3), null, 2)}</div>
                        <div class="warning">
                            <strong>âš ï¸ å…³é”®æ£€æŸ¥ç‚¹:</strong><br>
                            sell24hData[${sell24hData.length - 1}] = <span class="highlight">${sell24hData[sell24hData.length - 1]}</span><br>
                            è¿™ä¸ªå€¼åº”è¯¥ä¸é¡µé¢é¡¶éƒ¨ç»Ÿè®¡ä¸€è‡´ï¼
                        </div>
                    </div>
                `;
                
                setStepStatus(4, 'success');
                enableNextStep(4);
                currentStep = 4;
                updateProgress(4);
            } catch (error) {
                content.innerHTML = `<div class="warning">âŒ é”™è¯¯: ${error.message}</div>`;
                setStepStatus(4, 'error');
            }
        }

        async function runStep5() {
            setStepStatus(5, 'running');
            const content = document.getElementById('content5');
            
            try {
                content.innerHTML = '<p>æ­£åœ¨åˆ›å»º Tooltip å˜é‡...</p>';
                
                // å¤åˆ¶æ•°ç»„ï¼ˆè¿™æ˜¯å…³é”®ï¼ï¼‰
                chartData24h = sell24hData.slice();
                chartData2h = sell2hData.slice();
                chartFullTimes = fullTimes.slice();
                
                // æ£€æŸ¥æ˜¯å¦ç›¸åŒ
                const isSame24h = JSON.stringify(chartData24h) === JSON.stringify(sell24hData);
                const isSame2h = JSON.stringify(chartData2h) === JSON.stringify(sell2hData);
                const isSameTimes = JSON.stringify(chartFullTimes) === JSON.stringify(fullTimes);
                
                content.innerHTML = `
                    <div class="data-display">
                        <div class="data-row"><span class="key">chartData24h é•¿åº¦:</span> <span class="value">${chartData24h.length}</span></div>
                        <div class="data-row"><span class="key">chartData2h é•¿åº¦:</span> <span class="value">${chartData2h.length}</span></div>
                        <div class="data-row"><span class="key">chartFullTimes é•¿åº¦:</span> <span class="value">${chartFullTimes.length}</span></div>
                        <div class="data-row"><span class="key">æ•°æ®å¯¹é½æ£€æŸ¥:</span></div>
                        <div class="code-block">
chartData24h === sell24hData (å¼•ç”¨): ${chartData24h === sell24hData ? 'âŒ ç›¸åŒå¼•ç”¨' : 'âœ… ä¸åŒå¼•ç”¨'}
chartData24h å†…å®¹ === sell24hData å†…å®¹: ${isSame24h ? 'âœ… å†…å®¹ç›¸åŒ' : 'âŒ å†…å®¹ä¸åŒ'}
chartData2h === sell2hData (å¼•ç”¨): ${chartData2h === sell2hData ? 'âŒ ç›¸åŒå¼•ç”¨' : 'âœ… ä¸åŒå¼•ç”¨'}
chartData2h å†…å®¹ === sell2hData å†…å®¹: ${isSame2h ? 'âœ… å†…å®¹ç›¸åŒ' : 'âŒ å†…å®¹ä¸åŒ'}
                        </div>
                        <div class="data-row"><span class="key">æœ€åä¸€ä¸ªå€¼å¯¹æ¯”:</span></div>
                        <div class="comparison">
                            <div class="comparison-box expected">
                                <h3>sell24hData (series æ•°æ®)</h3>
                                <div class="code-block">
ç´¢å¼•: ${sell24hData.length - 1}
å€¼: <span class="highlight">${sell24hData[sell24hData.length - 1]}</span>
                                </div>
                            </div>
                            <div class="comparison-box ${chartData24h[chartData24h.length - 1] === sell24hData[sell24hData.length - 1] ? 'expected' : 'actual'}">
                                <h3>chartData24h (tooltip æ•°æ®)</h3>
                                <div class="code-block">
ç´¢å¼•: ${chartData24h.length - 1}
å€¼: <span class="highlight">${chartData24h[chartData24h.length - 1]}</span>
                                </div>
                            </div>
                        </div>
                        ${chartData24h[chartData24h.length - 1] !== sell24hData[sell24hData.length - 1] ? 
                            '<div class="warning">âŒ <strong>å‘ç°é—®é¢˜ï¼</strong> chartData24h å’Œ sell24hData çš„æœ€åä¸€ä¸ªå€¼ä¸ä¸€è‡´ï¼</div>' : 
                            '<div style="background: rgba(82, 196, 26, 0.2); padding: 15px; border-radius: 8px; margin-top: 15px;">âœ… <strong>æ­£ç¡®ï¼</strong> chartData24h å’Œ sell24hData çš„å€¼ä¸€è‡´ã€‚</div>'
                        }
                    </div>
                `;
                
                setStepStatus(5, 'success');
                enableNextStep(5);
                currentStep = 5;
                updateProgress(5);
            } catch (error) {
                content.innerHTML = `<div class="warning">âŒ é”™è¯¯: ${error.message}</div>`;
                setStepStatus(5, 'error');
            }
        }

        async function runStep6() {
            setStepStatus(6, 'running');
            const content = document.getElementById('content6');
            
            try {
                content.innerHTML = '<p>æ­£åœ¨æ¸²æŸ“å›¾è¡¨...</p>';
                
                // æ˜¾ç¤ºå›¾è¡¨å®¹å™¨
                document.getElementById('chartContainer').style.display = 'block';
                
                // åˆå§‹åŒ–å›¾è¡¨
                if (!chart) {
                    chart = echarts.init(document.getElementById('debugChart'));
                }
                
                const option = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'cross' },
                        formatter: function(params) {
                            if (!params || params.length === 0) return '';
                            const dataIndex = params[0].dataIndex;
                            const fullTime = chartFullTimes[dataIndex];
                            const actual24h = chartData24h[dataIndex];
                            const actual2h = chartData2h[dataIndex];
                            
                            console.log('ğŸ¯ Tooltip è°ƒè¯•:');
                            console.log('  dataIndex:', dataIndex);
                            console.log('  fullTime:', fullTime);
                            console.log('  actual24h:', actual24h);
                            console.log('  actual2h:', actual2h);
                            console.log('  chartData24h.length:', chartData24h.length);
                            console.log('  sell24hData.length:', sell24hData.length);
                            
                            let result = `<div style="font-weight: bold; margin-bottom: 8px;">ğŸ“… ${fullTime}</div>`;
                            result += `<div style="margin: 4px 0; color: #faad14;">
                                ğŸ› è°ƒè¯•: ç´¢å¼•${dataIndex}/${chartData24h.length - 1}
                            </div>`;
                            result += `<div style="margin: 4px 0;">
                                <span style="display:inline-block;width:10px;height:10px;background:#ff4d4f;border-radius:50%;margin-right:5px;"></span>
                                24hé€ƒé¡¶: <strong>${actual24h}</strong> æ¬¡
                            </div>`;
                            result += `<div style="margin: 4px 0;">
                                <span style="display:inline-block;width:10px;height:10px;background:#faad14;border-radius:50%;margin-right:5px;"></span>
                                2hé€ƒé¡¶: <strong>${actual2h}</strong> æ¬¡
                            </div>`;
                            return result;
                        }
                    },
                    legend: {
                        data: ['24hé€ƒé¡¶', '2hé€ƒé¡¶'],
                        textStyle: { color: '#fff' },
                        top: 10
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '10%',
                        top: '15%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: fullTimes.map(t => t.split(' ')[1]),
                        axisLabel: { 
                            color: '#a0a0a0',
                            rotate: 45
                        },
                        axisLine: { lineStyle: { color: '#444' } }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'ä¿¡å·æ•°é‡',
                        nameTextStyle: { color: '#a0a0a0' },
                        axisLabel: { color: '#a0a0a0' },
                        axisLine: { lineStyle: { color: '#444' } },
                        splitLine: { lineStyle: { color: '#2d2d44' } }
                    },
                    series: [
                        {
                            name: '24hé€ƒé¡¶',
                            type: 'line',
                            data: sell24hData,
                            itemStyle: { color: '#ff4d4f' },
                            areaStyle: { color: 'rgba(255, 77, 79, 0.2)' },
                            smooth: true
                        },
                        {
                            name: '2hé€ƒé¡¶',
                            type: 'line',
                            data: sell2hData,
                            itemStyle: { color: '#faad14' },
                            areaStyle: { color: 'rgba(250, 173, 20, 0.2)' },
                            smooth: true
                        }
                    ]
                };
                
                chart.setOption(option);
                
                content.innerHTML = `
                    <div class="data-display">
                        <div class="data-row"><span class="key">å›¾è¡¨æ¸²æŸ“:</span> <span class="value">âœ… æˆåŠŸ</span></div>
                        <div class="data-row"><span class="key">Series æ•°æ®:</span></div>
                        <div class="code-block">
series[0].data = sell24hData (é•¿åº¦: ${sell24hData.length})
series[1].data = sell2hData (é•¿åº¦: ${sell2hData.length})
                        </div>
                        <div class="data-row"><span class="key">Tooltip æ•°æ®:</span></div>
                        <div class="code-block">
tooltip ä½¿ç”¨: chartData24h (é•¿åº¦: ${chartData24h.length})
tooltip ä½¿ç”¨: chartData2h (é•¿åº¦: ${chartData2h.length})
                        </div>
                        <div class="warning">
                            <strong>ğŸ¯ å…³é”®æ£€æŸ¥:</strong><br>
                            series æ•°æ®å’Œ tooltip æ•°æ®çš„é•¿åº¦å¿…é¡»ç›¸åŒï¼<br>
                            sell24hData.length (${sell24hData.length}) ${sell24hData.length === chartData24h.length ? '==' : '!='} chartData24h.length (${chartData24h.length})
                        </div>
                        <div style="background: rgba(24, 144, 255, 0.2); padding: 15px; border-radius: 8px; margin-top: 15px;">
                            ğŸ“ <strong>ç°åœ¨è¯·å°†é¼ æ ‡æ‚¬åœåœ¨å›¾è¡¨çš„æœ€å³ä¾§</strong>ï¼ŒæŸ¥çœ‹ Console è¾“å‡ºï¼
                        </div>
                    </div>
                `;
                
                setStepStatus(6, 'success');
                enableNextStep(6);
                currentStep = 6;
                updateProgress(6);
            } catch (error) {
                content.innerHTML = `<div class="warning">âŒ é”™è¯¯: ${error.message}</div>`;
                setStepStatus(6, 'error');
            }
        }

        async function runStep7() {
            setStepStatus(7, 'running');
            const content = document.getElementById('content7');
            
            try {
                content.innerHTML = '<p>æ­£åœ¨æµ‹è¯• Tooltip...</p>';
                
                // æ¨¡æ‹Ÿè·å–æœ€åä¸€ä¸ªç‚¹çš„ Tooltip æ•°æ®
                const lastIndex = chartData24h.length - 1;
                const expectedValue = sell24hData[lastIndex];
                const tooltipValue = chartData24h[lastIndex];
                const fullTime = chartFullTimes[lastIndex];
                
                const isCorrect = expectedValue === tooltipValue;
                
                content.innerHTML = `
                    <div class="data-display">
                        <div class="data-row"><span class="key">æµ‹è¯•æ•°æ®ç‚¹:</span> <span class="value">æœ€åä¸€ä¸ªï¼ˆç´¢å¼• ${lastIndex}ï¼‰</span></div>
                        <div class="data-row"><span class="key">æ—¶é—´:</span> <span class="value">${fullTime}</span></div>
                        <div class="comparison">
                            <div class="comparison-box expected">
                                <h3>âœ… é¢„æœŸå€¼ (sell24hData)</h3>
                                <div class="code-block">
ç´¢å¼•: ${lastIndex}
å€¼: <span class="highlight" style="font-size: 2em;">${expectedValue}</span> æ¬¡
                                </div>
                                <p style="margin-top: 10px;">è¿™æ˜¯ series æ•°æ®ä¸­çš„å€¼</p>
                            </div>
                            <div class="comparison-box ${isCorrect ? 'expected' : 'actual'}">
                                <h3>${isCorrect ? 'âœ…' : 'âŒ'} å®é™…å€¼ (chartData24h)</h3>
                                <div class="code-block">
ç´¢å¼•: ${lastIndex}
å€¼: <span class="highlight" style="font-size: 2em;">${tooltipValue}</span> æ¬¡
                                </div>
                                <p style="margin-top: 10px;">è¿™æ˜¯ tooltip å°†æ˜¾ç¤ºçš„å€¼</p>
                            </div>
                        </div>
                        ${!isCorrect ? `
                            <div class="warning" style="margin-top: 20px;">
                                <h3>âŒ å‘ç°é—®é¢˜ï¼</h3>
                                <p><strong>é¢„æœŸå€¼:</strong> ${expectedValue} æ¬¡</p>
                                <p><strong>å®é™…å€¼:</strong> ${tooltipValue} æ¬¡</p>
                                <p><strong>å·®å¼‚:</strong> ${Math.abs(expectedValue - tooltipValue)} æ¬¡</p>
                                <p style="margin-top: 15px;"><strong>å¯èƒ½åŸå› :</strong></p>
                                <ul style="margin-left: 20px; line-height: 2;">
                                    <li>chartData24h æ²¡æœ‰æ­£ç¡®å¤åˆ¶ sell24hData</li>
                                    <li>æ•°ç»„é•¿åº¦ä¸åŒ¹é…</li>
                                    <li>ç´¢å¼•è®¿é—®é”™è¯¯</li>
                                    <li>æ•°æ®åœ¨æ¸²æŸ“åè¢«ä¿®æ”¹</li>
                                </ul>
                            </div>
                        ` : `
                            <div style="background: rgba(82, 196, 26, 0.2); padding: 20px; border-radius: 8px; margin-top: 20px;">
                                <h3 style="color: #52c41a;">âœ… æµ‹è¯•é€šè¿‡ï¼</h3>
                                <p style="font-size: 1.2em; margin-top: 10px;">
                                    Tooltip å°†æ­£ç¡®æ˜¾ç¤º <span class="highlight" style="font-size: 1.3em;">${tooltipValue} æ¬¡</span>
                                </p>
                                <p style="margin-top: 15px;">
                                    ç°åœ¨è¯·åœ¨ä¸Šé¢çš„å›¾è¡¨ä¸­æ‚¬åœåœ¨æœ€å³ä¾§ï¼ŒéªŒè¯å®é™…æ˜¾ç¤ºæ˜¯å¦ä¸æ­¤ä¸€è‡´ã€‚
                                </p>
                            </div>
                        `}
                        <div style="margin-top: 20px; padding: 15px; background: rgba(24, 144, 255, 0.2); border-radius: 8px;">
                            <h3>ğŸ“ è°ƒè¯•æ€»ç»“</h3>
                            <div style="line-height: 2; margin-top: 10px;">
                                <div>â€¢ æ•°æ®ç‚¹æ€»æ•°: ${chartData24h.length}</div>
                                <div>â€¢ æœ€åç´¢å¼•: ${lastIndex}</div>
                                <div>â€¢ sell24hData[${lastIndex}]: ${expectedValue}</div>
                                <div>â€¢ chartData24h[${lastIndex}]: ${tooltipValue}</div>
                                <div>â€¢ æ•°æ®ä¸€è‡´æ€§: ${isCorrect ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                setStepStatus(7, isCorrect ? 'success' : 'error');
                currentStep = 7;
                updateProgress(7);
            } catch (error) {
                content.innerHTML = `<div class="warning">âŒ é”™è¯¯: ${error.message}</div>`;
                setStepStatus(7, 'error');
            }
        }

        function startDebug() {
            if (currentStep === 0) {
                runStep1();
            } else {
                alert('è°ƒè¯•å·²ç»å¼€å§‹ã€‚è¯·ç‚¹å‡»"é‡ç½®"é‡æ–°å¼€å§‹ã€‚');
            }
        }

        function resetDebug() {
            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            apiData = null;
            allData = [];
            displayData = [];
            sell24hData = [];
            sell2hData = [];
            fullTimes = [];
            chartData24h = [];
            chartData2h = [];
            chartFullTimes = [];
            currentStep = 0;
            
            // é‡ç½® UI
            for (let i = 1; i <= 7; i++) {
                document.getElementById('step' + i).classList.remove('active', 'error');
                document.getElementById('status' + i).textContent = 'â¸ï¸';
                document.getElementById('content' + i).innerHTML = 
                    i === 1 ? '<p>ä»åç«¯ API è·å–åŸå§‹æ•°æ®...</p><button class="button" onclick="runStep1()">è¿è¡Œæ­¥éª¤ 1</button>' :
                    `<p>ç­‰å¾…æ­¥éª¤ ${i - 1} å®Œæˆ...</p><button class="button" onclick="runStep${i}()" disabled>è¿è¡Œæ­¥éª¤ ${i}</button>`;
            }
            
            // éšè—å›¾è¡¨
            document.getElementById('chartContainer').style.display = 'none';
            if (chart) {
                chart.dispose();
                chart = null;
            }
            
            updateProgress(0);
        }

        async function runAll() {
            resetDebug();
            for (let i = 1; i <= 7; i++) {
                await window['runStep' + i]();
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        // åˆå§‹åŒ–
        updateProgress(0);
    </script>
</body>
</html>
