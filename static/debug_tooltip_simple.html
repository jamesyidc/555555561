<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tooltip æ•°æ®è°ƒè¯• - ç®€åŒ–ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #0f0f23;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%);
            border-radius: 15px;
            margin-bottom: 30px;
        }
        h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .section {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        .section.success {
            border-color: #52c41a;
            background: rgba(82, 196, 26, 0.1);
        }
        .section.error {
            border-color: #ff4d4f;
            background: rgba(255, 77, 79, 0.1);
        }
        .button {
            background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%);
            color: #fff;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(24, 144, 255, 0.4);
        }
        .data-row {
            padding: 10px;
            margin: 5px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }
        .key {
            color: #ffd700;
            font-weight: bold;
        }
        .value {
            color: #52c41a;
        }
        .error-value {
            color: #ff4d4f;
            font-weight: bold;
            font-size: 1.2em;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .comparison-box {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            border: 3px solid;
        }
        .comparison-box.match {
            border-color: #52c41a;
        }
        .comparison-box.mismatch {
            border-color: #ff4d4f;
        }
        .bignum {
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        #testChart {
            width: 100%;
            height: 500px;
        }
        .highlight {
            background: rgba(255, 215, 0, 0.3);
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
        }
        #log {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” Tooltip æ•°æ®è°ƒè¯• - ç®€åŒ–ç‰ˆ</h1>
            <p style="font-size: 1.1em; margin-top: 10px;">ç›´æ¥ä½¿ç”¨å®é™… APIï¼ŒéªŒè¯ Tooltip æ•°æ®</p>
        </div>

        <div style="text-align: center; margin-bottom: 30px;">
            <button class="button" onclick="runTest()">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <button class="button" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="section" id="dataInfo" style="display: none;">
            <h2>ğŸ“Š æ•°æ®ä¿¡æ¯</h2>
            <div id="dataContent"></div>
        </div>

        <div class="section" id="arrayInfo" style="display: none;">
            <h2>ğŸ”¢ æ•°ç»„å¯¹æ¯”</h2>
            <div id="arrayContent"></div>
        </div>

        <div class="section" id="tooltipTest" style="display: none;">
            <h2>ğŸ¯ Tooltip æµ‹è¯•ç»“æœ</h2>
            <div id="tooltipContent"></div>
        </div>

        <div class="chart-container" id="chartContainer" style="display: none;">
            <h2>ğŸ“ˆ æµ‹è¯•å›¾è¡¨</h2>
            <p style="color: #faad14; margin-bottom: 15px;">æ‚¬åœåœ¨å›¾è¡¨æœ€å³ä¾§ï¼ŒæŸ¥çœ‹ Tooltip æ˜¾ç¤ºçš„å€¼</p>
            <div id="testChart"></div>
        </div>

        <div class="section">
            <h2>ğŸ“ æ‰§è¡Œæ—¥å¿—</h2>
            <div id="log"></div>
        </div>
    </div>

    <script>
        let sell24hData = [];
        let sell2hData = [];
        let fullTimes = [];
        let chartData24h = [];
        let chartData2h = [];
        let chartFullTimes = [];
        let chart = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'ğŸ“';
            const color = type === 'error' ? '#ff4d4f' : type === 'success' ? '#52c41a' : type === 'warning' ? '#faad14' : '#aaa';
            
            entry.innerHTML = `<span style="color: ${color};">[${timestamp}] ${icon} ${message}</span>`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function runTest() {
            clearLog();
            log('å¼€å§‹æµ‹è¯•...', 'info');
            
            try {
                // Step 1: Load data
                log('æ­¥éª¤ 1: åŠ è½½æ•°æ®...', 'info');
                const currentDate = new Date().toISOString().split('T')[0];
                const prevDateObj = new Date(currentDate + 'T00:00:00');
                prevDateObj.setDate(prevDateObj.getDate() - 1);
                const prevDate = prevDateObj.toISOString().split('T')[0];
                
                log(`å½“å‰æ—¥æœŸ: ${currentDate}, å‰ä¸€å¤©: ${prevDate}`, 'info');
                
                const [chartDataResp, prevDataResp] = await Promise.all([
                    fetch(`/api/signal-timeline/data?date=${currentDate}`),
                    fetch(`/api/signal-timeline/data?date=${prevDate}`)
                ]);
                
                const chartData = await chartDataResp.json();
                const prevData = await prevDataResp.json();
                
                log(`${currentDate}: ${chartData.data?.length || 0} æ¡æ•°æ®`, 'success');
                log(`${prevDate}: ${prevData.data?.length || 0} æ¡æ•°æ®`, 'success');
                
                // Step 2: Merge and deduplicate
                log('æ­¥éª¤ 2: åˆå¹¶å¹¶å»é‡æ•°æ®...', 'info');
                const combinedData = [...(prevData.data || []), ...(chartData.data || [])];
                const uniqueTimeMap = new Map();
                combinedData.forEach(item => {
                    uniqueTimeMap.set(item.time, item);
                });
                const deduplicatedData = Array.from(uniqueTimeMap.values()).sort((a, b) => {
                    return a.time < b.time ? -1 : 1;
                });
                
                log(`åˆå¹¶å‰: ${combinedData.length} æ¡`, 'info');
                log(`å»é‡å: ${deduplicatedData.length} æ¡ (ç§»é™¤ ${combinedData.length - deduplicatedData.length} æ¡é‡å¤)`, 'success');
                
                // Step 3: Prepare data
                log('æ­¥éª¤ 3: è®¡ç®—ç»Ÿè®¡æ•°æ®...', 'info');
                const allData = deduplicatedData;
                const displayData = chartData.data || [];
                
                log(`allData: ${allData.length} æ¡ (ç”¨äºç»Ÿè®¡)`, 'info');
                log(`displayData: ${displayData.length} æ¡ (ç”¨äºæ˜¾ç¤º)`, 'info');
                
                // Calculate statistics for each display point
                sell24hData = [];
                sell2hData = [];
                fullTimes = [];
                
                for (let i = 0; i < displayData.length; i++) {
                    const currentTime = new Date(displayData[i].time).getTime();
                    const time24hAgo = currentTime - 24 * 60 * 60 * 1000;
                    const time2hAgo = currentTime - 2 * 60 * 60 * 1000;
                    
                    const count24h = allData.filter(item => {
                        const itemTime = new Date(item.time).getTime();
                        return itemTime > time24hAgo && itemTime <= currentTime && item.signal_type === 'sell';
                    }).length;
                    
                    const count2h = allData.filter(item => {
                        const itemTime = new Date(item.time).getTime();
                        return itemTime > time2hAgo && itemTime <= currentTime && item.signal_type === 'sell';
                    }).length;
                    
                    sell24hData.push(count24h);
                    sell2hData.push(count2h);
                    fullTimes.push(displayData[i].time);
                }
                
                log(`è®¡ç®—å®Œæˆ: ${sell24hData.length} ä¸ªæ•°æ®ç‚¹`, 'success');
                
                // Display data info
                const dataInfoDiv = document.getElementById('dataInfo');
                dataInfoDiv.style.display = 'block';
                document.getElementById('dataContent').innerHTML = `
                    <div class="data-row"><span class="key">allData é•¿åº¦:</span> <span class="value">${allData.length}</span></div>
                    <div class="data-row"><span class="key">displayData é•¿åº¦:</span> <span class="value">${displayData.length}</span></div>
                    <div class="data-row"><span class="key">sell24hData é•¿åº¦:</span> <span class="value">${sell24hData.length}</span></div>
                    <div class="data-row"><span class="key">sell24hData æœ€å 5 ä¸ªå€¼:</span> <span class="value">${JSON.stringify(sell24hData.slice(-5))}</span></div>
                    <div class="data-row"><span class="key">sell2hData æœ€å 5 ä¸ªå€¼:</span> <span class="value">${JSON.stringify(sell2hData.slice(-5))}</span></div>
                    <div class="data-row"><span class="key">æœ€åæ—¶é—´ç‚¹:</span> <span class="value">${fullTimes[fullTimes.length - 1]}</span></div>
                `;
                
                // Step 4: Create tooltip variables
                log('æ­¥éª¤ 4: åˆ›å»º Tooltip å˜é‡...', 'info');
                chartData24h = sell24hData.slice();
                chartData2h = sell2hData.slice();
                chartFullTimes = fullTimes.slice();
                
                log(`chartData24h.length: ${chartData24h.length}`, 'info');
                log(`chartData2h.length: ${chartData2h.length}`, 'info');
                log(`chartFullTimes.length: ${chartFullTimes.length}`, 'info');
                
                // Step 5: Compare arrays
                log('æ­¥éª¤ 5: å¯¹æ¯”æ•°ç»„...', 'info');
                const lastIndex = sell24hData.length - 1;
                const sell24hLast = sell24hData[lastIndex];
                const chartData24hLast = chartData24h[lastIndex];
                const isMatch = sell24hLast === chartData24hLast;
                
                log(`sell24hData[${lastIndex}]: ${sell24hLast}`, 'info');
                log(`chartData24h[${lastIndex}]: ${chartData24hLast}`, 'info');
                log(isMatch ? 'æ•°ç»„å€¼åŒ¹é… âœ…' : 'æ•°ç»„å€¼ä¸åŒ¹é… âŒ', isMatch ? 'success' : 'error');
                
                // Display comparison
                const arrayInfoDiv = document.getElementById('arrayInfo');
                arrayInfoDiv.style.display = 'block';
                arrayInfoDiv.className = 'section ' + (isMatch ? 'success' : 'error');
                
                document.getElementById('arrayContent').innerHTML = `
                    <div class="comparison">
                        <div class="comparison-box ${isMatch ? 'match' : 'mismatch'}">
                            <h3>sell24hData (series æ•°æ®)</h3>
                            <div class="bignum" style="color: #52c41a;">${sell24hLast}</div>
                            <p>ç´¢å¼•: ${lastIndex}</p>
                            <p>æ•°ç»„é•¿åº¦: ${sell24hData.length}</p>
                        </div>
                        <div class="comparison-box ${isMatch ? 'match' : 'mismatch'}">
                            <h3>chartData24h (tooltip æ•°æ®)</h3>
                            <div class="bignum" style="color: ${isMatch ? '#52c41a' : '#ff4d4f'};">${chartData24hLast}</div>
                            <p>ç´¢å¼•: ${lastIndex}</p>
                            <p>æ•°ç»„é•¿åº¦: ${chartData24h.length}</p>
                        </div>
                    </div>
                    ${!isMatch ? `
                        <div style="background: rgba(255, 77, 79, 0.2); padding: 15px; border-radius: 8px; margin-top: 20px;">
                            <strong>âŒ æ£€æµ‹åˆ°é—®é¢˜ï¼</strong><br>
                            å·®å¼‚: ${Math.abs(sell24hLast - chartData24hLast)} æ¬¡
                        </div>
                    ` : `
                        <div style="background: rgba(82, 196, 26, 0.2); padding: 15px; border-radius: 8px; margin-top: 20px;">
                            <strong>âœ… æ•°æ®ä¸€è‡´ï¼</strong><br>
                            Tooltip åº”è¯¥æ˜¾ç¤ºæ­£ç¡®çš„å€¼
                        </div>
                    `}
                `;
                
                // Step 6: Render chart
                log('æ­¥éª¤ 6: æ¸²æŸ“æµ‹è¯•å›¾è¡¨...', 'info');
                await renderChart();
                
                // Step 7: Test tooltip
                log('æ­¥éª¤ 7: Tooltip æµ‹è¯•...', 'info');
                const tooltipTestDiv = document.getElementById('tooltipTest');
                tooltipTestDiv.style.display = 'block';
                tooltipTestDiv.className = 'section ' + (isMatch ? 'success' : 'error');
                
                document.getElementById('tooltipContent').innerHTML = `
                    <div class="comparison">
                        <div class="comparison-box match">
                            <h3>âœ… é¢„æœŸæ˜¾ç¤ºå€¼</h3>
                            <div class="bignum" style="color: #52c41a;">${sell24hLast}</div>
                            <p>æ¥æº: sell24hData[${lastIndex}]</p>
                        </div>
                        <div class="comparison-box ${isMatch ? 'match' : 'mismatch'}">
                            <h3>${isMatch ? 'âœ…' : 'âŒ'} Tooltip å®é™…å€¼</h3>
                            <div class="bignum" style="color: ${isMatch ? '#52c41a' : '#ff4d4f'};">${chartData24hLast}</div>
                            <p>æ¥æº: chartData24h[${lastIndex}]</p>
                        </div>
                    </div>
                    <div style="background: rgba(24, 144, 255, 0.2); padding: 20px; border-radius: 8px; margin-top: 20px;">
                        <h3 style="margin-bottom: 15px;">ğŸ“ éªŒè¯æ­¥éª¤</h3>
                        <ol style="line-height: 2.5; margin-left: 20px;">
                            <li>åœ¨ä¸‹æ–¹å›¾è¡¨ä¸­ï¼Œå°†é¼ æ ‡æ‚¬åœåœ¨<strong>æœ€å³ä¾§</strong>ï¼ˆæœ€åä¸€ä¸ªæ•°æ®ç‚¹ï¼‰</li>
                            <li>æŸ¥çœ‹ Tooltip æ˜¾ç¤ºçš„ "24hé€ƒé¡¶" æ•°å€¼</li>
                            <li>è¯¥å€¼åº”è¯¥æ˜¯ <span class="highlight">${sell24hLast} æ¬¡</span></li>
                            <li>åŒæ—¶æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å° (F12) çš„æ—¥å¿—è¾“å‡º</li>
                        </ol>
                    </div>
                `;
                
                log('âœ… æµ‹è¯•å®Œæˆï¼è¯·æ‚¬åœå›¾è¡¨æœ€å³ä¾§éªŒè¯ Tooltip', 'success');
                
            } catch (error) {
                log(`âŒ é”™è¯¯: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function renderChart() {
            document.getElementById('chartContainer').style.display = 'block';
            
            if (!chart) {
                chart = echarts.init(document.getElementById('testChart'));
            }
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    formatter: function(params) {
                        if (!params || params.length === 0) return '';
                        const dataIndex = params[0].dataIndex;
                        const fullTime = chartFullTimes[dataIndex];
                        const actual24h = chartData24h[dataIndex];
                        const actual2h = chartData2h[dataIndex];
                        
                        // Log to console for verification
                        console.log('ğŸ¯ Tooltip è§¦å‘:');
                        console.log('  dataIndex:', dataIndex);
                        console.log('  fullTime:', fullTime);
                        console.log('  actual24h:', actual24h);
                        console.log('  actual2h:', actual2h);
                        console.log('  chartData24h.length:', chartData24h.length);
                        console.log('  sell24hData.length:', sell24hData.length);
                        console.log('  chartData24h[dataIndex] === sell24hData[dataIndex]:', actual24h === sell24hData[dataIndex]);
                        
                        log(`Tooltip: ç´¢å¼•${dataIndex}, 24h=${actual24h}æ¬¡, 2h=${actual2h}æ¬¡`, 'info');
                        
                        let result = `<div style="font-weight: bold; margin-bottom: 8px;">ğŸ“… ${fullTime}</div>`;
                        result += `<div style="margin: 4px 0; color: #faad14;">
                            ğŸ› è°ƒè¯•: ç´¢å¼•${dataIndex}/${chartData24h.length - 1}
                        </div>`;
                        result += `<div style="margin: 4px 0;">
                            <span style="display:inline-block;width:10px;height:10px;background:#ff4d4f;border-radius:50%;margin-right:5px;"></span>
                            24hé€ƒé¡¶: <strong>${actual24h}</strong> æ¬¡
                        </div>`;
                        result += `<div style="margin: 4px 0;">
                            <span style="display:inline-block;width:10px;height:10px;background:#faad14;border-radius:50%;margin-right:5px;"></span>
                            2hé€ƒé¡¶: <strong>${actual2h}</strong> æ¬¡
                        </div>`;
                        return result;
                    }
                },
                legend: {
                    data: ['24hé€ƒé¡¶', '2hé€ƒé¡¶'],
                    textStyle: { color: '#fff' },
                    top: 10
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: fullTimes.map(t => t.split(' ')[1]),
                    axisLabel: { 
                        color: '#a0a0a0',
                        rotate: 45,
                        interval: Math.floor(fullTimes.length / 20)
                    },
                    axisLine: { lineStyle: { color: '#444' } }
                },
                yAxis: {
                    type: 'value',
                    name: 'ä¿¡å·æ•°é‡',
                    nameTextStyle: { color: '#a0a0a0' },
                    axisLabel: { color: '#a0a0a0' },
                    axisLine: { lineStyle: { color: '#444' } },
                    splitLine: { lineStyle: { color: '#2d2d44' } }
                },
                series: [
                    {
                        name: '24hé€ƒé¡¶',
                        type: 'line',
                        data: sell24hData,
                        itemStyle: { color: '#ff4d4f' },
                        areaStyle: { color: 'rgba(255, 77, 79, 0.2)' },
                        smooth: true
                    },
                    {
                        name: '2hé€ƒé¡¶',
                        type: 'line',
                        data: sell2hData,
                        itemStyle: { color: '#faad14' },
                        areaStyle: { color: 'rgba(250, 173, 20, 0.2)' },
                        smooth: true
                    }
                ]
            };
            
            chart.setOption(option);
            log('å›¾è¡¨æ¸²æŸ“å®Œæˆ', 'success');
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å¼€å§‹æµ‹è¯•', 'info');
        });
    </script>
</body>
</html>
