# OKX每日利润分析功能说明

**开发时间**: 2026-02-08 15:30  
**开发者**: GenSpark AI Developer  
**版本**: v1.0  
**状态**: ✅ 已部署

---

## 📋 功能概述

根据用户提供的OKX资金账单截图，开发了**每日利润分析页面**，用于：
- 📊 **可视化每日利润趋势** - 通过图表展示每天的盈亏情况
- 💰 **统计转账记录** - 分析每天的转出/转入金额
- 📈 **累计利润曲线** - 展示利润累积趋势
- 📋 **详细操作记录** - 列出每日的交易次数和收益明细

---

## 🎯 核心功能

### 1. 📊 统计卡片

展示6个关键指标：

| 指标 | 说明 |
|------|------|
| 📈 累计利润 | 所选时间范围内的总利润 |
| 📅 平均每日利润 | 平均每天的收益 |
| 🎯 最高单日利润 | 收益最好的一天及日期 |
| ⚠️ 最低单日利润 | 收益最差的一天及日期 |
| 📊 交易天数 | 有资金变动的天数 |
| 💰 转出总额 | 所有转出的累计金额 |

### 2. 📈 每日利润趋势图

**柱状图** + **折线图**组合：
- **柱状图**: 显示每日利润
  - 🟢 绿色：盈利
  - 🔴 红色：亏损
- **折线图**: 显示累计利润曲线
  - 📈 渐变填充，趋势一目了然

### 3. 💸 转账分布分析图

**堆叠柱状图**：
- 🔴 红色：每日转出金额
- 🟢 绿色：每日转入金额
- 直观对比每天的资金流向

### 4. 📋 每日详细记录表

表格展示：
- **日期**: YYYY-MM-DD
- **转出金额**: 负数（红色）
- **转入金额**: 正数（绿色）
- **当日利润**: 转出 + 转入
- **累计利润**: 从起始日到当天的总利润
- **交易次数**: 当天的转账次数

### 5. 🎛️ 筛选功能

- **账户选择**: 支持多账户切换
- **日期范围**: 
  - 最近7天
  - 最近30天（默认）
  - 最近90天
  - 全部
- **自定义日期**: 选择开始日期和结束日期

---

## 🔧 技术实现

### 前端页面

**文件**: `templates/okx_profit_analysis.html`

**技术栈**:
- HTML5 + CSS3
- JavaScript (原生)
- ECharts 5.4.3 (图表库)

**特点**:
- 响应式设计
- 渐变背景
- 毛玻璃效果（backdrop-filter）
- 交互式图表
- 流畅动画

### 后端API

**端点**: `POST /api/okx-trading/profit-analysis`

**请求参数**:
```json
{
  "apiKey": "OKX API Key",
  "apiSecret": "OKX API Secret",
  "passphrase": "OKX Passphrase",
  "dateRange": "30",  // 7, 30, 90, all
  // 或使用自定义日期
  "startDate": "2026-01-01",
  "endDate": "2026-02-08"
}
```

**响应数据**:
```json
{
  "success": true,
  "data": {
    "dailyData": [
      {
        "date": "2026-02-08",
        "withdraw": -15.4,  // 转出（负数）
        "deposit": 0,       // 转入（正数）
        "profit": -15.4,    // 当日利润
        "cumulativeProfit": 120.5,  // 累计利润
        "transactionCount": 1  // 交易次数
      }
      // ...更多日期
    ],
    "stats": {
      "totalProfit": 120.5,
      "avgDailyProfit": 4.02,
      "maxDailyProfit": 38.0,
      "maxDailyDate": "2026-02-06",
      "minDailyProfit": -38.0,
      "minDailyDate": "2026-02-06",
      "tradingDays": 30,
      "totalWithdraw": -500.0,
      "totalDeposit": 620.5
    }
  }
}
```

**数据来源**: OKX官方API - 资金账单接口
- 接口: `/api/v5/asset/bills`
- 类型: type=1 (转账类型)
- 时间: 根据用户选择的日期范围

### 路由配置

**文件**: `app.py`

新增路由：
1. `GET /okx-profit-analysis` - 页面路由
2. `POST /api/okx-trading/profit-analysis` - 数据API

---

## 📊 数据分析逻辑

### 1. 数据获取

从OKX API获取资金账单（转账记录）：
```python
# 调用 OKX /api/v5/asset/bills API
# type=1 表示转账类型（包括转出至主账户、从交易账户转入等）
```

### 2. 按日期分组

将所有转账记录按日期分组：
```python
daily_stats = {
    '2026-02-08': {
        'withdraw': -15.4,  # 转出总和
        'deposit': 0,       # 转入总和
        'count': 1          # 交易次数
    }
}
```

### 3. 计算利润

**当日利润** = 转出金额 + 转入金额

例如：
- 转出 -15.4 USDT
- 转入 0 USDT
- **当日利润 = -15.4 + 0 = -15.4 USDT**

### 4. 累计利润

从第一天开始累加：
```python
cumulative_profit = 0
for day in sorted_days:
    cumulative_profit += day.profit
    day.cumulativeProfit = cumulative_profit
```

---

## 🎨 界面设计

### 配色方案

- **背景**: 紫色渐变 (#667eea → #764ba2)
- **卡片**: 白色半透明 + 毛玻璃
- **盈利**: 绿色 (#10b981)
- **亏损**: 红色 (#ef4444)
- **主色**: 紫色 (#667eea)

### 布局结构

```
┌─────────────────────────────────────────┐
│  📊 每日利润分析     [返回] [利润分析] [刷新]  │
├─────────────────────────────────────────┤
│  [账户选择]  [日期范围]  [自定义日期]         │
├─────────────────────────────────────────┤
│  ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ │
│  │累计│ │平均│ │最高│ │最低│ │交易│ │转出│ │
│  │利润│ │利润│ │利润│ │利润│ │天数│ │总额│ │
│  └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ │
├─────────────────────────────────────────┤
│  📈 每日利润趋势                          │
│  ┌───────────────────────────────────┐   │
│  │ [柱状图 + 折线图]                   │   │
│  └───────────────────────────────────┘   │
├─────────────────────────────────────────┤
│  💸 转账分布分析                          │
│  ┌───────────────────────────────────┐   │
│  │ [堆叠柱状图]                        │   │
│  └───────────────────────────────────┘   │
├─────────────────────────────────────────┤
│  📋 每日详细记录                          │
│  ┌───────────────────────────────────┐   │
│  │ [数据表格]                          │   │
│  └───────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

---

## 🚀 使用方法

### 1. 访问页面

**方式一**: 直接访问
```
https://5000-idfgz76cf9poiqtgzfhan-c81df28e.sandbox.novita.ai/okx-profit-analysis
```

**方式二**: 从OKX交易页面跳转
1. 打开OKX交易页面
2. 点击页头的 **📊 利润分析** 按钮

### 2. 选择账户

在页面顶部的"账户"下拉框中选择要分析的账户（需要在OKX交易页面先配置账户）

### 3. 选择日期范围

- **预设范围**: 最近7天 / 30天 / 90天 / 全部
- **自定义日期**: 选择开始日期和结束日期，点击"查询"

### 4. 查看数据

页面会自动加载并展示：
- 统计卡片
- 利润趋势图
- 转账分布图
- 详细记录表

### 5. 刷新数据

点击页头的 **🔄 刷新** 按钮重新获取最新数据

---

## 📊 数据示例

### 示例场景

根据您提供的截图（2026年2月的资金账单）：

**日期**: 2026-02-08
- 转出至主账户: -15.4 USDT
- 从交易账户转入: +15.4 USDT
- **当日利润**: 0 USDT（平账）

**日期**: 2026-02-07
- 转出至主账户: -8.97 USDT
- 从交易账户转入: +8.97 USDT
- **当日利润**: 0 USDT（平账）

**日期**: 2026-02-06
- 转出至交易账户: -38 USDT
- 从主账户转入: +38 USDT
- 转出至主账户: -5.67 USDT
- 从交易账户转入: +5.67 USDT
- **当日利润**: 0 USDT（多次平账）

### 分析结果（假设30天）

```
📈 累计利润: +120.50 USDT
📅 平均每日利润: +4.02 USDT
🎯 最高单日利润: +38.00 USDT (2026-02-06)
⚠️ 最低单日利润: -15.40 USDT (2026-02-08)
📊 交易天数: 30 天
💰 转出总额: 500.00 USDT
```

---

## 🎯 实际应用场景

### 1. 每日盈亏分析

- 查看哪些天赚钱，哪些天亏钱
- 分析盈亏原因，优化交易策略

### 2. 累计收益追踪

- 观察累计利润曲线的走势
- 判断整体盈利能力

### 3. 资金流向监控

- 监控每天的转出/转入金额
- 发现异常资金变动

### 4. 交易频率分析

- 统计每天的交易次数
- 优化交易频率

### 5. 历史回测

- 选择不同日期范围
- 对比不同时期的收益表现

---

## ⚠️ 注意事项

### 1. API限制

- OKX API最多查询90天的历史数据
- 每次请求最多返回100条记录
- 如需更长时间范围，需要分页查询（当前版本暂不支持）

### 2. 数据准确性

- 数据来源于OKX官方API，准确可靠
- **仅统计"转账"类型**的资金变动（type=1）
- 不包括交易手续费、利息等其他类型

### 3. 时区问题

- 所有时间均为OKX服务器时间
- 日期按UTC+0时间分组
- 可能与您的本地时间有差异

### 4. 账户配置

- 需要先在OKX交易页面配置账户
- 账户API权限必须包括"查看资金账单"
- 不同账户之间数据独立统计

---

## 🔍 故障排查

### 问题1: 页面显示"暂无数据"

**原因**: 
- 账户未配置
- 选择的日期范围内无资金变动
- API权限不足

**解决**: 
1. 在OKX交易页面配置账户
2. 检查API权限设置
3. 选择有交易的日期范围

### 问题2: 数据加载失败

**原因**: 
- 网络问题
- API凭证错误
- OKX服务器异常

**解决**: 
1. 检查网络连接
2. 重新配置API凭证
3. 稍后重试

### 问题3: 统计数据不准确

**原因**: 
- 数据仅统计转账类型
- 时区差异
- API返回数据有限

**解决**: 
1. 确认理解"转账"的定义
2. 调整日期范围
3. 对比OKX官方账单

---

## 📈 后续优化

### 计划功能

- [ ] 支持分页查询（查询超过100条记录）
- [ ] 导出Excel报表
- [ ] 多账户对比分析
- [ ] 盈亏比率分析
- [ ] 月度/年度汇总报告
- [ ] 自定义统计维度
- [ ] 邮件定时报告

---

## 📝 相关文件

| 文件 | 说明 |
|------|------|
| `templates/okx_profit_analysis.html` | 利润分析页面 |
| `templates/okx_trading.html` | OKX交易页面（添加入口按钮） |
| `app.py` | 后端API实现 |

---

## 📱 访问信息

**页面地址**: https://5000-idfgz76cf9poiqtgzfhan-c81df28e.sandbox.novita.ai/okx-profit-analysis

**入口**:
1. 直接访问上述URL
2. OKX交易页面 → 点击 **📊 利润分析** 按钮

---

## 🎓 使用技巧

### 1. 快速查看近期表现

- 选择"最近7天"或"最近30天"
- 关注累计利润的趋势

### 2. 寻找最佳交易日

- 查看"最高单日利润"卡片
- 分析当天的操作记录

### 3. 风险控制

- 关注"最低单日利润"
- 分析亏损原因，避免重复

### 4. 对比不同时期

- 使用自定义日期功能
- 对比不同月份的收益

### 5. 监控转账频率

- 查看"交易次数"列
- 优化资金使用效率

---

## 📞 技术支持

如遇问题：
1. 查看浏览器控制台（F12 → Console）
2. 查看Flask日志（`pm2 logs flask-app`）
3. 检查API响应（F12 → Network）
4. 确认账户配置正确

---

## 📊 Git提交

```
commit 5bf92c4
feat: add daily profit analysis page with charts

- Create /okx-profit-analysis page with profit trend visualization
- Add API /api/okx-trading/profit-analysis to fetch OKX fund bills
- Display daily profit curve, cumulative profit, and transaction distribution
- Show statistics: total profit, avg daily profit, max/min profit days
- Add profit analysis button in OKX trading page header
- Support custom date range and account selection
- Use ECharts for interactive charts
```

---

**🎉 每日利润分析功能已上线！现在可以清晰地看到每天的操作和收益情况了！**
