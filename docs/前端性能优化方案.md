# å‰ç«¯æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ - å‡å°‘æµè§ˆå™¨å¡é¡¿

## ğŸ” é—®é¢˜åˆ†æ

é€šè¿‡ä»£ç å®¡æŸ¥ï¼Œå‘ç°ä»¥ä¸‹ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼š

### 1. **é«˜é¢‘å®šæ—¶å™¨é—®é¢˜** ğŸ”´

| é¡µé¢ | å®šæ—¶å™¨æ•°é‡ | æœ€é«˜é¢‘ç‡ | é—®é¢˜ä¸¥é‡ç¨‹åº¦ |
|------|-----------|---------|-------------|
| `control_center.html` | **7ä¸ª** | **500ms** | ğŸ”´ ä¸¥é‡ |
| `control_center_new.html` | **7ä¸ª** | **500ms** | ğŸ”´ ä¸¥é‡ |
| `anchor_system_real.html` | **8ä¸ª** | 15ç§’ | ğŸŸ¡ ä¸­ç­‰ |
| `okx_trading.html` | 2ä¸ª | 30ç§’ | ğŸŸ¢ è½»å¾® |
| `price_position_unified.html` | 2ä¸ª | 60ç§’ | ğŸŸ¢ è½»å¾® |

### 2. **æœ€ä¸¥é‡çš„æ€§èƒ½æ€æ‰‹** âš ï¸

#### `control_center.html` å’Œ `control_center_new.html`

```javascript
// âŒ æ¯ 500ms (0.5ç§’) æ›´æ–°ä¸€æ¬¡ä»·æ ¼ - æåº¦è€—è´¹èµ„æºï¼
setInterval(updateRealtimePrice, 500);

// âŒ æ¯ 2ç§’ æ›´æ–°ä¸€æ¬¡æ•°æ®
setInterval(updateData, 2000);

// âŒ æ¯ 5åˆ†é’Ÿ æ›´æ–°SARæ•°æ®
setInterval(updateSarData, 300000);

// âŒ æ¯ç§’ç›‘æ§å†…å­˜
setInterval(() => {
    const used = performance.memory.usedJSHeapSize / 1048576;
    const total = performance.memory.totalJSHeapSize / 1048576;
    // ... å¤æ‚è®¡ç®—
}, 1000);

// âŒ æ¯ 10ç§’ è‡ªåŠ¨æ¸…ç†å†…å­˜
setInterval(() => {
    // å¼ºåˆ¶åƒåœ¾å›æ”¶
}, 10000);
```

**é—®é¢˜ä¸¥é‡æ€§**ï¼š
- æ¯ 0.5ç§’ è¯·æ±‚ API å¹¶æ›´æ–°DOMï¼ˆæ¯å°æ—¶ 7200æ¬¡ï¼ï¼‰
- æ¯ 2ç§’ è¿›è¡Œå¤§é‡æ•°æ®å¤„ç†ï¼ˆæ¯å°æ—¶ 1800æ¬¡ï¼‰
- æŒç»­çš„å†…å­˜ç›‘æ§å’Œ DOM æ“ä½œå¯¼è‡´æµè§ˆå™¨å¡é¡¿

---

## ğŸ› ï¸ ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå»¶é•¿åˆ·æ–°é—´éš” â±ï¸

#### ä¿®æ”¹ `control_center.html` å’Œ `control_center_new.html`

```javascript
// âœ… å°†ä»·æ ¼æ›´æ–°ä» 0.5ç§’ æ”¹ä¸º 5ç§’
priceUpdateInterval = setInterval(updateRealtimePrice, 5000); // åŸæ¥ 500ms

// âœ… å°†æ•°æ®æ›´æ–°ä» 2ç§’ æ”¹ä¸º 10ç§’
updateInterval = setInterval(updateData, 10000); // åŸæ¥ 2000ms

// âœ… ç¦ç”¨å†…å­˜ç›‘æ§ï¼ˆæ”¹ä¸ºæŒ‰éœ€è§¦å‘ï¼‰
// memoryMonitorInterval = setInterval(...) // æ³¨é‡Šæ‰

// âœ… ç¦ç”¨è‡ªåŠ¨å†…å­˜æ¸…ç†ï¼ˆæ”¹ä¸ºæ‰‹åŠ¨è§¦å‘ï¼‰
// autoMemoryClearInterval = setInterval(...) // æ³¨é‡Šæ‰
```

**æ€§èƒ½æå‡**ï¼š
- ä»·æ ¼æ›´æ–°ï¼šä»æ¯å°æ—¶ 7200æ¬¡ é™è‡³ 720æ¬¡ï¼ˆ**é™ä½90%**ï¼‰
- æ•°æ®æ›´æ–°ï¼šä»æ¯å°æ—¶ 1800æ¬¡ é™è‡³ 360æ¬¡ï¼ˆ**é™ä½80%**ï¼‰
- å†…å­˜ç›‘æ§ï¼šå®Œå…¨ç§»é™¤ï¼ˆ**é™ä½100%**ï¼‰

---

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨ WebSocket æ›¿ä»£è½®è¯¢ ğŸŒ

#### åˆ›å»ºåç«¯ WebSocket æœåŠ¡

```python
# app.py
from flask_socketio import SocketIO, emit
import eventlet

socketio = SocketIO(app, cors_allowed_origins="*", async_mode='eventlet')

@socketio.on('connect')
def handle_connect():
    print('å®¢æˆ·ç«¯å·²è¿æ¥')

@socketio.on('subscribe_price')
def handle_subscribe(data):
    """è®¢é˜…å®æ—¶ä»·æ ¼"""
    symbol = data.get('symbol', 'BTC-USDT-SWAP')
    # å¯åŠ¨åå°ä»»åŠ¡ï¼Œæ¯5ç§’æ¨é€ä¸€æ¬¡ä»·æ ¼
    def background_task():
        while True:
            price_data = get_realtime_price(symbol)
            emit('price_update', price_data)
            eventlet.sleep(5)
    
    eventlet.spawn(background_task)

def get_realtime_price(symbol):
    """ä»OKXè·å–å®æ—¶ä»·æ ¼"""
    response = requests.get(f'https://www.okx.com/api/v5/market/ticker?instId={symbol}')
    return response.json()
```

#### å‰ç«¯ä¿®æ”¹

```javascript
// âœ… ä½¿ç”¨ WebSocket æ›¿ä»£ setInterval
const socket = io('http://localhost:9002');

socket.on('connect', () => {
    console.log('WebSocket å·²è¿æ¥');
    socket.emit('subscribe_price', { symbol: 'BTC-USDT-SWAP' });
});

socket.on('price_update', (data) => {
    // è¢«åŠ¨æ¥æ”¶ä»·æ ¼æ›´æ–°ï¼Œè€Œä¸æ˜¯ä¸»åŠ¨è½®è¯¢
    updatePriceDisplay(data);
});

// âŒ åˆ é™¤é«˜é¢‘å®šæ—¶å™¨
// setInterval(updateRealtimePrice, 500); // ä¸å†éœ€è¦
```

**ä¼˜åŠ¿**ï¼š
- æœåŠ¡å™¨ä¸»åŠ¨æ¨é€ï¼Œå‰ç«¯è¢«åŠ¨æ¥æ”¶
- å‡å°‘å‰ç«¯è®¡ç®—è´Ÿæ‹…
- å®æ—¶æ€§æ›´å¥½ï¼Œå»¶è¿Ÿæ›´ä½

---

### æ–¹æ¡ˆ3ï¼šæ•°æ®é¢„è®¡ç®— + ç¼“å­˜ ğŸ’¾

#### åç«¯é¢„è®¡ç®—

```python
# æ–°å¢APIï¼š/api/control-center/realtime-data
@app.route('/api/control-center/realtime-data', methods=['GET'])
def get_control_center_data():
    """
    åç«¯é¢„å…ˆè®¡ç®—å¥½æ‰€æœ‰éœ€è¦çš„æ•°æ®
    å‰ç«¯åªè´Ÿè´£æ¸²æŸ“ï¼Œä¸åšä»»ä½•è®¡ç®—
    """
    # 1. è·å–ä»·æ ¼æ•°æ®
    price_data = get_okx_price()
    
    # 2. è®¡ç®—æ¶¨è·Œå¹…
    change_data = calculate_change_percent(price_data)
    
    # 3. è®¡ç®—SARæ•°æ®
    sar_data = calculate_sar_data()
    
    # 4. è®¡ç®—å†…å­˜ä½¿ç”¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
    memory_data = get_server_memory()
    
    # 5. ç»„è£…æ‰€æœ‰æ•°æ®
    return jsonify({
        'success': True,
        'timestamp': time.time(),
        'price': price_data,
        'change': change_data,
        'sar': sar_data,
        'memory': memory_data
    })
```

#### å‰ç«¯ä¿®æ”¹

```javascript
// âœ… åªè´Ÿè´£è·å–å’Œæ˜¾ç¤ºï¼Œä¸åšè®¡ç®—
async function updateData() {
    const response = await fetch('/api/control-center/realtime-data');
    const data = await response.json();
    
    // ç›´æ¥æ¸²æŸ“ï¼Œä¸åšä»»ä½•è®¡ç®—
    document.getElementById('price').textContent = data.price.value;
    document.getElementById('change').textContent = data.change.percent;
    // ...
}

// âœ… é™ä½åˆ·æ–°é¢‘ç‡åˆ° 30ç§’
setInterval(updateData, 30000);
```

---

### æ–¹æ¡ˆ4ï¼šè™šæ‹Ÿæ»šåŠ¨ + åˆ†é¡µåŠ è½½ ğŸ“„

å¯¹äºå¤§é‡æ•°æ®çš„åˆ—è¡¨ï¼ˆå¦‚æŒä»“åˆ—è¡¨ã€æ—¥å¿—åˆ—è¡¨ï¼‰ï¼Œä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼š

```javascript
// âœ… åªæ¸²æŸ“å¯è§åŒºåŸŸçš„æ•°æ®
function renderVisibleItems() {
    const container = document.getElementById('positionsList');
    const scrollTop = container.scrollTop;
    const itemHeight = 60; // æ¯è¡Œé«˜åº¦
    const visibleCount = Math.ceil(container.clientHeight / itemHeight);
    const startIndex = Math.floor(scrollTop / itemHeight);
    const endIndex = startIndex + visibleCount;
    
    // åªæ¸²æŸ“å¯è§çš„æ•°æ®
    const visibleData = allData.slice(startIndex, endIndex);
    container.innerHTML = renderItems(visibleData);
}

// ç›‘å¬æ»šåŠ¨äº‹ä»¶
document.getElementById('positionsList').addEventListener('scroll', renderVisibleItems);
```

---

## ğŸ“‹ ä¼˜åŒ–ä¼˜å…ˆçº§

### ğŸ”´ ç´§æ€¥ï¼ˆç«‹å³ä¼˜åŒ–ï¼‰

1. **`control_center.html` å’Œ `control_center_new.html`**
   - å°†ä»·æ ¼æ›´æ–°ä» 500ms æ”¹ä¸º 5000msï¼ˆé™ä½90%ï¼‰
   - å°†æ•°æ®æ›´æ–°ä» 2000ms æ”¹ä¸º 10000msï¼ˆé™ä½80%ï¼‰
   - ç¦ç”¨å†…å­˜ç›‘æ§å’Œè‡ªåŠ¨æ¸…ç†

### ğŸŸ¡ é‡è¦ï¼ˆè¿‘æœŸä¼˜åŒ–ï¼‰

2. **`anchor_system_real.html`**
   - åˆå¹¶å¤šä¸ªå®šæ—¶å™¨ä¸ºä¸€ä¸ªç»Ÿä¸€çš„åˆ·æ–°ä»»åŠ¡
   - å‡å°‘é‡å¤çš„æ•°æ®è¯·æ±‚

3. **æ‰€æœ‰é¡µé¢**
   - ç»Ÿä¸€å°†åˆ·æ–°é—´éš”å»¶é•¿åˆ°è‡³å°‘ 30ç§’
   - é¿å…å¤šä¸ªå®šæ—¶å™¨åŒæ—¶è¿è¡Œ

### ğŸŸ¢ å¯é€‰ï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰

4. **å¼•å…¥ WebSocket**
   - å®æ—¶ä»·æ ¼æ¨é€
   - äº¤æ˜“ä¿¡å·æ¨é€
   - æŒä»“å˜åŒ–æ¨é€

5. **æ•°æ®é¢„è®¡ç®—**
   - åç«¯è®¡ç®—å¥½æ‰€æœ‰å¤æ‚æ•°æ®
   - å‰ç«¯åªè´Ÿè´£æ¸²æŸ“

---

## ğŸ”§ ç«‹å³å¯æ‰§è¡Œçš„ä¼˜åŒ–

### ä¼˜åŒ– `control_center.html`

```bash
# 1. å¤‡ä»½åŸæ–‡ä»¶
cp templates/control_center.html templates/control_center.html.backup

# 2. ä¿®æ”¹å®šæ—¶å™¨é—´éš”
sed -i 's/setInterval(updateRealtimePrice, 500)/setInterval(updateRealtimePrice, 5000)/g' templates/control_center.html
sed -i 's/setInterval(updateData, 2000)/setInterval(updateData, 10000)/g' templates/control_center.html

# 3. æ³¨é‡Šæ‰å†…å­˜ç›‘æ§
# æ‰‹åŠ¨ç¼–è¾‘ï¼Œæ³¨é‡Šæ‰ memoryMonitorInterval å’Œ autoMemoryClearInterval
```

### ä¼˜åŒ– `control_center_new.html`

```bash
# åŒæ ·çš„æ­¥éª¤
cp templates/control_center_new.html templates/control_center_new.html.backup
sed -i 's/setInterval(updateRealtimePrice, 500)/setInterval(updateRealtimePrice, 5000)/g' templates/control_center_new.html
sed -i 's/setInterval(updateData, 2000)/setInterval(updateData, 10000)/g' templates/control_center_new.html
```

---

## ğŸ“Š é¢„æœŸæ€§èƒ½æå‡

| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|--------|--------|--------|------|
| ä»·æ ¼æ›´æ–°é¢‘ç‡ | æ¯0.5ç§’ï¼ˆ7200æ¬¡/å°æ—¶ï¼‰ | æ¯5ç§’ï¼ˆ720æ¬¡/å°æ—¶ï¼‰ | **é™ä½90%** |
| æ•°æ®æ›´æ–°é¢‘ç‡ | æ¯2ç§’ï¼ˆ1800æ¬¡/å°æ—¶ï¼‰ | æ¯10ç§’ï¼ˆ360æ¬¡/å°æ—¶ï¼‰ | **é™ä½80%** |
| å†…å­˜ç›‘æ§ | æŒç»­è¿è¡Œ | ç¦ç”¨ | **é™ä½100%** |
| CPUä½¿ç”¨ç‡ | é¢„è®¡é™ä½ **60-80%** |
| æµè§ˆå™¨å“åº”é€Ÿåº¦ | é¢„è®¡æå‡ **3-5å€** |

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•æ­¥éª¤

1. **ä¼˜åŒ–å‰æµ‹è¯•**ï¼š
   - æ‰“å¼€Chromeå¼€å‘è€…å·¥å…· â†’ Performance
   - å½•åˆ¶30ç§’çš„æ€§èƒ½æ•°æ®
   - è®°å½•CPUä½¿ç”¨ç‡ã€å†…å­˜å ç”¨

2. **æ‰§è¡Œä¼˜åŒ–**ï¼š
   - ä¿®æ”¹å®šæ—¶å™¨é—´éš”
   - ç¦ç”¨å†…å­˜ç›‘æ§

3. **ä¼˜åŒ–åæµ‹è¯•**ï¼š
   - åŒæ ·å½•åˆ¶30ç§’æ€§èƒ½æ•°æ®
   - å¯¹æ¯”CPUå’Œå†…å­˜å˜åŒ–

4. **ç”¨æˆ·ä½“éªŒæµ‹è¯•**ï¼š
   - æµ‹è¯•é¡µé¢æµç•…åº¦
   - æµ‹è¯•å¤šæ ‡ç­¾é¡µåŒæ—¶æ‰“å¼€çš„æƒ…å†µ

---

## ğŸ“… å®æ–½è®¡åˆ’

### ç¬¬1é˜¶æ®µï¼ˆç«‹å³æ‰§è¡Œï¼‰- å»¶é•¿åˆ·æ–°é—´éš”
- [ ] ä¿®æ”¹ `control_center.html` å®šæ—¶å™¨
- [ ] ä¿®æ”¹ `control_center_new.html` å®šæ—¶å™¨
- [ ] æµ‹è¯•æ€§èƒ½æå‡

### ç¬¬2é˜¶æ®µï¼ˆæœ¬å‘¨å†…ï¼‰- åˆå¹¶å®šæ—¶å™¨
- [ ] åˆå¹¶ `anchor_system_real.html` çš„8ä¸ªå®šæ—¶å™¨
- [ ] ç»Ÿä¸€å…¶ä»–é¡µé¢çš„åˆ·æ–°é—´éš”ä¸º30ç§’

### ç¬¬3é˜¶æ®µï¼ˆä¸‹å‘¨ï¼‰- WebSocket
- [ ] å®ç°åç«¯ WebSocket æœåŠ¡
- [ ] è¿ç§»å®æ—¶ä»·æ ¼æ¨é€
- [ ] è¿ç§»äº¤æ˜“ä¿¡å·æ¨é€

### ç¬¬4é˜¶æ®µï¼ˆé•¿æœŸï¼‰- æ•°æ®é¢„è®¡ç®—
- [ ] åˆ›å»ºæ•°æ®é¢„è®¡ç®—API
- [ ] å‰ç«¯è¿ç§»åˆ°çº¯æ¸²æŸ“æ¨¡å¼

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [Flask-SocketIO æ–‡æ¡£](https://flask-socketio.readthedocs.io/)
- [Chrome Performance åˆ†æ](https://developer.chrome.com/docs/devtools/performance/)
- [è™šæ‹Ÿæ»šåŠ¨å®ç°](https://github.com/bvaughn/react-window)

---

## æ›´æ–°æ—¥å¿—

- **2026-02-15 10:10:00 UTC**ï¼šåˆæ¬¡åˆ›å»ºæ–‡æ¡£
  - è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
  - æå‡º4ç§ä¼˜åŒ–æ–¹æ¡ˆ
  - åˆ¶å®šå®æ–½è®¡åˆ’

