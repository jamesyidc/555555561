# 全时间段日内模式监控 v2.0 - 触发条件详解

## 版本更新

### v2.0 (2026-02-23)
- ✅ 情况1新增：红→黄→黄→绿模式
- ✅ 情况1触发条件细化：根据日线预测动态调整阈值
- ✅ 情况2触发条件明确：空白柱子做多
- ✅ 情况3触发条件细化：涨跌幅<-50 且 up_ratio<10%
- ✅ 情况4触发条件细化：up_ratio<10%时做多
- ✅ 大周期控制增强：小周期严格服从大周期

## 核心原则

### 小周期服从大周期
- **大周期做空系列**（等待新低/做空/诱多不参与/观望）→ **禁止所有做多信号**
- **大周期做多系列**（低吸/诱空试仓抄底）→ **禁止所有做空信号**

## 模式详解

### 情况1：诱多等待新低 [做空]

#### 颜色模式
1. **红→黄→绿**（3根）
2. **绿→黄→红**（3根）
3. **红→黄→黄→绿**（4根，新增）

#### 触发条件（v2.0新增）
根据当天的日线预测动态调整：

| 日线预测 | 中间柱up_ratio阈值 | 说明 |
|----------|-------------------|------|
| 等待新低 | > 65% | 最严格，需要更强的反弹信号 |
| 做空 | > 50% | 标准阈值 |
| 观望 | > 50% | 标准阈值 |
| 其他 | > 50% | 默认阈值 |

**举例 - 2月7日**：
```
日线预测: 等待新低
柱子序列: 红(40%) → 黄(68%) → 绿(58%)
           ↑
         触发点

判断: 中间柱68% > 65% ✅
结果: 触发"逢高做空"信号
```

**4根模式（新增）**：
```
柱子序列: 红(35%) → 黄(52%) → 黄(54%) → 绿(60%)
                     ↑
                   触发点

中间两根黄色柱平均值: (52% + 54%) / 2 = 53%
日线预测: 做空
判断: 53% > 50% ✅
结果: 触发"逢高做空"信号
```

#### 操作建议
- **信号**: 逢高做空
- **执行时机**: 检测到模式后，在中间柱（up_ratio满足条件）时做空
- **风险**: 反弹力量减弱，下跌概率高

---

### 情况2：诱空试仓抄底 [做多]

#### 颜色模式
**红 + 3空白**
```
红(35%) → 空白(0%) → 空白(0%) → 空白(0%)
           ↑
         触发点
```

#### 触发条件
1. **空白柱子占当天总数 ≤ 25%**
   ```python
   blank_count = sum(1 for bar in bars if bar['color'] == '空白')
   blank_ratio = blank_count / len(bars)
   
   if blank_ratio <= 0.25:
       # 允许触发
   ```

2. **在空白柱子时做多**
   - 不是检测到就立即做多
   - 而是在后续出现空白柱时做多

#### 操作建议
- **信号**: 开多单试仓
- **执行时机**: 在空白柱子（up_ratio=0%）时开仓
- **风险**: 试探性开仓，仓位控制在小额

**案例**：
```
当天共100根柱子，其中20根空白
空白占比: 20/100 = 20% ≤ 25% ✅

11:00 红(38%)
11:10 空白(0%) ← 做多
11:20 空白(0%) ← 做多
11:30 空白(0%) ← 做多
```

---

### 情况3：筑底信号 [做多]

#### 颜色模式
**黄→绿→黄**（3根）
```
黄(48%) → 绿(58%) → 黄(52%)
           ↑
         触发点
```

#### 触发条件（v2.0细化）
**必须同时满足两个条件**：

1. **涨跌幅总和 < -50**
   ```python
   total_change = get_current_total_change()
   if total_change < -50:  # 总跌幅超过50%
       # 满足条件1
   ```

2. **触发后中间柱up_ratio < 10%**
   ```python
   middle_bar = bars[i+1]
   if middle_bar['up_ratio'] < 10:
       # 满足条件2，可以做多
   ```

#### 操作建议
- **信号**: 逢低做多
- **执行时机**: 总跌幅够深（<-50）且中间柱上涨占比很低（<10%）时做多
- **风险**: 深度超跌后的反弹机会

**案例**：
```
当前总涨跌幅: -65% ✅ (满足<-50)

柱子序列:
12:00 黄(47%)
12:10 绿(8%)  ← 8% < 10% ✅ 做多
12:20 黄(51%)

结果: 触发"逢低做多"信号
```

**反例（不触发）**：
```
场景1: 总涨跌幅 = -30% ❌ (不满足<-50)
       即使有黄→绿→黄模式，也不触发

场景2: 总涨跌幅 = -60% ✅
       中间柱up_ratio = 25% ❌ (不满足<10%)
       不触发做多信号
```

---

### 情况4：诱空信号 [做多]

#### 颜色模式
1. **绿→红→红→绿**（4根）
2. **绿→红→绿**（3根）

#### 触发条件（v2.0细化）
**触发后中间柱up_ratio < 10%时做多**

**4根模式**：
```
绿(60%) → 红(8%) → 红(5%) → 绿(58%)
           ↑
         触发点

中间两根红柱平均值: (8% + 5%) / 2 = 6.5%
判断: 6.5% < 10% ✅
结果: 触发"逢低可以做多"信号
```

**3根模式**：
```
绿(62%) → 红(7%) → 绿(59%)
           ↑
         触发点

中间柱: 7%
判断: 7% < 10% ✅
结果: 触发"逢低可以做多"信号
```

#### 操作建议
- **信号**: 逢低可以做多
- **执行时机**: 中间柱上涨占比很低（<10%）时做多
- **风险**: V型反转机会，但需要快速反应

---

## 颜色定义

| 颜色 | up_ratio范围 | 含义 |
|------|-------------|------|
| 绿色 | > 55% | 上涨占比高，多头强势 |
| 黄色 | 45% - 55% | 多空均衡 |
| 红色 | < 45% | 下跌占比高，空头强势 |
| 空白 | = 0% | 无涨跌数据 |

## 大周期控制逻辑

### 做空系列（禁止做多）
```python
short_signals = ['等待新低', '做空', '诱多不参与', '观望']

if any(s in daily_signal for s in short_signals):
    if pattern_signal_type == 'long':
        # ❌ 阻止：情况2、情况3、情况4
        return False, f"大周期{daily_signal}禁止做多"
```

### 做多系列（禁止做空）
```python
long_signals = ['低吸', '诱空试仓抄底']

if any(s in daily_signal for s in long_signals):
    if pattern_signal_type == 'short':
        # ❌ 阻止：情况1
        return False, f"大周期{daily_signal}禁止做空"
```

## 监控配置

### 时间设置
```python
MONITOR_START_HOUR = 2   # 2:00 开始
MONITOR_END_HOUR = 23    # 23:59 结束
CHECK_INTERVAL = 600     # 每10分钟检查一次
```

### 阈值配置
```python
BLANK_RATIO_THRESHOLD = 0.25  # 空白占比≤25%

# 情况1动态阈值
get_pattern1_threshold(daily_prediction):
    if '等待新低' in signal: return 65
    elif '做空' or '观望' in signal: return 50
    else: return 50

# 情况3和情况4固定阈值
PATTERN3_UP_RATIO_MAX = 10   # 情况3: < 10%
PATTERN3_TOTAL_CHANGE_MAX = -50  # 情况3: < -50
PATTERN4_UP_RATIO_MAX = 10   # 情况4: < 10%
```

## API数据源

### 1. 获取日线预测
```bash
GET /api/coin-change-tracker/daily-prediction
```

### 2. 获取当前总涨跌幅
```bash
GET /api/coin-change-tracker/latest
```

### 3. 获取10分钟柱状图
```bash
GET /api/coin-change-tracker/up-ratio-bars
```

## 使用方法

### 1. 备份旧版本
```bash
cd /home/user/webapp/monitors
cp intraday_pattern_monitor.py intraday_pattern_monitor_v1.py.bak
```

### 2. 替换为v2.0
```bash
cp intraday_pattern_monitor_v2.py intraday_pattern_monitor.py
chmod +x intraday_pattern_monitor.py
```

### 3. 重启监控器
```bash
cd /home/user/webapp/scripts
./manage_intraday_monitor.sh restart
```

### 4. 查看日志
```bash
./manage_intraday_monitor.sh logs -f
```

## 检测记录格式

```json
{
  "timestamp": "2026-02-23T14:30:00+08:00",
  "date": "20260223",
  "daily_prediction": "等待新低",
  "pattern": "情况1",
  "name": "诱多等待新低",
  "type": "红→黄→绿",
  "signal_type": "short",
  "operation": "逢高做空",
  "time_range": "14:10-14:30",
  "bars": [
    {"time": "14:10", "up_ratio": 38, "color": "红色"},
    {"time": "14:20", "up_ratio": 68, "color": "黄色"},
    {"time": "14:30", "up_ratio": 58, "color": "绿色"}
  ],
  "trigger_condition": "中间柱up_ratio=68.0% > 65%"
}
```

## 常见问题

### Q1: 为什么情况1的阈值会变化？
A: 根据日线预测动态调整，更严格的预测需要更强的信号确认。

### Q2: 情况2什么时候做多？
A: 不是检测到就做多，而是在后续出现的空白柱时做多。

### Q3: 情况3为什么要求涨跌幅<-50？
A: 筑底信号需要在深度超跌后才有效，浅跌时的筑底信号可靠性低。

### Q4: 如果大周期预测是"观望"，能触发做多吗？
A: 不能。观望属于做空系列，会禁止所有做多信号（情况2、3、4）。

## 版本对比

| 特性 | v1.0 | v2.0 |
|------|------|------|
| 情况1模式 | 2种（3根） | 3种（新增4根） |
| 情况1阈值 | 固定50% | 动态65%/50% |
| 情况2触发点 | 检测时 | 空白柱时 |
| 情况3条件 | 仅颜色 | 颜色+涨跌幅+阈值 |
| 情况4条件 | 仅颜色 | 颜色+阈值 |
| 大周期控制 | 基础 | 增强 |

---

**文档版本**: v2.0  
**更新时间**: 2026-02-23  
**维护者**: Intraday Pattern Monitor Team
