# 数据采集策略调整说明

## 📅 发布时间
2026-01-16 23:00

## 🔍 问题发现

经过深入测试，我们发现了**OKX API的关键限制**：

### OKX API行为测试结果

测试代码：
```python
# 测试1：请求2026-01-03 12:00:00的数据
params = {
    'instId': 'BTC-USDT-SWAP',
    'bar': '30m',
    'before': '2026-01-03 12:00:00 (timestamp)',
    'limit': '3'
}

# 结果：返回最新数据
# K线1: 2026-01-16 22:30:00 | 收盘价: $95,236.80
# K线2: 2026-01-16 22:00:00 | 收盘价: $95,668.00
# K线3: 2026-01-16 21:30:00 | 收盘价: $95,400.00

# 测试2：请求2025-12-20 12:00:00的数据
params = {
    'instId': 'BTC-USDT-SWAP',
    'bar': '30m',
    'before': '2025-12-20 12:00:00 (timestamp)',
    'limit': '3'
}

# 结果：仍然返回最新数据
# K线1: 2026-01-16 22:30:00 | 收盘价: $95,242.10
# K线2: 2026-01-16 22:00:00 | 收盘价: $95,668.00
# K线3: 2026-01-16 21:30:00 | 收盘价: $95,400.00
```

### 结论

**OKX API无法获取历史日期（2026-01-03至2026-01-15）的K线数据。**

原因：
1. 在API的视角中，"现在"是2026-01-16
2. 当`before`参数指定的时间点是"未来"（相对于API服务器时间）时，API会返回当前最新的K线数据
3. 因此，我们请求1月3日至1月15日的数据时，API认为这些是"未来日期"，直接返回最新数据

---

## ✅ 新的数据策略

### 1. 放弃历史数据回填

**不再回填** 2026-01-03 至 2026-01-15 的历史数据，原因：
- OKX API技术限制
- 即使修改脚本也无法获取真实的历史价格
- 任何回填的数据都会是重复的"当前价格"，导致涨跌幅为0%

### 2. 专注实时数据采集

**从2026-01-16 20:00开始**，系统每30分钟自动采集一次实时价格数据。

当前已采集数据：
```
✅ 2026-01-16 20:47:43: 27/27币种 完整
✅ 2026-01-16 21:11:18: 27/27币种 完整  
✅ 2026-01-16 21:41:35: 27/27币种 完整
✅ 2026-01-16 22:11:44: 27/27币种 完整
```

### 3. 数据累积计划

从今天开始，每天将累积：
- **48个时间节点**（每30分钟一次）
- **27个币种** 的完整数据
- **准确的涨跌幅**（相对于当天00:00基准价）

**预计数据完整时间**：
- 1天后（1月17日）：96个节点
- 3天后（1月19日）：192个节点  
- 7天后（1月23日）：384个节点
- 14天后（1月30日）：672个节点 ✅ 完整数据集

---

## 📊 系统当前状态

### 数据文件
- **主数据文件**: `/home/user/webapp/data/coin_price_tracker/coin_prices_30min.jsonl`
- **当前记录数**: 4条（全部为实时采集数据）
- **数据范围**: 2026-01-16 20:47:43 ~ 22:11:44
- **数据完整性**: 100%（所有4条记录都是27/27币种完整）

### 实时采集服务
- **进程状态**: 运行中（PM2管理）
- **进程名**: `coin-price-tracker`
- **采集频率**: 每30分钟
- **下次采集**: 2026-01-16 23:00:00

### 前端页面
- **主页面**: `/coin-price-tracker` - 27币涨跌幅总和曲线图
- **历史查询**: `/coin-price-history` - 详细数据查询
- **回填监控**: `/backfill-monitor` - 已停用（不再需要回填）

---

## 🎯 下一步计划

### 短期（未来24小时）
1. ✅ 继续实时采集数据
2. ✅ 每30分钟自动记录价格
3. ✅ 确保基准价（每天00:00）正确获取

### 中期（未来7天）
1. 累积足够的数据点（约336个节点）
2. 观察曲线趋势和波动
3. 优化页面展示和交互

### 长期（未来14天）
1. 达成672个完整节点
2. 实现完整的14天数据覆盖
3. 支持完整的数据分析和导出

---

## 📝 用户需要了解的

### 为什么不回填历史数据？

**技术原因**：
- OKX API不支持获取"相对于系统时间的未来日期"的历史K线
- 在2026-01-16无法获取1月3日至1月15日的真实历史价格
- API会将任何"未来日期"的请求重定向到当前最新数据

**数据质量原因**：
- 强行回填会导致所有历史数据的涨跌幅为0%（因为获取的都是同一时刻的价格）
- 这样的数据毫无意义，反而会误导用户

### 什么时候能看到完整的曲线？

**答案**：从现在开始计算，**14天后**（2026-01-30）可以看到完整的14天曲线。

**时间表**：
- **1月17日**: 可以看到24小时的曲线（48个节点）
- **1月19日**: 可以看到3天的曲线（144个节点）
- **1月23日**: 可以看到7天的曲线（336个节点）
- **1月30日**: 可以看到完整14天的曲线（672个节点）✅

### 当前能看到什么？

**现在就可以**：
1. 查看实时价格变化
2. 查看27币涨跌幅总和
3. 查看每个币种的详细数据
4. 导出CSV数据

只是数据点还比较少（目前只有4个节点），曲线还不够密集。

---

## 🔧 技术细节

### 实时采集脚本
- **文件**: `source_code/coin_price_realtime_collector.py`
- **采集频率**: 每30分钟
- **基准价获取**: 每天00:00自动更新
- **数据持久化**: JSONL格式，追加写入
- **错误处理**: 自动重试机制

### 数据格式
```json
{
  "collect_time": "2026-01-16 22:11:44",
  "timestamp": 1768566704,
  "base_date": "2026-01-16",
  "coins": {
    "BTC": {
      "base_price": 95419.5,
      "current_price": 95403.6,
      "change_pct": -0.0167
    },
    ...
  },
  "total_coins": 27,
  "valid_coins": 27
}
```

### 数据完整性保证
- ✅ 每次采集都记录时间戳
- ✅ 每个币种都记录基准价和当前价
- ✅ 涨跌幅精确到小数点后4位
- ✅ 记录有效币种数，便于数据质量监控

---

## 📞 联系和反馈

如果您有任何问题或建议，请通过以下方式反馈：
1. 查看系统日志：`logs/coin_price_collector.log`
2. 访问监控页面：https://5000-igsydcyqs9jlcot56rnqk-18e660f9.sandbox.novita.ai/backfill-monitor
3. 查看数据文件：`data/coin_price_tracker/coin_prices_30min.jsonl`

---

## 🎉 总结

虽然我们无法回填历史数据，但**从现在开始，系统将持续准确地记录每一个30分钟节点的数据**。

14天后，您将拥有一个**完整、准确、可靠**的27币涨跌幅总和数据集！

**耐心等待，数据会自然累积！** 🚀
