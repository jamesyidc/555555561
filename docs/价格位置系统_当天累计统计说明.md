# 价格位置预警系统 - 当天累计统计功能说明

## 📊 功能概述

**版本**：v2.0.7  
**更新时间**：2026-02-15 18:50:00 UTC  
**文档作者**：Claude AI Developer

---

## 🎯 核心功能

### 顶部5个统计卡片显示的数据含义

页面顶部的5个彩色卡片显示的是：**当天所有采集次数中，28个币种进入该涨速区间的总次数累加**。

#### 统计逻辑

```
当天累计统计 = Σ(每次采集的区间统计)
```

**示例说明**：
- 假设今天共采集100次（每3分钟1次）
- 每次采集28个币种，根据10分钟涨速分类到5个区间
- 蓝色卡片显示 **167** = 表示在这100次采集中，共有167次币种的10分钟涨速落在 +1%~+4% 区间

#### 与即时统计的区别

| 统计类型 | 数据来源 | 含义 | 示例 |
|---------|---------|------|------|
| **即时统计** | `statistics` | 最新一次采集中，当前有多少个币在该区间 | 蓝色区间：3个币 |
| **累计统计** | `daily_total_statistics` | 当天所有采集中，进入该区间的总次数 | 蓝色区间：167次 |

---

## 🔧 技术实现

### 1. 数据采集与存储

#### 采集进程
- **进程名称**：`price-speed-10m-collector`（PM2管理）
- **采集频率**：每3分钟
- **监控币种**：28种主流加密货币
- **数据来源**：OKX交易所1分钟K线

#### JSONL文件存储

**文件路径**：`/home/user/webapp/data/price_speed_10m/price_speed_10m_YYYYMMDD.jsonl`

**文件格式**：每行一条JSON记录
```json
{
  "time": "2026-02-15 18:48:04",
  "coins": [
    {
      "symbol": "BTC",
      "current_price": 70444.6,
      "price_10m_ago": 70300.0,
      "speed_10m": 0.206,
      "category": "0%"
    },
    ...
  ],
  "statistics": {
    "+4%": 0,
    "+1%": 0,
    "0%": 28,
    "-1%": 0,
    "-3%": 0
  },
  "daily_counts": {
    "BTC": { "+4%": 0, "+1%": 5, "-1%": 3, "-3%": 1 },
    ...
  },
  "total_coins": 28
}
```

**字段说明**：
- **`statistics`**：当次采集的即时统计（5个区间各有多少币）
- **`daily_counts`**：每个币种的当日累计统计（该币进入各区间的次数）

---

### 2. API接口

#### 接口地址
```
GET /api/price-speed-10m/latest
```

#### 返回数据结构
```json
{
  "success": true,
  "time": "2026-02-15 18:48:04",
  "coins": [...],                      // 最新一次28个币的10分钟涨速数据
  "statistics": {                      // 最新一次的即时统计
    "+4%": 0, "+1%": 0, "0%": 28, "-1%": 0, "-3%": 0
  },
  "daily_total_statistics": {          // 🆕 当天累计统计
    "+4%": 0, "+1%": 9, "0%": 2507, "-1%": 60, "-3%": 0
  },
  "daily_counts": {...},               // 每个币的当日统计
  "total_coins": 28
}
```

#### 🆕 新增字段：`daily_total_statistics`

**字段说明**：当天所有采集次数中，各区间的币种进入次数累加

**计算逻辑**（后端实现）：
```python
# 遍历当天JSONL文件的所有行
daily_total_stats = { '+4%': 0, '+1%': 0, '0%': 0, '-1%': 0, '-3%': 0 }

with open(file_path, 'r', encoding='utf-8') as f:
    for line in f:
        data = json.loads(line)
        stats = data.get('statistics', {})
        for key in daily_total_stats:
            daily_total_stats[key] += stats.get(key, 0)

# 结果示例（92次采集）：
# {
#   "+4%": 0,
#   "+1%": 9,       ← 92次采集中，共9次有币进入+1%~+4%区间
#   "0%": 2507,     ← 92次采集中，共2507次有币进入-1%~+1%区间
#   "-1%": 60,      ← 92次采集中，共60次有币进入-3%~-1%区间
#   "-3%": 0
# }
```

**理论最大值**：28（币种数）× 采集次数
- 例如：92次采集，理论最大值 = 28 × 92 = 2576

---

### 3. 前端展示

#### 顶部统计卡片（使用累计统计）

```javascript
// 获取API数据
const speedResult = await fetch('/api/price-speed-10m/latest').then(r => r.json());

// 使用 daily_total_statistics 更新卡片
dailyTotalStats = speedResult.daily_total_statistics || { '+4%': 0, '+1%': 0, '0%': 0, '-1%': 0, '-3%': 0 };

// 更新显示
document.getElementById('statSpeed4Up').innerText = dailyTotalStats['+4%'];    // 绿色卡片
document.getElementById('statSpeed1Up').innerText = dailyTotalStats['+1%'];    // 蓝色卡片
document.getElementById('statSpeed0').innerText = dailyTotalStats['0%'];       // 灰色卡片
document.getElementById('statSpeed1Down').innerText = dailyTotalStats['-1%'];  // 橙色卡片
document.getElementById('statSpeed3Down').innerText = dailyTotalStats['-3%'];  // 红色卡片
```

#### 卡片下方说明文字

```
📊 统计说明：上方数字为当天所有采集次数中，28个币种进入该涨速区间的总次数累加（每3分钟采集1次）
   示例：今日共采集100次，其中蓝色区间(+1%~+4%)共有167次币种进入该区间
```

---

## 📈 数据验证

### 实际数据示例（2026-02-15）

#### 当天采集情况
- **采集文件**：`price_speed_10m_20260215.jsonl`
- **采集次数**：92次（从00:00到当前时间）
- **监控币种**：28个

#### API返回数据
```json
{
  "statistics": {
    "+4%": 0, "+1%": 0, "0%": 28, "-1%": 0, "-3%": 0
  },
  "daily_total_statistics": {
    "+4%": 0,
    "+1%": 9,
    "0%": 2507,
    "-1%": 60,
    "-3%": 0
  }
}
```

#### 数据解读
1. **即时统计（statistics）**：最新一次采集，所有28个币都在 0% 区间（横盘震荡）
2. **累计统计（daily_total_statistics）**：
   - 0%区间：2507次（占比 2507/2576 ≈ 97.3%）
   - -1%区间：60次（占比 60/2576 ≈ 2.3%）
   - +1%区间：9次（占比 9/2576 ≈ 0.3%）
   - +4%和-3%区间：0次

3. **结论**：今日市场整体横盘为主，偶有小幅波动

---

## 🔄 数据更新机制

### 自动清零

- **清零时间**：每日00:00（北京时间）
- **实现方式**：通过JSONL文件名包含日期（`YYYYMMDD`），新的一天自动创建新文件
- **无需手动操作**：系统自动按日期切换文件，旧数据保留用于历史查询

### 实时更新

- **采集频率**：每3分钟
- **前端刷新**：页面每60秒自动刷新一次
- **数据延迟**：最长3分钟（等待下一次采集）

---

## 📚 相关文档

1. **10分钟涨速采集器配置**：`/home/user/webapp/source_code/price_speed_10m_collector.py`
2. **价格位置系统完整说明**：`/home/user/webapp/docs/价格位置预警系统_完整说明.md`
3. **API文档**：`/home/user/webapp/docs/价格位置API文档.md`
4. **JSONL数据格式规范**：见本文"技术实现 → JSONL文件存储"部分

---

## 🌐 访问地址

- **系统页面**：https://9002-iou7okyaq15h840cyuitp-c07dda5e.sandbox.novita.ai/price-position
- **API基础URL**：https://9002-iou7okyaq15h840cyuitp-c07dda5e.sandbox.novita.ai/api

---

## 📝 更新日志

### v2.0.7 (2026-02-15)
- ✅ 新增 `daily_total_statistics` 字段（API）
- ✅ 顶部卡片改为显示当天累计统计（前端）
- ✅ 添加卡片下方说明文字
- ✅ 更新系统说明文档中的统计逻辑描述

### v2.0.6 (2026-02-14)
- 新增10分钟涨速实时监控功能
- 新增每日累计统计（表格4列）
- JSONL数据存储

---

## ⚠️ 注意事项

1. **数据含义理解**：顶部卡片不是"当前有多少个币在该区间"，而是"今天累计有多少次币进入该区间"
2. **数值范围**：理论最大值 = 28 × 当天采集次数
3. **数据准确性**：依赖于采集器正常运行（PM2管理，自动重启）
4. **历史查询**：每日文件独立存储，可查询历史数据

---

**文档完成时间**：2026-02-15 18:50:00 UTC  
**Git提交**：c94610d
