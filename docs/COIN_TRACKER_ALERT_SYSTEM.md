# 27币涨跌幅追踪系统 - 预警功能使用指南

## 📋 功能概述

在27币涨跌幅追踪系统中新增了智能预警功能，当累计涨跌幅达到设定阈值时，系统会：
- 🔊 **播放预警音效** - 三声警报提醒
- 📱 **发送Telegram通知** - 即时推送到您的手机
- 💬 **弹窗提示** - 显示详细的预警信息
- 🔄 **自动关闭开关** - 触发后需手动重新开启

## 🎯 使用方法

### 1. 预警设置面板

在页面顶部导航栏下方，您会看到**预警设置**面板，包含：

#### 上限预警（涨幅预警）
- **阈值输入框**：设置触发预警的涨幅百分比（默认 300%）
- **开关按钮**：绿色=已开启，灰色=已关闭
- **触发条件**：当累计涨跌幅 ≥ 设定值时触发

#### 下限预警（跌幅预警）
- **阈值输入框**：设置触发预警的跌幅百分比（默认 -300%）
- **开关按钮**：绿色=已开启，灰色=已关闭
- **触发条件**：当累计涨跌幅 ≤ 设定值时触发

### 2. 设置预警步骤

```
1. 在阈值输入框中输入目标百分比
   - 上限预警：例如 300（表示+300%）
   - 下限预警：例如 -300（表示-300%）

2. 点击对应的开关按钮，开启预警
   - 开关变为绿色表示已启用
   - 灰色表示未启用

3. 等待系统自动监控
   - 系统每10秒检查一次涨跌幅
   - 达到阈值时自动触发预警
```

### 3. 预警触发效果

当预警被触发时，您会看到：

#### 📢 音效提示
- 连续播放3次警报音（800Hz-1000Hz）
- 每次持续0.5秒，间隔0.6秒

#### 📱 Telegram通知
自动发送消息到您的Telegram，包含：
- 触发类型（涨幅/跌幅预警）
- 当前累计涨跌幅
- 设定的阈值
- 触发的币种列表及其涨跌幅

#### 💬 弹窗提示
页面中央弹出预警对话框，显示：
- 预警标题（🔴 涨幅预警 / 🟢 跌幅预警）
- 详细数据（当前值、阈值、触发币种）
- 操作按钮（关闭、刷新数据）
- 5秒后自动关闭

#### 🔒 自动关闭开关
- 预警触发后，对应的开关会自动关闭
- 开关变回灰色状态
- 需要手动重新开启才能再次预警

### 4. 重新启用预警

触发预警后，如需再次监控：

```
1. 点击对应的开关按钮
   - 开关重新变为绿色

2. 可以修改阈值
   - 输入新的百分比值
   - 修改后自动保存

3. 系统重新开始监控
   - 触发状态已重置
   - 可以再次触发预警
```

## ⚙️ Telegram配置

### 前提条件

预警功能需要先配置Telegram Bot：

1. **创建Bot**
   - 在Telegram中搜索 @BotFather
   - 发送 `/newbot` 创建新机器人
   - 获取Bot Token

2. **获取Chat ID**
   - 在Telegram中搜索 @userinfobot
   - 发送 `/start` 获取您的Chat ID

3. **配置系统**
   - 访问系统配置页面：`/system-config`
   - 输入Bot Token和Chat ID
   - 保存配置

### 配置文件位置

```
/home/user/webapp/telegram_notification_config.json
```

配置格式：
```json
{
  "bot_token": "YOUR_BOT_TOKEN",
  "chat_id": "YOUR_CHAT_ID"
}
```

## 📊 使用场景

### 场景1：捕捉大涨机会
```
设置：上限预警 +300%
开启：上限开关
目标：当市场整体大涨时及时知晓
```

### 场景2：防范大跌风险
```
设置：下限预警 -300%
开启：下限开关
目标：当市场整体大跌时及时预警
```

### 场景3：双向监控
```
设置：上限 +300%，下限 -300%
开启：两个开关都打开
目标：同时监控大涨和大跌
```

### 场景4：自定义阈值
```
设置：上限 +200%，下限 -200%
开启：两个开关都打开
目标：更敏感的预警，更早发现机会
```

## 🔍 技术细节

### 预警检查机制
- **检查频率**：每10秒检查一次
- **数据源**：实时获取最新的累计涨跌幅
- **触发条件**：
  - 上限：cumulative_pct ≥ upperThreshold
  - 下限：cumulative_pct ≤ lowerThreshold

### 本地存储
预警设置自动保存到浏览器localStorage：
```javascript
localStorage.setItem('coinAlertSettings', JSON.stringify({
  upperThreshold: 300,
  lowerThreshold: -300,
  upperEnabled: true,
  lowerEnabled: true,
  upperTriggered: false,
  lowerTriggered: false
}))
```

### 防重复触发
- 每次触发后设置 `triggered` 标志
- 自动关闭对应开关
- 必须手动重新开启才能再次触发
- 最小检查间隔10秒

## 🎨 UI说明

### 预警设置面板样式
```
┌─────────────────────────────────────────────┐
│ ⚡ 预警设置                                  │
├─────────────────────────────────────────────┤
│ 上限预警（涨幅）：[300] % [●开关]           │
│ 下限预警（跌幅）：[-300] % [●开关]          │
└─────────────────────────────────────────────┘
```

### 开关状态
- **绿色** = 已开启预警
- **灰色** = 未开启/已触发

### 颜色说明
- 🔴 红色：涨幅预警
- 🟢 绿色：跌幅预警
- 🟡 黄色：提示信息

## 📝 常见问题

### Q1: 为什么触发后开关自动关闭？
**A**: 这是防止频繁重复预警的设计。触发一次后，您需要手动确认并重新开启，确保每次预警都得到关注。

### Q2: 可以同时开启上下限预警吗？
**A**: 可以！两个预警是独立的，可以同时开启，互不影响。

### Q3: 修改阈值后会立即生效吗？
**A**: 是的，修改阈值后会自动保存并立即生效。同时会重置触发状态。

### Q4: 预警音效可以关闭吗？
**A**: 目前预警音效是自动播放的，无法单独关闭。如需静音，可以将浏览器标签页静音。

### Q5: Telegram通知没有收到怎么办？
**A**: 请检查：
1. Telegram配置是否正确
2. Bot Token和Chat ID是否有效
3. 检查浏览器控制台是否有错误信息
4. 确认 `/api/telegram/send-alert` 接口是否正常

### Q6: 预警设置会保存吗？
**A**: 会的！所有设置都保存在浏览器的localStorage中，关闭页面后再打开会自动恢复。

## 🚀 快速开始

1. **首次使用**
   ```
   1. 访问 /coin-change-tracker
   2. 找到预警设置面板
   3. 设置上限 300%，下限 -300%
   4. 打开两个开关
   5. 配置Telegram（可选）
   ```

2. **测试预警**
   ```
   1. 设置较低的阈值（如 ±50%）
   2. 开启预警开关
   3. 等待市场波动触发
   4. 观察音效、弹窗和Telegram通知
   ```

3. **日常使用**
   ```
   1. 根据市场情况调整阈值
   2. 开启需要的预警
   3. 专注其他工作
   4. 收到预警后及时查看
   ```

## 📈 最佳实践

1. **合理设置阈值**
   - 不要设置过低的阈值（避免频繁预警）
   - 根据历史数据调整（查看趋势图）
   - 考虑市场波动性

2. **及时响应预警**
   - 收到预警后尽快查看
   - 分析触发原因
   - 根据策略决策

3. **定期检查配置**
   - 确认开关状态
   - 验证阈值设置
   - 测试Telegram通知

4. **记录预警历史**
   - 截图保存预警信息
   - 记录市场情况
   - 总结经验教训

## 🎯 版本信息

- **版本**：v2.1.0
- **更新日期**：2026-02-09
- **新增功能**：预警系统（音效 + Telegram + 弹窗）
- **技术栈**：
  - Web Audio API（音效）
  - Fetch API（Telegram通知）
  - LocalStorage（设置持久化）
  - Modal Dialog（弹窗提示）

## 📞 技术支持

如遇到问题或有改进建议，请：
1. 查看浏览器控制台日志
2. 检查网络请求状态
3. 验证Telegram配置
4. 查看相关文档

---

**提示**：首次使用建议先配置Telegram Bot，以便接收通知。预警功能完全在前端运行，不会影响数据采集和图表展示。
