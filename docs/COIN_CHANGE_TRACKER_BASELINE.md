# 币种涨跌追踪系统 - 基准价设置说明

## 功能概述
27币涨跌追踪系统在每天北京时间0点自动重置基准价，使用**OKX日线K线的开盘价**作为当天的基准价格。

## 基准价来源

### 数据源
- **API**: OKX API v5
- **接口**: `/api/v5/market/candles`
- **参数**: 
  - `instId`: 币种合约ID（如 BTC-USDT-SWAP）
  - `bar`: `1D`（日线）
  - `limit`: `1`（最新一根K线）

### 开盘价位置
K线数据格式: `[时间戳, 开盘价, 最高价, 最低价, 收盘价, 成交量, ...]`
- **开盘价位于索引[1]**

## 重置机制

### 触发时机
1. **每天0点**: 系统自动检测日期变化
2. **服务启动**: 如果没有今天的基准价文件，立即创建

### 重置流程
```
1. 检测到新的一天（日期变更）
2. 依次请求27个币种的日线K线数据
3. 提取每个币种的开盘价（索引[1]）
4. 保存到基准价文件: baseline_YYYYMMDD.json
5. 开始使用新基准价计算涨跌幅
```

### 容错机制
- **部分失败**: 如果部分币种获取失败，使用成功获取的币种继续运行
- **全部失败**: 回退使用当前价格作为临时基准价

## 文件示例

### 基准价文件路径
```
data/coin_change_tracker/baseline_20260204.json
```

### 文件内容
```json
{
  "date": "20260204",
  "timestamp": "2026-02-04T00:00:00.000225+08:00",
  "prices": {
    "BTC-USDT-SWAP": 78797.5,
    "ETH-USDT-SWAP": 2371.07,
    "XRP-USDT-SWAP": 1.6178,
    ...
  },
  "note": "日线开盘价（当天0点基准价）"
}
```

## 验证方式

### 1. 查看基准价文件
```bash
cat data/coin_change_tracker/baseline_$(date +%Y%m%d).json
```

### 2. 查看服务日志
```bash
pm2 logs coin-change-tracker --lines 100 | grep "基准"
```

### 3. 调用API查询
```bash
curl https://5000-iehbqwjte74vmohs308jg-d0b9e1e2.sandbox.novita.ai/api/coin-change-tracker/latest
```

## 重要时间节点

### 时区
- 系统使用**北京时间（UTC+8）**
- 所有时间戳都是北京时间

### 0点重置
- **触发时间**: 每天 00:00:00（北京时间）
- **完成时间**: 通常在00:00:03内完成（取决于API响应速度）

### 示例时间线
```
2026-02-03 23:59:59  - 使用2月3日的基准价
2026-02-04 00:00:00  - 检测到日期变更，创建2月4日基准价
2026-02-04 00:00:03  - 基准价创建完成，开始使用新基准价
```

## 涨跌幅计算公式
```
涨跌幅(%) = ((当前价格 - 基准价) / 基准价) × 100
```

## 服务管理

### PM2服务
- **服务名**: `coin-change-tracker`
- **运行周期**: 每1分钟采集一次
- **自动重启**: 异常退出自动重启

### 常用命令
```bash
# 查看服务状态
pm2 status coin-change-tracker

# 查看日志
pm2 logs coin-change-tracker

# 重启服务
pm2 restart coin-change-tracker
```

## 实际运行验证

### 2026-02-04验证结果
✅ **基准价创建时间**: 2026-02-04T00:00:00（北京时间0点）
✅ **基准价来源**: OKX日线开盘价
✅ **币种数量**: 27个币种全部成功获取
✅ **数据格式**: 正确保存到baseline_20260204.json
✅ **API返回**: 正常返回基准价和涨跌幅数据

### 示例数据
- BTC基准价: 78797.5 USDT
- ETH基准价: 2371.07 USDT
- 当前涨跌幅: 实时计算中...

## 代码位置
- **主程序**: `source_code/coin_change_tracker.py`
- **相关函数**:
  - `fetch_daily_open_prices()`: 获取日线开盘价
  - `check_and_reset_baseline()`: 检查并重置基准价
  - `calculate_changes()`: 计算涨跌幅

## 总结
✅ **功能已完整实现**
✅ **北京时间0点自动重置**
✅ **使用OKX日线开盘价**
✅ **27个币种全覆盖**
✅ **服务稳定运行中**

最后更新: 2026-02-04 03:10:00（北京时间）
