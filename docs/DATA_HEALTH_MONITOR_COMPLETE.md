# 数据采集健康监控系统 - 完成报告

## 📋 需求分析

### 用户反馈的问题
从用户提供的截图可以看到：
1. **27币涨跌幅追踪器** - 1月31日21点后数据中断，2月1日9点多才恢复
2. **1小时爆仓金额曲线** - 同样的数据中断问题

### 核心问题
- **数据采集器停止工作** - 31号21点后数据停止更新
- **缺乏监控机制** - 没有自动检测数据中断
- **需要人工发现** - 用户看到图表才发现问题
- **恢复时间长** - 直到9点多才恢复，中断超过12小时

### 用户需求
1. ✅ **自动监控** - 实时监控数据采集器是否正常更新
2. ✅ **自动修复** - 发现数据中断时自动重启服务
3. ✅ **可视化界面** - 直观查看所有采集器的健康状态
4. ✅ **独立模块** - 单独的监控服务和可视化页面

---

## ✅ 实现功能

### 1. 数据采集健康监控服务 ✅
**文件**: `source_code/data_health_monitor.py`

**核心功能**:
- 📊 **多服务监控** - 监控4个核心数据采集器
  - 27币涨跌幅追踪 (coin-change-tracker)
  - 1小时爆仓金额 (liquidation-1h-collector)
  - 恐慌清洗指数 (panic-collector)
  - 锚点盈利统计 (anchor-profit-monitor)

- 🔍 **数据新鲜度检查**
  - 每60秒检查一次
  - 最大允许延迟: 5分钟
  - 自动提取最新数据时间戳
  - 支持多种时间戳格式

- 🔄 **自动重试机制**
  - 连续2次检查失败后触发
  - 自动重启对应的PM2服务
  - 发送Telegram告警通知
  - 记录重启历史

- 💾 **状态持久化**
  - 实时保存监控状态
  - 记录连续失败次数
  - 追踪最后检查时间
  - 记录最后重启时间

### 2. 可视化监控页面 ✅
**文件**: `source_code/templates/data_health_monitor.html`

**页面特性**:
- 🎨 **现代化设计**
  - 渐变背景和阴影效果
  - 响应式网格布局
  - 动态颜色指示器
  - 流畅的hover动画

- 📊 **统计概览**
  - 监控服务总数
  - 健康服务数量（绿色）
  - 异常服务数量（红色）
  - 今日自动重启次数

- 🔧 **监控卡片** (每个服务一个卡片)
  - ✅/❌ 健康状态徽章
  - 📝 PM2服务名称
  - ⏱️ 数据延迟时间（带颜色指示器）
  - 🔄 PM2运行状态
  - 📈 连续失败次数
  - 🕒 最后检查时间
  - 🔄 最后重启时间
  - 🔘 手动重启按钮
  - 📜 查看日志按钮

- 📜 **最近日志** (最新50条)
  - 时间戳
  - 日志级别（info/warning/error）
  - 日志内容
  - 颜色区分不同级别

- 🔄 **自动刷新**
  - 每30秒自动更新
  - 显示最后更新时间
  - 刷新指示器动画

### 3. Flask API接口 ✅
**文件**: `source_code/app_new.py`

**新增路由**:
```python
# 页面路由
GET  /data-health-monitor              # 监控页面

# API路由
GET  /api/data-health-monitor/status   # 获取所有监控器状态
GET  /api/data-health-monitor/logs     # 获取最近日志（limit参数）
POST /api/data-health-monitor/restart  # 手动重启服务（pm2_name参数）
GET  /api/data-health-monitor/service-logs?pm2_name=xxx  # 查看特定服务日志
```

**API功能**:
- 📊 **状态API** - 返回统计和所有监控器详情
- 📜 **日志API** - 返回解析后的结构化日志
- 🔄 **重启API** - 手动重启指定PM2服务
- 📝 **服务日志API** - 查看特定服务的PM2日志

### 4. 首页集成 ✅
**文件**: `source_code/templates/index.html`

**新增卡片**:
- 📊 **数据采集健康监控卡片**
  - 位置: 重大事件监控卡片后面
  - 渐变背景: 绿色主题
  - 实时数据加载
  - 点击跳转到监控页面

**显示数据**:
- 监控服务总数
- 健康服务数量（绿色）
- 异常服务数量（红色，动态颜色）
- 今日重启次数（橙色）

---

## 📊 监控配置

### 监控服务列表
| 服务名称 | PM2名称 | API端点 | 最大延迟 | 检查间隔 |
|---------|---------|---------|----------|----------|
| 27币涨跌幅追踪 | coin-change-tracker | /api/coin-price-tracker/history?days=1 | 5分钟 | 60秒 |
| 1小时爆仓金额 | liquidation-1h-collector | /api/panic/liquidation-1h-data?days=1 | 5分钟 | 60秒 |
| 恐慌清洗指数 | panic-collector | /api/panic/history?days=1 | 5分钟 | 60秒 |
| 锚点盈利统计 | anchor-profit-monitor | /api/anchor-system/profit-stats?days=1 | 5分钟 | 60秒 |

### 自动修复触发条件
- **连续失败次数** ≥ 2次
- **数据延迟** > 5分钟
- **自动重启** ✅ 启用
- **Telegram通知** ✅ 启用（如果配置）

---

## 🚀 部署状态

### PM2服务
```bash
✅ data-health-monitor - 监控服务 (PID: 654221, 在线)
✅ flask-app - Web应用 (PID: 654411, 在线)
```

### 日志文件
```
/home/user/webapp/logs/data_health_monitor.log  # 监控服务日志
```

### 状态文件
```
/home/user/webapp/data/data_health_monitor_state.json  # 状态持久化
```

---

## 🌐 访问地址

### 主要入口
**数据采集健康监控页面**:
https://5000-ikmpd2up5chrwx4jjjkih-5185f4aa.sandbox.novita.ai/data-health-monitor

### 首页入口
**系统首页** (包含监控卡片):
https://5000-ikmpd2up5chrwx4jjjkih-5185f4aa.sandbox.novita.ai/

---

## 🔍 工作原理

### 监控流程
```
1. 每60秒执行一次检查
   ↓
2. 对每个服务执行以下步骤:
   a) 检查PM2服务状态 (online/stopped/errored)
   b) 调用API获取最新数据
   c) 提取最新数据时间戳
   d) 计算数据延迟时间（分钟）
   ↓
3. 判断数据新鲜度:
   - 延迟 ≤ 5分钟 → ✅ 健康
   - 延迟 > 5分钟 → ❌ 异常
   ↓
4. 异常处理:
   - 第1次失败 → 记录警告，consecutive_failures = 1
   - 第2次失败 → 触发自动修复
   ↓
5. 自动修复流程:
   a) 发送Telegram告警（数据中断）
   b) 执行 pm2 restart <service-name>
   c) 等待重启完成
   d) 发送Telegram通知（重启成功/失败）
   e) 重置consecutive_failures为0
   ↓
6. 状态持久化:
   - 保存监控状态到JSON文件
   - 记录最后检查时间、延迟时间、连续失败次数
   ↓
7. 等待60秒，返回步骤1
```

### 数据新鲜度检查
```python
# 从API响应中提取时间戳
latest_time = extract_timestamp_from_response(api_response)

# 计算延迟
now = datetime.now(BEIJING_TZ)
delay_minutes = (now - latest_time).total_seconds() / 60

# 判断新鲜度
is_fresh = delay_minutes <= max_delay_minutes (5分钟)
```

---

## 📱 Telegram告警集成

### 告警类型
1. **数据中断告警**
   ```
   🚨 数据采集中断

   服务: 27币涨跌幅追踪
   PM2名称: coin-change-tracker
   数据延迟: 10.5 分钟
   连续失败: 2 次
   时间: 2026-02-01 01:45:00

   🔄 正在自动重启服务...
   ```

2. **重启成功通知**
   ```
   ✅ 服务重启成功

   服务: 27币涨跌幅追踪
   PM2名称: coin-change-tracker
   时间: 2026-02-01 01:45:30
   ```

3. **重启失败通知**
   ```
   ❌ 服务重启失败

   服务: 27币涨跌幅追踪
   PM2名称: coin-change-tracker
   时间: 2026-02-01 01:45:30

   ⚠️ 需要人工介入处理
   ```

### 配置Telegram（可选）
创建文件 `/home/user/webapp/telegram_config.json`:
```json
{
  "bot_token": "YOUR_BOT_TOKEN",
  "chat_id": "YOUR_CHAT_ID"
}
```

---

## 🎯 解决的问题

### 问题1: 数据中断无法及时发现 ✅
**解决方案**:
- 每60秒自动检查数据新鲜度
- 超过5分钟延迟立即告警
- 可视化页面实时显示状态

### 问题2: 需要人工重启服务 ✅
**解决方案**:
- 连续2次检查失败自动重启
- PM2服务重启机制
- Telegram告警通知运维

### 问题3: 无法追踪历史问题 ✅
**解决方案**:
- 状态持久化记录所有检查结果
- 记录重启历史和失败次数
- 日志文件记录详细操作

### 问题4: 缺少可视化界面 ✅
**解决方案**:
- 独立的监控页面
- 实时数据更新（30秒）
- 统计概览和详细卡片
- 首页集成快速入口

---

## 🔧 使用说明

### 查看监控状态
1. 访问首页看到监控卡片概览
2. 点击卡片进入详细监控页面
3. 查看每个服务的健康状态和延迟
4. 查看最近的监控日志

### 手动重启服务
1. 进入监控页面
2. 找到异常服务的卡片
3. 点击"🔄 手动重启"按钮
4. 确认重启操作
5. 等待重启完成

### 查看服务日志
1. 进入监控页面
2. 找到对应服务的卡片
3. 点击"📜 查看日志"按钮
4. 新窗口打开PM2日志

### 查看监控日志
1. 进入监控页面
2. 滚动到"📜 最近日志"区域
3. 查看最新50条日志记录
4. 根据颜色区分不同级别

---

## 📈 监控指标

### 健康状态
- **✅ 健康** - 数据延迟 ≤ 5分钟，服务在线
- **❌ 异常** - 数据延迟 > 5分钟，或服务离线
- **❓ 未知** - 无法获取服务状态或数据

### 延迟指示器
- 🟢 **良好** - 延迟 ≤ 3分钟
- 🟠 **警告** - 延迟 3-5分钟
- 🔴 **异常** - 延迟 > 5分钟

### 统计数据
- **监控服务总数** - 当前监控的服务数量
- **健康服务** - 状态为"健康"的服务数
- **异常服务** - 状态为"异常"的服务数
- **今日重启次数** - 当天自动重启的总次数

---

## 🛠️ 技术栈

### 后端
- **Python 3** - 监控服务主语言
- **Flask** - Web框架和API
- **pytz** - 时区处理（北京时间）
- **requests** - HTTP请求
- **subprocess** - PM2命令执行
- **json** - 数据序列化

### 前端
- **HTML5** - 页面结构
- **CSS3** - 样式和动画
- **JavaScript** - 交互逻辑
- **Fetch API** - 异步数据加载

### 运维
- **PM2** - 进程管理
- **Telegram Bot API** - 告警通知（可选）

---

## 🎉 完成总结

### 已完成功能 ✅
- [x] 数据采集健康监控服务
- [x] 自动数据新鲜度检查
- [x] 自动重启服务机制
- [x] 状态持久化
- [x] Telegram告警通知
- [x] 可视化监控页面
- [x] 统计概览卡片
- [x] 详细监控卡片（4个服务）
- [x] 最近日志显示
- [x] 手动重启功能
- [x] PM2服务日志查看
- [x] Flask API接口
- [x] 首页集成
- [x] PM2服务部署
- [x] 自动刷新机制

### 核心优势 🚀
1. **自动化** - 无需人工干预，自动检测和修复
2. **实时性** - 60秒检查间隔，快速发现问题
3. **可视化** - 直观的图形界面，一目了然
4. **可靠性** - 状态持久化，服务重启后继续工作
5. **可追溯** - 完整的日志记录，方便问题排查
6. **易用性** - 一键重启，一键查看日志

### 解决用户痛点 ✅
- ✅ **问题发现** - 从12小时缩短到5分钟
- ✅ **问题修复** - 从人工重启到自动重启
- ✅ **可视化** - 从无到有，完整的监控界面
- ✅ **独立模块** - 单独的服务和页面，易于维护

---

## 📝 未来优化建议

### 功能扩展
1. **更多监控指标**
   - CPU使用率
   - 内存使用率
   - API响应时间
   - 数据库查询性能

2. **告警策略**
   - 多级告警（警告/严重/紧急）
   - 告警抑制（避免重复）
   - 告警统计和分析

3. **历史数据**
   - 服务可用性统计
   - 故障时间统计
   - 重启频率分析

4. **扩展监控**
   - 支持更多数据采集器
   - 配置化监控规则
   - 动态添加监控服务

---

## 📊 系统状态

### 当前运行状态
```
✅ data-health-monitor - 正在运行
✅ coin-change-tracker - 正常监控
✅ liquidation-1h-collector - 正常监控
✅ panic-collector - 正常监控
✅ anchor-profit-monitor - 正常监控
✅ flask-app - Web服务在线
```

### 访问地址
**监控页面**: https://5000-ikmpd2up5chrwx4jjjkih-5185f4aa.sandbox.novita.ai/data-health-monitor
**首页**: https://5000-ikmpd2up5chrwx4jjjkih-5185f4aa.sandbox.novita.ai/

---

*完成时间: 2026-02-01*  
*系统状态: ✅ 所有功能正常运行*  
*开发人: Claude Code Assistant*  
*部署环境: Sandbox (ikmpd2up5chrwx4jjjkih-5185f4aa)*
