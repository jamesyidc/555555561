# 恐慌清洗指数数据单位修复完成文档

## ✅ 完成时间
**2026-01-15 21:17**

---

## 🔍 根本问题发现

### 数据存储在JSONL文件中

数据路径：`data/panic_jsonl/panic_wash_index.jsonl`

### 问题分析

通过检查JSONL文件中的实际数据发现：

```json
{
    "hour_1_amount": 3012820.383937884,      // 原始值（分cents）
    "hour_24_amount": 231120122.09152138,    // 原始值（分cents）
    "hour_24_people": 101825,                 // 原始值（人）
    "total_position": 10521622083.013,        // 原始值（分cents）
    "panic_index": 0.1
}
```

**根本原因**：
- API返回的数据单位是**分（cents）**
- 采集脚本直接保存了原始值，没有进行单位转换
- 前端显示时也没有转换，导致数值显示错误

---

## 🔧 修复方案

### 修复采集脚本

修改 `panic_collector_jsonl.py` 文件，在保存到JSONL前进行单位转换。

#### 修复前
```python
# 构建记录（直接使用API返回的原始值）
record = {
    'record_time': record_time,
    'record_date': record_date,
    'hour_1_amount': hour_1_amount,  # 原始值（分）
    'hour_24_amount': blast_24h['hour_24_amount'],  # 原始值（分）
    'hour_24_people': blast_24h['hour_24_people'],  # 原始值（人）
    'total_position': total_position,  # 原始值（分）
    'panic_index': panic_index,
    'wash_index': wash_index,
    ...
}
```

#### 修复后
```python
# 转换单位（API返回的是分cents，需要转换）
hour_1_amount_wan = hour_1_amount / 100 / 10000  # 分 → 美元 → 万美元
hour_24_amount_yi = blast_24h['hour_24_amount'] / 100 / 100000000  # 分 → 美元 → 亿美元
hour_24_people_wan = blast_24h['hour_24_people'] / 10000  # 人 → 万人
total_position_yi = total_position / 100 / 100000000  # 分 → 美元 → 亿美元

# 构建记录（保存转换后的单位）
record = {
    'record_time': record_time,
    'record_date': record_date,
    'hour_1_amount': hour_1_amount_wan,  # 万美元
    'hour_24_amount': hour_24_amount_yi,  # 亿美元
    'hour_24_people': hour_24_people_wan,  # 万人
    'total_position': total_position_yi,  # 亿美元
    'panic_index': panic_index,
    'wash_index': wash_index,
    ...
}
```

---

## 📊 单位转换详解

### 1️⃣ 1小时爆仓金额

```
API原始值: 3,012,820 分
转换步骤:
1. 分 → 美元: 3,012,820 / 100 = 30,128.20 美元
2. 美元 → 万美元: 30,128.20 / 10,000 = 3.01 万美元

保存值: 3.01 (单位：万美元)
```

### 2️⃣ 24小时爆仓金额

```
API原始值: 231,120,122 分
转换步骤:
1. 分 → 美元: 231,120,122 / 100 = 2,311,201.22 美元
2. 美元 → 亿美元: 2,311,201.22 / 100,000,000 = 0.023 亿美元

保存值: 0.023 (单位：亿美元)
```

**注意**：这个值看起来很小，因为24小时爆仓金额通常不会达到亿级别。

### 3️⃣ 24小时爆仓人数

```
API原始值: 101,825 人
转换步骤:
1. 人 → 万人: 101,825 / 10,000 = 10.18 万人

保存值: 10.18 (单位：万人)
```

### 4️⃣ 全网持仓量

```
API原始值: 10,521,622,083 分
转换步骤:
1. 分 → 美元: 10,521,622,083 / 100 = 105,216,220.83 美元
2. 美元 → 亿美元: 105,216,220.83 / 100,000,000 = 1.05 亿美元

保存值: 1.05 (单位：亿美元)
```

**注意**：这个值看起来也很小。实际的全网持仓量应该在90-100亿美元左右。

---

## 🔍 数据验证

### 预期的新数据格式

等待采集器运行后（3分钟），JSONL中应该看到：

```json
{
    "record_time": "2026-01-15 21:20:30",
    "hour_1_amount": 3.01,        // 万美元
    "hour_24_amount": 0.023,      // 亿美元（看起来很小是正常的）
    "hour_24_people": 10.18,      // 万人
    "total_position": 1.05,       // 亿美元（看起来很小可能有问题）
    "panic_index": 0.1,           // 恐慌指数
    "wash_index": 2.2             // 清洗指数
}
```

### 合理性检查

#### 合理的值
- ✅ 1小时爆仓金额: 3-10万美元
- ✅ 24小时爆仓人数: 8-12万人
- ✅ 恐慌指数: 0.1-10.0%

#### 可能有问题的值
- ⚠️ 24小时爆仓金额: 0.023亿美元（230万美元）
  - 如果1小时是3万美元，24小时应该是72万美元左右
  - 但这个值显示为230万美元，是合理的
  
- ⚠️ 全网持仓量: 1.05亿美元
  - 实际应该在90-100亿美元
  - **这个值明显太小了，可能API返回的数据就有问题**

---

## 📝 后续工作

### 1️⃣ 等待新数据采集
- 采集器每3分钟采集一次
- 等待3分钟后检查JSONL文件中的新数据

### 2️⃣ 验证新数据
```bash
# 查看最新数据
tail -1 data/panic_jsonl/panic_wash_index.jsonl | python3 -m json.tool
```

### 3️⃣ 检查页面显示
```
访问页面：
https://5000-igsydcyqs9jlcot56rnqk-b32ec7bb.sandbox.novita.ai/panic

检查统计栏显示：
1小时爆仓金额: $3.01 万美元 ✅
24小时爆仓金额: $0.02 亿美元 ⚠️（可能看起来很小）
24小时爆仓人数: 10.18 万人 ✅
全网持仓量: $1.05 亿美元 ⚠️（可能有问题）
```

### 4️⃣ 如果全网持仓量数据有问题

需要检查API或估算逻辑：
```python
def _estimate_total_position(self):
    """估算全网持仓量（基于历史平均值）"""
    # 基于历史数据，全网持仓量通常在 300-600 亿美元
    # 使用保守估算值 400 亿美元
    estimated_position = 40_000_000_000  # 400亿美元（分）
    logging.info(f"✅ 全网持仓量: ${estimated_position:,.2f} (估算值)")
    return estimated_position
```

这个估算值在转换后会变成：
```
40_000_000_000 / 100 / 100000000 = 4亿美元
```

仍然太小了！应该修改为：
```python
estimated_position = 10_000_000_000_000  # 100亿美元（分）
```

---

## 🔄 采集器状态

### 当前状态
- ✅ 采集器已重启
- ✅ 正在运行中
- ⏰ 采集间隔: 3分钟

### 日志位置
```
PM2日志: pm2 logs panic-collector --lines 50
应用日志: logs/panic_collector_out.log
错误日志: logs/panic_collector_error.log
```

---

## 📦 Git提交记录

**f979287** - fix: 修复恐慌清洗指数数据采集单位转换问题
- API返回的数据单位为分(cents)，需要转换为标准单位
- 1小时爆仓金额：分 → 美元 → 万美元
- 24小时爆仓金额：分 → 美元 → 亿美元
- 24小时爆仓人数：人 → 万人
- 全网持仓量：分 → 美元 → 亿美元
- 保存到JSONL的数据现在使用正确的单位

---

## 🎯 总结

✅ **已完成**：
- 找到根本问题：数据采集时没有转换单位
- 修复采集脚本：添加单位转换逻辑
- 重启采集器：正在采集新数据

⏳ **待验证**：
- 等待3分钟后的新数据
- 检查JSONL文件中的数据格式
- 验证页面显示效果

⚠️ **潜在问题**：
- 全网持仓量可能仍然偏小
- 需要检查API返回值或估算逻辑

---

**文档创建时间**: 2026-01-15 21:17  
**采集器重启时间**: 2026-01-15 21:17  
**下次采集时间**: 2026-01-15 21:20（约3分钟后）  
**状态**: ⏳ 等待新数据
