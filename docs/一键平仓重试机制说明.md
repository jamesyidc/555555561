# 一键平仓失败重试机制说明

## 功能概述

在一键平仓所有持仓时，如果第一轮有持仓平仓失败，系统会自动进行**第二轮重试**，而不是直接结束。这大大提高了平仓成功率，减少手动干预。

---

## 工作流程

### 完整流程图

```
开始
  ↓
1. 获取所有持仓（8个）
  ↓
2. 第一轮平仓
  ├─ 成功：6个 ✅
  └─ 失败：2个 ❌
  ↓
3. 等待2秒
  ↓
4. 第二轮重试（仅对失败的2个）
  ├─ 重试成功：1个 ✅
  └─ 重试失败：1个 ❌
  ↓
5. 汇总结果
  ├─ 总成功：7个（6 + 1）
  └─ 最终失败：1个
  ↓
6. 返回详细报告
```

---

## 详细说明

### 第一轮平仓

系统会遍历所有持仓，逐个调用 OKX 的 `close-position` API 进行平仓。

**可能的失败原因**：
- 网络波动
- API 频率限制
- 持仓状态变化
- 市场流动性不足
- 临时错误

**第一轮结果**：
- 记录成功的持仓
- **记录失败的持仓到重试列表**
- 打印日志：`[一键平仓] 第一轮完成，发现 N 个失败，开始第二轮重试...`

### 等待间隔

在第一轮和第二轮之间，系统会**等待 2 秒**。

**原因**：
1. 避免 API 频率限制
2. 给市场状态一些恢复时间
3. 减少网络波动影响

### 第二轮重试

只对**第一轮失败的持仓**进行重试。

**重试逻辑**：
- 使用相同的 API 接口
- 使用相同的参数
- 独立处理每个持仓
- 记录重试结果

**可能的结果**：
1. **重试成功** ✅
   - 更新总成功数 +1
   - 更新失败数 -1
   - 标记为 `attempt: 2`

2. **重试仍失败** ❌
   - 保持失败状态
   - 记录失败原因
   - 标记为 `attempt: 2`

### 最终汇总

系统会汇总两轮的结果，返回详细报告。

---

## 响应格式

### 完整响应示例

```json
{
    "success": true,
    "message": "一键平仓完成: 成功 7 个，失败 1 个 （第二轮重试: 成功 1/2）",
    "totalPositions": 8,
    "closedCount": 7,
    "failedCount": 1,
    "retryCount": 2,
    "retrySuccess": 1,
    "results": [
        {
            "instId": "SOL-USDT-SWAP",
            "posSide": "long",
            "size": "10",
            "avgPx": "145.23",
            "upl": "2.50",
            "status": "success",
            "message": "平仓成功",
            "attempt": 1
        },
        {
            "instId": "XRP-USDT-SWAP",
            "posSide": "long",
            "size": "50",
            "avgPx": "0.58",
            "upl": "-1.20",
            "status": "failed",
            "message": "余额不足",
            "code": "51008",
            "attempt": 1
        },
        {
            "instId": "TAO-USDT-SWAP",
            "posSide": "long",
            "size": "5",
            "avgPx": "650.00",
            "upl": "-5.00",
            "status": "failed",
            "message": "网络超时",
            "code": "timeout",
            "attempt": 1
        },
        {
            "instId": "TAO-USDT-SWAP",
            "posSide": "long",
            "size": "5",
            "avgPx": "650.00",
            "upl": "-5.00",
            "status": "success",
            "message": "重试成功",
            "attempt": 2
        },
        {
            "instId": "XRP-USDT-SWAP",
            "posSide": "long",
            "size": "50",
            "avgPx": "0.58",
            "upl": "-1.20",
            "status": "failed",
            "message": "重试失败: 余额不足",
            "code": "51008",
            "attempt": 2
        },
        ...
    ]
}
```

### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 整体是否成功 |
| message | string | 包含重试信息的消息 |
| totalPositions | integer | 总持仓数量 |
| closedCount | integer | 最终成功平仓数量 |
| failedCount | integer | 最终失败数量 |
| retryCount | integer | 进行重试的持仓数量 |
| retrySuccess | integer | 重试成功的数量 |
| results | array | 详细结果（包含第一轮和第二轮） |

### result 对象新增字段

| 字段 | 类型 | 说明 |
|------|------|------|
| attempt | integer | 尝试次数（1=第一轮，2=第二轮） |

---

## 日志输出

### 控制台日志示例

```
[一键平仓] 找到 8 个持仓需要平仓
[一键平仓] 账户持仓模式: long_short_mode
[一键平仓] 开始第一轮平仓...
[一键平仓] ✅ SOL-USDT-SWAP long 平仓成功
[一键平仓] ✅ BTC-USDT-SWAP long 平仓成功
[一键平仓] ✅ ETH-USDT-SWAP long 平仓成功
[一键平仓] ✅ LDO-USDT-SWAP long 平仓成功
[一键平仓] ✅ CFX-USDT-SWAP long 平仓成功
[一键平仓] ✅ CRV-USDT-SWAP long 平仓成功
[一键平仓] ❌ XRP-USDT-SWAP long 平仓失败: 余额不足 (代码: 51008)
[一键平仓] ❌ TAO-USDT-SWAP long 平仓失败: 网络超时 (代码: timeout)

[一键平仓] 第一轮完成，发现 2 个失败，开始第二轮重试...
[一键平仓-重试] ✅ TAO-USDT-SWAP long 重试成功
[一键平仓-重试] ❌ XRP-USDT-SWAP long 重试仍然失败: 余额不足
[一键平仓] 第二轮重试完成: 成功 1 个，失败 1 个
```

### JSONL 日志格式

```json
{
    "timestamp": "2026-02-15T09:45:00.000000+08:00",
    "account_id": "account_main",
    "action": "close_all_positions",
    "details": {
        "totalPositions": 8,
        "firstRoundSuccess": 6,
        "firstRoundFailed": 2,
        "retryCount": 2,
        "finalSuccessCount": 7,
        "finalFailedCount": 1
    },
    "result": {
        "status": "completed",
        "results": [...]
    }
}
```

---

## 使用场景

### 场景 1：网络波动导致失败

**第一轮**：
- 成功：7个
- 失败：1个（网络超时）

**第二轮重试**：
- 重试成功：1个 ✅

**最终结果**：
- 总成功：8个
- 最终失败：0个
- **完美！无需手动干预**

### 场景 2：余额不足导致失败

**第一轮**：
- 成功：7个
- 失败：1个（余额不足）

**第二轮重试**：
- 重试失败：1个 ❌（依然余额不足）

**最终结果**：
- 总成功：7个
- 最终失败：1个
- **需要用户检查账户余额**

### 场景 3：API限流导致失败

**第一轮**：
- 成功：5个
- 失败：3个（API限流）

**第二轮重试**（2秒后）：
- 重试成功：3个 ✅

**最终结果**：
- 总成功：8个
- 最终失败：0个
- **完美！重试解决了限流问题**

---

## 重试机制优势

### ✅ 提高成功率
- 自动解决临时性错误
- 减少网络波动影响
- 避免API限流问题

### ✅ 减少手动干预
- 用户无需手动重试
- 系统自动处理失败
- 节省时间和精力

### ✅ 详细记录
- 清楚标记尝试次数
- 记录失败原因
- 便于问题追踪

### ✅ 智能等待
- 2秒等待间隔
- 避免频繁请求
- 给系统恢复时间

---

## 技术实现

### 核心代码逻辑

```python
# 第一轮平仓
failed_positions = []
for position in active_positions:
    result = close_position(position)
    if result.failed:
        failed_positions.append(position)

# 第二轮重试
if failed_positions:
    print(f"第一轮完成，发现 {len(failed_positions)} 个失败，开始第二轮重试...")
    time.sleep(2)  # 等待2秒
    
    for position in failed_positions:
        retry_result = close_position(position)
        if retry_result.success:
            success_count += 1
            failed_count -= 1
```

### 关键参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 重试间隔 | 2秒 | 等待时间 |
| 重试次数 | 1次 | 只重试一次 |
| 重试对象 | 失败的持仓 | 不重试成功的 |

---

## 常见问题

### Q1: 为什么只重试一次？
**A**: 一次重试已经能解决大部分临时性错误。如果两次都失败，通常是系统性问题（如余额不足），需要用户手动处理。

### Q2: 为什么等待2秒？
**A**: 2秒是经过权衡的时间：
- 足够长：避免API限流
- 足够短：不会让用户等太久
- 平衡：网络和系统有恢复时间

### Q3: 重试会增加多少时间？
**A**: 
- 无失败：0秒（不重试）
- 有失败：2秒 + 失败数量 × 0.5秒
- 示例：2个失败大约需要 3秒

### Q4: 重试会重复记录日志吗？
**A**: 会的，但会清楚标记 `attempt: 1` 或 `attempt: 2`，便于区分。

### Q5: 所有失败都会重试吗？
**A**: 是的，第一轮所有失败的持仓都会在第二轮重试。

---

## 注意事项

1. **重试不是万能的**
   - 系统性错误（余额不足、权限问题）重试也会失败
   - 需要用户根据错误信息手动处理

2. **网络环境**
   - 网络不稳定时重试效果明显
   - 网络稳定时重试较少触发

3. **API限流**
   - 2秒等待能有效缓解限流
   - 但不能完全避免

4. **时间成本**
   - 重试会增加总时间
   - 但相比手动重试，仍然更快

---

## 性能指标

### 重试成功率估算

| 失败原因 | 重试成功率 | 说明 |
|----------|------------|------|
| 网络波动 | 90% | 大部分能通过重试解决 |
| API限流 | 85% | 2秒等待能缓解 |
| 临时错误 | 80% | 重试有较高成功率 |
| 余额不足 | 0% | 系统性问题，无法重试 |
| 权限问题 | 0% | 系统性问题，无法重试 |

### 时间成本

| 场景 | 第一轮 | 等待 | 第二轮 | 总计 |
|------|--------|------|--------|------|
| 全部成功 | 4秒 | 0秒 | 0秒 | 4秒 |
| 1个失败 | 4秒 | 2秒 | 0.5秒 | 6.5秒 |
| 2个失败 | 4秒 | 2秒 | 1秒 | 7秒 |
| 3个失败 | 4秒 | 2秒 | 1.5秒 | 7.5秒 |

---

## 更新日志

- **2026-02-15**: 实现失败重试机制
  - 第一轮失败自动进行第二轮重试
  - 2秒等待间隔
  - 详细的重试统计信息
  - 标记尝试次数（attempt字段）
  - 优化日志记录

---

## 相关文档

- **一键平仓API文档**: `/home/user/webapp/docs/一键平仓所有持仓API文档.md`
- **止盈止损自动关闭说明**: `/home/user/webapp/docs/止盈止损自动关闭说明.md`

---

**文档完成时间**: 2026-02-15 09:47:00 UTC  
**提交记录**: commit d1c85fc
