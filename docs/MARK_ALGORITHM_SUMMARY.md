# 📍 标记算法说明文档

## 🎯 标记规则

### 绿色标记（48小时高点）
- **条件**: 在48小时窗口内，24小时信号数的最大值 > 50
- **间隔**: 每48小时最多1个标记
- **预计数量**: 约 5-11 个

### 红色标记（2小时高点）
- **条件**: 在2小时窗口内，2小时信号数的最大值 > 10
- **间隔**: 每2小时最多1个标记
- **预计数量**: 约 29-30 个

## 🔧 算法实现

### 数据密度计算
```
总数据点: 2000-3608 个（根据API返回）
数据范围: 23天
数据密度: ~6.5 个点/小时
```

### 窗口大小
```javascript
// 48小时窗口 = 48小时 * 6.5点/小时 ≈ 312点
const window48h = 312;

// 2小时窗口 = 2小时 * 6.5点/小时 ≈ 13点
const window2h = 13;
```

### 滑动窗口算法
```javascript
// 48小时标记
for (let i = 0; i < sampledData.length; i += window48h) {
    // 在当前窗口内找最大值
    let maxIndex = i;
    let maxValue = sampledData[i].signal_24h_count || 0;
    
    for (let j = i; j < Math.min(i + window48h, sampledData.length); j++) {
        const value = sampledData[j].signal_24h_count || 0;
        if (value > maxValue) {
            maxValue = value;
            maxIndex = j;
        }
    }
    
    // 只有当最大值 > 50 时才添加标记
    if (maxValue > 50) {
        extremeHighMarks.push({ ... });
    }
}
```

## 📊 数据统计

### 实际数据分析（基于2000个数据点）

| 指标 | 值 | 百分比 |
|------|-----|--------|
| 总数据点 | 2000 | 100% |
| 24h信号数 > 50 | 832 | 41.6% |
| 2h信号数 > 10 | 390 | 19.5% |
| 48h窗口数 | ~6 | - |
| 2h窗口数 | ~153 | - |

### 预期标记数量

| 标记类型 | 计算方式 | 预期数量 |
|---------|---------|---------|
| 绿色标记 | 6个窗口 × 41.6% | ~2-4 个 |
| 红色标记 | 153个窗口 × 19.5% | ~29-30 个 |

## 🔍 如何验证

### 浏览器控制台日志
```
🎯 标记统计: {
    48h高点标记(24h信号>50): X,
    2h高点标记(2h信号>10): Y
}
```

### 预期范围
- X (绿色标记): 2-11 个
- Y (红色标记): 29-30 个

## ⚙️ 参数调整

如果标记太多或太少，可以调整：

### 调整阈值
```javascript
// 更严格（减少标记）
if (maxValue > 100)  // 原来是 > 50
if (maxValue > 20)   // 原来是 > 10

// 更宽松（增加标记）
if (maxValue > 30)   // 原来是 > 50
if (maxValue > 5)    // 原来是 > 10
```

### 调整窗口大小
```javascript
// 更大窗口（减少标记）
const window48h = 624;  // 96小时，原来是48小时
const window2h = 26;    // 4小时，原来是2小时

// 更小窗口（增加标记）
const window48h = 156;  // 24小时，原来是48小时
const window2h = 7;     // 1小时，原来是2小时
```

## 📝 Git信息

- **当前实现**: 滑动窗口算法，自动适配数据密度
- **文件**: `source_code/templates/escape_signal_history.html`
- **代码行**: 1024-1082
- **最后更新**: commit e0aad9b

## 🚀 测试方法

1. 刷新页面（Ctrl+Shift+R）
2. 按F12打开控制台
3. 查看日志输出的标记统计
4. 对比图表上的标记数量
5. 验证每48h和每2h只有一个标记

---

**生成时间**: 2026-01-25 14:00 UTC
