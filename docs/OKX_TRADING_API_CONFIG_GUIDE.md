# OKX交易系统 - API配置指南

## 📋 问题说明

**用户反馈：** 账户余额和持仓信息显示为"-- USDT"和"暂无持仓"

**根本原因：** 系统设计上需要用户配置OKX API凭证后才能查询实时数据

## ✅ 这不是Bug！

系统按照设计正常工作：
- **未配置API凭证时：** 显示"未配置"提示，提醒用户需要配置
- **配置API凭证后：** 自动从OKX获取实时余额和持仓数据

## 🔧 如何配置API凭证

### 步骤1：获取OKX API凭证

1. 登录OKX官网 (https://www.okx.com)
2. 进入"个人中心" → "API管理"
3. 创建新的API Key，需要以下权限：
   - ✅ 查看账户权限（必须）
   - ✅ 查看交易权限（必须）
   - ❌ 交易权限（根据需求选择）
4. 保存以下信息：
   - **API Key**
   - **API Secret**
   - **Passphrase**（创建时设置的密码）

### 步骤2：在系统中配置API

1. 访问OKX交易页面：
   ```
   https://5000-i4rq388xy9v1hw2uaz7ln-8f57ffe2.sandbox.novita.ai/okx-trading
   ```

2. 点击账户标签（例如"账户1 (主账户)"）旁边的"编辑"按钮

3. 在弹出的表单中填入：
   - **账户名称**：自定义名称（例如：主账户）
   - **API Key**：从OKX获取的API Key
   - **API Secret**：从OKX获取的API Secret
   - **Passphrase**：创建API Key时设置的密码

4. 点击"保存"按钮

5. 系统会自动：
   - 验证API凭证
   - 从OKX获取账户余额
   - 自动填充余额信息

### 步骤3：验证配置成功

配置成功后，右侧账户信息面板会显示：

```
💰 账户信息
总权益: 1234.56 USDT
可用余额: 1000.00 USDT
持仓保证金: 234.56 USDT
未实现盈亏: +50.00 USDT
冻结余额: 0.00 USDT

📊 持仓 (2)
[显示所有持仓列表]
```

## 🔄 数据刷新机制

系统提供多种方式更新数据：

1. **自动刷新**：每30秒自动从OKX获取最新数据
2. **手动刷新**：点击"🔄"按钮立即刷新
3. **切换账户**：切换账户时自动刷新该账户数据

## 🔐 安全提示

1. **API密钥安全**
   - 不要与他人分享API密钥
   - 建议创建只读权限的API（不包含交易权限）
   - 定期更换API密钥

2. **数据存储**
   - API凭证存储在浏览器本地存储（localStorage）
   - 不会上传到服务器
   - 仅在API调用时使用

3. **网络安全**
   - 所有API调用使用HTTPS加密
   - 使用OKX官方API签名机制

## 📊 API端点说明

系统使用以下OKX API端点：

### 1. 获取账户余额
```
GET https://www.okx.com/api/v5/account/balance
```
返回数据：
- 总权益（USD）
- 可用余额（USDT）
- 冻结余额（USDT）
- 未实现盈亏（USDT）

### 2. 获取持仓信息
```
GET https://www.okx.com/api/v5/account/positions
```
返回数据：
- 合约代码
- 持仓方向（多/空）
- 持仓数量
- 杠杆倍数
- 开仓均价
- 标记价格
- 未实现盈亏

## 🎯 UI改进（本次更新）

### 改进前
- 显示"-- USDT"，用户不清楚原因
- 持仓显示"暂无持仓"，无法区分是真的没有持仓还是未配置

### 改进后
- 显示"未配置"，明确提示用户
- 添加醒目的配置提示横幅
- 持仓显示"请先配置账户API凭证"
- 提供详细的配置步骤说明

### 新增配置提示横幅
```
⚠️ 需要配置API凭证
当前账户未配置OKX API凭证，无法查询账户余额和持仓信息。
请点击账户标签上的"编辑"按钮，填入您的API Key、API Secret和Passphrase。
```

## 🔍 故障排查

### 问题1：配置后仍显示"未配置"
**解决方案：**
- 刷新页面
- 检查API凭证是否正确保存
- 查看浏览器控制台是否有错误

### 问题2：显示"Invalid OK-ACCESS-KEY"错误
**解决方案：**
- 检查API Key是否复制正确
- 检查API Secret是否复制正确
- 检查Passphrase是否正确
- 确认API权限包含"查看账户"和"查看交易"

### 问题3：余额显示为0
**可能原因：**
- 账户确实没有余额
- API权限不足
- 选择了错误的账户

**解决方案：**
- 登录OKX官网核实账户余额
- 检查API权限设置
- 确认使用了正确的API凭证

## 📝 代码变更记录

### 修改文件
- `source_code/templates/okx_trading.html`

### 主要变更

1. **添加配置提示横幅**
   ```html
   <div id="apiConfigNotice" style="display: none; ...">
       ⚠️ 需要配置API凭证
       ...
   </div>
   ```

2. **修改loadAccountInfo函数**
   - 未配置时显示"未配置"而非"-- USDT"
   - 自动显示配置提示横幅

3. **修改loadPositions函数**
   - 未配置时显示"请先配置账户API凭证"
   - 提供明确的操作指引

4. **新增辅助函数**
   ```javascript
   function showApiConfigNotice()  // 显示配置提示
   function hideApiConfigNotice()  // 隐藏配置提示
   ```

## 🌐 访问地址

```
https://5000-i4rq388xy9v1hw2uaz7ln-8f57ffe2.sandbox.novita.ai/okx-trading
```

## 📚 相关文档

- [OKX_AUTO_BALANCE_FETCH_2026_01_19.md](./OKX_AUTO_BALANCE_FETCH_2026_01_19.md) - 自动获取余额功能实现
- [ANCHOR_MONITORS_FIX_2026_01_19.md](./ANCHOR_MONITORS_FIX_2026_01_19.md) - 锚定系统监控修复

## ✅ 总结

**问题性质：** 不是Bug，是需要用户配置

**解决方案：** 
1. 改进UI提示，让用户明确知道需要配置API凭证
2. 添加详细的配置指南
3. 优化用户体验

**用户操作：**
1. 获取OKX API凭证
2. 在系统中配置凭证
3. 系统自动获取并显示实时数据

---

**最后更新：** 2026-01-19
**版本：** v1.0
