# 负值角度标记系统完成报告

## 📋 用户需求

> **"负值的标记用其他的形式表现 负值也是可以标记的"**

用户希望能够标记**负值峰值**（下跌趋势的最低点），并使用不同的形式来区分正负值。

---

## ✅ 实现方案

### 1. 后端分析器增强

#### 新增负值峰值检测
修改 `find_all_peaks()` 函数，同时检测：
- **正峰值**（局部最大值，>=5%）
- **负峰值**（局部最小值，<=-5%）

```python
def find_all_peaks(data_points):
    positive_peaks = []  # 正值峰值（局部最大值）
    negative_peaks = []  # 负值峰值（局部最小值）
    
    # 检查局部最大值（正峰值）
    if current_value >= MIN_PEAK_VALUE:
        positive_peaks.append(i)
    
    # 检查局部最小值（负峰值）
    if current_value <= -MIN_PEAK_VALUE:
        negative_peaks.append(i)
    
    return positive_peaks, negative_peaks
```

#### 新增负值角度计算
- **正峰值**：找峰值后的谷底（下跌）→ 计算上升角度
- **负峰值**：找谷底后的回升点（上升）→ 计算下降角度

```python
def find_recovery_after_trough(data_points, trough_idx):
    """在谷底（负峰值）后找回升点"""
    # 找到负峰值后的回升点
    
def calculate_negative_angle_visual(data_points, c_prime_idx, trough_idx):
    """计算负角度（下降趋势的角度）"""
    # 计算从C'点到负峰值的下降角度
```

---

### 2. 前端显示区分

#### 四种角度类型

| 类型 | 图标 | 颜色 | 形状 | 说明 |
|------|------|------|------|------|
| **↗️ 上升锐角** | 🔺 | 红色 `#e53e3e` | 正三角形 ▲ | 正值，角度<45° |
| **↗️ 上升钝角** | 🔶 | 橙色 `#dd6b20` | 方块 ■ | 正值，角度>=45° |
| **↘️ 下降锐角** | 🔻 | 蓝色 `#3182ce` | 倒三角形 ▼ | 负值，角度<45° |
| **↘️ 下降钝角** | 🔷 | 紫色 `#805ad5` | 菱形 ◆ | 负值，角度>=45° |

#### 标签显示位置
- **上升角度**：标签显示在**上方**（position: 'top'）
- **下降角度**：标签显示在**下方**（position: 'bottom'）

---

## 📊 数据统计

### 重新生成数据结果

| 日期 | 正峰值 | 负峰值 | 上升角度 | 下降角度 | 总计 |
|------|--------|--------|----------|----------|------|
| **2月8日** | 27个 | 9个 | 17个 (14锐+3钝) | 8个 (7锐+1钝) | **25个** |
| **2月9日** | 3个 | 36个 | 3个 (3锐+0钝) | 23个 (16锐+7钝) | **26个** |
| **2月10日** | 17个 | 1个 | 11个 (9锐+2钝) | 1个 (0锐+1钝) | **12个** |

### 2月9号详细数据（示例）

```
↗️ 🔺 锐角 9.01° - 峰值: 02:37:00 (8.78%)
↘️ 🔺 锐角 1.78° - 峰值: 03:34:00 (-6.56%)
↗️ 🔺 锐角 6.95° - 峰值: 03:56:00 (7.15%)
↘️ 🔺 锐角 0.99° - 峰值: 04:55:00 (-25.42%)
↘️ 🔻 钝角 81.19° - 峰值: 05:39:00 (-42.16%)
...
↗️ 🔺 锐角 22.30° - 峰值: 07:08:00 (24.57%)
↘️ 🔺 锐角 4.53° - 峰值: 07:25:00 (-38.77%)
```

---

## 🎨 视觉效果

### 图表标记示例

```
              ▲ 9.0°               ▲ 22.3°
           (8.78%)              (24.57%)
         ┌────────┐            ┌────────┐
         │ 上升   │            │ 上升   │
         └────────┘            └────────┘

                    ▼ 1.8°
                  (-6.56%)
                 ┌────────┐
                 │ 下降   │
                 └────────┘
```

### 图例说明
- **红色三角形 ▲**：上升锐角（快速上涨）
- **橙色方块 ■**：上升钝角（缓慢上涨）
- **蓝色倒三角 ▼**：下降锐角（快速下跌）
- **紫色菱形 ◆**：下降钝角（缓慢下跌）

---

## 🔧 技术实现细节

### 参数配置

```python
# 峰值检测参数
MIN_PEAK_VALUE = 5  # 最小峰值（%）- 同时用于正负值
MIN_PEAK_DISTANCE = 30  # 最小峰值间距（分钟）
MIN_VALLEY_TIME_GAP = 2  # C点与A点的最小时间间隔（分钟）
```

### 前端标记配置

```javascript
// 上升锐角（红色三角形）
{
    symbol: 'triangle',
    symbolSize: 25,
    symbolRotate: 0,  // 尖端向上
    color: '#e53e3e',
    label: { position: 'top' }
}

// 下降锐角（蓝色倒三角）
{
    symbol: 'triangle',
    symbolSize: 25,
    symbolRotate: 180,  // 尖端向下
    color: '#3182ce',
    label: { position: 'bottom' }
}
```

---

## 🌐 测试地址

https://5000-idfgz76cf9poiqtgzfhan-c81df28e.sandbox.novita.ai/okx-trading-marks

### 测试步骤

1. **选择日期 2月9号**
   - 应看到 **26个角度标记**
   - 3个上升角度（红色三角形）
   - 23个下降角度（蓝色/紫色标记）

2. **鼠标悬停查看详情**
   - 上升角度：显示"峰值"和正百分比
   - 下降角度：显示"谷底"和负百分比

3. **观察标签位置**
   - 上升角度标签在**上方**
   - 下降角度标签在**下方**

---

## 📝 API 响应示例

```json
{
  "success": true,
  "data": [
    {
      "date": "20260209",
      "hour": "02",
      "angle": 9.01,
      "type": "acute",
      "direction": "up",
      "peak_time": "02:37:00",
      "peak_price": 8.78
    },
    {
      "date": "20260209",
      "hour": "03",
      "angle": 1.78,
      "type": "acute",
      "direction": "down",
      "peak_time": "03:34:00",
      "peak_price": -6.56
    }
  ]
}
```

---

## 🎯 优化效果

### 问题1：2月9号只有1个角度 ✅ 已修复
- **修复前**：只显示1个上升角度
- **修复后**：显示26个角度（3个上升 + 23个下降）
- **原因**：
  - 降低峰值阈值：15% → 5%
  - 放宽C'点匹配：5% → 10%
  - 新增负值峰值检测

### 问题2：角度标记看不到数字 ✅ 已修复
- **修复前**：标签可能被遮挡或不显示
- **修复后**：
  - 标签始终显示（`show: true`）
  - 增大字体（12-14px）
  - 增加对比度（白字+彩色背景）
  - 上升角度标签在上方，下降角度标签在下方

---

## 📚 文件清单

### 后端
- `collectors/okx_angle_analyzer_v3.py` - 角度分析器（已支持负值）
- `app.py` - API接口（/api/okx-trading/angles）
- `data/okx_angle_analysis/okx_angles_*.jsonl` - 角度数据

### 前端
- `templates/okx_trading_marks.html` - 前端展示页面
  - `createAngleSeries()` - 角度标记函数（已重写）
  - 支持4种角度类型显示

---

## ✅ 完成清单

- [x] 后端：检测正值峰值（局部最大值）
- [x] 后端：检测负值峰值（局部最小值）
- [x] 后端：计算上升角度（正峰值）
- [x] 后端：计算下降角度（负峰值）
- [x] 后端：每小时保留最高正峰值
- [x] 后端：每小时保留最低负峰值
- [x] 后端：添加direction字段（up/down）
- [x] 前端：上升锐角（红色三角形）
- [x] 前端：上升钝角（橙色方块）
- [x] 前端：下降锐角（蓝色倒三角）
- [x] 前端：下降钝角（紫色菱形）
- [x] 前端：标签位置区分（上/下）
- [x] 前端：Tooltip显示方向
- [x] 数据：重新生成2月8-10号数据
- [x] 测试：验证API返回
- [x] 测试：验证前端显示

---

## 🎉 总结

1. ✅ **负值峰值检测**：成功识别下跌趋势的最低点
2. ✅ **视觉区分明确**：4种颜色+形状组合，一目了然
3. ✅ **数据完整**：2月9号从1个角度增加到26个角度
4. ✅ **标签清晰可见**：始终显示，位置合理，对比度高

**现在请访问页面测试效果，特别关注2月9号的下降角度标记！**

---

## 📅 完成时间
- 2026-02-10 08:45

## 🔗 相关文件
- `collectors/okx_angle_analyzer_v3.py` - 角度分析器
- `templates/okx_trading_marks.html` - 前端页面
- `data/okx_angle_analysis/` - 角度数据目录
