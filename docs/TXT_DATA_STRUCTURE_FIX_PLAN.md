# TXT数据结构修复计划

## 🔴 问题分析

### 当前问题
1. **TXT解析不完整**: 只解析了币种数据，跳过了透明标签聚合数据
2. **缺少字段对应关系**: 没有提取TXT中的透明标签字段
3. **图表数据源错误**: 图表使用的是旧数据库数据，不是JSONL
4. **缺少优先级计算**: 没有实现基于最高占比/最低占比的优先级逻辑
5. **缺少计次得分**: 没有实现基于时间段和计次的星级计算

## 📋 TXT文件字段对应关系

### 透明标签字段（聚合数据）
```
TXT字段                          -> 系统字段名        -> 示例值
透明标签_急涨总和               -> rush_up_total    -> 14
透明标签_急跌总和               -> rush_down_total  -> 18
透明标签_五种状态               -> status           -> 震荡无序
透明标签_急涨急跌比值           -> ratio            -> 0.29
透明标签_计次                   -> count_aggregate  -> 3
透明标签_差值结果               -> diff_total       -> -4
透明标签_比价最低得分           -> price_lowest     -> 0
透明标签_仓位得分(比价创新高)   -> price_newhigh    -> 1
```

### 币种数据字段（需要调整）
```
原字段顺序:
序号|币名|急涨|急跌|更新时间|历史高位|高位时间|距离高位跌幅|24涨幅|+4%|-3%|排行|当前价格|最高占比|最低占比|

需要调整为:
优先级|币名|急涨|急跌|更新时间|历史高位|高位时间|距离高位跌幅|24涨幅|排行|当前价格|最高占比|最低占比|计次|计次得分|

移除字段: +4%, -3%
新增字段: 计次, 计次得分
调整顺序: 优先级放在第一位
```

## 🎯 优先级计算规则

### 等级1-5规则（基于最高占比和最低占比）
| 等级 | 最高占比条件 | 最低占比条件 |
|------|-------------|-------------|
| 等级1 | > 90 | > 120 |
| 等级2 | > 80 | > 120 |
| 等级3 | > 90 | > 110 |
| 等级4 | > 70 | > 120 |
| 等级5 | > 80 | > 110 |

### 等级6规则（带计次得分）
**条件**: 最高占比 < 80 且 最低占比 < 110

**计次得分规则**（基于时间段）:

#### 6点前（00:00-06:00）
| 计次范围 | 显示 |
|---------|------|
| ≤1 | ★★★ |
| ≤2且>1 | ★★ |
| ≤3且>2 | ★ |
| >3且≤4 | ☆ |
| >4且≤5 | ☆☆ |
| >5 | ☆☆☆ |

#### 12点前（06:00-12:00）
| 计次范围 | 显示 |
|---------|------|
| ≤2 | ★★★ |
| ≤3且>2 | ★★ |
| ≤4且>3 | ★ |
| >5且≤6 | ☆ |
| >6且≤7 | ☆☆ |
| >7 | ☆☆☆ |

#### 18点前（12:00-18:00）
| 计次范围 | 显示 |
|---------|------|
| ≤3 | ★★★ |
| ≤4且>3 | ★★ |
| ≤5且>4 | ★ |
| >7且≤8 | ☆ |
| >8且≤9 | ☆☆ |
| >9 | ☆☆☆ |

#### 24点前（18:00-24:00）
| 计次范围 | 显示 |
|---------|------|
| ≤4 | ★★★ |
| ≤5且>4 | ★★ |
| ≤6且>5 | ★ |
| >9且≤10 | ☆ |
| >10且≤11 | ☆☆ |
| >11 | ☆☆☆ |

## 🔧 实施步骤

### 步骤1: 修改TXT解析代码（gdrive_detector_jsonl.py）
- [ ] 提取透明标签聚合数据
- [ ] 解析最高占比、最低占比字段
- [ ] 保存到单独的聚合JSONL文件
- [ ] 移除+4%和-3%字段
- [ ] 添加计次字段到币种数据

### 步骤2: 实现优先级计算函数
- [ ] 创建priority_calculator.py
- [ ] 实现等级1-5判断逻辑
- [ ] 实现等级6的计次得分计算
- [ ] 根据当前时间段选择计次规则

### 步骤3: 修改API端点
- [ ] `/api/latest`: 添加聚合数据和优先级
- [ ] `/api/query`: 添加聚合数据和优先级
- [ ] `/api/index/current`: 使用透明标签数据
- [ ] `/api/index/history`: 使用透明标签数据

### 步骤4: 删除旧图表数据源
- [ ] 识别crypto_index页面使用的SQLite表
- [ ] 删除相关SQLite查询代码
- [ ] 切换到JSONL数据源

### 步骤5: 前端显示调整
- [ ] 调整币种列表显示顺序（优先级在前）
- [ ] 显示计次得分（星级）
- [ ] 移除+4%和-3%列
- [ ] 显示透明标签聚合数据

## 📦 新增数据结构

### 聚合数据JSONL（crypto_aggregate.jsonl）
```json
{
  "snapshot_time": "2026-01-14 22:10:00",
  "rush_up_total": 14,
  "rush_down_total": 18,
  "diff_total": -4,
  "ratio": 0.29,
  "status": "震荡无序",
  "count_aggregate": 3,
  "price_lowest": 0,
  "price_newhigh": 1
}
```

### 币种数据JSONL（扩展字段）
```json
{
  "snapshot_time": "2026-01-14 22:10:00",
  "inst_id": "BTC",
  "priority": 2,
  "priority_level": "等级2",
  "count_score": "★★",
  "count_score_value": 2,
  "max_ratio": 85.5,
  "min_ratio": 125.3,
  "rush_up": 1,
  "rush_down": 0,
  "count": 13,
  "last_price": 126259.48,
  "change_24h": -24.7,
  ...
}
```

## ✅ 验证标准

1. **TXT解析完整性**: 所有透明标签字段正确提取
2. **优先级准确性**: 等级1-6计算正确
3. **计次得分准确性**: 星级显示符合时间段规则
4. **API数据一致性**: 返回数据与TXT源文件100%匹配
5. **图表数据正确性**: 使用JSONL数据源，显示最新数据

## 📝 注意事项

1. TXT文件中的数据是**直接取值**，不需要累加计算
2. 优先级必须放在币种列表的**第一列**
3. 计次得分根据**当前时间段**动态计算
4. 图表数据必须从**JSONL读取**，不能用SQLite
5. 所有聚合数据来自透明标签，不能自己计算

---

**创建时间**: 2026-01-14 23:30  
**状态**: 待实施  
**优先级**: 🔴 最高
