# 日内模式监控功能说明

## 📋 概述

日内模式监控器是一个全时间段 (2:00-23:59) 的自动监控系统，用于检测27个币种10分钟级别的价格模式，并根据大周期（0-2点预判）控制小周期操作信号。

## 🎯 监控的四种模式

### 情况1：诱多等待新低
- **触发条件**：连续3根柱子出现 `红→黄→绿` 或 `绿→黄→红`
- **操作信号**：📉 **逢高做空**
- **信号类型**：`short` (做空)
- **含义**：出现诱多信号，可能还有新低，建议等待更好的入场点

### 情况2：诱空试仓抄底
- **触发条件**：红柱子后连续出现3个空白柱子
- **额外限制**：空白柱子占当天总柱子数的比例 ≤ 25%
- **操作信号**：🟢 **开多单试仓**
- **信号类型**：`long` (做多)
- **含义**：出现诱空信号，可以小仓位试仓抄底

### 情况3：筑底信号
- **触发条件**：连续3根柱子出现 `黄→绿→黄`
- **操作信号**：🟡 **逢低做多**
- **信号类型**：`long` (做多)
- **含义**：黄绿黄形态表明底部正在形成，建议分批建仓

### 情况4：诱空信号
- **触发条件A**：连续4根柱子出现 `绿→红→红→绿`
- **触发条件B**：连续3根柱子出现 `绿→红→绿`
- **操作信号**：🟢 **逢低做多**
- **信号类型**：`long` (做多)
- **含义**：V型反转形态，诱空后快速拉升，把握反弹机会

## 🔴🟡🟢 柱子颜色规则

- **🟢 绿色**：上涨币种占比 > 55%
- **🟡 黄色**：上涨币种占比 45% - 55%
- **🔴 红色**：上涨币种占比 < 45%
- **⚪ 空白**：上涨币种占比 = 0%

## 🔄 大周期控制逻辑（小周期服从大周期）

监控器会读取每日0-2点的预判信号，并据此过滤小周期操作：

### 做空方向预判
当日预判为以下信号时，**禁止所有做多操作**：
- ❌ 做空
- ❌ 等待新低
- ❌ 诱多不参与
- ❌ 观望

### 做多方向预判
当日预判为以下信号时，**禁止所有做空操作**：
- ✅ 低吸
- ✅ 诱空试盘抄底

### 无预判
- 如果无法获取预判数据，允许所有信号执行

## 📊 示例场景

### 场景1: 大周期观望
```
大周期预判: 观望
检测结果:
- ✅ 模式1 (红→黄→绿，逢高做空): 允许执行 (与大周期一致)
- ❌ 模式2 (诱空试仓抄底): 被阻止 (做多操作被禁止)
- ❌ 模式3 (筑底信号): 被阻止 (做多操作被禁止)
- ❌ 模式4 (诱空信号): 被阻止 (做多操作被禁止)
```

### 场景2: 大周期低吸
```
大周期预判: 低吸
检测结果:
- ❌ 模式1 (红→黄→绿，逢高做空): 被阻止 (做空操作被禁止)
- ✅ 模式2 (诱空试仓抄底): 允许执行 (与大周期一致)
- ✅ 模式3 (筑底信号): 允许执行 (与大周期一致)
- ✅ 模式4 (诱空信号): 允许执行 (与大周期一致)
```

## ⚙️ 监控配置

| 配置项 | 值 |
|--------|-----|
| 监控时间段 | 02:00 - 23:59 (北京时间) |
| 检查频率 | 每10分钟 |
| 数据源 | 27币种10分钟上涨占比 |
| 通知渠道 | Telegram |
| 通知策略 | 每个模式每天只通知一次 |
| 日志位置 | `logs/intraday_pattern_monitor.log` |
| 检测记录 | `data/intraday_patterns/detections_{date}.jsonl` |

## 🚀 启动监控器

```bash
# 启动监控器 (后台运行)
cd /home/user/webapp
nohup python3 monitors/intraday_pattern_monitor.py > logs/intraday_pattern_monitor.log 2>&1 &

# 查看日志
tail -f logs/intraday_pattern_monitor.log

# 检查进程
ps aux | grep intraday_pattern_monitor

# 停止监控器
pkill -f intraday_pattern_monitor.py
```

## 📈 监控数据来源

- **API端点**：`http://localhost:9002/api/coin-change-tracker/history`
- **预判API**：`http://localhost:9002/api/coin-change-tracker/daily-prediction`
- **查看页面**：https://9002-iopxcqas7abbrajoi4k4x-2e77fc33.sandbox.novita.ai/coin-change-tracker

## 📝 日志示例

```
[2026-02-23 11:52:36] ================================================================================
[2026-02-23 11:52:36] 🔍 开始检查模式 [2026-02-23 11:52:36]
[2026-02-23 11:52:36] ================================================================================
[2026-02-23 11:52:36] ✅ 获取到 561 条数据记录
[2026-02-23 11:52:36] 📊 当前共有 72 个10分钟柱子
[2026-02-23 11:52:36] 📈 颜色分布: 绿色1根, 黄色4根, 红色50根, 空白17根
[2026-02-23 11:52:36] ✅ 获取到今日预判: 观望
[2026-02-23 11:52:36] 🎯 检测到pattern1: 诱多等待新低
[2026-02-23 11:52:36]    类型: 红→黄→绿
[2026-02-23 11:52:36]    时间范围: 06:30 - 06:50
[2026-02-23 11:52:36]    信号: 逢高做空
[2026-02-23 11:52:36] ✅ 信号通过大周期检查: 与大周期一致或中性，允许执行
[2026-02-23 11:52:36] ℹ️ 今天已经通知过此模式，跳过
[2026-02-23 11:52:36] 🎯 检测到pattern2: 诱空试仓抄底
[2026-02-23 11:52:36]    类型: N/A
[2026-02-23 11:52:36]    时间范围: 09:00 - 09:30
[2026-02-23 11:52:36]    信号: 开多单试仓
[2026-02-23 11:52:36] 🚫 信号被大周期过滤: 大周期为做空信号(观望)，禁止做多
```

## 🔧 技术实现

### 代码结构
```python
monitors/
  intraday_pattern_monitor.py  # 主监控脚本
  
data/
  intraday_patterns/
    detections_2026-02-23.jsonl  # 每日检测记录
    
logs/
  intraday_pattern_monitor.log  # 运行日志
```

### 关键函数
- `fetch_today_data()`: 获取今日10分钟柱状图数据
- `get_daily_prediction()`: 获取今日0-2点预判
- `is_signal_allowed()`: 大周期控制逻辑
- `check_pattern_1/2/3/4()`: 检测各种模式
- `send_pattern_notification()`: 发送Telegram通知
- `monitor_loop()`: 主监控循环

## 📞 Telegram通知示例

```
🟢 【日内模式检测】诱空信号

⏰ 检测时间: 14:30:25
📊 模式: 绿→红→绿 (3根)
⚠️ 操作信号: 逢低做多

📈 检测到的柱子:
   13:50 52.3%
   14:00 42.1%
   14:10 58.7%

📅 大周期预判: 低吸

💡 操作建议:
   V型反转形态，诱空后快速拉升
   建议：逢低做多，把握反弹机会

🔗 查看详情: https://9002-iopxcqas7abbrajoi4k4x-2e77fc33.sandbox.novita.ai/coin-change-tracker
```

## ⚠️ 注意事项

1. **大周期优先**：小周期必须服从大周期方向，否则信号被过滤
2. **每日一次**：同一模式每天只通知一次，避免重复提醒
3. **空白比例**：情况2要求空白柱子占比 ≤ 25%
4. **监控时间**：只在 02:00-23:59 时间段内运行检查
5. **数据延迟**：基于10分钟级别数据，可能存在轻微延迟

## 📚 相关文档

- [0-2点行情预判系统](./0-2点行情预判系统.md)
- [币种涨跌监控页面](https://9002-iopxcqas7abbrajoi4k4x-2e77fc33.sandbox.novita.ai/coin-change-tracker)
- [OKX交易管理页面](https://9002-iopxcqas7abbrajoi4k4x-2e77fc33.sandbox.novita.ai/okx-trading)
