# 🔔 预警触发完整测试指南

## 📋 问题原因

您的预警**已经触发过一次了**！之后开关被自动关闭，所以不会再次触发。

### 当前状态
```json
{
  "lowerEnabled": false,    ← 下限开关已关闭
  "lowerTriggered": true,   ← 已经触发过
  "lowerThreshold": -40,    
  "currentValue": -47.33    ← 当前值
}
```

## ✅ 解决方案

### 步骤 1: 重新开启预警

1. 打开页面: https://5000-idfgz76cf9poiqtgzfhan-c81df28e.sandbox.novita.ai/coin-change-tracker
2. 找到页面顶部的"涨跌预警设置"面板
3. 确认阈值设置：
   - 上涨阈值: **30%**
   - 下跌阈值: **-40%**
4. **重新开启"下跌预警"开关**（变成绿色）
5. 点击"💾 保存预警设置"按钮

### 步骤 2: 等待触发

- 预警会在下次自动刷新时检查（每10秒）
- 当前值 **-47.33%** < **-40%**，应该会立即触发

### 步骤 3: 验证预警功能

触发后您应该看到：

1. **🔊 音效**
   - 播放3次"哔哔"声
   - 频率: 800Hz → 1000Hz → 800Hz

2. **📝 弹窗**
   - 标题: "🟢 跌幅预警触发"
   - 当前累计涨跌幅: -47.33%
   - 阈值: -40%
   - 触发币种列表
   - 两个按钮: "关闭" 和 "刷新数据"
   - 5秒后自动关闭

3. **📱 Telegram通知**
   - 如果开启了 Telegram 开关
   - 消息内容同弹窗

4. **🔴 开关自动关闭**
   - "下跌预警"开关变成灰色
   - 防止重复触发

## 🔧 调试方法

### 方法 1: 查看控制台日志

按 **F12** 打开开发者工具，查看控制台，应该看到：

```
🔍 checkAlerts 被调用，数据: {...}
📊 当前值: -47.33, 上限: 30, 下限: -40
🔔 上限开关: true, 下限开关: true
🟢 触发下限预警: -47.33 <= -40
🎵 playAlertSound 被调用
🔊 预警音效已播放
📢 showAlertDialog 被调用: {type: 'lower', value: -47.33, coins: ...}
✅ Telegram通知已发送
💾 预警设置已保存到服务器
```

### 方法 2: 手动触发测试

在控制台执行：

```javascript
// 检查当前状态
console.log('当前预警状态:', alertState);

// 手动触发预警检查
checkAlerts({
  cumulative_pct: -47.33,
  changes: window.currentCoinsData || {}
});
```

### 方法 3: 降低阈值快速测试

如果想更容易触发：

1. 将下跌阈值改为 **-45%**（比当前值高）
2. 开启"下跌预警"开关
3. 保存设置
4. 等待10秒

## 🎯 预警逻辑说明

### 触发条件

**下跌预警触发条件**（三个条件同时满足）：
```
lowerEnabled === true       (开关已开启)
&&
lowerTriggered === false    (本次未触发过)
&&
currentValue <= lowerThreshold  (当前值 <= 阈值)
```

### 防重复触发机制

1. **触发后自动关闭**: 预警触发后，对应的开关会自动关闭
2. **状态标记**: `lowerTriggered` 标记为 `true`
3. **手动重置**: 需要手动重新开启开关才能再次触发
4. **时间限制**: 两次检查至少间隔10秒

### 重置方法

**方法 1**: 手动重新开启开关
- 在页面上点击开关重新打开
- 点击"保存设置"

**方法 2**: 修改阈值
- 修改阈值会自动重置 `triggered` 状态

**方法 3**: 点击"恢复默认"按钮

## 📞 需要帮助？

如果仍然没有触发，请提供：

1. 控制台截图（按F12）
2. 当前预警设置的截图
3. 页面显示的当前涨跌幅

---

## ⚠️ 重要提醒

**预警只会触发一次！** 触发后开关会自动关闭，这是设计行为，目的是：
- 避免频繁触发造成骚扰
- 用户看到预警后可以决定是否继续监控
- 需要继续监控时手动重新开启即可
