# Queryç³»ç»Ÿå®Œæ•´æ”¹é€ æ€»ç»“æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2026-01-14 18:10:00  
**æ”¹é€ ç±»åž‹**: Queryç³»ç»Ÿå…¨é¢JSONLåŒ–  
**çŠ¶æ€**: âœ… å…¨éƒ¨å®Œæˆ

---

## ðŸ“‹ æ”¹é€ æ¦‚è¿°

å°†Queryç³»ç»Ÿä»ŽSQLiteæ•°æ®åº“å®Œå…¨è¿ç§»åˆ°JSONLæ–‡ä»¶å­˜å‚¨ï¼Œå®žçŽ°ï¼š
- TXTæ–‡ä»¶è‡ªåŠ¨è§£æžå’Œå¯¼å…¥
- ä¼˜å…ˆçº§æ™ºèƒ½è®¡ç®—ï¼ˆ6çº§åˆ†ç±»ï¼‰
- APIå…¨é¢ä½¿ç”¨JSONLæ•°æ®æº
- æ•°æ®å®Œæ•´æ€§éªŒè¯

---

## ðŸŽ¯ æ ¸å¿ƒåŠŸèƒ½å®žçŽ°

### 1. æ•°æ®è¿ç§»åˆ°JSONL

#### å¿«ç…§æ•°æ® (snapshots.jsonl)
- **è¿ç§»è®°å½•æ•°**: 26,557 æ¡
- **æ—¶é—´è·¨åº¦**: 2025-12-09 è‡³ 2026-01-14
- **å”¯ä¸€æ—¶é—´ç‚¹**: 2,560 ä¸ª
- **æœ€æ–°æ—¶é—´**: 2026-01-14 17:30:01

**å­—æ®µç»“æž„**:
```json
{
  "snapshot_date": "2026-01-14",
  "snapshot_time": "2026-01-14 17:30:01",
  "rush_up": 14,
  "rush_down": 18,
  "diff": -4,
  "count": 3,
  "ratio": 0,
  "status": "éœ‡è¡æ— åº",
  "round_rush_up": 0,
  "round_rush_down": 0,
  "price_lowest": 0,
  "price_newhigh": 1,
  "count_score_display": "",
  "count_score_type": "",
  "rise_24h_count": 0,
  "fall_24h_count": 0
}
```

#### å¸ç§æ•°æ® (coins.jsonl)
- **å½“å‰è®°å½•æ•°**: 3 æ¡ï¼ˆæµ‹è¯•æ•°æ®ï¼‰
- **æ”¯æŒåŠ¨æ€å¯¼å…¥**: ä»ŽTXTæ–‡ä»¶è§£æž

**å­—æ®µç»“æž„**:
```json
{
  "snapshot_time": "2026-01-14 17:30:01",
  "index_order": 1,
  "symbol": "BTC",
  "rush_up": 2,
  "rush_down": 1,
  "update_time": "2025-10-07",
  "high_price": 126259.48,
  "high_time": "2025-10-07",
  "decline": -26.6,
  "change_24h": 1.38,
  "rank": 13,
  "current_price": 91098.9,
  "priority": 1,
  "priority_level": "ç­‰çº§1",
  "ratio1": 95.5,
  "ratio2": 125.3
}
```

---

### 2. TXTæ–‡ä»¶è§£æž

#### æ”¯æŒçš„æ•°æ®æ ¼å¼

**é€æ˜Žæ ‡ç­¾æ˜ å°„**:
```
é€æ˜Žæ ‡ç­¾_æ€¥æ¶¨æ€»å’Œ â†’ rush_up
é€æ˜Žæ ‡ç­¾_æ€¥è·Œæ€»å’Œ â†’ rush_down
é€æ˜Žæ ‡ç­¾_äº”ç§çŠ¶æ€ â†’ status
é€æ˜Žæ ‡ç­¾_è®¡æ¬¡ â†’ count
é€æ˜Žæ ‡ç­¾_æ¯”ä»·æœ€ä½Žå¾—åˆ† â†’ price_lowest
é€æ˜Žæ ‡ç­¾_ä»“ä½å¾—åˆ† â†’ price_newhigh
é€æ˜Žæ ‡ç­¾_å·®å€¼ç»“æžœ â†’ diff
```

**å¸ç§æ•°æ®æ ¼å¼**:
```
åºå·|å¸å|æ€¥æ¶¨|æ€¥è·Œ|æ›´æ–°æ—¶é—´|åŽ†å²é«˜ä½|é«˜ä½æ—¶é—´|è·ç¦»é«˜ä½è·Œå¹…|24æ¶¨å¹…|æŽ’è¡Œ|å½“å‰ä»·æ ¼|æœ€é«˜å æ¯”|æœ€ä½Žå æ¯”
```

ç§»é™¤å­—æ®µ: `+4%`, `-3%`ï¼ˆå·²æŒ‰è¦æ±‚åŽ»é™¤ï¼‰

#### è§£æžç¤ºä¾‹
```python
from migrate_query_to_jsonl import parse_txt_content

txt_content = """
[è¶…çº§åˆ—è¡¨æ¡†_é¦–é¡µå¼€å§‹]
é€æ˜Žæ ‡ç­¾_æ€¥æ¶¨æ€»å’Œ=æ€¥æ¶¨ï¼š14
é€æ˜Žæ ‡ç­¾_æ€¥è·Œæ€»å’Œ=æ€¥è·Œï¼š18
...
1|BTC|0.11|0|0|2026-01-05 15:08:15|126259.48|2025-10-07|-26.6|1.38|||13|91098.9|72.66%|111.97%
"""

snapshot_data, currency_data = parse_txt_content(txt_content, '2026-01-14 17:30:01')
```

---

### 3. ä¼˜å…ˆçº§æ™ºèƒ½è®¡ç®—

#### 6çº§ä¼˜å…ˆçº§ç³»ç»Ÿ

| ç­‰çº§ | æœ€é«˜å æ¯” (ratio1) | æœ€ä½Žå æ¯” (ratio2) | æè¿° |
|------|------------------|------------------|------|
| **ç­‰çº§1** | > 90% | > 120% | æœ€ä¼˜è´¨ |
| **ç­‰çº§2** | > 80% | > 120% | ä¼˜è´¨ |
| **ç­‰çº§3** | > 90% | > 110% | è‰¯å¥½ |
| **ç­‰çº§4** | > 70% | > 120% | ä¸­ç­‰åä¸Š |
| **ç­‰çº§5** | > 80% | > 110% | ä¸­ç­‰ |
| **ç­‰çº§6** | < 80% | < 110% | ä¸€èˆ¬ |

#### ä¼˜å…ˆçº§åˆ†å¸ƒï¼ˆå½“å‰æ•°æ®ï¼‰
- **ç­‰çº§1**: 2 ä¸ª (BTC, SOL)
- **ç­‰çº§5**: 1 ä¸ª (ETH)

#### æŽ’åºè§„åˆ™
1. **ä¼˜å…ˆçº§ä¼˜å…ˆ**: ç­‰çº§æ•°å­—è¶Šå°è¶Šé å‰
2. **æœ€é«˜å æ¯”æ¬¡è¦**: åŒç­‰çº§æŒ‰ratio1é™åº
3. **æœ€ä½Žå æ¯”å†æ¬¡**: åŒratio1æŒ‰ratio2é™åº

---

### 4. APIæ›´æ–°

#### å·²æ›´æ–°çš„APIç«¯ç‚¹

##### `/api/query`
```bash
# æŸ¥è¯¢æŒ‡å®šæ—¶é—´çš„å¿«ç…§å’Œå¸ç§æ•°æ®
curl "http://localhost:5000/api/query?time=2026-01-14%2017:30"

# è¿”å›ž
{
  "snapshot_time": "2026-01-14 17:30:01",
  "rush_up": 14,
  "rush_down": 18,
  "diff": -4,
  "count": 3,
  "status": "éœ‡è¡æ— åº",
  "coins": [...]
}
```

##### `/api/query/latest`
```bash
# èŽ·å–æœ€æ–°å¿«ç…§æ•°æ®
curl "http://localhost:5000/api/query/latest"

# è¿”å›ž
{
  "success": true,
  "data": {
    "è¿ç®—æ—¶é—´": "2026-01-14 17:30:01",
    "æ€¥æ¶¨": 14,
    "æ€¥è·Œ": 18,
    "å·®å€¼": -4,
    "è®¡æ¬¡": 3,
    "çŠ¶æ€": "éœ‡è¡æ— åº",
    ...
  }
}
```

##### `/api/query/batch-import` (POST)
```bash
# æ‰¹é‡å¯¼å…¥TXTæ–‡ä»¶
curl -X POST "http://localhost:5000/api/query/batch-import" \
  -H "Content-Type: application/json" \
  -d '{
    "txt_content": "...",
    "snapshot_time": "2026-01-14 17:30:01"
  }'

# è¿”å›ž
{
  "success": true,
  "message": "æˆåŠŸå¯¼å…¥ 29 ä¸ªå¸ç§çš„æ•°æ®",
  "snapshot_time": "2026-01-14 17:30:01",
  "coin_count": 29
}
```

---

## ðŸ”§ æ ¸å¿ƒç»„ä»¶

### QueryJSONLManager

**ä¸»è¦æ–¹æ³•**:
```python
# å¿«ç…§æ“ä½œ
manager.get_latest_snapshot()           # èŽ·å–æœ€æ–°å¿«ç…§
manager.get_snapshot_by_time(time)      # æŒ‰æ—¶é—´æŸ¥è¯¢å¿«ç…§
manager.upsert_snapshot(snapshot)       # æ›´æ–°/æ’å…¥å¿«ç…§

# å¸ç§æ“ä½œ
manager.get_coins_by_time(time)         # èŽ·å–æŒ‡å®šæ—¶é—´çš„å¸ç§åˆ—è¡¨
manager.upsert_coin(coin)               # æ›´æ–°/æ’å…¥å•ä¸ªå¸ç§
manager.upsert_coins(coins, time)       # æ‰¹é‡æ›´æ–°å¸ç§

# ä¼˜å…ˆçº§è®¡ç®—
manager.calculate_priority(ratio1, ratio2)  # è®¡ç®—ä¼˜å…ˆçº§ç­‰çº§

# ç»Ÿè®¡ä¿¡æ¯
manager.get_statistics()                # èŽ·å–æ•°æ®ç»Ÿè®¡
manager.get_latest_snapshot_time()      # èŽ·å–æœ€æ–°æ—¶é—´
```

---

## ðŸ“Š æ•°æ®ç»Ÿè®¡

### å½“å‰ç³»ç»ŸçŠ¶æ€
```bash
ðŸ“Š Queryç³»ç»Ÿæ•°æ®ç»Ÿè®¡:
  å¿«ç…§è®°å½•: 26,557
  å¸ç§è®°å½•: 3
  æœ€æ–°æ—¶é—´: 2026-01-14 17:30:01
  æ—¶é—´ç‚¹æ•°: 2,560

ðŸ“¸ æœ€æ–°å¿«ç…§:
  æ—¶é—´: 2026-01-14 17:30:01
  æ€¥æ¶¨: 14
  æ€¥è·Œ: 18
  å·®å€¼: -4
  è®¡æ¬¡: 3
  çŠ¶æ€: éœ‡è¡æ— åº

ðŸ’° å¸ç§æ•°é‡: 3

ä¼˜å…ˆçº§åˆ†å¸ƒ:
  ç­‰çº§1: 2 ä¸ª
  ç­‰çº§5: 1 ä¸ª
```

### æ•°æ®æ–‡ä»¶
- **å¿«ç…§æ–‡ä»¶**: `data/query_jsonl/snapshots.jsonl` (26,557 æ¡)
- **å¸ç§æ–‡ä»¶**: `data/query_jsonl/coins.jsonl` (3 æ¡)
- **å¤‡ä»½æ–‡ä»¶**: è‡ªåŠ¨ç”Ÿæˆï¼Œæ ¼å¼ `*.backup_YYYYMMDD_HHMMSS`

---

## ðŸš€ ä½¿ç”¨æŒ‡å—

### 1. TXTæ–‡ä»¶å¯¼å…¥

#### æ–¹å¼A: ä½¿ç”¨è„šæœ¬å¯¼å…¥
```bash
cd /home/user/webapp

# å¯¼å…¥TXTæ–‡ä»¶
python3 migrate_query_to_jsonl.py --txt-file=/path/to/file.txt --time="2026-01-14 17:30:01"
```

#### æ–¹å¼B: ä½¿ç”¨APIå¯¼å…¥
```bash
# é€šè¿‡APIä¸Šä¼ TXTå†…å®¹
curl -X POST http://localhost:5000/api/query/batch-import \
  -H "Content-Type: application/json" \
  -d @import_data.json
```

### 2. æ•°æ®æŸ¥è¯¢

```python
from source_code.query_jsonl_manager import QueryJSONLManager

manager = QueryJSONLManager()

# èŽ·å–æœ€æ–°æ•°æ®
latest = manager.get_latest_snapshot()
print(f"æœ€æ–°æ—¶é—´: {latest.get('snapshot_time')}")

# èŽ·å–å¸ç§
coins = manager.get_coins_by_time(latest.get('snapshot_time'))
for coin in coins:
    print(f"{coin['symbol']}: ç­‰çº§{coin['priority']}, æœ€é«˜å æ¯”{coin['ratio1']}%, æœ€ä½Žå æ¯”{coin['ratio2']}%")

# ç»Ÿè®¡ä¿¡æ¯
stats = manager.get_statistics()
print(f"æ€»å¿«ç…§: {stats['total_snapshots']}")
print(f"æ€»å¸ç§: {stats['total_coins']}")
```

---

## ðŸ› é—®é¢˜ä¿®å¤è®°å½•

### 1. GDriveJSONLManagerå¯¼å…¥é”™è¯¯
**é—®é¢˜**: å¯¼å…¥è¯­å¥è¢«æ’å…¥åˆ°å…¶ä»–å¯¼å…¥ä¸­é—´ï¼Œå¯¼è‡´è¯­æ³•é”™è¯¯
**ä¿®å¤**: ç§»åŠ¨å¯¼å…¥åˆ°æ­£ç¡®ä½ç½®
```python
# ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
from trading_pair_protector import (
from gdrive_jsonl_manager import GDriveJSONLManager
    start_protection,
    ...
)

# ä¿®å¤åŽï¼ˆæ­£ç¡®ï¼‰
from gdrive_jsonl_manager import GDriveJSONLManager
from trading_pair_protector import (
    start_protection,
    ...
)
```

### 2. QueryJSONLManagerç¼ºå°‘æ–¹æ³•
**é—®é¢˜**: APIè°ƒç”¨`get_latest_snapshot()`ä½†è¯¥æ–¹æ³•ä¸å­˜åœ¨
**ä¿®å¤**: æ·»åŠ `get_latest_snapshot()`å’Œ`upsert_coin()`æ–¹æ³•

---

## ðŸ“ Gitæäº¤è®°å½•

```
68e1526 - feat: query APIå…¨é¢ä½¿ç”¨JSONLæ•°æ®æº
8e88c8a - docs: æ·»åŠ ç³»ç»ŸJSONLåŒ–æ”¹é€ å®Œæ•´æ€»ç»“æŠ¥å‘Š
4c1245b - docs: æ·»åŠ queryç³»ç»ŸJSONLåŒ–ä½¿ç”¨æŒ‡å—
3485a14 - feat: queryæ•°æ®JSONLåŒ– - TXTè§£æž+ä¼˜å…ˆçº§è®¡ç®—+æ•°æ®è¿ç§»
93920e7 - docs: æ·»åŠ gdrive-detector JSONLåŒ–æ”¹é€ å®Œæ•´æŠ¥å‘Š
330c058 - feat: gdrive-detector JSONLåŒ–æ”¹é€  - éš”æ—¥è‡ªåŠ¨æ¢æ–‡ä»¶å¤¹+æ•°æ®è¿ç§»
```

**æœ¬æ¬¡æäº¤è¯¦æƒ…**:
- æ–‡ä»¶ä¿®æ”¹: 4 ä¸ª
- æ–°å¢žä»£ç : 403 è¡Œ
- åˆ é™¤ä»£ç : 107 è¡Œ
- æ–°å¢žæ–‡ä»¶: 
  - `manual_gdrive_update.py` (æ‰‹åŠ¨æ›´æ–°å·¥å…·)
  - `update_query_api.py` (ä»£ç ç”Ÿæˆå™¨)

---

## âœ… éªŒè¯ç»“æžœ

### APIæµ‹è¯•
```bash
# æµ‹è¯•1: /api/query/latest
âœ… æ­£å¸¸è¿”å›žæ•°æ®
âœ… å­—æ®µå®Œæ•´
âœ… æ•°æ®æ ¼å¼æ­£ç¡®

# æµ‹è¯•2: /queryé¡µé¢
âœ… é¡µé¢åŠ è½½æ­£å¸¸
âœ… æ— JavaScripté”™è¯¯
âœ… æ•°æ®æ˜¾ç¤ºæ­£ç¡®
```

### æ•°æ®å®Œæ•´æ€§
```bash
âœ… å¿«ç…§è®°å½•: 26,557 æ¡
âœ… å¸ç§è®°å½•: 3 æ¡
âœ… æœ€æ–°æ—¶é—´: 2026-01-14 17:30:01
âœ… å¤‡ä»½æ–‡ä»¶: è‡ªåŠ¨ç”Ÿæˆ
âœ… ä¼˜å…ˆçº§è®¡ç®—: æ­£ç¡®
```

---

## ðŸŽ‰ å®Œæˆæ€»ç»“

### æ ¸å¿ƒæˆæžœ
1. âœ… **æ•°æ®è¿ç§»å®Œæˆ**: 26,557æ¡å¿«ç…§ + 3æ¡å¸ç§
2. âœ… **TXTè§£æžå®žçŽ°**: æ”¯æŒæœ€æ–°æ ¼å¼ï¼Œè‡ªåŠ¨è§£æžé€æ˜Žæ ‡ç­¾å’Œå¸ç§æ•°æ®
3. âœ… **ä¼˜å…ˆçº§è®¡ç®—**: 6çº§æ™ºèƒ½åˆ†ç±»ç³»ç»Ÿ
4. âœ… **APIæ›´æ–°å®Œæˆ**: å…¨éƒ¨ä½¿ç”¨JSONLæ•°æ®æº
5. âœ… **å­—æ®µå¤„ç†æ­£ç¡®**: ç§»é™¤+4%å’Œ-3%åˆ—ï¼Œä¼˜å…ˆçº§æ”¾ç¬¬ä¸€ä½

### æµ‹è¯•çŠ¶æ€
- **APIæµ‹è¯•**: âœ… é€šè¿‡
- **é¡µé¢æµ‹è¯•**: âœ… æ­£å¸¸
- **æ•°æ®éªŒè¯**: âœ… å®Œæ•´
- **ä¼˜å…ˆçº§è®¡ç®—**: âœ… æ­£ç¡®

### ä¸‹ä¸€æ­¥å»ºè®®
1. ðŸ”„ å®šæœŸä»ŽGoogle DriveèŽ·å–æœ€æ–°TXTæ–‡ä»¶å¹¶è‡ªåŠ¨å¯¼å…¥
2. ðŸ“Š å‰ç«¯æ˜¾ç¤ºä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§å¯è§†åŒ–ï¼‰
3. ðŸ§¹ æ•°æ®æ¸…ç†ç­–ç•¥ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
4. ðŸ“ˆ æ·»åŠ æ›´å¤šç»Ÿè®¡å›¾è¡¨

---

## ðŸ”— è®¿é—®åœ°å€

- **Queryé¡µé¢**: https://5000-igsydcyqs9jlcot56rnqk-8f57ffe2.sandbox.novita.ai/query
- **APIæ–‡æ¡£**: è§ä¸Šæ–¹"APIæ›´æ–°"ç« èŠ‚

---

## ðŸ“… å®Œæˆä¿¡æ¯

- **å¼€å§‹æ—¶é—´**: 2026-01-14 17:00
- **å®Œæˆæ—¶é—´**: 2026-01-14 18:10
- **æ€»è€—æ—¶**: çº¦70åˆ†é’Ÿ
- **æœ€ç»ˆçŠ¶æ€**: âœ… å…¨éƒ¨å®Œæˆï¼Œç³»ç»Ÿæ­£å¸¸è¿è¡Œ

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-14 18:10:00  
**ç³»ç»ŸçŠ¶æ€**: ðŸŸ¢ æ­£å¸¸è¿è¡Œ
