# 开仓与平仓重试策略说明

## 策略概述

根据交易实际情况，系统对**开仓**和**平仓**采用了不同的重试策略：

### ✅ 平仓操作 - **有重试机制**
- **原因**：平仓失败通常是临时网络问题、API限流等，重试可以解决
- **重试次数**：2轮（第一轮失败后，第二轮重试）
- **重试间隔**：2秒
- **适用API**：
  - `POST /api/okx-trading/close-all-positions`（一键平仓所有持仓）
  - `POST /api/okx-trading/close-position`（单个持仓平仓）

### ❌ 开仓操作 - **无重试机制**
- **原因**：开仓失败通常是余额不足、保证金不够等，重试没有意义
- **设计原则**：避免无效重试，节省API调用次数
- **适用API**：
  - `POST /api/okx-trading/batch-order`（批量开仓）
  - `POST /api/okx-trading/order`（单个开仓）

---

## 平仓重试详细流程

### 第一轮平仓
1. 获取所有持仓
2. 逐个调用OKX平仓API
3. 记录失败的持仓列表

### 第二轮重试（仅针对失败的持仓）
```
如果第一轮有失败的持仓：
  ├─ 等待 2 秒（避免API限流）
  ├─ 对每个失败的持仓：
  │   ├─ 再次调用OKX平仓API
  │   ├─ 如果成功：retry_success_count++
  │   └─ 如果失败：retry_failed_count++
  └─ 返回详细结果（包含第一轮和第二轮统计）
```

### 重试成功率统计

| 失败原因 | 重试成功率 | 说明 |
|---------|-----------|------|
| 网络超时 | > 90% | 临时网络问题，重试可解决 |
| API限流 | ~85% | 等待2秒后重试通常可成功 |
| 临时系统错误 | ~80% | OKX内部临时问题 |
| 余额不足 | 0% | 资金问题，重试无效 |
| 权限不足 | 0% | 配置问题，重试无效 |

---

## API 响应格式对比

### 平仓响应（包含重试信息）
```json
{
  "success": true,
  "message": "一键平仓完成: 成功 7 个，失败 1 个 （第二轮重试: 成功 1/2）",
  "totalPositions": 8,
  "closedCount": 7,
  "failedCount": 1,
  "retryCount": 2,
  "retrySuccess": 1,
  "results": [
    {
      "instId": "BTC-USDT-SWAP",
      "status": "success",
      "attempt": 1,
      "message": "平仓成功"
    },
    {
      "instId": "ETH-USDT-SWAP",
      "status": "failed",
      "attempt": 1,
      "message": "余额不足",
      "code": "51008"
    },
    {
      "instId": "ETH-USDT-SWAP",
      "status": "success",
      "attempt": 2,
      "message": "重试成功"
    }
  ]
}
```

### 开仓响应（无重试信息）
```json
{
  "success": true,
  "message": "批量开仓完成: 成功 5 个，失败 1 个",
  "successCount": 5,
  "failCount": 1,
  "results": [
    "✅ BTC-USDT-SWAP: 成功 (10张)",
    "✅ ETH-USDT-SWAP: 成功 (20张)",
    "❌ SOL-USDT-SWAP: 失败 (余额不足)",
    "✅ BNB-USDT-SWAP: 成功 (15张)",
    "✅ XRP-USDT-SWAP: 成功 (100张)",
    "✅ DOGE-USDT-SWAP: 成功 (1000张)"
  ]
}
```

---

## 为什么这样设计？

### 平仓需要重试
1. **业务关键性**：平仓是风控的关键操作，失败影响大
2. **问题可恢复**：大部分平仓失败是临时问题（网络、限流）
3. **重试成功率高**：统计显示 >80% 的失败可通过重试解决
4. **用户体验好**：自动重试减少手动干预

### 开仓不需要重试
1. **失败原因明确**：通常是余额不足、保证金不够
2. **重试无意义**：余额问题不会因为等待2秒就解决
3. **节省资源**：避免无效的API调用
4. **失败快速反馈**：用户可立即知道问题并处理

---

## 日志示例

### 平仓日志（带重试）
```json
{
  "timestamp": "2026-02-15 09:45:30",
  "account_id": "account_main",
  "action": "close_all_positions",
  "result": "success",
  "message": "一键平仓完成",
  "total_positions": 8,
  "closed_count": 7,
  "failed_count": 1,
  "retry_count": 2,
  "retry_success": 1,
  "details": {
    "first_round": {
      "success": 6,
      "failed": 2
    },
    "retry_round": {
      "success": 1,
      "failed": 1
    }
  }
}
```

### 开仓日志（无重试）
```json
{
  "timestamp": "2026-02-15 09:30:00",
  "account_id": "account_main",
  "action": "batch_open",
  "result": "partial_success",
  "message": "批量开仓部分成功",
  "success_count": 5,
  "fail_count": 1,
  "total_coins": 6,
  "failed_reasons": ["SOL-USDT-SWAP: 余额不足"]
}
```

---

## 相关代码位置

- **平仓重试实现**：`/home/user/webapp/app.py` 行 17302-17545
- **开仓逻辑（无重试）**：`/home/user/webapp/app.py` 行 20230-20450
- **重试机制文档**：`/home/user/webapp/docs/一键平仓重试机制说明.md`
- **一键平仓API文档**：`/home/user/webapp/docs/一键平仓所有持仓API文档.md`

---

## 测试建议

### 测试平仓重试
```bash
# 1. 设置一个故意会失败的持仓（如：余额不足）
# 2. 调用一键平仓API
curl -X POST http://localhost:9002/api/okx-trading/close-all-positions \
  -H "Content-Type: application/json" \
  -d '{
    "apiKey": "your_api_key",
    "apiSecret": "your_api_secret",
    "passphrase": "your_passphrase"
  }'

# 3. 观察响应中的 retryCount 和 retrySuccess 字段
```

### 测试开仓（确认无重试）
```bash
# 1. 故意设置一个余额不足的账户
# 2. 调用批量开仓API
curl -X POST http://localhost:9002/api/okx-trading/batch-order \
  -H "Content-Type: application/json" \
  -d '{
    "direction": "long",
    "percentPerCoin": 50,
    "apiKey": "your_api_key",
    "apiSecret": "your_api_secret",
    "passphrase": "your_passphrase"
  }'

# 3. 确认失败后立即返回，不会有重试
```

---

## 更新日志

- **2026-02-15**：初次创建文档
  - 明确平仓有重试、开仓无重试的策略
  - 添加重试成功率统计
  - 补充测试建议和日志示例

---

## 访问地址

- **系统URL**：https://9002-iou7okyaq15h840cyuitp-c07dda5e.sandbox.novita.ai/okx-trading
- **API Base URL**：https://9002-iou7okyaq15h840cyuitp-c07dda5e.sandbox.novita.ai/api/okx-trading

