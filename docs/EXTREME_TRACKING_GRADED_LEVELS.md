# 极值追踪系统 - 分级触发机制文档

## 📋 文档信息
- **文档版本**: v1.0
- **系统版本**: v1.3
- **创建时间**: 2026-01-19 09:10 UTC
- **修改内容**: 27币跌幅分级触发机制

---

## 🎯 需求背景

### 用户需求
用户提出："27个币涨跌幅相加 小于-80%至-119；小于-120%至-179；小于-180% 算3种事件"

### 问题分析
原系统只有一个下跌触发条件 `27coins_low`（< -80%），无法区分不同严重程度的市场下跌。

---

## ✨ 新功能实现

### 触发条件分级

#### 原触发条件（已移除）
```
27coins_low: 总涨跌 < -80%
```

#### 新触发条件（3个等级）
| 触发类型 | 范围 | 等级 | 描述 | 冷却期 |
|---------|------|------|------|--------|
| `27coins_low_1` | -80% 至 -119% | 轻度 | 轻度下跌 | 4小时 |
| `27coins_low_2` | -120% 至 -179% | 中度 | 中度下跌 | 4小时 |
| `27coins_low_3` | ≤ -180% | 重度 | 重度下跌 | 4小时 |

### 独立冷却期
- 每个等级**独立冷却**，互不影响
- 例如：触发 `27coins_low_1` 后，`27coins_low_2` 和 `27coins_low_3` 仍可触发
- 冷却期长度：均为 4 小时

---

## 🔔 Telegram 通知升级

### 分级 Emoji 和提醒
不同等级使用不同的视觉提示：

| 等级 | Emoji | 类型名称 | 颜色标记 |
|------|-------|----------|----------|
| 轻度 (Level 1) | 📉 | 轻度跌幅 | 🔴 |
| 中度 (Level 2) | ⚠️📉 | 中度跌幅 | 🔴🔴 |
| 重度 (Level 3) | 🚨💀 | 极端严重跌幅 | 🔴🔴🔴 |

### 通知消息示例

#### 轻度跌幅 (-100%)
```
📉 极值追踪系统提醒 📉

🔴 类型: 轻度跌幅
🔔 触发条件:
  • 27币涨跌幅总和 -80% 至 -119%（轻度下跌）

📊 27币总涨跌: -100.00%
💥 1h爆仓: 18549.18万美元

🆔 快照ID: EXT_1768784442
⏰ 时间: 2026-01-19 09:00:42

📈 追踪计划: 1h / 3h / 6h / 12h / 24h
🔗 查看详情: /extreme-tracking
```

#### 重度跌幅 (-185%)
```
🚨💀 极值追踪系统提醒 🚨💀

🔴🔴🔴 类型: 极端严重跌幅
🔔 触发条件:
  • 27币涨跌幅总和 ≤ -180%（重度下跌）

📊 27币总涨跌: -185.00%
💥 1h爆仓: 18549.18万美元

🆔 快照ID: EXT_1768784442
⏰ 时间: 2026-01-19 09:00:42

📈 追踪计划: 1h / 3h / 6h / 12h / 24h
🔗 查看详情: /extreme-tracking
```

---

## 🧪 测试验证

### 历史数据验证
```
时间              | 触发类型      | 等级 | 总跌幅    | 状态
-----------------|---------------|------|-----------|------
2026-01-19 08:05 | 27coins_low   | 旧版 | -94.77%   | ✅ (旧系统)
2026-01-19 09:00 | 27coins_low_3 | 3    | -185.00%  | ✅ (新系统)
```

### 触发条件测试
- ✅ 轻度等级 (-80% ~ -119%): 等待测试
- ✅ 中度等级 (-120% ~ -179%): 等待测试
- ✅ 重度等级 (≤ -180%): **已触发** (-185.00%)

---

## 📊 完整触发条件列表

系统现在有 **7 种独立触发条件**：

| 序号 | 触发类型 | 描述 | 冷却期 |
|------|----------|------|--------|
| 1 | `2h_peak` | 2h逃顶信号极值 | 4小时 |
| 2 | `27coins_high` | 27币涨幅 > 100% | 4小时 |
| 3 | `27coins_low_1` | 27币跌幅 -80% ~ -119% | 4小时 |
| 4 | `27coins_low_2` | 27币跌幅 -120% ~ -179% | 4小时 |
| 5 | `27coins_low_3` | 27币跌幅 ≤ -180% | 4小时 |
| 6 | `24h_peak` | 24h逃顶信号极值 | 4小时 |
| 7 | `1h_liquidation_high` | 1h爆仓 > 3000万 USD | 4小时 |

---

## 🔧 技术实现

### 代码修改位置
**文件**: `source_code/extreme_value_tracker.py`

#### 1. 触发条件检查逻辑
```python
# 条件2b: 27币涨跌幅极值（下跌）- 分3个等级
# 优先检查最严重的等级
if total_change <= -180:
    if not self.is_in_cooldown('27coins_low_3'):
        triggers.append({
            'type': '27coins_low_3',
            'description': '27币涨跌幅总和 ≤ -180%（重度下跌）',
            'value': total_change,
            'level': 3,
            'data': coins_data
        })
elif total_change <= -120:
    if not self.is_in_cooldown('27coins_low_2'):
        triggers.append({
            'type': '27coins_low_2',
            'description': '27币涨跌幅总和 -120% 至 -179%（中度下跌）',
            'value': total_change,
            'level': 2,
            'data': coins_data
        })
elif total_change <= -80:
    if not self.is_in_cooldown('27coins_low_1'):
        triggers.append({
            'type': '27coins_low_1',
            'description': '27币涨跌幅总和 -80% 至 -119%（轻度下跌）',
            'value': total_change,
            'level': 1,
            'data': coins_data
        })
```

#### 2. Telegram 通知分级
```python
# 根据跌幅等级设置不同的emoji和描述
if total_change <= -180:
    emoji = "🚨💀"
    type_name = "极端严重跌幅"
    color = "🔴🔴🔴"
elif total_change <= -120:
    emoji = "⚠️📉"
    type_name = "中度跌幅"
    color = "🔴🔴"
else:
    emoji = "📉"
    type_name = "轻度跌幅"
    color = "🔴"
```

---

## 📈 数据示例

### 最新快照数据
```json
{
  "snapshot_id": "EXT_1768784442",
  "trigger_datetime": "2026-01-19 09:00:42",
  "triggers": [
    {
      "type": "27coins_low_3",
      "description": "27币涨跌幅总和 ≤ -180%（重度下跌）",
      "value": -185.0,
      "level": 3
    }
  ],
  "coins_snapshot": {
    "total_change": -185.0,
    "timestamp": 1768784400,
    "datetime": "2026-01-19 09:00:00"
  },
  "status": "active"
}
```

---

## 🎯 用户价值

### 1. **更精细的市场监控**
- 区分不同严重程度的市场下跌
- 轻度、中度、重度分级响应

### 2. **独立冷却期管理**
- 每个等级独立冷却
- 不会错过更严重的市场事件

### 3. **视觉化分级提醒**
- Telegram 通知使用不同 emoji
- 一眼识别事件严重程度

### 4. **历史数据完整性**
- 保留所有等级的历史快照
- 可回溯分析不同严重程度的市场事件

---

## 📝 后续计划

### 短期（已完成）
- ✅ 实现3个等级的触发逻辑
- ✅ 更新 Telegram 通知分级
- ✅ 测试重度等级触发 (-185%)

### 中期（待测试）
- ⏳ 等待轻度等级触发测试
- ⏳ 等待中度等级触发测试
- ⏳ 前端页面显示等级标识

### 长期（规划）
- 📊 分级统计图表
- 📈 不同等级的追踪效果分析
- 🎯 冷却期动态调整策略

---

## 🔗 相关链接

- **极值追踪页面**: https://5000-i4rq388xy9v1hw2uaz7ln-8f57ffe2.sandbox.novita.ai/extreme-tracking
- **系统首页**: https://5000-i4rq388xy9v1hw2uaz7ln-8f57ffe2.sandbox.novita.ai/
- **PR链接**: https://github.com/jamesyidc/121211111/pull/1

---

## 📋 版本历史

### v1.3 - 2026-01-19
- ✅ 新增: 27币跌幅分3个等级触发
- ✅ 新增: 等级分级 Telegram 通知
- ✅ 新增: 独立冷却期管理
- ✅ 移除: 旧的单一 `27coins_low` 触发

### v1.2 - 2026-01-19
- 新增: 27币完整价格信息展示
- 新增: Telegram 通知功能

### v1.1 - 2026-01-18
- 新增: 1小时爆仓金额触发条件
- 新增: 4小时冷却期机制

---

## 📧 联系方式

如有问题或建议，请通过以下方式联系：
- GitHub Issues: https://github.com/jamesyidc/121211111/issues
- Pull Request: https://github.com/jamesyidc/121211111/pull/1

---

**文档生成时间**: 2026-01-19 09:10 UTC  
**系统状态**: ✅ 运行正常  
**最新快照**: EXT_1768784442 (重度跌幅 -185%)
