# 手动角度标记功能 V3.0 - 方向选择 + 智能B点寻找

## ✅ 最新更新（V3.0）

### 🎯 核心改进
根据您的要求实现：
1. **✨ 方向选择**：先选择正角（上升）或负角（下降）
2. **🔄 逆向逻辑**：正角和负角的B点寻找逻辑完全不同
3. **⏰ 时间约束**：C'点的时间必须晚于B点

---

## 📐 新的使用流程

### **完整步骤（3步选择）**：

#### **第1步：选择角度方向**
进入角度标记模式后，首先选择方向：
- **↗️ 正角（上升）** - 绿色按钮
- **↘️ 负角（下降）** - 蓝色按钮

#### **第2步：选择A点**
- **正角**：选择**高点**（峰值）
- **负角**：选择**低点**（谷底）
- 显示**红色圆圈** 🔴，标签 "A"

#### **第3步：选择C'点（起始点）**
- 在图表上选择一个起始点
- **重要约束**：C'点的时间必须**晚于B点**
- 显示**紫色圆圈** 🟣，标签 "C'"

#### **自动完成：系统寻找B点** ✨
系统根据选择的方向，自动在A点之前寻找B点：
- **正角**：在A点前找**最低点**（低于A）
- **负角**：在A点前找**最高点**（高于A）
- 自动验证：**C'点时间 > B点时间**
- 显示**蓝色圆圈** 🔵，标签 "B"

---

## 🔄 正角 vs 负角的逻辑差异

### **正角（上升 ↗️）**：
```
价格趋势：     B → A
              低   高
形态特征：从低点B上升到高点A
B点寻找：在A点之前找最低点
时间顺序：B时间 < C'时间

示例：
时间    价格    说明
07:00   15.5%   ← B点（低点）自动找到
07:20   10.5%   ← C'点（起始）手动选择
07:42   38.0%   ← A点（高点）手动选择

验证：07:00 < 07:20 ✓
```

### **负角（下降 ↘️）**：
```
价格趋势：     B → A
              高   低
形态特征：从高点B下降到低点A
B点寻找：在A点之前找最高点
时间顺序：B时间 < C'时间

示例：
时间    价格    说明
10:10   45.8%   ← B点（高点）自动找到
10:25   35.2%   ← C'点（起始）手动选择
10:35  -12.8%   ← A点（低点）手动选择

验证：10:10 < 10:25 ✓
```

---

## 🤖 B点自动寻找算法

### **正角算法（找低点）**：
```javascript
从A点往前搜索，找最低价格点：
- 起点：A点索引 - 1
- 方向：向前（时间递减）
- 条件：时间间隔 >= 2分钟
- 目标：找到最低价格点作为B点
- 验证：C'时间 > B时间
```

### **负角算法（找高点）**：
```javascript
从A点往前搜索，找最高价格点：
- 起点：A点索引 - 1
- 方向：向前（时间递减）
- 条件：时间间隔 >= 2分钟
- 目标：找到最高价格点作为B点
- 验证：C'时间 > B时间
```

---

## ⏰ 时间约束验证

### **C'点时间必须晚于B点**

这是关键约束，确保逻辑正确：

#### **正确示例**：
```
B点: 07:00
C'点: 07:20  ✓ (7:20 > 7:00)
```

#### **错误示例**：
```
B点: 07:20
C'点: 07:10  ✗ (7:10 < 7:20)

系统提示：
❌ C'点时间必须晚于B点！

B点时间: 07:20
C'点时间: 07:10

请重新选择C'点
```

---

## 🎨 视觉效果

### **方向选择按钮**：
- **↗️ 正角（上升）**
  - 未选择：浅绿色背景，绿色文字
  - 已选择：深绿色背景，白色文字

- **↘️ 负角（下降）**
  - 未选择：浅蓝色背景，蓝色文字
  - 已选择：深蓝色背景，白色文字

### **选中点标记**：
1. **A点** - 🔴 红色圆圈，标签 "A"
2. **C'点** - 🟣 紫色圆圈，标签 "C'"
3. **B点** - 🔵 蓝色圆圈，标签 "B"（自动）

### **角度标记**：
- ↗️ **上升锐角** - 红色三角形 ▲
- ↗️ **上升钝角** - 橙色方块 ■
- ↘️ **下降锐角** - 蓝色倒三角 ▼
- ↘️ **下降钝角** - 紫色菱形 ◆

---

## 💡 使用示例

### **示例1：添加正角（上升）**

1. **进入模式** - 点击"📐 进入角度标记模式"
2. **选择方向** - 点击"↗️ 正角（上升）"按钮
3. **选择A点** - 点击07:42的高点（38.0%）
4. **选择C'点** - 点击07:20的点（10.5%）
5. **自动寻找** - 系统在A点前找到B点：07:00（15.5%）
6. **验证通过** - C'时间 07:20 > B时间 07:00 ✓
7. **确认添加** - 点击"确定"

#### 结果：
```
✅ 已添加上升锐角：16.27°

A点: 07:42:00 (38.00%)
B点(自动): 07:00:00 (15.50%)
C'点: 07:20:00 (10.50%)

说明: B点时间 07:00:00 < C'点时间 07:20:00 ✓

价格变化: 27.50%
时间跨度: 22.0分钟
```

### **示例2：添加负角（下降）**

1. **进入模式** - 点击"📐 进入角度标记模式"
2. **选择方向** - 点击"↘️ 负角（下降）"按钮
3. **选择A点** - 点击10:35的低点（-12.8%）
4. **选择C'点** - 点击10:25的点（35.2%）
5. **自动寻找** - 系统在A点前找到B点：10:10（45.8%）
6. **验证通过** - C'时间 10:25 > B时间 10:10 ✓
7. **确认添加** - 点击"确定"

---

## 🗑️ 管理功能

### **单个删除**：
- 右键点击任何手动角度标记
- 确认删除

### **批量清除**：
- 点击"🗑️ 清除所有手动角度"按钮
- 确认清除

### **取消操作**：
- 点击"❌ 取消标记"按钮
- 重置当前选择

---

## ⚠️ 注意事项

### **1. 方向选择**
- ⚠️ 必须先选择方向（正角/负角）
- ⚠️ 如果不选方向，点击图表会提示

### **2. C'点时间约束**
- ⚠️ C'点时间必须晚于B点
- ⚠️ 如果违反，系统会拒绝并提示

### **3. B点寻找失败**
可能原因：
- A点是数据开头，前面没有数据
- A点前2分钟内没有数据
- 正角：A点前找不到更低的点
- 负角：A点前找不到更高的点

### **4. 数据持久化**
- ⚠️ 手动角度仅存储在浏览器内存
- ⚠️ 刷新页面或切换日期后会丢失

---

## 🎯 快速上手

### **4步添加角度**：
1. 点击 **"📐 进入角度标记模式"**
2. 选择 **"↗️ 正角"** 或 **"↘️ 负角"**
3. 依次点击 **A点** → **C'点**
4. 系统自动找B点，点击 **"确定"** 添加

### **验证要点**：
- ✅ 正角：A是高点，B是低点
- ✅ 负角：A是低点，B是高点
- ✅ 时间：C'时间 > B时间

---

## 📊 算法对比

### **V2.0**（旧版）：
```
流程：A点 → C'点 → 自动找B点
B点位置：在A点之后
B点类型：总是找低点（回落点）
时间约束：无
```

### **V3.0**（新版）：
```
流程：选择方向 → A点 → C'点 → 自动找B点
B点位置：在A点之前
B点类型：
  - 正角：找低点
  - 负角：找高点
时间约束：C'时间 > B时间（强制）
```

---

## 🔗 测试地址
https://5000-idfgz76cf9poiqtgzfhan-c81df28e.sandbox.novita.ai/okx-trading-marks

---

## 📝 核心代码

### **方向选择**：
```javascript
let angleDirection = null;  // 'up' 或 'down'

function selectDirection(direction) {
    angleDirection = direction;
    selectedPoints = [];
    updateButtonStyles();
    console.log(`✅ 选择了${direction === 'up' ? '正角' : '负角'}方向`);
}
```

### **B点寻找**：
```javascript
function findValleyPoint(peakPoint, cPrimePoint, direction) {
    if (direction === 'up') {
        // 正角：从A点往前找最低点
        for (let i = peakIdx - 1; i >= 0; i--) {
            if (currentValues[i] < targetValue) {
                targetValue = currentValues[i];
                valleyIdx = i;
            }
        }
    } else {
        // 负角：从A点往前找最高点
        for (let i = peakIdx - 1; i >= 0; i--) {
            if (currentValues[i] > targetValue) {
                targetValue = currentValues[i];
                valleyIdx = i;
            }
        }
    }
    
    // 验证C'时间 > B时间
    if (cPrimeTime <= valleyTime) {
        alert('❌ C\'点时间必须晚于B点！');
        return null;
    }
    
    return valleyPoint;
}
```

---

## 📅 更新日志

### **V3.0** (2026-02-10):
- ✨ 新增：方向选择（正角/负角）
- 🔄 改进：正负角逻辑完全分离
- 🔄 改进：B点在A点之前搜索
- ⏰ 新增：C'点时间晚于B点的约束
- 🎨 优化：方向选择按钮视觉效果
- 📝 完善：详细的使用文档和示例

### **V2.0** (2026-02-10):
- ✨ 新增：自动寻找B点功能
- ✨ 新增：一键清除所有手动角度
- 🔄 改进：简化选点流程（3点→2点）

### **V1.0** (2026-02-10):
- ✨ 首次发布：手动角度标记功能
- ✨ 支持3点手动选择

---

**功能已完成！** 🎉  
现在支持正角/负角选择，B点自动寻找，且有严格的时间约束验证！
