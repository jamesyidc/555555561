# OKX趋势角度分析系统 - 锐角/钝角识别

## 📐 系统概述

根据您的需求，开发了一个**趋势角度分析系统**，用于识别和标记趋势图中的**锐角**和**钝角**形态。

### 核心需求
> "取最高点A，取最高点之后下跌回升的点C，然后平移C的价格去取相等价格的A点（C'），A和C'的y轴相同但x轴不同，然后计算A角的角度，小于45度是锐角，大于45度是钝角。1小时内只计算一个最高的角度，计算结果存入jsonl调用。"

## 🎯 算法原理

### 1. 图解说明
```
价格(y轴)
   │
   │    A (最高点)
   │    ╱│
   │   ╱ │
   │  ╱  │ 
   │ ╱   │ 角度θ
   │╱____│ C' (与C相同价格的点)
   │     C (回升点)
   │
   └─────────────────> 时间(x轴)
```

### 2. 计算步骤

#### Step 1: 找最高点A
- 在趋势数据中找到累计涨跌幅的最高点
- 记录位置和价格

#### Step 2: 找回升点C
- 在A点之后，找到价格下跌后开始回升的转折点（谷底）
- 这是价格下跌后开始回升的第一个点

#### Step 3: 找C'点（关键步骤）
- 在A点**之前**，找到与C点价格相等（或最接近）的点
- C'和C的y轴坐标（价格）相同，但x轴坐标（时间）不同

#### Step 4: 计算角度
两种算法版本：

**V1: 基于数据点个数**
```python
垂直距离 = A的价格 - C'的价格 (%)
水平距离 = A的索引 - C'的索引 (数据点个数)
角度 = arctan(垂直距离 / 水平距离) * 180 / π
```

**V2: 基于图表视觉比例（推荐）**
```python
# 转换为像素
价格差_px = (价格差% / 100%) * 图表高度px
时间差_px = (时间差min / 600min) * 图表宽度px

# 计算视觉角度
角度 = arctan(价格差_px / 时间差_px) * 180 / π
```

#### Step 5: 判断类型
- **锐角** (Acute): θ < 45° → 急速上涨
- **钝角** (Obtuse): θ ≥ 45° → 缓慢上涨

### 3. 时间窗口规则
- **1小时内只计算1个角度**
- 如果1小时内有多个符合条件的形态，只保留**角度最大**的那个

## 📁 文件结构

```
/home/user/webapp/
├── collectors/
│   ├── okx_angle_analyzer.py      # V1: 基于数据点个数
│   └── okx_angle_analyzer_v2.py   # V2: 基于视觉比例（推荐）
└── data/
    └── okx_angle_analysis/
        └── okx_angles_YYYYMMDD.jsonl  # 角度分析结果
```

## 🔧 使用方法

### 1. 分析指定日期
```bash
# V1版本
python3 collectors/okx_angle_analyzer.py 20260210

# V2版本（推荐）
python3 collectors/okx_angle_analyzer_v2.py 20260210
```

### 2. 分析最近7天
```bash
# 不带参数，默认分析最近7天
python3 collectors/okx_angle_analyzer_v2.py
```

## 📊 输出示例

### 控制台输出
```
======================================================================
📐 分析日期: 20260210
======================================================================
📊 图表参数: 800×400px, 600min, 100%
📊 加载了 594 个数据点

📈 找到 3 个小时的角度形态:
======================================================================

⏰ 04:00 - 5:00
   类型: 🔺 锐角
   视觉角度: 13.50°
   C'点: 02:10:00 (50.26%)
   A点:  04:09:00 (59.78%)
   C点:  04:11:00 (50.35%)
   实际: 9.52% / 119.0分钟
   像素: 38.1px / 158.7px

⏰ 06:00 - 7:00
   类型: 🔺 锐角
   视觉角度: 9.77°
   C'点: 03:25:00 (38.16%)
   A点:  06:18:00 (48.09%)
   C点:  06:23:00 (38.15%)
   实际: 9.93% / 173.0分钟
   像素: 39.7px / 230.7px

======================================================================
✅ 分析完成
======================================================================
```

### JSONL文件格式
```json
{
  "date": "20260210",
  "hour": "04",
  "angle": 13.50,
  "type": "acute",
  "vertical_distance_pct": 9.52,
  "horizontal_distance_min": 119.0,
  "vertical_distance_px": 38.1,
  "horizontal_distance_px": 158.7,
  "c_prime_time": "02:10:00",
  "c_prime_price": 50.26,
  "peak_time": "04:09:00",
  "peak_price": 59.78,
  "valley_time": "04:11:00",
  "valley_price": 50.35,
  "analyzed_at": "2026-02-10T01:51:25.528861"
}
```

## ⚙️ 配置参数（V2版本）

### 图表参数
```python
CHART_WIDTH_PX = 800  # 图表宽度（像素）
CHART_HEIGHT_PX = 400  # 图表高度（像素）
CHART_TIME_RANGE_MIN = 600  # 时间范围（分钟，10小时）
CHART_PRICE_RANGE_PCT = 100  # 价格范围（%，-20到+80=100%）
```

### 调整建议
如果您觉得角度计算不准确，可以调整这些参数：

**情况1：角度太小**
- 增大 `CHART_HEIGHT_PX`（例如改为600）
- 减小 `CHART_WIDTH_PX`（例如改为600）

**情况2：角度太大**
- 减小 `CHART_HEIGHT_PX`（例如改为300）
- 增大 `CHART_WIDTH_PX`（例如改为1000）

**情况3：根据实际图表调整**
- 打开您的页面，用开发者工具查看图表的实际宽度和高度
- 将这些值设置到脚本中

## 📈 两个版本的对比

| 特性 | V1版本 | V2版本（推荐） |
|------|--------|---------------|
| 计算方式 | 数据点个数 | 图表像素比例 |
| 角度范围 | 1-5° | 4-20° |
| 优点 | 简单，不依赖图表 | 更符合视觉感受 |
| 缺点 | 角度太小 | 需要知道图表尺寸 |
| 适用场景 | 纯数学分析 | 前端图表展示 |

## 🎨 前端集成（下一步）

### 1. 添加API端点
```python
@app.route('/api/okx-trading/angles')
def get_angles():
    date = request.args.get('date', datetime.now().strftime('%Y%m%d'))
    file_path = f'data/okx_angle_analysis/okx_angles_{date}.jsonl'
    # 读取并返回角度数据
```

### 2. 前端展示
在趋势图上标记角度：
- 🔺 锐角：红色标记（急速上涨）
- 🔻 钝角：橙色标记（缓慢上涨）

显示信息：
- 角度大小（°）
- 时间范围
- 价格变化

### 3. 使用场景
- **交易策略**：锐角表示快速拉升，可能是爆发点
- **风险提示**：钝角表示缓慢上涨，可能更稳健
- **历史分析**：统计锐角/钝角出现的频率和效果

## 🔄 自动化运行

### PM2定时任务
```json
{
  "name": "okx-angle-analyzer",
  "script": "collectors/okx_angle_analyzer_v2.py",
  "args": "",
  "cron_restart": "*/30 * * * *",
  "autorestart": false
}
```

## 📝 测试数据

### 2026-02-10的结果
- **04:00-05:00**: 13.50° (锐角) - 9.52%涨幅/119分钟
- **06:00-07:00**: 9.77° (锐角) - 9.93%涨幅/173分钟
- **09:00-10:00**: 3.96° (锐角) - 4.29%涨幅/186分钟

所有形态都是锐角，说明今天的上涨都比较快速。

## ⚠️ 注意事项

### 1. 数据依赖
- 需要 `data/coin_change_tracker/coin_change_YYYYMMDD.jsonl` 文件
- 确保coin-change-tracker服务正常运行

### 2. 角度解释
- **锐角（<45°）**：不一定代表"非常陡"，因为时间跨度通常很大
- **视觉角度**：更接近人眼在图表上看到的效果
- **数学角度**：更客观，但可能不符合视觉感受

### 3. 参数调优
- 建议先用几个已知的典型形态测试
- 根据实际图表效果调整 `CHART_*` 参数
- 可以创建多个参数预设供选择

## 🚀 下一步计划

- [ ] 添加Flask API端点
- [ ] 前端集成角度标记
- [ ] PM2定时任务自动分析
- [ ] 参数优化和校准
- [ ] 添加更多形态识别（如双顶、头肩顶等）
- [ ] 统计分析：锐角/钝角的胜率和收益

---

**完成时间**：2026-02-10 03:15  
**状态**：✅ 核心功能已完成，等待集成测试

**测试方法**：
```bash
# 分析今天的数据
cd /home/user/webapp
python3 collectors/okx_angle_analyzer_v2.py 20260210

# 查看结果
cat data/okx_angle_analysis/okx_angles_20260210.jsonl | python3 -m json.tool
```

**相关文件**：
- `collectors/okx_angle_analyzer.py` - V1版本
- `collectors/okx_angle_analyzer_v2.py` - V2版本（推荐）
- `data/okx_angle_analysis/` - 结果目录

**Git提交**：
- `91c99c7 - feat: 添加OKX趋势角度分析器（锐角/钝角系统）`
