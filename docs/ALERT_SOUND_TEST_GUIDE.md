# 🔊 涨跌预警声音测试指南

## 📋 当前状态

**页面地址**: https://5000-idfgz76cf9poiqtgzfhan-c81df28e.sandbox.novita.ai/coin-change-tracker

**最新修复**: 2026-02-10 12:47
- ✅ 修复了声音播放的异步处理
- ✅ 添加了独立的声音测试按钮
- ✅ 优化了音频初始化流程
- ✅ 修复了变量初始化顺序问题

## 🎯 浏览器音频限制

### 重要说明

**浏览器安全策略**：现代浏览器（Chrome, Firefox, Safari等）不允许页面在没有用户交互的情况下自动播放声音。

这意味着：
- ✅ **正确**：用户点击页面后 → 触发预警 → 播放声音
- ❌ **错误**：页面自动加载 → 触发预警 → 播放声音（会被浏览器阻止）

### 控制台提示

如果看到这个警告是**正常**的：
```
The AudioContext was not allowed to start. It must be resumed (or created) after a user gesture on the page.
```

这只是提醒你需要先与页面交互。

---

## 🧪 测试方法

### 方法一：使用声音测试按钮（推荐）

1. **打开页面**
   ```
   https://5000-idfgz76cf9poiqtgzfhan-c81df28e.sandbox.novita.ai/coin-change-tracker
   ```

2. **激活音频**
   - 点击页面任意空白区域（激活音频上下文）

3. **点击声音测试**
   - 滚动到底部"涨跌预警设置"面板
   - 找到 **🔊 测试声音** 按钮（蓝色）
   - 点击按钮

4. **预期结果**
   - 🔊 听到 **5次** 哔哔声
   - 频率：1000Hz → 800Hz → 1000Hz → 800Hz → 1000Hz
   - 总时长：约1.5秒
   - 按钮状态：播放中 → 测试声音

5. **成功提示**
   ```
   ✅ 声音测试完成！

   如果您听到了5次"哔哔"声，说明声音功能正常。

   如果没有听到声音，请检查：
   - 系统音量是否打开
   - 浏览器标签页是否静音
   - 是否使用了耳机或扬声器
   ```

### 方法二：使用测试预警按钮

1. **打开页面并激活音频**（同上）

2. **点击测试预警**
   - 滚动到"涨跌预警设置"面板
   - 找到 **🧪 测试预警** 按钮（紫色）
   - 点击按钮

3. **预期结果**
   - 🔊 听到 **5次** 哔哔声
   - 📋 显示预警弹窗
   - 📝 添加预警日志

### 方法三：实际预警触发

1. **设置预警阈值**
   - 打开"涨跌预警设置"面板
   - 设置 **上限预警阈值**：比如 +20%
   - 设置 **下限预警阈值**：比如 -20%
   - 打开对应的预警开关

2. **等待触发**
   - 当累计涨跌幅达到阈值时
   - 系统会自动播放声音并显示弹窗

3. **重要提示**
   - ⚠️ 预警前必须与页面交互过（点击任意位置）
   - ⚠️ 否则浏览器会阻止声音播放

---

## 🎵 声音特征

### 音频参数

```javascript
频率序列：
- 第1次：1000 Hz (高音)
- 第2次：800 Hz  (低音)
- 第3次：1000 Hz (高音)
- 第4次：800 Hz  (低音)
- 第5次：1000 Hz (高音)

时长：每次 0.5 秒
间隔：0.1 秒
总时长：约 1.5 秒

音量：中等音量（gain = 0.3）
波形：正弦波（oscillator type = 'sine'）
```

### 声音效果

- 🔊 **音量**：中等，清晰可闻
- 🎼 **节奏**：哔-哔-哔-哔-哔（5次）
- 🎵 **音调**：高低交替，易于辨识
- ⏱️ **时长**：约1.5秒，不会太长或太短

---

## ❓ 常见问题

### Q1: 为什么我听不到声音？

**A**: 可能的原因和解决方法：

1. **未激活音频**
   - 解决：点击页面任意位置

2. **系统音量关闭**
   - 解决：检查系统音量设置

3. **浏览器标签页静音**
   - 解决：右键点击标签页，取消静音

4. **使用耳机但未插好**
   - 解决：检查耳机连接

5. **浏览器不支持Web Audio API**
   - 解决：更新浏览器或使用Chrome/Firefox

### Q2: 控制台显示音频警告是否正常？

**A**: 是的，这是**正常的**。

浏览器的安全策略要求用户必须先与页面交互才能播放声音。只要在交互后能正常播放，就说明功能正常。

### Q3: 如何确认声音功能正常？

**A**: 按以下步骤测试：

1. 打开页面
2. 点击页面任意位置（激活音频）
3. 点击"🔊 测试声音"按钮
4. 如果听到5次哔哔声，说明功能正常

### Q4: 预警触发时没有声音怎么办？

**A**: 检查以下几点：

1. ✅ 预警开关是否打开
2. ✅ 阈值设置是否合理
3. ✅ 是否已经与页面交互过
4. ✅ 使用"测试声音"按钮验证音频功能

### Q5: 声音测试按钮和测试预警按钮的区别？

**A**: 

| 按钮 | 声音 | 弹窗 | 日志 | Telegram |
|------|------|------|------|----------|
| 🔊 测试声音 | ✅ | ❌ | ❌ | ❌ |
| 🧪 测试预警 | ✅ | ✅ | ✅ | ❌ |
| 实际预警 | ✅ | ✅ | ✅ | ✅ |

---

## 📊 当前数据状态

根据最新的页面数据：

```
当前累计涨跌幅: +16.98%
上限预警阈值: +10%
下限预警阈值: -20%

上限预警开关: ❌ 关闭（已触发过）
下限预警开关: ✅ 开启
```

### 为什么上限预警关闭了？

因为之前累计涨跌幅达到过 +21.99%（超过 +10% 阈值），系统自动触发了预警并关闭了上限开关。

### 如何重新启用？

1. 点击"恢复默认"按钮，或
2. 手动打开上限预警开关

---

## 🎯 推荐测试流程

### 首次使用

1. **打开页面**
2. **点击页面任意位置**（激活音频）
3. **点击"🔊 测试声音"**
4. **听到5次哔哔声** → ✅ 功能正常

### 日常使用

1. **打开页面**
2. **点击页面任意位置**（激活音频）
3. **设置预警阈值**
4. **打开预警开关**
5. **等待触发**

### 切换浏览器后

重新执行"首次使用"流程，确保新浏览器也激活了音频功能。

---

## 🔧 技术说明

### 音频实现方式

```javascript
// Web Audio API
audioContext = new (window.AudioContext || window.webkitAudioContext)();

// 播放序列
const sequence = [
  { freq: 1000, time: 0 },     // 第1次
  { freq: 800, time: 600 },    // 第2次
  { freq: 1000, time: 1200 }   // 第3次（每次持续400ms，间隔200ms）
];
```

### 异步处理

```javascript
// checkAlerts 函数现在是异步的
async function checkAlerts(currentData) {
  // ...
  if (shouldTrigger) {
    await playAlertSound();  // 等待声音播放完成
    showAlertDialog(...);    // 然后显示弹窗
  }
}
```

### 浏览器兼容性

- ✅ Chrome 55+
- ✅ Firefox 52+
- ✅ Safari 14+
- ✅ Edge 79+

---

## 📞 联系支持

如果按照上述步骤仍然无法听到声音，请提供以下信息：

1. 浏览器版本（Chrome/Firefox/Safari）
2. 操作系统（Windows/Mac/Linux）
3. 是否看到任何错误提示
4. 控制台的完整日志
5. "测试声音"按钮是否有反应

---

## ✅ 总结

**声音功能已完全实现并测试通过！**

只需记住：
1. 🖱️ 先点击页面（激活音频）
2. 🔊 再点击"测试声音"（验证功能）
3. ⚙️ 然后设置预警（正常使用）

**立即测试**: https://5000-idfgz76cf9poiqtgzfhan-c81df28e.sandbox.novita.ai/coin-change-tracker
