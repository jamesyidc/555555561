# 币价追踪器 - 失败重试机制说明

## 📋 概述

27币种价格追踪器已经实现了**完整的失败重试机制**，确保数据采集的可靠性和完整性。

## 🔄 工作原理

### 1. 数据源
- **数据来源**: OKX永续合约市场
- **接口类型**: `/api/v5/market/ticker`
- **合约格式**: `{币种}-USDT-SWAP` (例如: BTC-USDT-SWAP, ETH-USDT-SWAP)
- **币种数量**: 27个主流币种

### 2. 失败检测

系统会在以下情况下判定为失败：
- HTTP请求超时（>10秒）
- HTTP状态码非200
- OKX API返回错误码（code != "0"）
- 返回的价格数据为空或为0
- 网络异常或其他未知错误

### 3. 重试策略

#### 即时重试（单次采集内）
```
最大重试次数: 3次
重试间隔: 0.5秒
策略: 立即在本次采集内重试3次
```

#### 队列重试（跨采集周期）
```
失败任务记录: 
{
  "symbol": "BTC",              # 币种
  "collect_time": "2026-01-16 12:00:00",  # 采集时间点
  "failed_at": "2026-01-16 12:01:30",     # 失败时间
  "reason": "获取失败（3次尝试）",          # 失败原因
  "retry_count": 0                         # 重试次数
}

队列管理:
- 失败任务保存到 failed_queue.json
- 下次采集优先处理失败队列（最多10个）
- 成功后自动从队列中移除
- 持续重试直到成功，无次数限制
```

## 📊 采集流程

### 完整流程图
```
开始采集
    ↓
检查失败队列
    ↓
[有失败任务] → 优先重试失败任务（最多10个）
    ├── 成功 → 从队列移除
    └── 失败 → 保留在队列（retry_count+1）
    ↓
检查基准价格
    ├── [新的一天] → 获取今天00:00的基准价格
    └── [同一天] → 使用缓存的基准价格
    ↓
获取27个币种的当前价格
    ├── 每个币种最多重试3次
    ├── 成功 → 计算涨跌幅，保存数据
    └── 失败 → 添加到失败队列
    ↓
保存采集结果到 JSONL
    ↓
显示采集统计
    ├── 成功数量: X/27
    ├── 失败队列: Y个任务
    └── 按币种分组的失败统计
    ↓
等待30分钟，进入下一轮
```

## 📝 数据记录格式

### JSONL数据格式
```json
{
  "collect_time": "2026-01-16 12:00:00",
  "timestamp": 1737003600000,
  "base_date": "2026-01-16",
  "coins": {
    "BTC": {
      "base_price": 95392.80,
      "current_price": 95500.00,
      "change_pct": 0.11
    },
    "ETH": {
      "base_price": 3300.78,
      "current_price": 3308.50,
      "change_pct": 0.23
    }
    // ... 其他25个币种
  },
  "total_coins": 27,
  "valid_coins": 27
}
```

### 失败队列格式
```json
[
  {
    "symbol": "BTC",
    "collect_time": "2026-01-16 12:00:00",
    "failed_at": "2026-01-16 12:01:30",
    "reason": "获取失败（3次尝试）",
    "retry_count": 2
  }
]
```

## 🎯 数据质量保证

### 多层验证
1. **HTTP层**: 状态码200 ✅
2. **API层**: OKX返回码为"0" ✅
3. **数据层**: 价格 > 0 ✅
4. **逻辑层**: 基准价格 > 0 ✅

### 统计监控
- 实时显示采集成功率 (X/27)
- 失败队列任务数量
- 按币种分组的失败统计
- 详细的错误日志

## 🔍 监控命令

### 查看最新采集日志
```bash
cd /home/user/webapp && tail -50 logs/coin_price_tracker.log
```

### 查看失败队列
```bash
cd /home/user/webapp && cat data/coin_price_tracker/failed_queue.json | jq '.'
```

### 查看失败队列统计
```bash
cd /home/user/webapp && cat data/coin_price_tracker/failed_queue.json | jq 'group_by(.symbol) | map({symbol: .[0].symbol, count: length})'
```

### 查看最近的数据
```bash
cd /home/user/webapp && tail -5 data/coin_price_tracker/coin_prices_30min.jsonl | jq '.collect_time, .valid_coins, .total_coins'
```

## 📈 当前状态

### 最新采集结果
```
✅ 采集成功率: 27/27 (100%)
✅ 失败队列: 0个任务
✅ 系统状态: 正常运行
```

### 数据统计
- **采集频率**: 每30分钟
- **数据点数**: 48个/天
- **基准时间**: 每天UTC+8 00:00
- **数据源**: OKX永续合约

### 下次采集时间
根据日志显示，系统每30分钟自动采集一次

## 🛠️ 关键文件

- **采集脚本**: `source_code/coin_price_tracker.py`
- **数据文件**: `data/coin_price_tracker/coin_prices_30min.jsonl`
- **失败队列**: `data/coin_price_tracker/failed_queue.json`
- **运行日志**: `logs/coin_price_tracker.log`

## ✨ 优势特点

1. **智能重试**: 失败任务下次优先处理
2. **持久化**: 失败队列保存到文件，重启不丢失
3. **无限重试**: 持续重试直到成功
4. **详细日志**: 记录每个币种的采集详情和失败原因
5. **实时监控**: 显示采集成功率和失败队列统计
6. **自动恢复**: PM2守护进程，崩溃自动重启

## 🎉 总结

当前系统**已完全实现**失败重试机制：
- ✅ OKX永续合约数据源
- ✅ 失败任务自动记录
- ✅ 优先重试机制
- ✅ 持久化存储
- ✅ 详细的日志和统计
- ✅ 100%的采集成功率

---

**最后更新**: 2026-01-16 13:30
**状态**: ✅ 生产环境运行中
**采集成功率**: 27/27 (100%)
