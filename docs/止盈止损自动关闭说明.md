# 止盈止损自动关闭功能说明

## 功能概述

当止盈或止损被触发时，系统会自动关闭对应的开关，防止重复触发警报。下次需要手动重新开启。

## 工作原理

### 触发条件

1. **止盈触发**：当账户未实现盈亏 ≥ 止盈阈值时
   - 示例：设置止盈阈值为 +100 USDT，当盈利达到 100 USDT 时触发

2. **止损触发**：当账户未实现盈亏 ≤ 止损阈值时
   - 示例：设置止损阈值为 -50 USDT，当亏损达到 50 USDT 时触发

### 自动关闭流程

```
1. 系统检测到触发条件满足
   ↓
2. 弹出警报提示用户
   ↓
3. 自动关闭对应开关（止盈/止损）
   ↓
4. 保存更新后的设置到服务器
   ↓
5. 记录到控制台日志
   ↓
6. 发送浏览器通知（如果已授权）
```

## 使用示例

### 场景 1：止盈触发

**设置**：
- 止盈开关：✅ 已开启
- 止盈阈值：+100 USDT

**触发时刻**：
- 当前未实现盈亏：+102.50 USDT
- 系统检测到 102.50 ≥ 100

**系统行为**：
```
✅ 弹出警报：
   🎉 止盈警报！
   
   当前未实现盈亏：+102.50 USDT
   止盈阈值：+100.00 USDT
   
   建议考虑平仓锁定利润！
   
   ⚠️ 止盈已自动关闭，下次需要手动开启！

✅ 自动关闭止盈开关
✅ 保存设置到服务器
✅ 记录日志：[止盈警报] 止盈已触发并自动关闭，下次需要手动开启
```

**后续操作**：
- 用户需要手动重新开启止盈开关
- 或者调整止盈阈值后再开启

### 场景 2：止损触发

**设置**：
- 止损开关：✅ 已开启
- 止损阈值：-50 USDT

**触发时刻**：
- 当前未实现盈亏：-52.30 USDT
- 系统检测到 -52.30 ≤ -50

**系统行为**：
```
✅ 弹出警报：
   ⚠️ 止损警报！
   
   当前未实现盈亏：-52.30 USDT
   止损阈值：-50.00 USDT
   
   建议立即平仓止损！
   
   ⚠️ 止损已自动关闭，下次需要手动开启！

✅ 自动关闭止损开关
✅ 保存设置到服务器
✅ 记录日志：[止损警报] 止损已触发并自动关闭，下次需要手动开启
```

**后续操作**：
- 用户需要手动重新开启止损开关
- 或者调整止损阈值后再开启

## 重复触发保护

系统设置了 **5 分钟冷却时间**，即使开关未关闭，同一类型的警报也不会在 5 分钟内重复触发。

## 技术实现

### 前端代码（templates/okx_trading.html）

```javascript
// 显示止盈警报（自动关闭版本）
async function showTakeProfitAlert(currentPnl, threshold) {
    const message = `🎉 止盈警报！\n\n当前未实现盈亏：+${currentPnl.toFixed(2)} USDT\n止盈阈值：+${threshold.toFixed(2)} USDT\n\n建议考虑平仓锁定利润！\n\n⚠️ 止盈已自动关闭，下次需要手动开启！`;
    alert(message);
    
    // 自动关闭止盈开关
    const takeProfitSwitch = document.getElementById('takeProfitSwitch');
    if (takeProfitSwitch) {
        takeProfitSwitch.checked = false;
        
        // 保存设置到服务器
        await saveTakeProfitStopLossSettings();
        
        console.log('[止盈警报] 止盈已触发并自动关闭，下次需要手动开启');
    }
    
    // 发送浏览器通知
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('🎉 止盈警报', {
            body: `当前盈利：+${currentPnl.toFixed(2)} USDT，已达止盈目标！止盈已自动关闭。`,
            icon: '/static/favicon.ico',
            requireInteraction: true
        });
    }
}

// 显示止损警报（自动关闭版本）
async function showStopLossAlert(currentPnl, threshold) {
    const message = `⚠️ 止损警报！\n\n当前未实现盈亏：${currentPnl.toFixed(2)} USDT\n止损阈值：${threshold.toFixed(2)} USDT\n\n建议立即平仓止损！\n\n⚠️ 止损已自动关闭，下次需要手动开启！`;
    alert(message);
    
    // 自动关闭止损开关
    const stopLossSwitch = document.getElementById('stopLossSwitch');
    if (stopLossSwitch) {
        stopLossSwitch.checked = false;
        
        // 保存设置到服务器
        await saveTakeProfitStopLossSettings();
        
        console.log('[止损警报] 止损已触发并自动关闭，下次需要手动开启');
    }
    
    // 发送浏览器通知
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('⚠️ 止损警报', {
            body: `当前亏损：${currentPnl.toFixed(2)} USDT，已达止损线！止损已自动关闭。`,
            icon: '/static/favicon.ico',
            requireInteraction: true
        });
    }
}
```

## 注意事项

1. **每个账户独立计算**：不同账户的止盈止损设置互不影响
2. **触发一次即关闭**：确保每个账户只触发一次警报
3. **需要手动重启**：触发后必须手动重新开启开关
4. **设置持久化**：关闭状态会保存到服务器，刷新页面后仍然保持关闭状态
5. **实时监控**：页面会实时监控未实现盈亏，自动检测触发条件

## 相关文件

- 前端页面：`/home/user/webapp/templates/okx_trading.html`
- API 接口：`/api/okx-trading/tpsl-settings/<account_id>`
- 配置存储：`/home/user/webapp/data/okx_tpsl_settings/<account_id>.json`
- 历史记录：`/home/user/webapp/data/okx_tpsl_settings/<account_id>_history.jsonl`

## 更新日志

- **2026-02-15**：实现止盈止损触发后自动关闭功能
  - 触发警报后自动关闭对应开关
  - 自动保存更新后的设置
  - 改进警报消息，明确提示开关已关闭
  - 防止同一账户重复触发警报

## 访问地址

https://9002-iou7okyaq15h840cyuitp-c07dda5e.sandbox.novita.ai/okx-trading
