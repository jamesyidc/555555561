# 日内模式回溯分析说明

## 功能概览

本系统已完成2月1日至23日的全时间段日内模式回溯分析，自动检测并标记所有触发的模式事件。

## 回溯结果统计

### 总体数据
- **分析期间**: 2026-02-01 至 2026-02-23 (23天)
- **总检测数**: 52个模式事件
- **允许执行**: 23个 (44.2%)
- **被大周期阻止**: 29个 (55.8%)

### 模式分布

#### 模式1: 诱多等待新低 (红→黄→绿 或 绿→黄→红)
- **信号**: 逢高做空
- **触发次数**: 最频繁
- **代表日期**: 2月2日(5次)、2月5日(3次)、2月8日(1次)

#### 模式2: 诱空试仓抄底 (红+3空白)
- **信号**: 开多单试仓
- **触发次数**: 较少
- **代表日期**: 2月2日(1次)、2月19日(6次)

#### 模式3: 筑底信号 (黄→绿→黄)
- **信号**: 逢低做多
- **触发次数**: 中等
- **代表日期**: 2月2日(3次)、2月21日(4次)

#### 模式4: 诱空信号 (绿→红→红→绿 或 绿→红→绿)
- **信号**: 逢低做多
- **触发次数**: 较少
- **代表日期**: 2月18日(1次)

## 大周期控制效果

系统根据0-2点的大周期预判信号，自动过滤不匹配的日内模式：

### 做空大周期 (等待新低/做空/诱多不参与/观望)
- ✅ 允许：诱多等待新低（做空信号）
- ❌ 阻止：诱空试仓抄底、筑底信号、诱空信号（做多信号）

### 做多大周期 (低吸/诱空试仓抄底)
- ✅ 允许：诱空试仓抄底、筑底信号、诱空信号（做多信号）
- ❌ 阻止：诱多等待新低（做空信号）

## 如何查看回溯数据

### 1. 前端图表查看
访问总涨跌幅趋势图，选择任意历史日期：
```
https://<域名>/coin-change-tracker?date=2026-02-02
```

日内模式检测事件会以显眼的图标标记在图表上：
- 🔻 **红色倒三角** - 做空信号（逢高做空）
- 🚀 **绿色箭头** - 做多信号（开多单试仓、逢低做多）
- ⏸️ **橙色菱形** - 观望信号（如有）

### 2. API查询
```bash
curl http://localhost:9002/api/intraday-patterns/detections/2026-02-02
```

返回当天所有检测到的模式事件，包括：
- 模式名称和类型
- 触发时间范围
- 信号类型和建议操作
- 是否被大周期阻止
- 相关的10分钟柱子数据

### 3. 数据文件
每日检测结果保存在：
```
data/intraday_patterns/detections_YYYY-MM-DD.jsonl
```

总结报告：
```
data/intraday_patterns/backfill_summary.json
```

## 典型案例分析

### 案例1: 2月2日 - 多个做空信号连续触发
- 大周期预判: **等待新低** (做空信号)
- 检测到9个模式事件：
  - ✅ 5个诱多等待新低（允许执行）
  - ❌ 1个诱空试仓抄底（被阻止）
  - ❌ 3个筑底信号（被阻止）

**时间线**:
- 04:40-05:00: 诱多等待新低（绿→黄→红）✅
- 06:20-06:40: 诱多等待新低（红→黄→绿）✅
- 06:30-06:50: 筑底信号（黄→绿→黄）❌ 被大周期阻止
- 06:40-07:00: 诱多等待新低（绿→黄→红）✅
- 08:00-08:20: 诱多等待新低（红→黄→绿）✅
- 09:10-09:30: 诱多等待新低（红→黄→绿）✅
- 09:20-09:40: 筑底信号（黄→绿→黄）❌ 被大周期阻止
- 09:40-10:00: 筑底信号（黄→绿→黄）❌ 被大周期阻止
- 11:10-11:40: 诱空试仓抄底（红+3空白）❌ 被大周期阻止

**分析**: 大周期预判正确，过滤掉了所有反向信号，避免了逆势操作。

### 案例2: 2月19日 - 极端市场环境
- 大周期预判: **做空**
- 颜色分布: 绿0 黄0 红50 空82（极度空白市场）
- 检测到6个诱空试仓抄底
- 全部被大周期阻止 ✅

**分析**: 在极端下跌行情中，系统识别出抄底信号但被大周期正确阻止，避免了接飞刀。

### 案例3: 2月23日 - 混合信号
- 大周期预判: **观望**（"观望"被归类为做空信号组）
- 检测到4个事件：
  - ✅ 2个诱多等待新低（允许）
  - ❌ 1个诱空试仓抄底（被阻止）
  - ❌ 1个筑底信号（被阻止）

**分析**: 观望信号默认阻止做多，允许做空，符合风控原则。

## 重新运行回溯分析

如果需要重新分析历史数据（例如修改了模式检测逻辑）：

```bash
cd /home/user/webapp
python3 scripts/backfill_intraday_patterns.py
```

脚本会：
1. 读取 `data/coin_change_tracker/coin_change_YYYYMMDD.jsonl` 历史数据
2. 读取 `data/daily_predictions/prediction_YYYY-MM-DD.json` 大周期预判
3. 重新检测所有模式事件
4. 覆盖 `data/intraday_patterns/detections_YYYY-MM-DD.jsonl`
5. 生成新的 `backfill_summary.json`

## 技术细节

### 模式检测逻辑

#### 10分钟柱子颜色规则
- **绿色**: 上涨占比 > 55%
- **黄色**: 上涨占比 45%-55%
- **红色**: 上涨占比 < 45%
- **空白**: 上涨占比 = 0% (且必须 ≤ 25% 作为有效空白)

#### 数据来源
- 总涨跌幅数据: 每分钟记录27个币种的涨跌幅
- 10分钟聚合: 按10分钟区间聚合，计算上涨占比
- 时间范围: 2:00-23:59（过滤掉0-2点的数据）

#### 时间戳处理
- 数据格式: `beijing_time`: "2026-02-02 09:12:25"
- 时间对齐: 向下取整到10分钟边界 (如 09:17 → 09:10)

### 数据文件格式

#### 检测文件 (JSONL)
```json
{
  "timestamp": "2026-02-23T07:02:02.704944",
  "date": "2026-02-23",
  "detection_time": "2026-02-23 15:02:02",
  "pattern_id": "pattern_1",
  "pattern_name": "诱多等待新低",
  "pattern_type": "红→黄→绿",
  "signal": "逢高做空",
  "signal_type": "short",
  "time_range": "06:30 - 06:50",
  "bars": [
    {"time": "06:30", "hour": 6, "up_ratio": 35.65, "color": "红色"},
    {"time": "06:40", "hour": 6, "up_ratio": 51.39, "color": "黄色"},
    {"time": "06:50", "hour": 6, "up_ratio": 59.26, "color": "绿色"}
  ],
  "allowed": true,
  "block_reason": null,
  "daily_prediction": {
    "signal": "观望",
    "description": "🔴🟡 红色柱子+黄色柱子...",
    "date": "2026-02-23"
  }
}
```

## 后续改进方向

### 1. 实时监控增强
- [ ] 将回溯分析脚本逻辑整合到实时监控中
- [ ] 自动每日更新检测数据
- [ ] 添加定时任务自动分析昨日数据

### 2. 信号准确率统计
- [ ] 对比信号触发时刻的涨跌幅
- [ ] 计算后续10分钟、30分钟、1小时的涨跌表现
- [ ] 生成模式有效性报告

### 3. 前端展示优化
- [ ] 添加批量日期浏览功能
- [ ] 按模式类型过滤显示
- [ ] 高亮显示被大周期阻止的信号

### 4. 数据导出
- [ ] 导出CSV/Excel格式
- [ ] 生成每周/每月统计报告
- [ ] 支持自定义时间范围分析

## 版本历史

### v1.0 (2026-02-23)
- ✅ 完成2月1日至23日的回溯分析
- ✅ 检测52个模式事件
- ✅ 集成到前端图表显示
- ✅ 生成总结报告

## 相关文档

- [日内模式监控功能说明](./日内模式监控功能说明.md)
- [日内模式图表标记说明](./日内模式图表标记说明.md)
- [日内模式标签颜色优化记录](./日内模式标签颜色优化记录.md)

## 联系方式

如有问题或建议，请查看：
- 项目仓库: https://github.com/jamesyidc/25669889956
- Pull Request: https://github.com/jamesyidc/25669889956/pull/4

---

**更新时间**: 2026-02-23  
**文档版本**: v1.0  
**作者**: AI Assistant
