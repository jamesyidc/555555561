# ç³»ç»Ÿå†…å­˜æ³„æ¼è¯Šæ–­æŠ¥å‘Š

## è¯Šæ–­æ—¶é—´
2026-02-07 21:35

## ğŸš¨ å‘ç°çš„é—®é¢˜

### 1. ä¸¥é‡é—®é¢˜ï¼šFlaskåº”ç”¨é¢‘ç¹é‡å¯
```
flask-app: 
- é‡å¯æ¬¡æ•°: 108æ¬¡
- å½“å‰è¿è¡Œæ—¶é•¿: ä»…4åˆ†é’Ÿ
- å†…å­˜å ç”¨: 129.7MB
```

**åˆ†æ**ï¼š
- Flaskåº”ç”¨åœ¨12å°æ—¶å†…é‡å¯äº†108æ¬¡ï¼Œå¹³å‡æ¯7åˆ†é’Ÿé‡å¯ä¸€æ¬¡
- è¿™è¡¨æ˜å­˜åœ¨ä¸¥é‡çš„ç¨³å®šæ€§é—®é¢˜ï¼Œå¯èƒ½æ˜¯ï¼š
  - å†…å­˜æ³„æ¼å¯¼è‡´OOM Killeræ€æ­»è¿›ç¨‹
  - æœªæ•è·çš„å¼‚å¸¸å¯¼è‡´å´©æºƒ
  - èµ„æºè€—å°½ï¼ˆæ–‡ä»¶å¥æŸ„ã€æ•°æ®åº“è¿æ¥ç­‰ï¼‰

### 2. ä¸­ç­‰é—®é¢˜ï¼šsignal-timeline-collectoré¢‘ç¹é‡å¯
```
signal-timeline-collector:
- é‡å¯æ¬¡æ•°: 64æ¬¡
- å½“å‰è¿è¡Œæ—¶é•¿: 16ç§’
- å†…å­˜å ç”¨: 31.5MB
```

**åˆ†æ**ï¼š
- è¿™ä¸ªé‡‡é›†å™¨ä¹Ÿé¢‘ç¹é‡å¯ï¼Œå¯èƒ½å­˜åœ¨æ•°æ®å¤„ç†å¼‚å¸¸æˆ–APIè°ƒç”¨å¤±è´¥

### 3. å†å²OOMäº‹ä»¶
```bash
dmesg æ˜¾ç¤ºï¼š
Out of memory: Killed process 129101 (git) 
total-vm:7164820kB, anon-rss:6920640kB
```

**åˆ†æ**ï¼š
- ç³»ç»Ÿæ›¾ç»è§¦å‘è¿‡OOM Killer
- ä¸€ä¸ªgitè¿›ç¨‹å ç”¨äº†çº¦6.7GBå†…å­˜è¢«æ€æ­»
- è¯´æ˜ç³»ç»Ÿåœ¨æŸä¸ªæ—¶åˆ»å†…å­˜ä¸¥é‡ä¸è¶³

## ğŸ“Š å½“å‰ç³»ç»ŸçŠ¶æ€

### ç³»ç»Ÿå†…å­˜
```
æ€»å†…å­˜: 7967MB (çº¦7.8GB)
å·²ä½¿ç”¨: 1148MB (14.4%)
ç©ºé—²: 6560MB
Swapä½¿ç”¨: 123MB/127MB (97% - å‡ ä¹ç”¨å®Œ)
```

**å½“å‰çŠ¶æ€**ï¼šâœ… æ­£å¸¸
- ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡ä½ï¼ˆ14.4%ï¼‰
- ä½†Swapå‡ ä¹ç”¨å®Œï¼Œè¯´æ˜ä¹‹å‰æœ‰è¿‡å†…å­˜å‹åŠ›

### è¿›ç¨‹å†…å­˜æ’è¡Œï¼ˆTOP 10ï¼‰
```
1. major-events-monitor: 197MB (è¿è¡Œ12h, æœ€é«˜)
2. flask-app: 129MB (è¿è¡Œ4m, é¢‘ç¹é‡å¯)
3. gdrive-detector: 49MB
4. sar-collector: 35MB
5. gdrive-jsonl-manager: 31MB
6. sar-bias-stats-collector: 31MB
7. signal-timeline-collector: 31MB
8. data-health-monitor: 27MB
9. sr-v2-daemon: 27MB
10. panic-wash-collector: 26MB
```

### æ•°æ®å­˜å‚¨çŠ¶æ€
```
æœ€å¤§çš„æ•°æ®ç›®å½•ï¼š
1. support_resistance_daily/: 977MB
2. support_resistance_jsonl/: 740MB
3. anchor_daily/: 191MB
4. anchor_profit_stats/: 163MB
5. price_speed_jsonl/: 134MB
```

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### Flaskåº”ç”¨é¢‘ç¹é‡å¯çš„å¯èƒ½åŸå› 

#### 1. å†…å­˜æ³„æ¼
**ç—‡çŠ¶**ï¼š
- åº”ç”¨è¿è¡Œä¸€æ®µæ—¶é—´åå†…å­˜æŒç»­å¢é•¿
- æœ€ç»ˆè¢«OOM Killeræ€æ­»
- PM2è‡ªåŠ¨é‡å¯

**æ’æŸ¥ç‚¹**ï¼š
- å…¨å±€å˜é‡ç§¯ç´¯æ•°æ®
- æ•°æ®åº“è¿æ¥æœªå…³é—­
- ç¼“å­˜æ— é™å¢é•¿
- å¤§æ•°æ®é›†åŠ è½½åˆ°å†…å­˜

#### 2. æœªæ•è·çš„å¼‚å¸¸
**ç—‡çŠ¶**ï¼š
- ä»£ç ä¸­å­˜åœ¨æœªå¤„ç†çš„å¼‚å¸¸
- å¯¼è‡´åº”ç”¨å´©æºƒé€€å‡º

**æ’æŸ¥ç‚¹**ï¼š
```bash
# æ£€æŸ¥Flaské”™è¯¯æ—¥å¿—
pm2 logs flask-app --err --lines 100
```

#### 3. æ•°æ®åº“é”æˆ–è¿æ¥é—®é¢˜
**ç—‡çŠ¶**ï¼š
- SQLiteæ•°æ®åº“é”æ­»
- è¿æ¥æ± è€—å°½

**æ’æŸ¥ç‚¹**ï¼š
- æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£ç¡®å…³é—­
- æ˜¯å¦æœ‰é•¿æ—¶é—´æŒæœ‰çš„é”

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### ç«‹å³æªæ–½

#### 1. æ·»åŠ å†…å­˜ç›‘æ§å’Œæ—¥å¿—
```python
# åœ¨app.pyä¸­æ·»åŠ å†…å­˜ç›‘æ§è£…é¥°å™¨
import tracemalloc
import psutil

def log_memory_usage(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        process = psutil.Process()
        mem_before = process.memory_info().rss / 1024 / 1024
        
        result = func(*args, **kwargs)
        
        mem_after = process.memory_info().rss / 1024 / 1024
        mem_diff = mem_after - mem_before
        
        if mem_diff > 10:  # å¢é•¿è¶…è¿‡10MB
            print(f"âš ï¸ Memory spike: {func.__name__} +{mem_diff:.1f}MB")
        
        return result
    return wrapper
```

#### 2. é™åˆ¶ç¼“å­˜å¤§å°
```python
from functools import lru_cache

# ä½¿ç”¨æœ‰é™å¤§å°çš„ç¼“å­˜
@lru_cache(maxsize=100)  # é™åˆ¶ç¼“å­˜æ¡ç›®æ•°
def expensive_function():
    pass
```

#### 3. ç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾
```python
# ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨
def get_db_connection():
    conn = sqlite3.connect('database.db')
    try:
        yield conn
    finally:
        conn.close()

# ä½¿ç”¨
with get_db_connection() as conn:
    # æ“ä½œæ•°æ®åº“
    pass
```

#### 4. æ·»åŠ å¼‚å¸¸æ•è·
```python
@app.errorhandler(Exception)
def handle_exception(e):
    # è®°å½•å®Œæ•´é”™è¯¯æ ˆ
    print(f"âŒ Unhandled exception: {e}")
    print(traceback.format_exc())
    return jsonify({'error': str(e)}), 500
```

### é•¿æœŸä¼˜åŒ–

#### 1. å®æ–½å†…å­˜åˆ†æ
```bash
# å¯ç”¨Pythonå†…å­˜åˆ†æ
python3 -m memory_profiler app.py

# æˆ–ä½¿ç”¨tracemalloc
import tracemalloc
tracemalloc.start()
# ... è¿è¡Œä¸€æ®µæ—¶é—´å
snapshot = tracemalloc.take_snapshot()
top_stats = snapshot.statistics('lineno')
for stat in top_stats[:10]:
    print(stat)
```

#### 2. æ•°æ®åº“ä¼˜åŒ–
- ä½¿ç”¨è¿æ¥æ± 
- åŠæ—¶å…³é—­è¿æ¥
- ä¼˜åŒ–æŸ¥è¯¢ï¼Œé¿å…åŠ è½½å¤§é‡æ•°æ®åˆ°å†…å­˜

#### 3. ç¼“å­˜ç­–ç•¥
- ä½¿ç”¨Redisç­‰å¤–éƒ¨ç¼“å­˜
- è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´
- é™åˆ¶ç¼“å­˜å¤§å°

#### 4. è¿›ç¨‹é‡å¯ç­–ç•¥
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'flask-app',
    max_memory_restart: '500M',  // å†…å­˜è¶…è¿‡500Mè‡ªåŠ¨é‡å¯
    max_restarts: 10,             // æœ€å¤šé‡å¯10æ¬¡
    min_uptime: '10s',            // æœ€å°è¿è¡Œæ—¶é—´10ç§’
    exp_backoff_restart_delay: 100  // æŒ‡æ•°é€€é¿é‡å¯
  }]
}
```

## ğŸ“ æ£€æŸ¥æ¸…å•

### ç«‹å³æ£€æŸ¥
- [ ] æŸ¥çœ‹Flaské”™è¯¯æ—¥å¿—ï¼š`pm2 logs flask-app --err --lines 200`
- [ ] æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶å¤§å°ï¼š`du -sh *.db`
- [ ] æŸ¥çœ‹æœ€è¿‘çš„å´©æºƒè®°å½•ï¼š`dmesg | grep -i killed`
- [ ] æ£€æŸ¥æ–‡ä»¶å¥æŸ„ï¼š`lsof -p $(pgrep -f flask-app) | wc -l`

### ä»£ç å®¡æŸ¥
- [ ] æ£€æŸ¥å…¨å±€å˜é‡æ˜¯å¦ç§¯ç´¯æ•°æ®
- [ ] æ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£ç¡®å…³é—­
- [ ] æ£€æŸ¥æ˜¯å¦æœ‰æ— é™å¢é•¿çš„ç¼“å­˜
- [ ] æ£€æŸ¥æ˜¯å¦æœ‰å†…å­˜æ³„æ¼çš„å¾ªç¯å¼•ç”¨

### ç›‘æ§è®¾ç½®
- [ ] é…ç½®å†…å­˜ç›‘æ§å‘Šè­¦
- [ ] æ·»åŠ åº”ç”¨çº§åˆ«çš„å¥åº·æ£€æŸ¥
- [ ] è®¾ç½®åˆç†çš„PM2é‡å¯ç­–ç•¥
- [ ] å¯ç”¨è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

## ğŸ¯ æ¨èè¡ŒåŠ¨è®¡åˆ’

### Phase 1: ç´§æ€¥è¯Šæ–­ï¼ˆä»Šå¤©ï¼‰
1. **æŸ¥çœ‹Flaské”™è¯¯æ—¥å¿—**ï¼Œæ‰¾å‡ºå´©æºƒåŸå› 
2. **æ£€æŸ¥å†…å­˜å¢é•¿è¶‹åŠ¿**ï¼Œä½¿ç”¨æ–°å»ºçš„å†…å­˜ç›‘æ§é¡µé¢
3. **ä¸´æ—¶æªæ–½**ï¼šé™ä½max_memory_restarté˜ˆå€¼åˆ°300M

### Phase 2: ä»£ç ä¿®å¤ï¼ˆæœ¬å‘¨ï¼‰
1. ä¿®å¤å‘ç°çš„å†…å­˜æ³„æ¼ç‚¹
2. æ·»åŠ å…¨é¢çš„å¼‚å¸¸å¤„ç†
3. ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢å’Œè¿æ¥ç®¡ç†
4. å®æ–½ç¼“å­˜å¤§å°é™åˆ¶

### Phase 3: é•¿æœŸä¼˜åŒ–ï¼ˆä¸‹å‘¨ï¼‰
1. å®æ–½å®Œæ•´çš„å†…å­˜åˆ†æå·¥å…·
2. é‡æ„é«˜å†…å­˜å ç”¨çš„æ¨¡å—
3. æ·»åŠ å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ
4. ç¼–å†™å†…å­˜ä½¿ç”¨è§„èŒƒæ–‡æ¡£

## ğŸ”— ç›¸å…³é“¾æ¥

- å†…å­˜ç›‘æ§é¡µé¢: https://5000-idfgz76cf9poiqtgzfhan-c81df28e.sandbox.novita.ai/check-memory-leak
- Flaskåº”ç”¨æ—¥å¿—: `pm2 logs flask-app`
- ç³»ç»Ÿç›‘æ§: `htop` æˆ– `free -h`

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-02-07 21:35  
**è¯Šæ–­å·¥å…·**: PM2, dmesg, free, ps  
**å»ºè®®ä¼˜å…ˆçº§**: ğŸ”´ é«˜ä¼˜å…ˆçº§ - Flaskåº”ç”¨é¢‘ç¹é‡å¯éœ€è¦ç«‹å³å¤„ç†
