# 止盈止损一键平仓集成说明

## 功能概述

在止盈或止损触发时，系统会自动关闭对应的开关，并弹出确认对话框询问用户是否**一键平仓所有持仓**。用户确认后，系统将调用一键平仓API，自动关闭所有持仓。

---

## 功能流程

### 止盈触发流程

```
1. 未实现盈亏 >= 止盈阈值 (如: +100 USDT)
   ↓
2. 自动关闭止盈开关 ✅
   ↓
3. 保存设置到服务器
   ↓
4. 弹出确认对话框：
   "🎉 止盈警报！
   
   当前未实现盈亏：+102.50 USDT
   止盈阈值：+100 USDT
   
   是否立即一键平仓所有持仓？
   
   ⚠️ 止盈已自动关闭，下次需要手动开启！"
   ↓
5a. 用户点击【确定】
   ↓ 调用一键平仓API
   ↓ 显示平仓结果
   ↓ 刷新账户数据
   
5b. 用户点击【取消】
   ↓ 不执行平仓操作
```

### 止损触发流程

```
1. 未实现盈亏 <= 止损阈值 (如: -50 USDT)
   ↓
2. 自动关闭止损开关 ✅
   ↓
3. 保存设置到服务器
   ↓
4. 弹出确认对话框：
   "⚠️ 止损警报！
   
   当前未实现盈亏：-52.30 USDT
   止损阈值：-50 USDT
   
   是否立即一键平仓所有持仓？
   
   ⚠️ 止损已自动关闭，下次需要手动开启！"
   ↓
5a. 用户点击【确定】
   ↓ 调用一键平仓API
   ↓ 显示平仓结果
   ↓ 刷新账户数据
   
5b. 用户点击【取消】
   ↓ 不执行平仓操作
```

---

## 一键平仓结果示例

### 成功场景（全部平仓成功）

```
✅ 一键平仓完成！

总持仓：8 个
成功平仓：8 个
失败：0 个
```

### 部分成功场景（有重试）

```
✅ 一键平仓完成！

总持仓：8 个
成功平仓：7 个
失败：1 个

第二轮重试：1/2 成功

失败详情：
• ETH-USDT-SWAP: 余额不足
```

### 失败场景

```
❌ 平仓失败：获取持仓失败: API凭证无效
```

---

## 关键特性

### 1. 自动关闭开关 ✅
- 止盈/止损触发后，对应的开关**立即自动关闭**
- 设置保存到服务器，刷新页面后仍为关闭状态
- 下次触发前需要**手动重新开启**

### 2. 用户确认机制 🤝
- 不自动执行平仓操作，而是弹出确认对话框
- 用户可以选择：
  - **确定** - 立即一键平仓所有持仓
  - **取消** - 不执行平仓，保留持仓

### 3. 一键平仓所有持仓 🎯
- 调用 `POST /api/okx-trading/close-all-positions` API
- 自动获取所有持仓并逐个关闭
- 支持多空双向持仓
- 详细的成功/失败报告

### 4. 失败重试机制 🔄
- 第一轮平仓失败的持仓会在2秒后自动重试
- 显示重试结果（如：第二轮重试：1/2 成功）
- 最大限度提高平仓成功率

### 5. 自动刷新数据 🔃
- 平仓成功后自动刷新账户信息
- 自动刷新持仓列表
- 实时更新余额和未实现盈亏

### 6. 浏览器通知 🔔
- 发送浏览器通知（需要用户授权）
- 即使页面在后台也能收到提醒

---

## 前端代码实现

### 1. 止盈警报函数

```javascript
async function showTakeProfitAlert(currentPnl, threshold) {
    // 1. 自动关闭止盈开关
    const takeProfitSwitch = document.getElementById('takeProfitSwitch');
    if (takeProfitSwitch) {
        takeProfitSwitch.checked = false;
        await saveTakeProfitStopLossSettings();
    }
    
    // 2. 弹出确认对话框
    const confirmed = confirm(
        `🎉 止盈警报！\n\n` +
        `当前未实现盈亏：+${currentPnl.toFixed(2)} USDT\n` +
        `止盈阈值：+${threshold.toFixed(2)} USDT\n\n` +
        `是否立即一键平仓所有持仓？\n\n` +
        `⚠️ 止盈已自动关闭，下次需要手动开启！`
    );
    
    // 3. 用户确认后执行平仓
    if (confirmed) {
        await closeAllPositions();
    }
    
    // 4. 发送浏览器通知
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('🎉 止盈警报', {
            body: `当前盈利：+${currentPnl.toFixed(2)} USDT，已达止盈目标！`,
            requireInteraction: true
        });
    }
}
```

### 2. 止损警报函数

```javascript
async function showStopLossAlert(currentPnl, threshold) {
    // 1. 自动关闭止损开关
    const stopLossSwitch = document.getElementById('stopLossSwitch');
    if (stopLossSwitch) {
        stopLossSwitch.checked = false;
        await saveTakeProfitStopLossSettings();
    }
    
    // 2. 弹出确认对话框
    const confirmed = confirm(
        `⚠️ 止损警报！\n\n` +
        `当前未实现盈亏：${currentPnl.toFixed(2)} USDT\n` +
        `止损阈值：${threshold.toFixed(2)} USDT\n\n` +
        `是否立即一键平仓所有持仓？\n\n` +
        `⚠️ 止损已自动关闭，下次需要手动开启！`
    );
    
    // 3. 用户确认后执行平仓
    if (confirmed) {
        await closeAllPositions();
    }
    
    // 4. 发送浏览器通知
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('⚠️ 止损警报', {
            body: `当前亏损：${currentPnl.toFixed(2)} USDT，已达止损线！`,
            requireInteraction: true
        });
    }
}
```

### 3. 一键平仓函数

```javascript
async function closeAllPositions() {
    const account = accounts.find(acc => acc.id === currentAccount);
    if (!account) {
        alert('未找到账户信息');
        return;
    }
    
    try {
        // 调用一键平仓API
        const response = await fetch('/api/okx-trading/close-all-positions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                apiKey: account.apiKey,
                apiSecret: account.apiSecret,
                passphrase: account.passphrase,
                accountId: account.id
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            let message = `✅ 一键平仓完成！\n\n` +
                         `总持仓：${result.totalPositions} 个\n` +
                         `成功平仓：${result.closedCount} 个\n` +
                         `失败：${result.failedCount} 个`;
            
            // 显示重试结果
            if (result.retryCount > 0) {
                message += `\n\n第二轮重试：${result.retrySuccess}/${result.retryCount} 成功`;
            }
            
            // 显示失败详情
            if (result.failedCount > 0) {
                message += '\n\n失败详情：';
                result.results.filter(r => r.status === 'failed').forEach(r => {
                    message += `\n• ${r.instId}: ${r.message}`;
                });
            }
            
            alert(message);
            
            // 刷新账户数据
            await refreshAccountData();
        } else {
            alert(`平仓失败：${result.message}`);
        }
    } catch (error) {
        alert(`一键平仓异常：${error.message}`);
    }
}
```

---

## 后端API

### 一键平仓API

- **端点**：`POST /api/okx-trading/close-all-positions`
- **请求体**：
```json
{
  "apiKey": "your_api_key",
  "apiSecret": "your_api_secret",
  "passphrase": "your_passphrase",
  "accountId": "account_main"
}
```

- **响应**：
```json
{
  "success": true,
  "message": "一键平仓完成: 成功 7 个，失败 1 个 （第二轮重试: 成功 1/2）",
  "totalPositions": 8,
  "closedCount": 7,
  "failedCount": 1,
  "retryCount": 2,
  "retrySuccess": 1,
  "results": [
    {
      "instId": "BTC-USDT-SWAP",
      "posSide": "long",
      "size": "10",
      "avgPx": "45000.5",
      "upl": "25.5",
      "status": "success",
      "message": "平仓成功",
      "attempt": 1
    }
  ]
}
```

---

## 用户体验流程

### 场景1：止盈触发并确认平仓

```
用户持有8个持仓，总未实现盈亏 +102.50 USDT

1. [自动] 系统检测到盈亏超过止盈阈值(+100 USDT)
2. [自动] 止盈开关自动关闭并保存
3. [用户] 看到确认对话框：
   "🎉 止盈警报！当前盈利 +102.50 USDT，是否一键平仓？"
4. [用户] 点击【确定】
5. [自动] 调用一键平仓API
6. [自动] 第一轮：成功关闭7个，失败1个（网络超时）
7. [自动] 等待2秒后第二轮重试
8. [自动] 第二轮：成功关闭1个
9. [用户] 看到结果：
   "✅ 一键平仓完成！
   总持仓：8个
   成功平仓：8个
   失败：0个
   第二轮重试：1/1 成功"
10. [自动] 刷新账户数据，持仓列表清空
11. [用户] 利润锁定，操作完成 ✅
```

### 场景2：止损触发但用户取消平仓

```
用户持有8个持仓，总未实现盈亏 -52.30 USDT

1. [自动] 系统检测到亏损达到止损阈值(-50 USDT)
2. [自动] 止损开关自动关闭并保存
3. [用户] 看到确认对话框：
   "⚠️ 止损警报！当前亏损 -52.30 USDT，是否一键平仓？"
4. [用户] 点击【取消】（决定继续持有）
5. [自动] 不执行平仓操作
6. [用户] 持仓保持不变
7. [提示] 下次触发需要手动重新开启止损
```

---

## 安全保护机制

### 1. 5分钟冷却时间
- 触发后5分钟内不会再次触发
- 避免频繁弹窗打扰用户

### 2. 用户确认机制
- 必须用户手动确认才执行平仓
- 避免误操作导致意外平仓

### 3. 开关自动关闭
- 触发后开关自动关闭
- 防止重复触发
- 需要手动重新开启

### 4. 失败重试机制
- 第一轮失败后自动重试
- 最大限度提高成功率
- 详细记录失败原因

### 5. 详细日志记录
- 记录所有操作到日志文件
- 包含时间戳、账户ID、操作结果
- 便于后续审计和排查

---

## 测试建议

### 测试场景1：止盈触发并平仓
1. 设置低止盈阈值（如：+1 USDT）
2. 等待未实现盈亏达到阈值
3. 确认弹出对话框
4. 点击【确定】
5. 验证所有持仓是否关闭
6. 验证止盈开关是否自动关闭

### 测试场景2：止损触发并取消
1. 设置低止损阈值（如：-1 USDT）
2. 等待未实现盈亏达到阈值
3. 确认弹出对话框
4. 点击【取消】
5. 验证持仓是否保持不变
6. 验证止损开关是否自动关闭

### 测试场景3：平仓失败重试
1. 故意制造一个会失败的持仓（如：余额不足）
2. 触发止盈/止损
3. 确认平仓
4. 观察是否有第二轮重试
5. 验证重试结果是否正确显示

---

## 相关文档

- [止盈止损自动关闭说明](/home/user/webapp/docs/止盈止损自动关闭说明.md)
- [一键平仓所有持仓API文档](/home/user/webapp/docs/一键平仓所有持仓API文档.md)
- [一键平仓重试机制说明](/home/user/webapp/docs/一键平仓重试机制说明.md)
- [开仓与平仓重试策略说明](/home/user/webapp/docs/开仓与平仓重试策略说明.md)

---

## 更新日志

- **2026-02-15 09:50:00 UTC**：初次创建文档
  - 集成一键平仓功能到止盈止损触发流程
  - 添加用户确认机制
  - 实现自动刷新数据
  - 支持失败重试和详细结果展示

---

## 访问地址

- **系统URL**：https://9002-iou7okyaq15h840cyuitp-c07dda5e.sandbox.novita.ai/okx-trading
- **API Base URL**：https://9002-iou7okyaq15h840cyuitp-c07dda5e.sandbox.novita.ai/api/okx-trading

