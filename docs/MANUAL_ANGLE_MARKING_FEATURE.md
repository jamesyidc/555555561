# 手动角度标记功能说明

## ✅ 功能已实现

### 🎯 功能概述
在 **OKX交易标记系统** 中添加了手动角度标记功能，用户可以通过点击图表上的具体点位来手动创建角度标记，也可以删除已有的手动标记。

## 📐 使用方法

### 1. **进入角度标记模式**
- 点击图表上方的 **"📐 进入角度标记模式"** 按钮
- 按钮变绿并显示 **"✅ 角度标记模式 (点击退出)"**
- 出现操作提示："📍 角度标记模式已激活 - 依次点击3个点：C'点(起始) → A点(峰值) → B点(回落)"

### 2. **添加角度标记**
按顺序点击趋势线上的3个点：

#### 第1步：选择 **C'点（起始点）**
- 在趋势线上点击一个点，作为角度的起始位置
- 系统提示："已选择 1/3 个点，下一步: A点(峰值)"
- 该点在图表上用**紫色圆圈**标记，标签显示 **"C'"**

#### 第2步：选择 **A点（峰值点）**
- 点击趋势线的峰值点（最高或最低点）
- 系统提示："已选择 2/3 个点，下一步: B点(回落)"
- 该点在图表上用**红色圆圈**标记，标签显示 **"A"**

#### 第3步：选择 **B点（回落点）**
- 点击峰值后的回落点
- 系统提示："已选择 3/3 个点"
- 该点在图表上用**蓝色圆圈**标记，标签显示 **"B"**
- 自动弹出确认对话框，显示角度信息

#### 确认对话框内容：
```
✅ 已添加上升锐角：16.27°

C'点: 07:02:00 (10.50%)
A点: 07:42:00 (38.01%)
B点: 07:48:00 (31.10%)

价格变化: 27.51%
时间跨度: 40.0分钟
```

#### 点击"确定"后：
- 角度标记添加到图表上
- 自动刷新图表，显示新增的手动角度
- 重置选择状态，可以继续添加下一个角度

### 3. **删除角度标记**
- 在图表上**右键点击**任何手动添加的角度标记（带 [手动] 标签）
- 弹出确认对话框：
  ```
  确定要删除这个角度标记吗？
  
  角度: 16.27°
  峰值: 07:42:00
  ```
- 点击"确定"删除该角度
- 系统提示：
  ```
  🗑️ 已删除角度标记
  
  角度: 16.27°
  峰值: 07:42:00
  ```

**注意：**
- 只能删除手动添加的角度（显示 [手动] 标签）
- 无法删除API生成的系统角度标记

### 4. **取消当前标记**
- 如果在选择点的过程中想重新开始
- 点击 **"❌ 取消标记"** 按钮
- 清除已选择的点，回到初始状态

### 5. **退出角度标记模式**
- 再次点击 **"✅ 角度标记模式 (点击退出)"** 按钮
- 按钮变回蓝色，显示 **"📐 进入角度标记模式"**
- 隐藏操作提示和取消按钮

## 🎨 视觉标识

### 角度类型与颜色：
1. **↗️ 上升锐角** (角度 < 45°)
   - 红色三角形 ▲
   - 标签位置：上方
   - 手动标记显示：↗️ 上升锐角 [手动]

2. **↗️ 上升钝角** (角度 ≥ 45°)
   - 橙色方块 ■
   - 标签位置：上方
   - 手动标记显示：↗️ 上升钝角 [手动]

3. **↘️ 下降锐角** (角度 < 45°)
   - 蓝色倒三角形 ▼
   - 标签位置：下方
   - 手动标记显示：↘️ 下降锐角 [手动]

4. **↘️ 下降钝角** (角度 ≥ 45°)
   - 紫色菱形 ◆
   - 标签位置：下方
   - 手动标记显示：↘️ 下降钝角 [手动]

### 选中点的标记：
- **C'点（起始）**：紫色圆圈，标签 "C'"
- **A点（峰值）**：红色圆圈，标签 "A"
- **B点（回落）**：蓝色圆圈，标签 "B"

## 💡 功能特点

### ✅ 已实现：
1. **可视化选择点位**
   - 点击趋势线即可选择点
   - 实时高亮显示已选择的点
   - 显示步骤提示（已选择 X/3 个点）

2. **自动角度计算**
   - 基于C'、A、B三点自动计算角度
   - 判断上升/下降方向
   - 判断锐角/钝角类型
   - 显示详细的时间、价格、角度信息

3. **手动角度管理**
   - 手动角度与API角度分开存储
   - 手动角度带 [手动] 标签
   - 支持右键删除手动角度
   - 不能删除系统生成的角度

4. **图表集成**
   - 手动角度与API角度一起显示
   - 保持相同的视觉样式
   - 区分手动和系统角度（tooltip显示 [手动]）
   - 切换日期时自动清空手动角度

5. **用户友好**
   - 清晰的操作提示
   - 确认对话框显示详细信息
   - 支持取消当前操作
   - 可随时进入/退出标记模式

## 📊 角度计算公式

与后端保持一致，使用相同的计算方法：

```javascript
// 图表配置
const CHART_WIDTH_PX = 800;
const CHART_HEIGHT_PX = 400;
const CHART_TIME_RANGE_MIN = 600;  // 10小时
const CHART_PRICE_RANGE_PCT = 100; // 100%

// 时间差（分钟）
const time_diff = peak_time - c_prime_time;

// 价格差（百分比）
const price_diff = peak_price - c_prime_price;

// 转换为像素
const price_diff_px = (price_diff / CHART_PRICE_RANGE_PCT) * CHART_HEIGHT_PX;
const time_diff_px = (time_diff / CHART_TIME_RANGE_MIN) * CHART_WIDTH_PX;

// 计算角度
const angle_rad = Math.atan2(price_diff_px, time_diff_px);
const angle_deg = (angle_rad * 180) / Math.PI;
```

## ⚠️ 注意事项

1. **数据持久化**
   - 手动角度存储在浏览器内存中（`manualAngles` 数组）
   - 刷新页面后手动角度会丢失
   - 切换日期后手动角度会丢失
   - **建议：** 如需长期保存，需要添加后端API支持

2. **只能操作趋势线**
   - 只能在**累计涨跌幅**趋势线上选择点
   - 点击角度标记、交易标记等不会触发选择

3. **角度标记顺序**
   - 必须按顺序选择：C' → A → B
   - 不能跳过或重复选择
   - 选择错误时使用"取消标记"按钮重新开始

4. **删除限制**
   - 只能删除带 [手动] 标签的角度
   - 系统生成的角度无法删除
   - 删除后立即刷新图表

## 🔧 技术实现

### 核心变量：
```javascript
let angleModeActive = false;   // 角度标记模式是否激活
let selectedPoints = [];       // 存储选中的点 [C'点, A点, B点]
let manualAngles = [];         // 存储手动添加的角度
let currentTrendData = [];     // 当前趋势数据
let currentTimes = [];         // 当前时间轴
let currentValues = [];        // 当前数值
```

### 核心函数：
- `toggleAngleMode()` - 切换角度标记模式
- `cancelAngleMarking()` - 取消当前角度标记
- `updateAngleStepInfo()` - 更新步骤提示
- `highlightSelectedPoints()` - 高亮显示已选择的点
- `calculateAngleFromPoints()` - 计算角度
- `addManualAngle()` - 添加手动角度
- `deleteAngleMarker()` - 删除角度标记

### ECharts事件：
- `chart.on('click')` - 点击事件（选择点）
- `chart.on('contextmenu')` - 右键事件（删除角度）

## 📝 使用示例

### 场景1：添加一个上升角度
1. 点击"📐 进入角度标记模式"
2. 在07:02:00的点上点击（C'点）
3. 在07:42:00的峰值上点击（A点）
4. 在07:48:00的回落点上点击（B点）
5. 确认对话框，点击"确定"
6. 角度添加成功，显示为红色三角形 ▲ 16.3°

### 场景2：删除一个手动角度
1. 找到带 [手动] 标签的角度标记
2. 右键点击该标记
3. 在确认对话框中点击"确定"
4. 角度删除成功，图表自动刷新

### 场景3：取消当前操作
1. 已选择了C'点和A点
2. 发现选错了，想重新开始
3. 点击"❌ 取消标记"按钮
4. 清除已选择的点，可以重新开始

## 🚀 访问地址
https://5000-idfgz76cf9poiqtgzfhan-c81df28e.sandbox.novita.ai/okx-trading-marks

## 📅 更新记录
- **2026-02-10**: 实现手动角度标记功能
  - 添加角度标记工具栏
  - 实现3点选择流程
  - 实现角度计算和添加
  - 实现右键删除功能
  - 区分手动和系统角度
  - 添加操作提示和确认对话框
